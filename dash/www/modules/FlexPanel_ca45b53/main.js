define(["backbone","Handlebars","QuickBase","css!./css/main.css"],function(i,e,n){var o={getComponentDefinition:function(e){var t,i;if(0<_.keys(e.settingsModel.attributes).length)for(i=o.upgrades.indexOf(_.find(o.upgrades,{version:e.settingsModel.get("version")}))+1;i<o.upgrades.length;i+=1)(t=o.upgrades[i]).fn(e.settingsModel,e),e.settingsModel.set("version",t.version);return{id:1011,componentName:"Flex Panel",componentDescription:"group two components together with a panel",appKey:"FlexPanel",disable_array_reorder:!0,appArgs:{json:{version:"4.3.0",Basics:{layout:"horizontaltop",maxSize:0,minSize:250},Style:{advanced:""}},schema:{type:"object",title:"Properties",properties:{Basics:{type:"object",title:"Basics",options:{disable_array_reorder:!0},properties:{layout:{type:"string",title:"Orientation",enum:["horizontaltop","verticalleft","verticalright","horizontalbottom"],options:{enum_titles:["Horizontal Top","Vertical Left","Vertical Right","Horizontal Bottom"]},default:"horizontaltop"},minSize:{type:"number",title:"Min Size"},maxSize:{type:"number",title:"Max Size"}}},Style:{type:"object",title:"Style",options:{collapsed:!0},properties:{advanced:{type:"css",title:"Advanced CSS",default:""}}}}}}}},upgrades:[{version:0,fn:function(){}}]},t=(s.app=e.template({compiler:[8,">= 4.3.0"],main:function(e,t,i,n,o){var s=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'<div class="worksheet">\n    <div class="grid-stack">\n        <div class=\'advanced-item two placeholder\'></div>\n    </div>\n    <div class="no-widgets-info">\n        <div class="loading">'+e.escapeExpression((s(i,"t")||t&&s(t,"t")||e.hooks.helperMissing).call(null!=t?t:e.nullContext||{},"start dragging widgets from the panel on your left",{name:"t",hash:{},data:o,loc:{start:{line:6,column:29},end:{line:6,column:87}}}))+'</div>\n\n        <div class="dragComponentsHelp">\n            <i class="fa fa-chevron-right"></i>\n            <i class="fa fa-chevron-right"></i>\n            <i class="fa fa-chevron-right"></i>\n        </div>\n    </div>\n</div>\n<div class="visual-indicator"></div>'},useData:!0}),s);function s(){}return n.ComponentDropView.extend({$gridstack:null,$horizontalStyles:null,$noWidgetsInfo:null,$root:null,$verticalStyles:null,$worksheet:null,api:null,dashboardAppModel:null,ignoreWidgetSelect:null,isGridstack:!1,selected:null,dashboardViewModel:null,widgets:null,panelId:null,events:null,initialize:function(e){this.panelId=_.uniqueId("flexpanel"),this.options=e,this.api=e.api,this.componentModel=e.componentModel,this.dashboardAppModel=e.dashboardAppModel,this.dashboardViewModel=e.dashboardViewModel,this.quickView=e.quickView,this.websiteUrl=e.websiteUrl,this.model||(this.model=this.componentModel),this.viewModel=new i.DeepModel,this.widgets=[],this.render()},initializeEvents:function(){this.$worksheet.on("dragover",this.getSafeDragNDropHandler(this.onWorksheetDragOver)),this.$worksheet.on("dragleave",this.getSafeDragNDropHandler(this.onWorksheetDragLeave)),this.$worksheet.on("drop",this.getSafeDragNDropHandler(this.onWorksheetDrop)),this.listenTo(this.viewModel,"change:Basics.layout",this.onLayoutChanged),this.listenTo(this.viewModel,"change:Basics.maxSize",this.onSizeLimitChanged),this.listenTo(this.viewModel,"change:Basics.minSize",this.onSizeLimitChanged),this.listenTo(this.dashboardViewModel,"change:selectedWidget",this.onSelectedWidgetChanged),this.listenTo(this.dashboardViewModel,"change:buildMode",function(){this.switchBuildMode(this.dashboardViewModel.get("buildMode"))}),this.listenTo(this.dashboardAppModel,"change:pendingSelectionWidgetId",this.onSelectingWidget),this.initializeEvents_widgetCollection()},initializePost:function(){this.hasInitPost||(this.hasInitPost=!0,this.$horizontalStyles=$("<style />",{type:"text/css"}).appendTo(document.head),this.$verticalStyles=$("<style />",{type:"text/css"}).appendTo(document.head),this.widgetsCollection=this.model.get("widgets"),this.initializeEvents(),this.clearPanel(this.applyCurrentPanel.bind(this)),this.switchBuildMode(this.dashboardViewModel.get("buildMode")),this.onLayoutChanged(),this.onSizeLimitChanged())},addWidget:function(e,t,i){return this.$noWidgetsInfo.hide(),this.$visualIndicator.hide(),n.ComponentDropView.prototype.addWidget.apply(this,arguments)},addWidgetEvents:function(e){var t,i=this;if(!(e instanceof $))throw"Wrong parameter.";_.each(e,function(e){(t=$(e)).on("click",$.proxy(i.onWidgetClick,i)),t.on("dragenter",i.getSafeDragNDropHandler(i.onComponentDragEnter)),t.on("dragleave",i.getSafeDragNDropHandler(i.onComponentDragLeave)),t.on("dragover",i.getSafeDragNDropHandler(i.onComponentDragOver)),t.on("drop",i.getSafeDragNDropHandler(i.onComponentDrop))})},applyCurrentPanel:function(){var t=this;this.isGridstack=!1,this.widgetsCollection.each(function(e){t.addWidget(e,!0,null)})},clearPanel:function(e){this.clearWidgets(function(){e&&e()})},clearWidgets:function(e){_.includes(this.model.get("widgets").map("id"),this.dashboardViewModel.get("selectedWidgetId"))&&this.deselectCurrentWidget(),0<this.widgets.length&&(_.each(this.widgets,function(e){e.view&&_.isFunction(e.view.remove)&&e.view.remove()}),this.widgets=[],this.$gridstack.children().remove()),e&&e()},getWidgetClass:function(e){var t="one";return 1===this.widgets.length&&(t="two",0===e&&(this.widgets[0].$widget.removeClass(t="one"),this.widgets[0].$widget.addClass("two"))),"ui-widget "+t},onComponentDragOver:function(e){if(!_.includes(e.originalEvent.dataTransfer.types,"Files"))return $(e.currentTarget).toggleClass("highlight",!0),!1},onComponentDragEnter:function(e){var t;if(!_.includes(e.originalEvent.dataTransfer.types,"Files"))return t=e.currentTarget.getAttribute("data-widgetid"),this.model.get("widgets").get(t).get("component")||$(e.currentTarget).toggleClass("highlight",!0),!1},onComponentDragLeave:function(e){return $(e.currentTarget).toggleClass("highlight",!1),!1},onComponentDrop:function(e){var t;return this.onComponentDragLeave(e),void 0!==e.originalEvent.dataTransfer&&(t=e.originalEvent.dataTransfer.getData("text"),this.dashboardAppModel.get("components").get(t)&&(e=$(e.currentTarget).attr("data-widgetid"),e=this.findWidgetItem(e),this.dashboardViewModel.set("selectedWidget",null),e?this.addComponentToWidget(e.model,t,!0):this.addNewWidget(null,t,!1)),!1)},onComponentDropWrap:function(e,t,i,n,o){var s=e.originalEvent.dataTransfer.getData("text");return e.preventDefault&&(e.preventDefault(),e.stopPropagation()),this.dashboardAppModel.get("components").has(s)&&this.addNewWidget(null,s,!1),!1},onLayoutChanged:function(){this.$visualIndicator.removeClass("horizontaltop"),this.$visualIndicator.removeClass("verticalleft"),this.$visualIndicator.removeClass("verticalright"),this.$visualIndicator.removeClass("horizontalbottom"),this.$el.removeClass("horizontaltop"),this.$el.removeClass("verticalleft"),this.$el.removeClass("verticalright"),this.$el.removeClass("horizontalbottom"),this.$visualIndicator.addClass(this.viewModel.get("Basics.layout")),this.$el.addClass(this.viewModel.get("Basics.layout"))},onResize:function(){this.onResizeWidgets()},onResizeWidgets:function(){_.each(this.widgets,function(e){e.view&&(_.isFunction(e.view.onResize)&&e.view.onResize(!0),_.isFunction(e.view.onResizeStop)&&e.view.onResizeStop(!0))})},onSelectingWidget:function(e,t){e&&(this.onWidgetClick(null,t),this.dashboardAppModel.set("pendingSelectionWidgetId",null,{silent:!0}))},onSelectedWidgetChanged:function(e,t,i){e=e.get("selectedWidgetId");this.$el.find(".advanced-item.selected").toggleClass("selected",!1),e&&this.$el.find(".advanced-item[data-widgetid='"+e+"']").toggleClass("selected",!0)},onSettingsChange:function(e){var i=this;_.each(e,function(e,t){i.viewModel.set(t,e)}),this.initializePost()},onSizeLimitChanged:function(e,t,i){var n="#"+this.panelId+".flex-panel",o=">.worksheet>.grid-stack>.advanced-item.one>.grid-stack-item-content>.component-build-view>.border-div>.app-div",s=this.viewModel.get("Basics.minSize"),a=this.viewModel.get("Basics.maxSize"),d=n+".horizontaltop"+o+","+n+".horizontalbottom"+o+"{",n=n+".verticalleft"+o+","+n+".verticalright"+o+"{";s&&(d+="min-height: "+s+"px;",n+="min-width: "+s+"px;"),a&&(d+="max-height: "+a+"px;",n+="max-width: "+a+"px;"),n+="height: 100%;}",this.$horizontalStyles.html(d+="width: 100%;}"),this.$verticalStyles.html(n),this.onResize()},onWidgetCollectionAdd:function(e,t,i){i=i&&i.at;this.addWidget(e,!1,i)},onWorksheetDragLeave:function(e){return this.$placeholder.hide(),!1},onWorksheetDragOver:function(e){return this.$placeholder.show(),!1},onWorksheetDrop:function(e){return this.$placeholder.hide(),this.deselectCurrentWidget(),this.widgets.length<2&&this.onComponentDropWrap(e),!1},pasteWidget:function(e){2===this.widgets.length&&this.removeWidget(this.widgets[1]),e.setParent(this.widgetsCollection),widgetItem=this.addNewWidget(e,e.get("component").get("definitionId"),!0)},remove:function(e){var t=this;this.removing||(this.removing=!0,this.$horizontalStyles.remove(),this.$horizontalStyles=null,this.$verticalStyles.remove(),this.$verticalStyles=null,this.stopListening(),this.$worksheet.off(),this.clearPanel(function(){t.removeCallbacks=[],t.$el.remove(),t.removing=!1,e&&e()})),i.View.prototype.remove.apply(this)},removeWidget:function(e){e=this.findWidgetItem(e.id);e&&(this.widgets=_.without(this.widgets,e),this.widgets.length<=0?(this.$noWidgetsInfo.show(),this.$visualIndicator.show()):1===this.widgets.length&&this.widgets[0].$widget.hasClass("two")&&(this.widgets[0].$widget.toggleClass("two",!1),this.widgets[0].$widget.toggleClass("one",!0)),this.quickView||this.model.get("widgets").remove(e.model),e.$widget.css({border:"none",background:"none","box-shadow":"none","pointer-events":"none"}),e.view&&e.view.remove&&e.view.remove(),e.$widget.off(),e.$widget.remove())},render:function(){return this.$el.addClass("flex-panel"),this.$el.attr("id",this.panelId),this.$el.html(t.app()),this.$worksheet=this.$el.find("> .worksheet"),this.$gridstack=this.$worksheet.find("> .grid-stack"),this.$noWidgetsInfo=this.$worksheet.find("> .no-widgets-info"),this.$visualIndicator=this.$el.find("> .visual-indicator"),this.$placeholder=this.$gridstack.find("> .placeholder"),this},renderComponent:function(e,t){t=this.createComponentView(e,t),t=$("<div/>",{class:"grid-stack-item-content"}).append(t.$el);e.$widget.append(t)},renderWidget:function(){var e=$('<div class="advanced-item"><div class="drop-show"></div></div>');return this.$gridstack.append(e),e},setTheme:function(t){_.each(this.widgets,function(e){e.view.app&&e.view.app.setTheme&&e.view.app.setTheme(t)})},switchOffBuildMode:function(){n.ComponentDropView.prototype.switchOffBuildMode.apply(this,arguments),this.$gridstack.find("> div").addClass("build-off")},switchOnBuildMode:function(){n.ComponentDropView.prototype.switchOnBuildMode.apply(this,arguments),this.$gridstack.find("> div").removeClass("build-off")}},{getComponentDefinition:o.getComponentDefinition})});