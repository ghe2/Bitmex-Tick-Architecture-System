define(["backbone","Handlebars","QuickBase","css!./css/main.css"],function(l,e,o){"use strict";var n,t=this&&this.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)},function(e,t){function i(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}),i=(s.getComponentDefinition=function(e){var t={id:50,componentName:"Accordion",componentDescription:"Create collapsible areas for your components",appKey:"Accordion",appArgs:{json:{version:"4.5.1",Basics:{ComponentName:"accordion",Direction:"Vertical",ScaleOnResize:!1,Sections:[{Title:"Section",TitleAlign:"Left",Expanded:!0,Weight:1,Resizeable:!1,HideTitle:!1,Flex:!1}]},Style:{Theme:"Dark",advanced:""}},schema:{type:"object",title:"Properties",properties:{Basics:{type:"object",title:"Basics",properties:{ComponentName:{type:"string",title:"hide me",default:"accordion",options:{hidden:!0}},Direction:{type:"string",default:"Vertical",enum:["Vertical","Horizontal"]},ScaleOnResize:{title:"Scale On Resize",type:"boolean",format:"checkbox",default:!1},Sections:{title:"Sections",type:"array",format:"object",options:{disable_collapse:!0},items:{title:"Section",type:"object",properties:{SectionId:{type:"string",options:{hidden:!0}},Title:{type:"string",default:"Section"},TitleAlign:{type:"string",title:"Title Align",default:"Left",enum:["Left","Center","Right"]},Expanded:{type:"boolean",format:"checkbox",default:!1},Flex:{type:"boolean",format:"checkbox",default:!1},MinSize:{type:"number",title:"Min Size"},MaxSize:{type:"number",title:"Max Size"},Weight:{type:"number",default:1},Resizeable:{type:"boolean",format:"checkbox",default:!1},HideTitle:{title:"Hide Title",type:"boolean",format:"checkbox",default:!1}},_transform:function(e,t,i,n){var o=e;o.Flex?(_.isUndefined(o.MinSize)&&(o.MinSize=0),_.isUndefined(o.MaxSize)&&(o.MaxSize=250),o.Weight=void 0,o.Resizeable=void 0):(_.isUndefined(o.Weight)&&(o.Weight=1),_.isUndefined(o.Resizeable)&&(o.Resizeable=!1),o.MaxSize=void 0,o.MinSize=void 0),n(e)}}}}},Style:{type:"object",title:"Style",options:{collapsed:!0},properties:{Theme:{type:"string",title:"Theme",options:{hidden:!0},enum:["Light","Dark"]},DashboardTheme:{options:{hidden:!0}},advanced:{type:"css",title:"Advanced CSS",default:""}}}}}}};if(0<_.keys(e.settingsModel.attributes).length)for(var i=_.find(s.upgrades,{version:e.settingsModel.get("version")}),n=void 0===i?1:s.upgrades.indexOf(i)+1;n<s.upgrades.length;n+=1){var o=s.upgrades[n];o.fn(e.settingsModel),e.settingsModel.set("version",o.version)}return t},s.upgrades=[{version:"4.0.0p2",fn:function(e){var t=[];e.get("Basics.Direction")||e.set("Basics.Direction","Vertical"),_.each(e.get("Basics.Sections"),function(e){e.TitleAlign||(e.TitleAlign="Left"),t.push(e)}),e.set("Basics.Sections",t)}},{version:"4.5.1",fn:function(e){e.set("Basics.ScaleOnResize",!1),_.each(e.get("Basics.Sections"),function(e){e.Flex=!1})}}],s);function s(){}a.app=e.template({compiler:[8,">= 4.3.0"],main:function(e,t,i,n,o){return'<div class="accordion">\n\n</div>'},useData:!0}),a.section=e.template({compiler:[8,">= 4.3.0"],main:function(e,t,i,n,o){var s,c=null!=t?t:e.nullContext||{},a=e.hooks.helperMissing,r="function",d=e.escapeExpression,e=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'<div class="'+d(typeof(s=null!=(s=e(i,"className")||(null!=t?e(t,"className"):t))?s:a)==r?s.call(c,{name:"className",hash:{},data:o,loc:{start:{line:1,column:12},end:{line:1,column:25}}}):s)+'">\n    <div class="heading ui-widget-content" style="text-align:'+d(typeof(s=null!=(s=e(i,"align")||(null!=t?e(t,"align"):t))?s:a)==r?s.call(c,{name:"align",hash:{},data:o,loc:{start:{line:2,column:61},end:{line:2,column:70}}}):s)+'"><i class="fa fa-angle-right"></i><span class="title">'+d(typeof(s=null!=(s=e(i,"heading")||(null!=t?e(t,"heading"):t))?s:a)==r?s.call(c,{name:"heading",hash:{},data:o,loc:{start:{line:2,column:125},end:{line:2,column:136}}}):s)+'</span></div>\n    <div class="content"></div>\n</div>\n'},useData:!0});var c=a;function a(){}r=o.ComponentDropView,t(h,r),h.prototype.initialize=function(e){this.section=e.section,this.widgetClass="component-drop-widget",r.prototype.initialize.call(this,e)},h.prototype.addNewWidget=function(e,t,i){return e.set("sectionId",this.section.viewModel.get("sectionId")),r.prototype.addNewWidget.call(this,e,t,i)},h.prototype.addWidget=function(e,t,i){if(e.get("sectionId")===this.section.viewModel.get("sectionId"))return(e=r.prototype.addWidget.call(this,e,t,i)).section=this.section,e},h.prototype.clearWidgets=function(e){var t=this,i=this.dashboardViewModel.get("selectedWidgetId");_.each(this.widgets,function(e){e.view&&(_.isFunction(e.view.remove)&&e.view.remove(),e.view.widgetId===i&&t.deselectCurrentWidget())}),this.widgets=[],e&&e()},h.prototype.executeCallback=function(){_.isFunction(this.callback)&&this.callback()},h.prototype.renderComponent=function(e,t){var i=this;r.prototype.renderComponent.call(this,e,function(e){t(e),i.executeCallback(),i.section.setMinMaxSizes(),_.isFunction(e.onResize)&&e.onResize(),i.section.onResizeStop()}),e.model.set("sectionId",this.section.viewModel.get("sectionId"))};var r,d=h;function h(e,t){var i=r.call(this,e)||this;return i.callback=t,i.section=e.section,_.find(i.widgetsCollection.models,function(e){return e.get("sectionId")===i.section.viewModel.get("sectionId")})||i.executeCallback(),i.section.setMinMaxSizes(),i}u.prototype.initDropView=function(e,t){this.componentDropView=new d(_.extend(e,{section:this}),t)},u.prototype.getSpan=function(){var e=this.$tel[0].getBoundingClientRect();return this.isVertical()?e.height:e.width},u.prototype.getClassName=function(e){var t=["section"];return this.viewModel.get("isExpanded")&&t.push("expanded"),this.viewModel.get("hideHeader")&&t.push("noHeader"),this.viewModel.get("flex")&&t.push("flex"),e&&t.push("ui-resizable"),t.join(" ")},u.prototype.onResize=function(e){this.componentDropView&&this.componentDropView.onResize(e)},u.prototype.onResizeStart=function(){this.componentDropView&&this.componentDropView.onResizeStart()},u.prototype.onResizeStop=function(){var e=this.isVertical()?"":this.$tel[0].getBoundingClientRect().height;this.$cel.find("> div").css("height",e),this.$cel.find(u.APP_PATH).css("height",e),this.onResize(!0),this.componentDropView&&this.componentDropView.onResizeStop()},u.prototype.remove=function(){this.componentDropView&&this.componentDropView.remove()},u.prototype.setMinMaxSizes=function(){var e=this.isVertical()?"Height":"Width",t=this.viewModel.get("flex")&&this.viewModel.get("maxSize")||"",i=this.viewModel.get("flex")&&this.viewModel.get("minSize")||"",n={};n["min"+e]=i,n["max"+e]=t,this.$cel.find("> div").css(n),this.$cel.find(u.APP_PATH).css(n)},u.APP_PATH="> div > .component-drop-widget > .component-build-view > .border-div > .app-div";var p=u;function u(e,t,i){var n=this;this.isVertical=i,this.viewModel=e.viewModel,this.$tel=$(c.section(_.extend(e.viewModel.toJSON(),{className:this.getClassName()}))),this.$hel=this.$tel.find(".heading"),this.$cel=this.$tel.find(".content"),this.$cel.append(e.$el),this.$hel.on("click",function(e){t(n),e.stopPropagation()})}g=l.View,t(w,g),w.prototype.addSection=function(e,t){var i=this,e=new p(e,function(e){return i.onSectionHeaderClick(e)},function(){return i.isVertical()});this.trigger("sectionAdded",e),this.$el.append(e.$tel),this.sections.push(e),this.initializeSectionEvents(e),t&&(this.normaliseWeights(),this.updateLayout(!0))},w.prototype.remove=function(){return this.sections.forEach(function(e){return e.remove()}),l.View.prototype.remove.apply(this)},w.prototype.removeSection=function(t){var e=_.find(this.sections,function(e){return e.viewModel.get("sectionId")===t});e&&(e.$hel.off(),e.$tel.off(),e.$tel.remove(),this.sections=_.without(this.sections,e),this.trigger("sectionRemoved",e)),this.normaliseWeights(),this.updateLayout(!0)},w.prototype.resize=function(){this.isVertical()?_.some(this.sections,function(e){return e.viewModel.get("isExpanded")})&&(this.expandedSpan=this.$el[0].getBoundingClientRect().height):this.expandedSpan=this.$el[0].getBoundingClientRect().width},w.prototype.setDirection=function(e){_.includes(w.POSSIBLE_DIRECTIONS,e)&&e!==this.direction&&(_.each(this.sections,function(e){e.resizeable&&(e.$tel.resizable("destroy"),delete e.resizeable)}),this.$el.removeClass(w.POSSIBLE_DIRECTIONS.join(" ")).addClass(e),this.direction=e,this.resize())},w.prototype.updateLayout=function(e){var i=this;o.Log.Info("Accordion: UpdateLayout"),this.$el.toggleClass("animate",e),_.each(this.sections,function(e,t){e.$tel.css({flexGrow:i.getFlexGrow(e,e.viewModel.get("isExpanded")),height:i.isVertical()?"":i.$el[0].getBoundingClientRect().height,width:""}),e.$hel.width(i.isVertical()?"":i.$el[0].getBoundingClientRect().height);t=e.viewModel.get("isResizeable")&&!e.viewModel.get("flex")&&e.viewModel.get("isExpanded")&&t<i.sections.length-1&&_.some(i.sections.slice(t+1),function(e){return e.viewModel.get("isExpanded")});e.$tel[0].className=e.getClassName(t),t?e.resizeable=e.$tel.resizable({handles:i.isVertical()?"s":"e",resize:i.onSectionResize.bind(i,e),start:i.onSectionResizeStart.bind(i,e),stop:i.onSectionResizeStop.bind(i,e)}).on("resize",function(e){e.stopPropagation()}):e.resizeable&&(e.$tel.resizable("destroy"),delete e.resizeable)}),this.delayedResize&&clearTimeout(this.delayedResize),e?this.delayedResize=setTimeout(function(){i.sections.forEach(function(e){return e.onResizeStop()}),i.$el.removeClass("animate")},300):this.sections.forEach(function(e){return e.onResizeStop()}),this.trigger("layoutUpdated")},w.prototype.adjustWeights=function(){var i=this,n=(o.Log.Info("Accordion: AdjustWeights"),_.sum(_.filter(this.resizeSpans,function(e,t){return!i.sections[t].viewModel.get("flex")})));this.sections.forEach(function(e,t){e.viewModel.set("weight",e.viewModel.get("flex")?0:i.resizeSpans[t]/n,{silent:!0})}),o.Log.Info("Spans",this.sections.map(function(e){return e.viewModel.get("weight")})),this.normaliseWeights()},w.prototype.getAvailableSpan=function(){var e=_.filter(this.sections,function(e){return e.viewModel.get("isExpanded")&&!e.viewModel.get("flex")}),t=_.filter(this.sections,function(e){return e.viewModel.get("isExpanded")&&e.viewModel.get("flex")}),i=_.filter(this.sections,function(e){return!e.viewModel.get("hideHeader")}),i=_.sumBy(i,function(e){return e.viewModel.get("isResizeable")?0:w.HEADING_SPAN}),e=(e.length?this.expandedSpan:i)-i;return this.isVertical()?e-=_.sumBy(t,function(e){return e instanceof p&&e.$cel.height()||0}):e-=_.sumBy(t,function(e){return e instanceof p&&e.$cel.width()||0}),e},w.prototype.getFlexGrow=function(e,t){return t?e.viewModel.get("flex")?0:e.viewModel.get("weight"):this.isIE?0:1e-6},w.prototype.initializeSectionEvents=function(t){var i=this;this.listenTo(t.viewModel,"change:heading",function(){t.$hel.find(".title").text(t.viewModel.get("heading"))}),this.listenTo(t.viewModel,"change:align",function(){t.$hel[0].style.textAlign=t.viewModel.get("align")}),this.listenTo(t.viewModel,"change:order",function(){var e=t.viewModel.get("order");t.$tel.index()!==e&&(0===e?i.$el.prepend(t.$tel):i.$el.find(".section:nth-child("+e+")").after(t.$tel))}),this.listenTo(t.viewModel,"change:isExpanded",function(){t.$tel.css("flexGrow",i.getFlexGrow(t,t.viewModel.previous("isExpanded"))),i.updateLayout(!0),i.trigger("sectionExpanded",t)}),this.listenTo(t.viewModel,"change:flex change:isResizeable change:hideHeader change:weight",function(){return i.updateLayout(!0)}),this.listenTo(t.viewModel,"change:maxSize change:minSize",function(){return t.setMinMaxSizes()})},w.prototype.isVertical=function(){return"Horizontal"!==this.direction},w.prototype.normaliseWeights=function(){var t=_.sumBy(_.filter(this.sections,function(e){return!e.viewModel.get("flex")}),function(e){return e.viewModel.get("weight")}),i=(this.sections.forEach(function(e){e=e.viewModel.get("weight");1e-10<=e&&e<t&&(t=e)}),1/t),n=Math.pow(10,w.WEIGHTS_PRECISION);this.sections.forEach(function(e){var t;e.viewModel.get("flex")||(t=e.viewModel.get("weight"),e.viewModel.set("weight",Math.round(t*i*n)/n,{silent:!0}))}),o.Log.Info("Weights",this.sections.map(function(e){return e.viewModel.get("weight")}))},w.prototype.onSectionHeaderClick=function(e){e.viewModel.set("isExpanded",!e.viewModel.get("isExpanded"))},w.prototype.onSectionResize=function(e,t,i){for(var n=e.$tel[0].getBoundingClientRect(),i=i.originalSize,n=this.isVertical()?n.height:n.width,o=n-(this.isVertical()?i.height:i.width),s=0,c=[e],a=[n],r=this.sections.indexOf(e)+1;r<this.sections.length;r++){var d=this.sections[r],l=d.viewModel.get("hideHeader")?0:w.HEADING_SPAN;if(d.viewModel.get("isExpanded")){var h=Math.max(l,this.resizeSpans[r]-(o-s));if(s+=Math.min(this.resizeSpans[r]-l,o-s),this.isVertical()?d.$tel.height(Math.floor(h)+"px"):d.$tel.width(Math.floor(h)+"px"),c.push(d),a.push(h),s===o)break}}this.trigger("sectionResized",c)},w.prototype.onSectionResizeStart=function(e){var i=this,t=this.getAvailableSpan();this.resizeSpans=this.sections.map(function(e){return e.getSpan()||0}),this.sections.forEach(function(e,t){e.$tel.css(i.isVertical()?"height":"width",Math.floor(i.resizeSpans[t])+"px")}),this.$el.removeClass("flex"),this.sections.forEach(function(e){e.viewModel.get("isExpanded")&&e.onResizeStart()}),this.isVertical()?(e.$tel.resizable("option","maxHeight",t),e.$tel.resizable("option","maxWidth",null)):(e.$tel.resizable("option","maxHeight",null),e.$tel.resizable("option","maxWidth",t))},w.prototype.onSectionResizeStop=function(e){var t=this;this.resizeSpans=this.sections.map(function(e){return e.getSpan()||0}),this.adjustWeights(),_.defer(function(){t.updateLayout(!1),t.$el.addClass("flex"),e.$tel.resizable("option",t.isVertical()?"maxHeight":"maxWidth",null),t.sections.forEach(function(e){e.viewModel.get("isExpanded")&&e.onResizeStop()})})},w.HEADING_SPAN=32,w.POSSIBLE_DIRECTIONS=["Vertical","Horizontal"],w.WEIGHTS_PRECISION=32;var g,f,v=w;function w(e){var t=g.call(this,e)||this;return t.sections=[],t.resizeSpans=[],t.direction=w.POSSIBLE_DIRECTIONS[0],t.expandedSpan=t.isVertical()?t.$el[0].getBoundingClientRect().height:t.$el[0].getBoundingClientRect().width,t.isIE=!!window.document.documentMode,t.$el.addClass("accordion flex "+t.direction),e.sections&&e.sections.length&&(e.sections.forEach(function(e){t.addSection(e)}),t.normaliseWeights(),t.updateLayout(!1)),t}function S(e){var t=f.call(this,e)||this;return t.hasInit=!1,t.pendingWeights=[],t.removing=!1,t.resizeSections=[],t.viewModel=new l.DeepModel,t.api=e.api,t.componentModel=e.componentModel,t.dashboardAppModel=e.dashboardAppModel,t.dashboardViewModel=e.dashboardViewModel,t.DeltaClientLib=e.DeltaClientLib,t.model=e.model,t.quickView=e.quickView,t.settingsModel=e.settingsModel,t.documentViewModel=e.viewModel,t.model||(t.model=t.componentModel),t.debouncedResizeSections=function(e){t.api.getProperty("Basics.ScaleOnResize")&&(t.resizeSections=_.union(t.resizeSections,e),window.requestAnimationFrame(t.animationResizeSection.bind(t)))},t.animationResizeSection=function(){var e=t.resizeSections;t.resizeSections=[],e&&e.length&&_.each(e,function(e){return e.onResize(!0)})},t.accordion=new v({el:t.$el,sections:[]}),t}return f=l.View,t(S,f),S.prototype.initializeEvents=function(){this.listenTo(this.viewModel,"change:Basics.Direction",this.onDirectionChanged.bind(this)),this.listenTo(this.model.get("widgets"),"materialChange",this.onMaterialChange.bind(this)),this.listenTo(this.accordion,"layoutUpdated",this.onLayoutUpdate.bind(this)),this.listenTo(this.accordion,"sectionAdded",this.onSectionAdd.bind(this)),this.listenTo(this.accordion,"sectionRemoved",this.onSectionRemove.bind(this)),this.listenTo(this.accordion,"sectionExpanded",this.onSectionExpand.bind(this)),this.listenTo(this.accordion,"sectionResized",this.onSectionResize.bind(this))},S.prototype.initializeSection=function(e,t){e.initDropView({el:e.$cel.find("> div"),api:this.api,dashboardAppModel:this.dashboardAppModel,dashboardViewModel:this.dashboardViewModel,DeltaClientLib:this.DeltaClientLib,quickView:this.quickView,widgets:this.model.get("widgets"),viewModel:this.viewModel},t)},S.prototype.convertSectionSetting=function(i){var n={};return _.each(S.SETTINGS_MAP,function(e,t){_.isUndefined(i[t])||(n[e]=i[t])}),_.each(S.SETTINGS_MAP_BOOL,function(e,t){_.isUndefined(i[t])||(n[e]=!!i[t])}),n},S.prototype.getSectionById=function(t){return _.find(this.accordion.sections,function(e){return e.viewModel.get("sectionId")===t})},S.prototype.onDirectionChanged=function(){this.accordion.setDirection(this.viewModel.get("Basics.Direction")),this.accordion.updateLayout(!1)},S.prototype.onLayoutUpdate=function(){var i,n=this,e=this.pendingWeights;e&&e.length&&(i=e.map(function(e){return e.viewModel.get("weight")}),_.each(e,function(e,t){n.setSectionSetting(e,{Weight:i?i[t]:0})}),this.pendingWeights=[])},S.prototype.onMaterialChange=function(){this.documentViewModel.trigger("materialChange")},S.prototype.onResize=function(){this.debouncedResizeSections(this.accordion.sections)},S.prototype.onResizeStop=function(){this.accordion.resize(),this.accordion.updateLayout(!1)},S.prototype.onSectionAdd=function(e){var t=this;e.viewModel.get("isExpanded")?this.initializeSection(e,function(){}):_.delay(function(){return t.initializeSection(e,function(){})},S.UNEXPANDED_INIT_DELAY)},S.prototype.onSectionRemove=function(e){e.remove()},S.prototype.onSectionExpand=function(e){this.setSectionSetting(e,{Expanded:e.viewModel.get("isExpanded")})},S.prototype.onSectionResize=function(e){this.debouncedResizeSections(e),this.pendingWeights=e},S.prototype.onSettingsChange=function(i){var n,o,s,c,a,t,r=this,d=_.keys(i);void 0!==i["Basics.Sections"]?(a=_.map(this.accordion.sections,function(e){return e.viewModel.get("sectionId")}),_.each(i,function(i,e){"Basics.Sections"===e&&_.isArray(i)?_.each(i,function(e,t){s=e.SectionId,c=r.convertSectionSetting(e),s||(s=_.uniqueId("section_"),r.api.setProperty("Basics.Sections."+t+".SectionId",s)),c.order=t,c.sectionId=s,(e=r.getSectionById(s))?e.viewModel.set(c):r.accordion.addSection({$el:$("<div />").attr("data-sectionid",s),viewModel:new l.Model(c)},i.length-1===t),a=_.without(a,s)}):r.viewModel.set(e,i)}),a.length&&_.each(a,function(e){r.accordion.removeSection(e)}),this.pendingWeights=[]):_.each(i,function(e,t){(n=S.SETTINGS_REGEX.exec(t))&&3===n.length?(o=_.find(r.accordion.sections,function(e){return e.viewModel.get("order")===parseInt(n[1],10)}))&&((c={})[n[2]]=i[d[0]],o.viewModel.set(r.convertSectionSetting(c))):r.viewModel.set(t,i[t])}),this.hasInit||(t=_.after(this.accordion.sections.length,function(){r.accordion.updateLayout(!1)}),this.hasInit=!0,this.accordion.setDirection(this.viewModel.get("Basics.Direction")),this.accordion.sections.forEach(function(e){return r.initializeSection(e,t)}),this.initializeEvents())},S.prototype.pasteWidget=function(e){var t,i=_.find(this.accordion.sections,function(e){return e.viewModel.get("isExpanded")});i instanceof p&&i.componentDropView&&(t=i.componentDropView,e.setParent(t.widgetsCollection),t.clearWidgets(function(){t.addNewWidget(e,e.get("component").get("definitionId"),!0)}))},S.prototype.remove=function(){return this.removing||(this.removing=!0,this.stopListening()),this.accordion&&_.isFunction(this.accordion.remove.bind(this.accordion))&&this.accordion.remove(),l.View.prototype.remove.apply(this)},S.prototype.render=function(){return this.$el.html(c.app()),this},S.prototype.setSectionSetting=function(i,e){var n,o=this;_.find(this.settingsModel.get("Basics.Sections"),function(e,t){return n=t,e.SectionId===i.viewModel.get("sectionId")})&&_.each(e,function(e,t){o.api.setProperty("Basics.Sections."+n+"."+t,e)})},S.prototype.setTheme=function(t){var i=this;_.isString(t),_.each(this.accordion.sections,function(e){e.componentDropView&&_.isFunction(e.componentDropView.setTheme.bind(i))&&e.componentDropView.setTheme(t)})},S.AccordionView=v,S.getComponentDefinition=i.getComponentDefinition,S.SETTINGS_MAP={MaxSize:"maxSize",MinSize:"minSize",Title:"heading",TitleAlign:"align",Weight:"weight"},S.SETTINGS_MAP_BOOL={Expanded:"isExpanded",Flex:"flex",Resizeable:"isResizeable",HideTitle:"hideHeader"},S.SETTINGS_REGEX=/Basics.Sections.(\d)+.(\w+)/,S.UNEXPANDED_INIT_DELAY=1e3,S});