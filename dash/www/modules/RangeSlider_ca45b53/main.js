define(["backbone","jqueryui","d3","nv","biPartite","Handlebars","QuickBase","css!./css/app.css"],function(o,e,n,i,s,a,r){"use strict";var l,d,p=this&&this.__extends||(l=function(e,t){return(l=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)},function(e,t){function i(){this.constructor=e}l(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}),h=(d=o.View,p(c,d),c.prototype.initRangeSlider=function(){this.initSlider(this.getLineData())},c.prototype.remove=function(){o.View.prototype.remove.apply(this)},c.prototype.setSelected=function(){var e=this.api.getProperty("Basics"),e=""!==e.SelectedMin||""!==e.SelectedMax,t=("by Number"===this.api.getProperty("Xaxis.Scale")&&this.xAxisIndex.sort(function(e,t){return e[1]-t[1]}),_.map(this.xAxisIndex,"0")),i=this.api.getProperty("Basics.SelectedMin"),s=this.api.getProperty("Basics.SelectedMax"),a=this.api.getProperty("Basics.Selected");e?this.$slider.slider({values:[""===i?_.min(t):this.findSelectedIndex(i),""===s?_.min(t):this.findSelectedIndex(s)]}):this.$slider.slider({value:""===a?_.min(t):this.findSelectedIndex(a)})},c.prototype.drawAxis=function(e){var t=window.d3.select(this.$graph.find("> svg")[0]),e=n.scale.linear().domain([e[0],e[e.length-1]]).range([0,this.$slider.width()]),e=n.svg.axis().scale(e);this.formatXaxis=this.formatXaxis.bind(this),e.tickFormat(this.formatXaxis),e.ticks(this.formatXtickValues()),t.append("g").call(e).selectAll("text").attr("transform","rotate("+this.api.getProperty("Xaxis.Rotation")/4+")").style("text-anchor","start"),t.selectAll("text").attr("x",function(e){return 0===e?0:this.getBoundingClientRect().width/2*-1})},c.prototype.findSelectedIndex=function(e){var i=this,s=0,a=e;return e&&"number"!=typeof e&&(a=e.toString()),_.each(this.xAxisIndex,function(e,t){e[1]&&i.isIndexEqual(e[1],a)&&(s=t)}),s},c.prototype.formatXaxis=function(t){var e="",i=this.api.getProperty("Xaxis");return void 0!==i.AxisFormat&&""!==i.AxisFormat&&(e=i.AxisFormat),"Date"===i.AxisType?"object"==typeof(i=(i=$.grep(this.xAxisIndex,function(e){return e[0]===t})[0])&&i[1])?""===e?i.toString():f.convertKDBTemporalToMoment(i).formatNano(e,{trim:!1}):i:"string"==typeof this.xAxisIndex[t]?this.xAxisIndex[t]:void 0===this.xAxisIndex[t]?"":this.xAxisIndex[t][1]},c.prototype.formatXtickValues=function(){var e=this.api.getProperty("Xaxis"),i=e.AxisFormat,s=[],t=e.FitTick?e.MinTickWidth:10,a=1,r=(_.isArray(this.data)&&this.data.length?this.data[0].values:this.xAxisIndex).length,t=e.ShowAll?r:t;for(2<Math.abs(this.xAxisIndex.length-r)&&(this.data=this.getLineData());0!==t&&t<r/a;)a+=1;return _.each(this.xAxisIndex,function(e,t){t%a==0&&s.push(e[0])}),"Date"===e.AxisType&&e.DisplayNewDate&&_.each(this.xAxisIndex,function(e,t){"object"==typeof e&&(""===i?e[1].toString():n.time.format(i)(e[1].toDate()))}),s.length},c.prototype.getLabels=function(e,t,i){return $.inArray(e.get(i),t)<0&&void 0!==e.get(i)&&t.push(e.get(i)),0===t.length&&(this.api.getProperty("possibleLabels")&&(i=this.api.getProperty("possibleLabels")[0]),$.inArray(e.get(i),t)<0&&t.push(e.get(i))),[t,i]},c.prototype.getLineData=function(){var e,a=this,r=[],s=this.api.getProperty("Xaxis"),t=this.api.getProperty("possibleLabels"),i=this.breakdown[0],o=i,n=[],l=[];return void 0!==t&&void 0!==t.Label?o=t.Label:s.Label&&(o=s.Label),s.IsFixed?this.model.each(function(t){var i=[],s=0;_.each(a.xAxisIndex,function(e){"string"==typeof e&&(i.push([s,parseFloat(t.get(e))]),s+=1)}),e=t.get(o),r.push({key:e,values:i})}):0<this.model.models.length&&(e=(n=this.getLabels(this.model.models[0],n,i))[n.length-1],r=[],this.xAxisIndex=[],this.cache={},_.each(this.model.models,function(e,t){a.xAxisIndex.push([t,e.get(s.Label)]),a.cache[e.get(s.Label)]=t}),0<this.model.models.length&&(t=_.map(this.options.appView.columnInfo.models,"id"),_.each(this.getRexColumns(this.settingsData,t),function(i){var t;l=_.map(a.model.models,function(e,t){return[0<=s.Scale.indexOf("by Number")?e.get(s.Label):t,parseFloat(e.get(i.Column))]}),void 0!==e&&void 0!==i.Column&&(t=e+" "+i.Display,0===$.grep(r,function(e){return e.key===t}).length&&r.push({key:t,values:l.sort(function(e,t){return e[1]-t[1]})}))}))),r},c.prototype.getRexColumns=function(e,t){var i=this,s=[],e=_.extend([],e),e=_.filter(e,function(e,t){return _.indexOf(s,t)<0});return this.extendedCol=e,this.exKeys=[],_.each(this.extendedCol,function(e){i.exKeys.push(e.Column)}),this.exKeys=_.union(t,this.exKeys),e},c.prototype.getSelectedVal=function(e){var t,i=e;return _.isObject(e)?void 0!==e.class&&(t=e.class,_.includes(["1212","1213","1214","1215","1216","1217","1218","1219"],t)&&(i=f.convertKDBTemporalToMoment(e).toDashString())):e&&"number"!=typeof e&&(i=e.toString()),i},c.prototype.initSlider=function(e){var a=this,t=_.map(this.xAxisIndex,"0"),i=this.api.getProperty("Basics"),s=""!==i.SelectedMin||""!==i.SelectedMax;0!==e.length&&(this.$el.find("svg").addClass("sliderAxis"),this.$slider.slider({max:_.max(t),min:_.min(t),range:s,step:1,slide:function(e,t){s&&t.values?null===a.xAxisIndex[t.values[0]]&&void 0===a.xAxisIndex[t.values[0]]||null===a.xAxisIndex[t.values[1]]&&void 0===a.xAxisIndex[t.values[1]]||(a.api.setProperty("Basics.SelectedMin",a.getSelectedVal(a.xAxisIndex[t.values[0]][1])),a.api.setProperty("Basics.SelectedMax",a.getSelectedVal(a.xAxisIndex[t.values[1]][1]))):t.value&&null!==a.xAxisIndex[t.value]&&null!==a.xAxisIndex[t.value][1]&&a.api.setProperty("Basics.Selected",a.getSelectedVal(a.xAxisIndex[t.value][1]))}}),i=this.api.getProperty("Segments"),_.each(i,_.bind(function(e,t){var i=a.api.getProperty("Segments."+t+".Percentage"),s=a.api.getProperty("Segments."+t+".Color"),t=a.api.getProperty("Segments."+t+".Name");a.$slider.append('<div  class="'+t+'" style="position:absolute;top:0;height:100%; width:'+i+"%; background:"+s+'"</div>')},this)),this.setSelected(),this.$slider.css("margin-left",70),this.$slider.css("margin-top",10),this.$slider.css("margin-right",70),$(this.$graph.find("> svg")[0]).css("margin-left",70),$(this.$graph.find("> svg")[0]).css("margin-right",70),this.drawAxis(t))},c.prototype.isIndexEqual=function(e,t){var i,s=e;return _.isObject(e)&&void 0!==e.class&&(i=e.class,_.includes(["1212","1213","1214","1215","1216","1217","1218","1219"],i)&&(s=f.convertKDBTemporalToMoment(e).toDashString())),!(!t||!s)&&_.isEqual(s.toString().replace(/[^\w\s]/gi,""),t.toString().replace(/[^\w\s]/gi,""))},c);function c(e){var t=d.call(this,e)||this,i=[];return t.api=e.api,t.cache={},t.exKeys=[],t.options=e,t.settingsData=t.api.getProperty("Data"),t.xAxisIndex=[],t.$el.html(u.slider()),t.$el.addClass("graphingArea"),t.$graph=t.$el.find("> .graph"),t.$slider=t.$el.find(".slider"),_.each(t.settingsData,function(e){i.push(e.Column)}),t.xAxisIndex=i,t.sliderData=t.options.data,e=t.sliderData.get("breakdown"),t.breakdown=e?e.split(","):"",t}m.app=a.template({compiler:[8,">= 4.3.0"],main:function(e,t,i,s,a){return'<div class="RangeSlider">\n    \n    <div class="title">\n    </div>\n\n    <div class="frame">\n    </div>\n\n</div>'},useData:!0}),m.slider=a.template({compiler:[8,">= 4.3.0"],main:function(e,t,i,s,a){return'<div class="crumbs">\n</div>\n<div class="graph">\n\n    <div class="slider"></div>\n    \n    <svg ></svg>\n</div>'},useData:!0});var u=m;function m(){}g.getComponentDefinition=function(e){return{id:39,componentName:"Range Slider",componentDescription:"This element displays Range slider Charts.",appKey:"RangeSlider",listViewThumb:e.websiteUrl+"Images/range.png",ghostViewThumb:null,buildViewThumb:null,appArgs:{quickStart:[{path:"Basics.Data"}],json:{version:"4.2.1",Basics:{Data:"",Theme:"Dark",Range:"",Selected:"",SelectedMin:"",SelectedMax:""},Segments:[],Xaxis:{IsFixed:!1,Label:"",Rotation:0,AxisType:"",AxisFormat:"",Scale:"none",FitTick:!1,ShowAll:!1,MinTickWidth:10},Style:{advanced:""},possibleColumns:[""],possibleLabels:[""]},schema:{type:"object",title:"Properties",properties:{possibleColumns:{type:"array",format:"table",items:{type:"string"},default:[],options:{collapsed:!0,hidden:!0}},possibleLabels:{type:"array",format:"table",items:{type:"string"},default:["sym"],options:{collapsed:!0,hidden:!0}},Basics:{type:"object",title:"Basics",options:{collapsed:!1},properties:{Data:{type:"data",format:"string",title:"Data Source",default:""},Theme:{type:"string",title:"Theme",options:{hidden:!0},enum:["Light","Dark"]},DashboardTheme:{options:{hidden:!0}},Range:{type:"viewstate",title:"Range",default:""},Selected:{type:"viewstate",title:"Selected Value",default:""},SelectedMin:{type:"viewstate",title:"Selected Min Value",default:""},SelectedMax:{type:"viewstate",title:"Selected Max Value",default:""}}},Xaxis:{type:"object",title:"X-Axis",options:{collapsed:!0},properties:{Label:{type:"string",title:"Axis Value",propertyOrder:1,enumSource:"possible_labels",default:"",watch:{possible_labels:"root.possibleLabels"}},AxisType:{type:"string",title:"Axis Type",propertyOrder:2,enum:["String","Date","Number"]},AxisFormat:{type:"string",title:"Axis Format",propertyOrder:3,enum:[""].concat(f.Formats.DateTime)},Scale:{type:"string",propertyOrder:4,title:"Axis Scale",enum:["none","by Number"]},IsFixed:{type:"boolean",title:"Fixed Columns",format:"checkbox",propertyOrder:5,options:{hidden:!0}},FitTick:{type:"boolean",title:"Use Fixed Num of Ticks",propertyOrder:6,format:"checkbox"},ShowAll:{type:"boolean",title:"Show all Ticks",propertyOrder:7,format:"checkbox"},MinTickWidth:{title:"Num of Ticks",propertyOrder:8,default:10,minimum:0,maximum:600,type:"number"},Rotation:{title:"Rotation",propertyOrder:9,default:0,minimum:0,maximum:359,type:"number",step:1,format:"range"}}},Segments:{type:"array",format:"object",title:"Segments",uniqueItems:!1,options:{collapsed:!0,reset:!0},items:{type:"object",title:"Segments",properties:{Name:{default:"",type:"string"},Percentage:{type:"number",default:"",title:"Percentage"},Color:{type:"gradient",options:{gradient:!1},title:"Color",default:"#4f6aa6"}}}},Style:{type:"object",title:"Style",options:{collapsed:!0},properties:{advanced:{type:"css",title:"Advanced CSS",default:""}}}}}}}};a=g;function g(){}var x,f=r.Tools;function y(e){var t=x.call(this,e)||this;return t.options=e,t.api=e.api,t.settingsModel=e.settingsModel,t.themeClass="",t.primaryKey="_rowIndex",t.collection=new o.Collection([],{model:o.Model.extend({idAttribute:t.primaryKey})}),t.columnInfo=new o.Collection([],{model:o.Model.extend({idAttribute:"id"})}),t.collection.id=t.primaryKey,t.columnInfo.id="id",t.columnInfo.comparator="index",t.hideErrorMessage=e.api.hideErrorMessage,t.showErrorMessage=e.api.showErrorMessage,t.$el.html(u.app()),t.$root=t.$el.find(">.RangeSlider"),t.$frame=t.$el.find(".frame"),t.setTheme(),t}return x=o.View,p(y,x),y.prototype.onResize=function(){this.el.height=this.$el.height(),this.el.width=this.$el.width(),this.initSlider()},y.prototype.onSettingsChange=function(s){var a=this,e=[y.PROP_LABEL,y.PROP_FIXED,y.PROP_TYPE,y.PROP_FORMAT,y.PROP_SCALE,y.PROP_FITTICK,y.PROP_SHOWALL,y.PROP_MINTICK,y.PROP_ROTATE],t=[y.PROP_SEG_NAME,y.PROP_SEG_PERCENT,y.PROP_SEG_COLOR],i=this.api.getProperty(y.PROP_SEGMENTS),r=[y.PROP_RANGE,y.PROP_SELECTED,y.PROP_MIN,y.PROP_MAX];this.callIfDef(s,y.PROP_DATA,this.onDataSourceChange),this.callIfDef(s,"Segments",this.initSlider),_.each(i,function(e,i){_.each(t,function(e,t){a.callIfDef(s,y.PROP_SEGMENTS+"."+i+"."+e,a.initSlider)})}),_.each(r,function(e){a.callIfDef(s,e,a.refresh)}),_.each(e,function(e){a.callIfDef(s,e,a.initSlider)})},y.prototype.remove=function(){this.sliderData&&(this.api.unsubscribe(this.sliderData),this.sliderData=null),this.slider&&(this.slider.remove(),delete this.slider),this.undelegateEvents(),this.$el.removeData().unbind()},y.prototype.applyDataProperties=function(e,i){var s,a=this,r=0,o=(this.sliderData.set("columns",i.join(",")),[]),n=[],l=_.extend({},this.api.getProperty("Basics")),d=_.extend({},this.api.getProperty("Xaxis"));return _.defer(function(){s=[{}],_.each(a.columnInfo.models,function(e){for(var t=e;t.attributes;)t=t.attributes;var e=t.id,i=(12<=t.kdbType?o.unshift(e):o.push(e),s[r%s.length].type);n.push({Color:i=void 0===i?"#0095ff":i,Column:e,Display:e}),r+=1}),d.IsFixed=!1,d.Label=o[0];for(var e=a.api.getProperty("Xaxis.Label"),t=0;t<o.length;t++)o[t]===e&&(d.Label=e);a.settingsModel.set({Basics:l,Data:n,possibleColumns:i,possibleLabels:o,Xaxis:d})}),!1},y.prototype.callIfDef=function(e,t,i){void 0!==e[t]&&i.call(this,e[t],t)},y.prototype.initSlider=function(){this.sliderData&&this.setSlider()},y.prototype.onData=function(t,e){var i,s=0,a=!1,r=t.columns;t.primaryKey!==this.primaryKey&&(this.primaryKey=t.primaryKey,this.collection.reset(),this.collection=new o.Collection([],{model:o.Model.extend({idAttribute:this.primaryKey})}),a=!0),s=e.remove?s+e.remove.length:s,s=e.remove&&e.change?s+e.change.length:s,s=e.remove&&e.add?s+e.add.length:s,r.reset?this.columnInfo.reset(t.columns.reset):(this.columnInfo.remove(_.map(r.remove,function(e){return e[t.primaryKey]})),this.columnInfo.remove(r.remove),this.columnInfo.add(r.add),this.columnInfo.add(r.change,{merge:!0})),a=a||_.some(["add","remove","reset","change"],function(e){return void 0!==r[e]}),this.columnInfo.sort(),s=_.map(this.columnInfo.models,function(e){return e.id}),i=this.sliderData.get("_breakdownCols"),s=s.slice(1),i instanceof o.Model&&(i=i.get("value")),a&&this.applyDataProperties(i,s)&&this.initSlider(),e.reset?this.collection.reset(e.reset):(this.collection.remove(_.map(e.remove,function(e){return e[t.primaryKey]})),this.collection.add(e.add),this.collection.add(e.change,{merge:!0}),this.initSlider())},y.prototype.onDataSourceChange=function(e){var i=this;if(this.sliderData&&this.api.unsubscribe(this.sliderData),!e)return this.remove(),void this.showErrorMessage({error:t("To populate this component, please define a")+" <b> "+t("Data Source")+"</b> "+t("from")+"<b> "+t("Properties")+"-"+t("Basics")+"</b>",type:"Warning"},this.sliderData);this.sliderData=e,this.sliderData&&this.sliderData.attributes?(this.api.subscribe(this.sliderData,$.proxy(this.onData,this)),this.updateErrorMessage(),_.delay(function(){i.initSlider()},1500)):this.showErrorMessage({error:t("Invalid Data Source")+': "'+e.path+'" '+t("selected"),type:"Warning"},this.sliderData)},y.prototype.refresh=function(){this.slider&&this.slider.setSelected()},y.prototype.setSlider=function(){this.slider&&(this.stopListening(this.slider),this.stopListening(this.slider.model,"reset"),this.slider.remove(),delete this.slider);try{this.slider=new h({api:this.api,appView:this,data:this.sliderData,model:this.collection})}catch(e){r.Log.Log(e)}this.$frame.append(this.slider.el),this.slider.initRangeSlider()},y.prototype.updateErrorMessage=function(){this.sliderData.get("error")?this.showErrorMessage(this.sliderData.get("error")):this.hideErrorMessage()},y.prototype.setTheme=function(){var e=this.api.getProperty("Basics").Theme.toLowerCase();this.options.dashboardViewModel.get("DashboardTheme")&&(e=this.options.dashboardViewModel.get("DashboardTheme").toLowerCase()),this.themeClass!==e&&(this.$root.removeClass(this.themeClass),this.themeClass=e,this.$root.addClass(this.themeClass))},y.getComponentDefinition=a.getComponentDefinition,y.PROP_DATA="Basics.Data",y.PROP_RANGE="Basics.Range",y.PROP_SELECTED="Basics.Selected",y.PROP_MIN="Basics.SelectedMin",y.PROP_MAX="Basics.SelectedMax",y.PROP_LABEL="Xaxis.Label",y.PROP_FIXED="Xaxis.isFixed",y.PROP_TYPE="Xaxis.AxisType",y.PROP_FORMAT="Xaxis.AxisFormat",y.PROP_SCALE="Xaxis.Scale",y.PROP_FITTICK="Xaxis.FitTick",y.PROP_SHOWALL="Xaxis.ShowAll",y.PROP_MINTICK="Xaxis.MinTickWidth",y.PROP_ROTATE="Xaxis.Rotation",y.PROP_SEGMENTS="Segments",y.PROP_SEG_NAME="Name",y.PROP_SEG_PERCENT="Percentage",y.PROP_SEG_COLOR="Color",y});