define(["backbone","Handlebars","QuickBase","css!./css/app.css"],function(t,e,i){var r,s={getComponentDefinition:function(t){var e,i;if(0<_.keys(t.settingsModel.attributes).length)for(i=s.upgrades.indexOf(_.find(s.upgrades,{version:t.settingsModel.get("version")}))+1;i<s.upgrades.length;i+=1)(e=s.upgrades[i]).fn(t.settingsModel,t),t.settingsModel.set("version",e.version);return{id:1,componentName:"ivyvi",componentDescription:"",appArgs:{json:{version:"4.2.1",Basics:{Data:"",Selected:""},Style:{advanced:""}},schema:{type:"object",title:"Properties",properties:{Basics:{type:"object",title:"Basics",options:{collapsed:!1},propertyOrder:200,properties:{Data:{type:"data",title:"Data Source",default:""},Selected:{type:"viewstate",title:"Selected Value",default:""}}},Style:{type:"object",title:"Style",options:{collapsed:!0},propertyOrder:210,properties:{advanced:{type:"css",title:"Advanced CSS",default:""}}}}}}}},upgrades:[{version:0,fn:function(){}},{version:"4.0.0d2",fn:function(t,e){t.set("Style.advanced","")}},{version:"4.2.1",fn:function(t){var e=t.get("Basics");e.Selected="",t.set("Basics",e)}}]},n=(r={},o.html=function(s,n){var o="";return Object.keys(n).forEach(function(t){var e=n[t],i=("date"===(i=e,{}.toString.call(i).match(/\s([a-z|A-Z]+)/)[1].toLowerCase())&&(e=e.toUTCString()),t);-1===s.indexOf(i)&&(i=(t="__"===(t=i).slice(-2)?t.slice(0,t.length-2):t).replace("_"," ")),o+="<b>"+i+" </b>: "+e+"<br>"}),o},o.div=function(t,e,i,s,n){var o,a;s&&(s=s.map(function(t){return r.Rollover.html(e,t)}).join('<hr style="opacity:0.3">'),a=n[0],n=n[1],(o=document.createElement("div")).innerHTML=s,$(o).on("click",function(t){t.preventDefault(),t.stopPropagation()}).addClass("ggtooltip"),t.appendChild(o),i.appendChild(t),s=$(i).width(),(t=a)+$(o).width()+20>s&&(t-=$(o).width()+10),a=$(i).height(),(s=n)+$(o).height()>a&&(s=Math.max(0,s-$(o).height()-10)),$(o).css({left:t,top:s}))},a.prototype.push=function(t){this._history.push(t)},a.prototype.pop=function(){return this._history.pop()},a.prototype.clear=function(){this._history=[]},a.prototype.length=function(){return this._history.length},a.prototype.peek=function(){return 0<this._history.length?this._history[this._history.length-1]:null},a.prototype.toString=function(){return'"G"$"'+this.peek()+'"'},r.Cache=a,r.Rollover=o,r);function o(){}function a(){this.clear()}c.app=e.template({compiler:[8,">= 4.3.0"],main:function(t,e,i,s,n){return'<div class="main">\n    <div class="Dark">\n        <div class="ivyvi"></div>\n    </div>\n</div>'},useData:!0});var h=c;function c(){}return t.View.extend({$div:null,_class:{main:"gg-image",drillupbtn:"gg-drillup-btn"},_cache:null,_drillBounds:null,initialize:function(t){this.$el.html(h.app()),this.DeltaClientLib=t.DeltaClientLib,this.api=t.api,this.dataSource=null,this.$div=this.$el.find(".ivyvi:first"),this._cache=new n.Cache,window.addEventListener("beforeunload",this._clearAllCache.bind(this))},remove:function(){this._clearAllCache(),this.dataSource&&this.dataSource.off("change:queryStatus"),t.View.prototype.remove.apply(this,arguments)},events:{"resize .gg-overlay-canvas":"onResize",mouseout:"onMouseout"},onMouseout:function(t){t=t.toElement||t.relatedTarget;this._$tooltipDiv&&!this.$el[0].contains(t)&&this._$tooltipDiv.remove()},onResize:function(t){clearTimeout(this._resizeID),this.api.showQueryStatus({type:"Loading"}),this._resizeID=setTimeout(this._resizeGraph.bind(this),800)},onDataSourceChange:function(t,e,i){if(this.api.hideErrorMessage.call(this),i)return this.api.showErrorMessage.call(this,i),!1;this._clearAllCache(),e.reset&&0<e.reset.length?this._cache.push(e.reset[0].id):e.change&&0<e.change.length&&this._cache.push(e.change[0].id),this._resizeGraph()},onSettingsChange:function(t){t.hasOwnProperty("Basics.Data")?(t=t["Basics.Data"])&&0<Object.keys(t).length?(this.dataSource&&(this.api.unsubscribe(this.dataSource),this.dataSource.off("change:queryStatus")),this.dataSource=t,this.api.subscribe(this.dataSource,this.onDataSourceChange.bind(this)),this.api.showQueryStatus({type:"Loading"}),this.dataSource.on("change:queryStatus",function(t,e){e&&this.api.showQueryStatus(e)}.bind(this))):this.api.showQueryStatus({message:"To populate this component, define a Data Source with an Analyst Grammar of Graphics query",type:"Warning"}):this.$div[0].clientWidth===this.$el[0].clientWidth&&this.$div[0].clientHeight===this.$el[0].clientHeight||this._resizeGraph()},rollover:function(t){null!==this._cache.peek()&&this._query(".gg.web.rollover["+t.offsetX+" "+t.offsetY+";"+this._cache+" ]",function(t){var s,e=_.zipObject(_.map(t.rows,"Property"),_.map(t.rows,"Value"));e.error||(this._$tooltipDiv&&this._$tooltipDiv.remove(),null!==(t=this._traverse(e,["data","rows",1,"Value","rows",0]))&&null!==(e=this._traverse(t,["data","rows"]))&&0!==e.length&&(e[0].hasOwnProperty("Property")?e.forEach(function(t){var e=t.Property,i=t.Value;switch(e){case"tooltip":s=i.rows;break;case"viewstate":""!==this.api.getProperty("Basics.Selected")&&this.api.setProperty("Basics.Selected",i)}}.bind(this)):s=e,s&&t.pt&&(this._$tooltipDiv=$("<div>"),n.Rollover.div(this._$tooltipDiv[0],[],this.$div[0],s,t.pt))))},function(t){})},drilldown:function(t){var e;null!==this._cache.peek()&&(e=this._drillBounds,this._query(".gg.dash.zoom["+e[0].join(" ")+";"+e[1].join(" ")+";"+this._cache+"]",function(t){this._cache.push(t.rows[0].id),this._resizeGraph()},function(t){}))},drillup:function(){this._clearCurrCache(),this._resizeGraph()},_resizeGraph:function(t){var e;null!==this._cache.peek()&&(e=this.$div.parent(),this._query(".gg.dash.resize["+e.width()+";"+e.height()+";"+this._cache+"]",function(t){this.api.hideQueryStatus(),this._drawImage({reset:t.rows})},function(){this.api.hideQueryStatus()}))},_drawImage:function(t){var e;this.$div.empty(),t=t.reset[0],(e=new Image).src="data:image/png;base64,"+t.bytes,$("<div>").append($(e).attr("class",this._classname)).append(e=$("<canvas>").attr("width",t.w).attr("height",t.h).attr("class","gg-overlay-canvas")).css({display:"block",margin:"0 auto",width:t.w,height:t.h}).appendTo(this.$div);this._addRectListener(e[0]),t.hasParent&&this._addDrillUpBtn()},_base64:function(t){return base64js.fromByteArray(t)},_clearCurrCache:function(){this._cache.peek()&&(this._query(".gg.web.clear["+this._cache+"]",function(){},function(){}),this._cache.pop())},_clearAllCache:function(){for(;0<this._cache.length();)this._clearCurrCache();this._cache.clear()},_addDrillUpBtn:function(){this.$div.append($("<div>").attr("class",this._class.drillupbtn).text("â‡ª").on("click",this.drillup.bind(this)))},_addRectListener:function(r){var h=$(r),c=r.getContext("2d"),l=!1;h.on("mouseup",this.rollover.bind(this)),h.on("mousedown",function(t){if(t.preventDefault(),t.stopPropagation(),!t.ctrlKey&&!t.altKey&&!t.metaKey)return!1;h.off("mouseup"),h.off("mousemove"),l=!0;var e,i,s,n,o=t.offsetY,a=t.offsetX;this._drillBounds=[[a,o],null],$(document).on("keydown",function(t){27===t.keyCode&&(c.clearRect(0,0,r.width,r.height),h.off("mousemove"),h.off("mouseup"),$(document).off("keydown"),h.on("mouseup",function(t){t.preventDefault(),t.stopPropagation(),this.rollover()}.bind(this)),l=!1)}.bind(this)),h.on("mousemove",function(t){if(!l)return!1;s=t.offsetX,n=t.offsetY,this._drillBounds[1]=[s,n],e=Math.abs(s-a),i=Math.abs(n-o),s=s<a?a-e:a,n=n<o?o-i:o,c.clearRect(0,0,r.width,r.height),c.fillStyle="#336699",c.strokeStyle="#efefef",c.lineWidth=1,c.fillRect(s,n,e,i),c.strokeRect(s,n,e,i)}.bind(this)).on("mouseup",function(t){t.preventDefault(),t.stopPropagation(),c.clearRect(0,0,r.width,r.height),$(document).off("keydown"),h.off("mousemove"),h.off("mouseup"),h.on("mouseup",this.rollover.bind(this)),l&&this._drillBounds[0]&&this._drillBounds[1]&&this.drilldown(t),l=!1}.bind(this))}.bind(this))},_traverse:function(t,e){return e.reduce(function(t,e,i){return t&&t.hasOwnProperty(e)?t[e]:null},t)},_query:function(t,e,i,s){s=s||10,this.dataSource.attributes&&this.dataSource.attributes._connection&&this.DeltaClientLib.getQueryData("q",this.dataSource.get("_connection"),t,[],e.bind(this),i.bind(this),s)}},{getComponentDefinition:s.getComponentDefinition})});