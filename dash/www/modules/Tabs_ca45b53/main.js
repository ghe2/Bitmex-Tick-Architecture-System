define(["backbone","Handlebars","QuickBase","css!./css/main.css"],function(e,t,l){"use strict";var n,i=this&&this.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)},function(e,t){function i(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}),c=(o.getGUID=function(){function e(){return Math.floor(65536*Math.random()).toString(16)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},o);function o(){}d.getComponentDefinition=function(e){var t={id:26,componentName:"tabs",componentDescription:"Tab control.",appKey:"Tabs",disable_array_reorder:!0,listViewThumb:e.websiteUrl+"Images/tabs.png",ghostViewThumb:null,buildViewThumb:null,appArgs:{json:{version:"4.2.0s3",dropdownPossibleValues:[],Selection:{target_tab:"",unloadInactive:"",expandOnPdf:"",SetViewStateOnSelect:{ViewState:"",Value:""}},Basics:{ComponentName:"tabs"},Items:[{Id:c.getGUID(),Name:"Tab 1",Tooltip:"",HideTab:!1},{Id:c.getGUID(),Name:"Tab 2",Tooltip:"",HideTab:!1}],Style:{advanced:""}},schema:{type:"object",title:"Properties",properties:{dropdownPossibleValues:{type:"array",format:"table",items:{type:"object",properties:{Id:{type:"string"},Name:{type:"string"}}},options:{hidden:!0,disable_array_reorder:!0}},Selection:{type:"object",title:"View State",options:{collapsed:!1,disable_array_reorder:!0},properties:{target_tab:{type:"string",title:"Selected Tab",watch:{dashboards:"root.dropdownPossibleValues"},enumSource:{source:"dashboards",title:"Name",value:"Id"}},unloadInactive:{type:"boolean",title:"Unload Inactive Tabs",format:"checkbox",default:!1},expandOnPdf:{type:"boolean",title:"Expand When Creating Pdf",format:"checkbox",default:!1},SetViewStateOnSelect:{type:"object",title:"Set View State On Tab Change",options:{collapsed:!0},properties:{ViewState:{title:"View State",type:"viewstate"},Value:{type:"string",default:"<tabname>"}}}}},Basics:{type:"object",title:"Basics",options:{hidden:!0,disable_array_reorder:!0},properties:{ComponentName:{type:"string",title:"hide me",default:"tabs"}}},Items:{type:"array",format:"object",title:"Tabs",uniqueItems:!0,options:{collapsed:!1},items:{type:"object",title:"Tab",properties:{Id:{type:"string",default:"",options:{hidden:!0}},Name:{type:"string"},Tooltip:{type:"string",default:""},HideTab:{type:"boolean",title:"Hide",format:"checkbox",default:!1}}}},Style:{type:"object",title:"Style",options:{collapsed:!0},properties:{advanced:{type:"css",title:"Advanced CSS",default:""}}}}}}};if(0<_.keys(e.settingsModel.attributes).length)for(var i=void 0,n=d.upgrades.indexOf(_.find(d.upgrades,{version:e.settingsModel.get("version")}))+1;n<d.upgrades.length;n+=1)(i=d.upgrades[n]).fn(e.settingsModel),e.settingsModel.set("version",i.version);return t},d.upgrades=[{version:"4.0.0d14",fn:function(e){_.each(e.get("Items"),function(e){return e.HideTab=!1})}},{version:"4.1.0s1",fn:function(e){_.each(e.get("Items"),function(e){e.Tooltip=""})}},{version:"4.2.0s2",fn:function(e){_.isUndefined(e.get("Selection.unloadInactive"))&&e.set("Selection.unloadInactive",!1)}},{version:"4.2.0s3",fn:function(e){_.isUndefined(e.get("Selection.expandOnPdf"))&&e.set("Selection.expandOnPdf",!1)}}];var s=d;function d(){}h.app=t.template({compiler:[8,">= 4.3.0"],main:function(e,t,i,n,o){return'<div class="tabs-div">\n    <ul></ul>\n\n    <div class="interaction-div">\n        <div class="selection-div">\n            <div class="fa fa-times remove-btn"></div>\n        </div>\n    </div>\n</div>'},useData:!0});var a,r=h;function h(){}function p(e){var t=a.call(this,e)||this;return t.ignoreItemsChange=!1,t.ignoreWidgetSelect=!1,t.canPdfExtend=!1,t.hasInit=!1,t.options=e,t.api=e.api,t.viewModel=e.viewModel,t.dataModel=e.dataModel,t.dashboardAppModel=e.dashboardAppModel,t.dashboardViewModel=e.dashboardViewModel,t.settingsModel=e.settingsModel,t.websiteUrl=e.websiteUrl,t.componentModel=e.componentModel,t.DeltaClientLib=e.DeltaClientLib,t.quickView=e.quickView||!1,t.viewModel=new window.Backbone.DeepModel({dropdownPossibleValues:[]}),t.tabsItems=[],t.initializeEvents(),e=!(e=parseInt(t.api.getProperty("Selection.target_tab"),10))||e>=t.settingsModel.get("Items").length?0:e,t.api.setProperty("Selection.target_tab",e),t.setTheme(),t.onBuildModeChanged(),t.checkIfPdfCanExpand(),t}return a=Backbone.View,i(p,a),p.prototype.initializeEvents=function(){var i=this;this.listenTo(this.viewModel,"change:Items",function(e,t){return i.onItemsChanged(e,t)}),this.listenTo(this.viewModel,"change:Selection.target_tab",function(e,t){return i.onSelectionChanged(e,t)}),this.listenTo(this.componentModel.get("components"),"add",function(e,t){return i.onComponentAdded(e,t)}),this.listenTo(this.componentModel.get("components"),"remove",function(e){return i.onComponentRemoved(e)}),this.listenTo(this.dashboardViewModel,"change:buildMode",function(){return i.onBuildModeChanged()}),this.listenTo(this.dashboardViewModel,"change:DashboardTheme",function(e,t){i.setTheme(t)}),this.listenTo(this.dashboardViewModel,"change:selectedWidget",function(e,t){return i.onSelectedWidgetChanged(e,t)}),this.listenTo(this.dashboardViewModel,"change:selectedSubComponent",function(e,t){return i.onSubComponentChanged(e,t)}),this.listenTo(this.viewModel,"change:Selection.unloadInactive change:Selection.target_tab",function(){return i.onUnloadInactive()}),this.listenTo(this.viewModel,"change:Selection.expandOnPdf",function(){return i.onExpandOnPdfChanged()}),this.listenTo(this.dashboardAppModel,"change:pendingSelectionWidgetId",function(e,t){return i.onSelectingWidget(e,t)}),this.$el.on("dragenter",function(e){return i.onDragEnter(e)}),this.$el.on("dragover",function(e){return i.onDragOver(e)}),this.$el.on("dragleave",function(){return i.onDragLeave()}),this.$el.on("drop",function(){return i.onDragLeave()})},p.prototype.addApp=function(e,t){var o=this,i=t.attr("id"),n=this.getSelectedDocument(),s=new l.Widget({id:e.id},{},{}),n=(s.set("component",e),new l.ComponentView({model:e,dashboardAppModel:this.dashboardAppModel,dashboardViewModel:this.dashboardViewModel,docViewModel:n.get("viewState"),docDataModel:n.get("data"),deltaClient:this.DeltaClientLib,quickView:this.quickView,websiteUrl:this.websiteUrl,widgetId:s.id})),d={containerId:i,$div:t,widgetId:s.id,model:s,view:n},a=(t.empty(),$(document.createElement("div"))),r=(a.addClass("fa fa-times remove-btn"),a.attr("title",n.getComponentName()),a.appendTo(t),a.click(function(e){e.preventDefault(),e.stopPropagation(),s.trigger("removeWidget")}),_.find(this.tabsItems,{Id:i}));e.set("containerId",i),r.widgetItem=d,n.model&&t.attr("data-componentid",n.model.get("key")),t.attr("data-widgetid",s.id),n.$el.appendTo(t),t.off("click"),t.on("click",function(e){return o.onAppClick(d,e)}),this.listenTo(s,"removeWidget",_.bind(function(e,t,i,n){t.off(),i.remove(),o.componentModel.get("components").commandRemove(e),n.widgetItem=null,o.dashboardViewModel.set("selectedWidget",null),o.dashboardViewModel.set("selectedWidgetView",null,{silent:!0})},this,e,t,a,r))},p.prototype.addTab=function(e,t,i,n,o){var s=$(document.createElement("li")),d=$(document.createElement("div")),a=$(document.createElement("a")),n={Id:e,Name:t,Index:n,Tooltip:o=o||""};return this.tabsItems.push(n),a.attr("title",this.convertTooltipNewlines(o)),a.attr("href","#"+e),a.text(t),a.appendTo(s),d.attr("id",e),s.appendTo(this.$ul),d.appendTo(this.$root),n},p.prototype.checkIfPdfCanExpand=function(){var e=_.uniqueId("tabs"),t=(this.$el.attr("id",e),$("#appdiv > .content-panel > .document-view > .screen-view-div > .screen-view > .worksheet > .grid-stack > .grid-stack-item > .grid-stack-item-content > .component-build-view > .border-div > #"+e));this.canPdfExtend=0<t.length,this.canPdfExtend||(t=$("#appdiv > .document-view-div > .document-view > .screen-view-div > .screen-view > .worksheet > .grid-stack > .grid-stack-item > .grid-stack-item-content > .component-build-view > .border-div > #"+e),this.canPdfExtend=0<t.length)},p.prototype.convertTooltipNewlines=function(e){return(e||"").replace(/(?:\\r\\n|\\r|\\n)/g,"\r\n")},p.prototype.findAnchor=function(e){return this.$ul.find('a[href="#'+e+'"]')},p.prototype.findTabItem=function(t){return _.find(this.tabsItems,function(e){return e.widgetItem&&e.widgetItem.widgetId===t})},p.prototype.getSelectedDocument=function(){return this.dashboardAppModel.get("documents").get(this.dashboardViewModel.get("selectedDocumentId"))},p.prototype.isInteger=function(e){return"number"==typeof e&&isFinite(e)&&Math.floor(e)===e},p.prototype.loadTabsContent=function(e){var i=this;this.viewModel.get("Items").forEach(function(e,t){e.HideTab||i.onSelectionChanged(null,t)}),this.isInteger(e)&&this.onSelectionChanged(null,e)},p.prototype.onAppClick=function(e,t){this.ignoreWidgetSelect||(t&&t.stopPropagation&&t.stopPropagation(),this.dashboardViewModel.get("selectedWidget")===e.model?(this.dashboardViewModel.set("selectedWidget",null),this.dashboardViewModel.set("selectedWidgetView",null,{silent:!0})):(this.dashboardViewModel.set("selectedWidget",e.model),this.dashboardViewModel.set("selectedWidgetView",e.view,{silent:!0})))},p.prototype.onBuildModeChanged=function(){this.dashboardViewModel.get("buildMode")&&!this.quickView?this.ignoreWidgetSelect=!1:this.ignoreWidgetSelect=!0},p.prototype.onComponentAdded=function(e,t){this.currentTabItem.widgetItem&&this.currentTabItem.widgetItem.view&&t.remove(this.currentTabItem.widgetItem.view.model),this.addApp(e,this.$currentDiv)},p.prototype.onComponentRemoved=function(e){e=e.get("containerId"),e=_.find(this.tabsItems,{Id:e});e.widgetItem&&e.widgetItem.view&&e.widgetItem.view.remove&&e.widgetItem.view.remove()},p.prototype.onDragEnter=function(e){this.api.isBuildMode()&&this.onDragOver(e)},p.prototype.onDragLeave=function(){this.api.isBuildMode()&&this.$el.removeClass("drop-target")},p.prototype.onDragOver=function(e){if(this.api.isBuildMode()){if(l.ComponentDropView.prototype.isDraggingSupportedFile(e))return!1;if(_.includes(["Accordion","FlexPanel","Panel","Tabs"],_.get(this.currentTabItem,"widgetItem.model.attributes.component.attributes.key")))return!1;this.$el.addClass("drop-target")}return!0},p.prototype.onItemsChanged=function(e,t){var i=this;if(!this.rendered||this.ignoreItemsChange)return!1;var n,o=!1,s=!1,d=[],a=[],r=[],l=(_.each(t,function(e,t){_.isEmpty(e)||(e.Id.length<=0&&(e.Id=c.getGUID(),o=!0),(n=_.find(i.tabsItems,{Id:e.Id}))?(n.Name!==e.Name&&(i.updateTabName(n.Id,e.Name),o=!0),n.Tooltip!==e.Tooltip&&i.updateTabTooltip(n.Id,e.Tooltip),n.Index!==t&&(s=!0,n.Index=t),d.push(n)):(i.api.setProperty("Items."+t+".Name","Tab "+(t+1)),e.Name="Tab "+(t+1),d.push(i.addTab(e.Id,e.Name,e,t,e.Tooltip))),(e.HideTab?a:r).push(t))}),_.filter(this.tabsItems,function(e){return!_.includes(d,e)}));return 0<l.length&&(o=!0,_.each(l,function(e){i.onRemoveTab(e)})),o&&(this.ignoreItemsChange=!0,_.each(t,function(e,t){i.api.setProperty("Items."+t+".Id",e.Id)}),this.refreshDropdownItems(),this.ignoreItemsChange=!1),s&&this.updateTabsOrder(),this.toggleTabs(a,r),this.updateDivPosition(this.$currentDiv),!0},p.prototype.onSelectedWidgetChanged=function(e,t){this.selected&&this.selected.$div.removeClass("selected"),t?(t=this.findTabItem(t.id))&&t.widgetItem&&(this.selected=t.widgetItem,this.selected.$div.addClass("selected")):this.selected=null},p.prototype.onSelectingWidget=function(e,t){var i;e&&(_.each(this.tabsItems,function(e){e.widgetItem&&e.widgetItem.widgetId===t&&(i=e.widgetItem)}),i&&this.onAppClick(i,null),this.dashboardAppModel.set("pendingSelectionWidgetId",null,{silent:!0}))},p.prototype.onRemoveTab=function(e){var t=this.findAnchor(e.Id).parent(),i=this.$("#"+e.Id),n=e.widgetItem&&e.widgetItem.model?e.widgetItem.model.get("component"):this.componentModel.get("components").findWhere({containerId:e.Id}),n=(n&&this.componentModel.get("components").remove(n),this.tabsItems.indexOf(e));this.tabsItems.splice(n,1),t.remove(),i.remove()},p.prototype.onResize=function(e){var i,n;this.viewModel.get("Selection.expandOnPdf")&&(i=1080-this.$ul.height(),this.$root&&$("body").hasClass("pdf")&&(n=this.$root.find("> div:not(.interaction-div)")).each(function(e,t){0===e?$(t).height(15+i):e===n.length-1?$(t).height(1080):$(t).height(1100)}),this.tabsItems.forEach(function(e){e.widgetItem&&e.widgetItem.view&&e.widgetItem.view.onResize&&e.widgetItem.view.onResize(!0)})),this.currentTabItem&&this.currentTabItem.widgetItem&&this.currentTabItem.widgetItem.view&&this.currentTabItem.widgetItem.view.onResize&&this.currentTabItem.widgetItem.view.onResize(e),this.$currentDiv&&this.updateDivPosition(this.$currentDiv)},p.prototype.onResizeStart=function(){this.currentTabItem&&this.currentTabItem.widgetItem&&this.currentTabItem.widgetItem.view&&this.currentTabItem.widgetItem.view.onResizeStart&&this.currentTabItem.widgetItem.view.onResizeStart()},p.prototype.onResizeStop=function(){this.currentTabItem&&this.currentTabItem.widgetItem&&this.currentTabItem.widgetItem.view&&this.currentTabItem.widgetItem.view.onResizeStop&&this.currentTabItem.widgetItem.view.onResizeStop()},p.prototype.onSelectionChanged=function(e,t){if(!this.rendered)return!1;var i,n,o;switch(this.isInteger(parseInt(t,10))?i=parseInt(t,10):this.isInteger(parseInt(t.target_tab,10))&&(i=parseInt(t.target_tab,10)),this.isInteger(i)?n=this.viewModel.get("Items")[i]?this.viewModel.get("Items")[i].Id:null:(n=t.target_tab,t=this.findAnchor(n).parent(),i=this.$ul.find("li").index(t)),this.$root.tabs("option","active",i),this.$currentDiv=this.$("#"+n),this.currentTabItem=_.find(this.tabsItems,{Id:n}),this.currentTabItem&&this.currentTabItem.widgetItem&&this.currentTabItem.widgetItem.view||(e=this.componentModel.get("components").findWhere({containerId:n}))&&this.addApp(e,this.$currentDiv),this.onResizeStart(),this.onResize(!0),this.onResizeStop(),o=this.viewModel.get("Selection.SetViewStateOnSelect.Value")){case"<tabName>":o=this.currentTabItem.Name;break;case"<tabIndex>":o=i}return _.isUndefined(o)&&(o=""),this.api.setProperty("Selection.SetViewStateOnSelect.ViewState",o),!0},p.prototype.onSettingsChange=function(e){var i,n,o=this;_.each(e,function(e,t){o.viewModel.set(t,e)}),this.hasInit||(this.hasInit=!0,this.render(),this.refreshDropdownItems(),e=this.api.getProperty("Selection.target_tab"),e=_.isUndefined(e)?this.viewModel.get("Selection.target_tab"):e,this.viewModel.get("Selection.expandOnPdf")?this.loadTabsContent(e):this.onSelectionChanged(null,e),i=[],n=[],_.each(this.viewModel.get("Items"),function(e,t){_.isEmpty(e)||(e.HideTab?i:n).push(t)}),this.toggleTabs(i,n))},p.prototype.onSubComponentChanged=function(e,t){t?this.currentTabItem&&this.currentTabItem.widgetItem.view&&this.currentTabItem.widgetItem.view.model&&t===this.currentTabItem.widgetItem.view.model&&this.$selectionDiv.show():this.$selectionDiv.hide()},p.prototype.onUnloadInactive=function(){var t=this;this.viewModel.get("Selection.unloadInactive")&&this.currentTabItem&&(this.api.setProperty("Selection.expandOnPdf",!1),_.each(this.tabsItems,function(e){e&&t.currentTabItem.Id!==e.Id&&e.widgetItem&&(e.widgetItem.view.remove&&e.widgetItem.view.remove(),e.widgetItem=null)}))},p.prototype.onExpandOnPdfChanged=function(){var e=this;this.viewModel.get("Selection.expandOnPdf")?this.canPdfExtend?this.$gridStackItem&&(this.$gridStackItem.toggleClass("pdf-expandable",!0),$("body").hasClass("pdf")&&(this.$gridStackItem.css("margin-bottom",13+parseInt(this.$gridStackItem.css("top"),10)),this.loadTabsContent(this.api.getProperty("Selection.target_tab")||0))):_.defer(function(){e.api.showQueryStatus({message:"To enable 'Expand When Creating Pdf' Tab Control has to be embedded in dashboard's root element.",type:"Info"}),e.api.setProperty("Selection.expandOnPdf",!1)}):(this.$gridStackItem&&this.$gridStackItem.toggleClass("pdf-expandable",!1),this.$root&&this.$root.find("> div:not(.interaction-div)").height("auto"))},p.prototype.refreshDropdownItems=function(){var e=this,t=this.viewModel.get("dropdownPossibleValues").slice();t.length=0,_.each(this.tabsItems,function(e){t.push({Id:e.Index,Name:e.Name})}),_.defer(function(){e.api.setProperty("dropdownPossibleValues",t)})},p.prototype.remove=function(){var t=this;return _.each(this.tabsItems,function(e){e.widgetItem&&e.widgetItem.widgetId===t.options.dashboardViewModel.get("selectedWidgetId")&&t.options.dashboardViewModel.set("selectedWidget",null),e.widgetItem&&e.widgetItem.view&&e.widgetItem.view.remove()}),this.stopListening(),this.$el.remove(),this},p.prototype.render=function(){var i=this;return this.$el.addClass("basic-components-tabs"),this.$el.html(r.app()),this.$root=this.$(".tabs-div"),this.$ul=this.$("ul"),this.$selectionDiv=this.$(".selection-div"),this.$selectionDiv.hide(),_.each(this.viewModel.get("Items"),function(e,t){i.addTab(e.Id,e.Name,e,t,e.Tooltip)}),this.$root.tabs({activate:function(e,t){i.api.setProperty("Selection.target_tab",t.newTab.index())}}),this.maxHeight=this.$el.height(),this.rendered=!0,this.$gridStackItem=this.$el.closest(".grid-stack-item"),this.viewModel.get("Selection.expandOnPdf")&&this.$gridStackItem&&(this.onExpandOnPdfChanged(),this.$gridStackItem.toggleClass("rendered",!0)),this},p.prototype.setTheme=function(e){var t=e||"Dark";!e&&this.options.dashboardViewModel&&this.options.dashboardViewModel.get("DashboardTheme")&&(t=this.options.dashboardViewModel.get("DashboardTheme")),this.$el.removeClass("Dark").removeClass("Light").addClass(t),_.each(this.tabsItems,function(e){e.widgetItem&&e.widgetItem.view&&e.widgetItem.view.app&&_.isFunction(e.widgetItem.view.app.setTheme)&&e.widgetItem.view.app.setTheme(t)})},p.prototype.toggleTabs=function(e,t){this.$root.tabs("option","disabled",e),t.length?(e=this.$root.tabs("option","active"),e=-1!==t.indexOf(e)?e:t[0],this.$root.show(),this.$root.tabs("option","active",e)):this.$root.hide(),this.$root.tabs("refresh")},p.prototype.updateDivPosition=function(e){this.$el.find(".ui-tabs-nav").is(":visible")?e.css("top",this.$ul.height()):e.css("top",0)},p.prototype.updateTabName=function(e,t){var i=_.find(this.tabsItems,{Id:e});i&&(i.Name=t,this.findAnchor(e).text(t))},p.prototype.updateTabTooltip=function(e,t){var i=_.find(this.tabsItems,{Id:e});i&&(i.Tooltip=t,this.findAnchor(e).attr("title",this.convertTooltipNewlines(t)))},p.prototype.updateTabsOrder=function(){var t,i=this;_.each(_.sortBy(this.tabsItems,function(e){return e.Index}),function(e){e=i.findAnchor(e.Id).parent();e.detach(),t?t.after(e):e.prependTo(i.$ul),t=e})},p.getComponentDefinition=s.getComponentDefinition,p});