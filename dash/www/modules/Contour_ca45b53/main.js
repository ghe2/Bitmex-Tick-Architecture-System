define(["d3","Plotly","Handlebars","QuickBase","moment","xlsx","backbone","css!./css/app.css"],function(a,R,e,p,o,r,i){"use strict";var n,l=this&&this.__extends||(n=function(t,e){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])})(t,e)},function(t,e){function o(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(o.prototype=e.prototype,new o)}),s=(P.getComponentDefinition=function(t){var e,o;if(0<_.keys(t.settingsModel.attributes).length)for(o=P.upgrades.indexOf(_.find(P.upgrades,{version:t.settingsModel.get("version")}))+1;o<P.upgrades.length;o+=1)(e=P.upgrades[o]).fn(t.settingsModel),t.settingsModel.set("version",e.version);return{appArgs:{componentDescription:"",componentName:"Contour",id:1,quickStart:[{path:"Basics.Data"}],json:{Basics:{Data:"",ShowScale:!0,Theme:"Dark",Type:"contour"},ColorPalette:{ColorScheme:[{type:"#F8696B"},{type:"#F98570"},{type:"#FBA276"},{type:"#FCBF7B"},{type:"#FEDC81"},{type:"#EEE683"},{type:"#CCDD82"},{type:"#A9D27F"},{type:"#86C97E"},{type:"#63BE7B"}],ContourVal:!1,TickInterval:1},Image:{Source:""},Layout:{Background:"",Bottom:20,Left:80,Pad:0,Right:20,Top:20},Style:{Smoothing:75},Tooltip:{ShowTooltip:!0,TooltipTemplate:'<p><i style="color:{{color}}" class="fa fa-circle"></i> Contour Data</p><table>    <tr><td>{{xaxis.title.text}}</td><td>{{x}}</td></tr>    <tr><td>{{yaxis.title.text}}</td><td>{{y}}</td></tr>    <tr><td>{{data.colorbar.title.text}}</td><td>{{toFixed z 2}}</td></tr></table>'},X:{Column:"",Max:100,Min:0,Title:{Label:"",LabelSize:12},Type:"linear",UseRange:!1},Y:{Column:"",Max:100,Min:0,Title:{Label:"",LabelSize:12},Type:"linear",UseRange:!1},Z:{Column:"",Max:100,Min:0,Title:{Label:"",LabelSize:12},Type:"linear",UseRange:!1},possibleColumns:[""],possibleLabels:[""],version:"4.5.0"},schema:{properties:{Basics:{options:{collapsed:!1},properties:{DashboardTheme:{options:{hidden:!0}},Data:{default:"",format:"string",propertyOrder:1,title:"Data Source",type:"data"},FixedColumn:{propertyOrder:4,title:"Column Def",type:"string"},ShowScale:{default:!0,format:"checkbox",propertyOrder:3,title:"Show Scale Bar",type:"boolean"},Theme:{enum:["Light","Dark"],options:{hidden:!0},propertyOrder:2,title:"Theme",type:"string"},Type:{default:"contour",enum:["contour","heatmap"],propertyOrder:5,type:"string"}},propertyOrder:3,title:"Basics",type:"object"},ColorPalette:{options:{collapsed:!0},properties:{ColorScheme:{format:"table",items:{properties:{type:{default:"#5B9BD5",options:{gradient:!1},title:"Color",type:"gradient"}},title:"Color",type:"object"},options:{collapsed:!1},propertyOrder:5,title:"Color Palette",type:"array",uniqueItems:!1},ContourVal:{default:!1,format:"checkbox",title:"Show Annotation",type:"boolean"},TickInterval:{default:1,title:"Tick Interval",type:"number"}},propertyOrder:8,title:"Contour",type:"object"},Image:{options:{collapsed:!0},properties:{Source:{default:"",title:"Source",type:"string"}},propertyOrder:11,title:"Image",type:"object"},Layout:{options:{collapsed:!0},properties:{Background:{default:"",options:{noColor:!0},propertyOrder:1,type:"gradient"},Bottom:{default:80,propertyOrder:3,type:"number"},Left:{default:50,propertyOrder:4,type:"number"},Pad:{default:0,propertyOrder:6,type:"number"},Right:{default:80,propertyOrder:5,type:"number"},Top:{default:20,propertyOrder:2,type:"number"}},propertyOrder:7,title:"Layout",type:"object"},Style:{options:{collapsed:!0},properties:{Smoothing:{default:75,max:100,min:0,propertyOrder:15,title:"Line Smoothing",type:"number"},advanced:{default:"",propertyOrder:14,title:"Advanced CSS",type:"css"}},propertyOrder:11,title:"Style",type:"object"},Tooltip:{options:{collapsed:!0},properties:{ShowTooltip:{format:"checkbox",title:"Show Tooltip",type:"boolean"},TooltipTemplate:{title:"Custom Template",type:"tooltipTemplate"}},propertyOrder:9,title:"Tooltip",type:"object"},X:{options:{collapsed:!0},properties:{Column:{enumSource:"possible_columns",propertyOrder:1,type:"string",watch:{possible_columns:"root.possibleColumns"}},Max:{default:10,propertyOrder:5,type:"number"},Min:{default:0,propertyOrder:4,type:"number"},Title:{options:{collapsed:!0},properties:{Label:{default:"",propertyOrder:1,type:"string"},LabelSize:{default:"12",propertyOrder:2,type:"number"}},propertyOrder:6,title:"Title",type:"object"},Type:{default:"linear",enum:["linear","category","date"],propertyOrder:2,type:"string"},UseRange:{default:!1,format:"checkbox",propertyOrder:3,title:"Use Range",type:"boolean"}},propertyOrder:4,title:"X Axis",type:"object"},Y:{options:{collapsed:!0},properties:{Column:{enumSource:"possible_columns",propertyOrder:1,type:"string",watch:{possible_columns:"root.possibleColumns"}},Max:{default:10,propertyOrder:5,type:"number"},Min:{default:0,propertyOrder:4,type:"number"},Title:{options:{collapsed:!0},properties:{Label:{default:"",propertyOrder:1,type:"string"},LabelSize:{default:"12",propertyOrder:2,type:"number"}},propertyOrder:6,title:"Title",type:"object"},Type:{default:"linear",enum:["linear","category","date"],propertyOrder:2,type:"srting"},UseRange:{default:!1,format:"checkbox",propertyOrder:3,title:"Use Range",type:"boolean"}},propertyOrder:5,title:"Y Axis",type:"object"},Z:{options:{collapsed:!0},properties:{Column:{enumSource:"possible_columns",propertyOrder:1,type:"string",watch:{possible_columns:"root.possibleColumns"}},Max:{default:10,propertyOrder:5,type:"number"},Min:{default:0,propertyOrder:4,type:"number"},Title:{options:{collapsed:!0},properties:{Label:{default:"",propertyOrder:1,type:"string"},LabelSize:{default:"12",propertyOrder:2,type:"number"}},propertyOrder:6,title:"Title",type:"object"},Type:{default:"linear",enum:["linear"],propertyOrder:2,type:"string",options:{hidden:!0}},UseRange:{default:!1,format:"checkbox",propertyOrder:3,title:"Use Range",type:"boolean"}},propertyOrder:6,title:"Z Axis",type:"object"},notificationEvent:{default:["sym"],format:"table",items:{type:"string"},options:{collapsed:!0,hidden:!0},type:"array"},possibleColumns:{default:["sym"],format:"table",items:{type:"string"},options:{collapsed:!0,hidden:!0},propertyOrder:2,type:"array"},possibleLabels:{default:["sym"],format:"table",items:{type:"string"},options:{collapsed:!0,hidden:!0},propertyOrder:1,type:"array"},possibleRules:{default:[],format:"table",items:{type:"string"},options:{collapsed:!0,hidden:!0},propertyOrder:1,type:"array"}},title:"Properties",type:"object"},version:"4.5.0"}}},P);function P(){}s.upgrades=[{fn:function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e]},version:0},{fn:function(t){var e=void 0===(e=t.get("Image"))?{Source:""}:e;t.set("Image",e)},version:"4.5.0"}];c.app=e.template({compiler:[8,">= 4.3.0"],main:function(t,e,o,r,i){var p=t.lookupProperty||function(t,e){if(Object.prototype.hasOwnProperty.call(t,e))return t[e]};return'<div class="contour-container">\n    <div class="contour" id='+t.escapeExpression("function"==typeof(o=null!=(o=p(o,"id")||(null!=e?p(e,"id"):e))?o:t.hooks.helperMissing)?o.call(null!=e?e:t.nullContext||{},{name:"id",hash:{},data:i,loc:{start:{line:2,column:28},end:{line:2,column:34}}}):o)+" >\n    </div>\n\n</div>"},useData:!0});var u,y=c;function c(){}function S(t){var e=u.call(this,t)||this;return e.ContourID="",e.columnNames=[],e.subscriptionKey="",e.columnTypes="",e.keyColName="",e.valueColName="",e.api=t.api,e.ContourID="Contour-"+e.cid,e.$el.html(y.app({id:e.ContourID})),e.$el.addClass("Contour-app"),e.$chart=e.$el.find(".contour"),e}return u=i.View,l(S,u),S.prototype.onSettingsChange=function(e){var o=this,t=[S.PROP_X,S.PROP_Y,S.PROP_Z,S.PROP_PALETTE,S.PROP_TYPE,S.PROP_Y_LAYOUT,S.PROP_X_RANGE,S.PROP_X_MIN,S.PROP_X_MAX,S.PROP_Y_RANGE,S.PROP_Y_MIN,S.PROP_Y_MAX,S.PROP_TOOLTIP,S.PROP_TOOLTIP_SHOW,S.PROP_Z_RANGE,S.PROP_Z_MIN,S.PROP_Z_MAX,S.PROP_X_TITLE,S.PROP_Y_TITLE,S.PROP_Z_TITLE,S.PROP_X_TITLE_SIZE,S.PROP_Y_TITLE_SIZE,S.PROP_Z_TITLE_SIZE,S.PROP_SCALE_SHOW,S.PROP_STYLE_SMOOTH,S.PROP_STYLE_TICKINT,S.PROP_LAYOUT_T,S.PROP_LAYOUT_B,S.PROP_LAYOUT_L,S.PROP_LAYOUT_R,S.PROP_LAYOUT_PAD,S.PROP_LAYOUT_BACKGR,S.PROP_STYLE_SHOWCONTOURLBL,S.PROP_X_LAYOUT];this.callIfDef(e,S.PROP_DATA,this.onDataSourceChange.bind(this)),_.each(t,function(t){o.callIfDef(e,t,o.initializeChart.bind(o))}),this.callIfDef(e,S.PROP_IMG_SRC,this.appendImage.bind(this))},S.prototype.onResize=function(){this.initializeChart()},S.prototype.remove=function(){return this.subscriptionKey&&(this.api.unsubscribeTemplateViewStates(this.subscriptionKey),this.subscriptionKey=""),i.View.prototype.remove.apply(this)},S.prototype.getColorBar=function(){var t=this.api.getProperty(S.PROP_Z_TITLE),e=this.api.getProperty(S.PROP_Z_TITLE_SIZE);return{dtick:this.api.getProperty(S.PROP_STYLE_TICKINT),tickfont:{color:"white",family:"Courier New, monospace",size:e},tickmode:"linear",title:{size:e,text:t}}},S.prototype.getMargin=function(){var t=this.api.getProperty(S.PROP_LAYOUT_T),e=this.api.getProperty(S.PROP_LAYOUT_B),o=this.api.getProperty(S.PROP_LAYOUT_L),r=this.api.getProperty(S.PROP_LAYOUT_R);return{b:e,l:o,pad:this.api.getProperty(S.PROP_LAYOUT_PAD),r:r,t:t}},S.prototype.getAxis=function(t,e,o,r){return{side:t,title:e,titlefont:{size:o},type:r}},S.prototype.getLayout=function(t,e,o){var r=this.api.getProperty(S.PROP_LAYOUT_BACKGR),i=this.api.getProperty(S.PROP_X_TITLE),p=this.api.getProperty(S.PROP_Y_TITLE),a=this.api.getProperty(S.PROP_X_TITLE_SIZE),n=this.api.getProperty(S.PROP_Y_TITLE_SIZE),l=this.api.getProperty(S.PROP_X_RANGE),s=this.api.getProperty(S.PROP_X_MIN),P=this.api.getProperty(S.PROP_X_MAX),u=this.api.getProperty(S.PROP_Y_RANGE),y=this.api.getProperty(S.PROP_Y_MIN),c=this.api.getProperty(S.PROP_Y_MAX),d=this.getMargin(),O=this.api.getProperty(S.PROP_X_LAYOUT),h=this.api.getProperty(S.PROP_Y_LAYOUT),m=this.api.getProperty(S.PROP_STYLE_SHOWCONTOURLBL),T=this.api.getProperty(S.PROP_TYPE)||"contour",g=this.$el.height(),R={autosize:!1,height:void 0===g?d.b:g-d.b,hovermode:"closest",margin:d,paper_bgcolor:r||"transparent",width:this.$el.width(),xaxis:this.getAxis("bottom",i,a,O),yaxis:this.getAxis("left",p,n,h)};if(m&&"heatmap"===T){R.annotations=[];for(var f=0;f<e.length;f++)for(var b=0;b<t.length;b++){var L={font:{family:"Arial",size:12,color:"white"},showarrow:!1,text:o[f][b],x:t[b],xref:"x",y:e[f],yref:"y"};R.annotations.push(L)}}return l&&_.set(R,"xaxis.range",[s,P]),u&&_.set(R,"yaxis.range",[y,c]),R},S.prototype.getTooltip=function(){var u=this,y=this.api.getProperty(S.PROP_TOOLTIP),t=this.api.getProperty(S.PROP_TOOLTIP_SHOW),c=this.$chart.width(),d=this.$chart.height();t&&((t=document.getElementById(this.ContourID)).on("plotly_hover",function(t){var e,o,r=t.points,i=t.event.pointerX,t=t.event.pointerY,p=void 0!==c&&i<c/2?0:-80,a=void 0!==d&&t<d/2?5:-80,n=u.api.getProperty(S.PROP_Z_RANGE),l=u.api.getProperty(S.PROP_Z_MIN),s=u.api.getProperty(S.PROP_Z_MAX),P=u.api.getProperty(S.PROP_TYPE)||"contour";0<r.length&&(e=r[0],o=2,o="heatmap"===P?(n||(s=_.max(_.flatten(r[0].fullData.z)),l=_.min(_.flatten(r[0].fullData.z))),(e.z-l)/(s-l)):(P=e.data.contours,(e.z-P.start)/(P.end-P.start)),n=_.filter(e.data.colorscale,function(t){return t[0]<=o}),r=_.get(e,"data.colorscale"),s=0<n.length?_.last(n):_.first(r),e.color=s[1],u.tooltip=u.api.setTooltip({data:e,text:y,anchorEl:u.el,position:{left:i+p,top:t+a}}))}),t.on("plotly_unhover",function(){u.tooltip&&(u.api.removeTooltip(),delete u.tooltip)}))},S.prototype.callIfDef=function(t,e,o){void 0!==t[e]&&o.call(this,t[e],e)},S.prototype.destroyChart=function(){this.$chart.html("")},S.prototype.formatTick=function(t,e){return"linear"===this.api.getProperty(e+".Type")?parseFloat(t):t.toString()},S.prototype.initializeChart=function(){var i=this;if(_.get(this,"data.collection")){var p=_.get(this,"data.collection").toJSON(),t=this.api.getProperty(S.PROP_TYPE)||"contour",a=this.api.getProperty(S.PROP_X),n=this.api.getProperty(S.PROP_Y),l=this.api.getProperty(S.PROP_Z),e=_.map(this.api.getProperty(S.PROP_PALETTE),"type"),o=this.api.getProperty(S.PROP_SCALE_SHOW),r=this.api.getProperty(S.PROP_Z_RANGE),s=this.api.getProperty(S.PROP_Z_MIN),P=this.api.getProperty(S.PROP_Z_MAX),u=this.api.getProperty(S.PROP_STYLE_SMOOTH),y=this.api.getProperty(S.PROP_STYLE_SHOWCONTOURLBL),c={smoothing:void 0===u?.75:u/100};if(this.destroyChart(),a&&n&&l&&0<p.length){for(var d=_.sortBy(_.uniq(_.map(p,function(t){return i.formatTick(t[a],"X")}))),O=_.sortBy(_.uniq(_.map(p,function(t){return i.formatTick(t[n],"Y")}))),h=[],m=(_.each(O,function(o){var r=[];_.each(d,function(e){var t=_.filter(p,function(t){return i.formatTick(t[a],"X")===e&&i.formatTick(t[n],"Y")===o}),t=0<t.length?t[0][l]:null;r.push(t)}),h.push(r)}),[]),T=0;T<e.length;T++){var g=e[T];m.push([T*(1/(e.length-1)),g])}y={autocontour:!0,colorbar:this.getColorBar(),colorscale:m,connectgaps:!0,contours:{showlabels:y},hoverinfo:"none",line:c,showscale:o,type:t,x:d,y:O,z:h,zauto:!r,zmax:P,zmin:s,zsmooth:100===u&&"best"},c=this.getLayout(d,O,h);R.newPlot(this.ContourID,[y],c,{displayModeBar:!1,responsive:!0}),this.getTooltip(),this.appendImage()}}},S.prototype.appendImage=function(){var t,e,o,r,i=this.api.getProperty(S.PROP_IMG_SRC),p=a.select("#Contour-"+this.cid+" .bglayer");this.$el.find(".contourBackground-Image").remove(),i&&p&&p.node()&&(t=(p=p.node().getBBox()).height,e=p.width,o=p.x,p=p.y,(r=document.createElementNS("http://www.w3.org/2000/svg","image")).setAttributeNS(null,"height",t),r.setAttributeNS(null,"class","contourBackground-Image"),r.setAttributeNS(null,"width",e),r.setAttributeNS(null,"preserveAspectRatio","none"),r.setAttributeNS("http://www.w3.org/1999/xlink","href",i),r.setAttributeNS(null,"x",o),r.setAttributeNS(null,"y",p),r.setAttributeNS(null,"visibility","visible"),this.$el.find(".contour .main-svg").append(r))},S.prototype.onDataSourceChange=function(r){var i=this;this.unsubscribe(),this.datasource=r,this.data=null,this.datasource&&this.api.subscribe(this.datasource,function(e,o){i.columnNames=e.columns.collection.pluck("id"),i.columnTypes=e.columns.collection.pluck("kdbType"),i.keyColName=-1<i.columnNames.indexOf("key")?"key":i.columnNames[0],i.valueColName=-1<i.columnNames.indexOf("value")?"value":i.columnNames[1],i.data=o,i.api.setProperty("possibleColumns",i.columnNames);e=p.HeuristicHelpers.getNumericColumns(r);e.length<1?i.api.showErrorMessage({error:t("Data Source provided is not valid for Contour Chart"),type:"Warning"}):(""!==i.api.getProperty(S.PROP_X)&&-1!==i.columnNames.indexOf(i.api.getProperty(S.PROP_X))||i.api.setProperty(S.PROP_X,e[0]),""!==i.api.getProperty(S.PROP_Y)&&-1!==i.columnNames.indexOf(i.api.getProperty(S.PROP_Y))||i.api.setProperty(S.PROP_Y,e[1]),""!==i.api.getProperty(S.PROP_Z)&&-1!==i.columnNames.indexOf(i.api.getProperty(S.PROP_Z))||i.api.setProperty(S.PROP_Z,e[2]),i.initializeChart())})},S.prototype.setTheme=function(t){t=t.toLowerCase();this.$el.removeClass("dark light"),this.$el.addClass(t),this.initializeChart()},S.prototype.unsubscribe=function(){this.api.unsubscribe(this.datasource)},S.getComponentDefinition=s.getComponentDefinition,S.PROP_DATA="Basics.Data",S.PROP_TYPE="Basics.Type",S.PROP_X="X.Column",S.PROP_Y="Y.Column",S.PROP_Z="Z.Column",S.PROP_PALETTE="ColorPalette.ColorScheme",S.PROP_SCALE_SHOW="Basics.ShowScale",S.PROP_X_RANGE="X.UseRange",S.PROP_X_MIN="X.Min",S.PROP_X_MAX="X.Max",S.PROP_X_LAYOUT="X.Type",S.PROP_Y_RANGE="Y.UseRange",S.PROP_Y_MIN="Y.Min",S.PROP_Y_MAX="Y.Max",S.PROP_Y_LAYOUT="Y.Type",S.PROP_Z_RANGE="Z.UseRange",S.PROP_Z_MIN="Z.Min",S.PROP_Z_MAX="Z.Max",S.PROP_TOOLTIP="Tooltip.TooltipTemplate",S.PROP_TOOLTIP_SHOW="Tooltip.ShowTooltip",S.PROP_X_TITLE="X.Title.Label",S.PROP_X_TITLE_SIZE="X.Title.LabelSize",S.PROP_Y_TITLE="Y.Title.Label",S.PROP_Y_TITLE_SIZE="Y.Title.LabelSize",S.PROP_Z_TITLE="Z.Title.Label",S.PROP_Z_TITLE_SIZE="Z.Title.LabelSize",S.PROP_LAYOUT_T="Layout.Top",S.PROP_LAYOUT_B="Layout.Bottom",S.PROP_LAYOUT_L="Layout.Left",S.PROP_LAYOUT_R="Layout.Right",S.PROP_LAYOUT_PAD="Layout.Pad",S.PROP_LAYOUT_BACKGR="Layout.Background",S.PROP_STYLE_SMOOTH="Style.Smoothing",S.PROP_STYLE_SHOWCONTOURLBL="ColorPalette.ContourVal",S.PROP_STYLE_TICKINT="ColorPalette.TickInterval",S.PROP_IMG_SRC="Image.Source",S});