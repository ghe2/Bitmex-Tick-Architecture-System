define(["backbone","Forms","Handlebars","dashMoment","QuickBase","css!./css/main.css"],function(d,i,e,h,c){o.FailedLoginsNotification=e.template({1:function(e,t,i,n,o){var s,a=null!=t?t:e.nullContext||{},l=e.hooks.helperMissing,r="function",c=e.escapeExpression,d=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'    <div class="status-'+c(typeof(s=null!=(s=d(i,"status")||(null!=t?d(t,"status"):t))?s:l)==r?s.call(a,{name:"status",hash:{},data:o,loc:{start:{line:2,column:23},end:{line:2,column:33}}}):s)+'">\n        <span>'+c(typeof(s=null!=(s=d(i,"time")||(null!=t?d(t,"time"):t))?s:l)==r?s.call(a,{name:"time",hash:{},data:o,loc:{start:{line:3,column:14},end:{line:3,column:22}}}):s)+'</span>\n        <span class="info">from:</span>\n        <span>'+c(typeof(s=null!=(s=d(i,"machineID")||(null!=t?d(t,"machineID"):t))?s:l)==r?s.call(a,{name:"machineID",hash:{},data:o,loc:{start:{line:5,column:14},end:{line:5,column:27}}}):s)+"</span>\n"+(null!=(e=d(i,"if").call(a,null!=t?d(t,"status"):t,{name:"if",hash:{},fn:e.program(2,o,0),inverse:e.noop,data:o,loc:{start:{line:6,column:8},end:{line:9,column:15}}}))?e:"")+'        <span class="info">url:</span>\n        <span>'+c(typeof(s=null!=(s=d(i,"url")||(null!=t?d(t,"url"):t))?s:l)==r?s.call(a,{name:"url",hash:{},data:o,loc:{start:{line:11,column:14},end:{line:11,column:21}}}):s)+"</span>\n    </div>\n"},2:function(e,t,i,n,o){var s=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'        <span class="info">status:</span>\n        <span>'+e.escapeExpression("function"==typeof(i=null!=(i=s(i,"status")||(null!=t?s(t,"status"):t))?i:e.hooks.helperMissing)?i.call(null!=t?t:e.nullContext||{},{name:"status",hash:{},data:o,loc:{start:{line:8,column:14},end:{line:8,column:24}}}):i)+"</span>\n"},compiler:[8,">= 4.3.0"],main:function(e,t,i,n,o){var s=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return null!=(i=s(i,"each").call(null!=t?t:e.nullContext||{},null!=t?s(t,"rows"):t,{name:"each",hash:{},fn:e.program(1,o,0),inverse:e.noop,data:o,loc:{start:{line:1,column:0},end:{line:13,column:9}}}))?i:""},useData:!0}),o.LoadingScreen=e.template({compiler:[8,">= 4.3.0"],main:function(e,t,i,n,o){var s=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'<div class="loading" style="display: table; width: 100%; height: 100%; opacity: 0.9; pointer-events: none;">\n    <div style="display: table-cell; width: 100%; height: 100%; vertical-align: middle; text-align: center;">\n        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" width="64" height="64" fill="#D2D2D2">\n            <circle cx="16" cy="3" r="0">\n                <animate attributeName="r" values="0;3;0;0" dur="1s" repeatCount="indefinite" begin="0" keySplines="0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8" calcMode="spline" />\n            </circle>\n            <circle transform="rotate(45 16 16)" cx="16" cy="3" r="0">\n                <animate attributeName="r" values="0;3;0;0" dur="1s" repeatCount="indefinite" begin="0.125s" keySplines="0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8" calcMode="spline" />\n            </circle>\n            <circle transform="rotate(90 16 16)" cx="16" cy="3" r="0">\n                <animate attributeName="r" values="0;3;0;0" dur="1s" repeatCount="indefinite" begin="0.25s" keySplines="0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8" calcMode="spline" />\n            </circle>\n            <circle transform="rotate(135 16 16)" cx="16" cy="3" r="0.567031">\n                <animate attributeName="r" values="0;3;0;0" dur="1s" repeatCount="indefinite" begin="0.375s" keySplines="0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8" calcMode="spline" />\n            </circle>\n            <circle transform="rotate(180 16 16)" cx="16" cy="3" r="1.82452">\n                <animate attributeName="r" values="0;3;0;0" dur="1s" repeatCount="indefinite" begin="0.5s" keySplines="0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8" calcMode="spline" />\n            </circle>\n            <circle transform="rotate(225 16 16)" cx="16" cy="3" r="2.88475">\n                <animate attributeName="r" values="0;3;0;0" dur="1s" repeatCount="indefinite" begin="0.625s" keySplines="0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8" calcMode="spline" />\n            </circle>\n            <circle transform="rotate(270 16 16)" cx="16" cy="3" r="2.1029">\n                <animate attributeName="r" values="0;3;0;0" dur="1s" repeatCount="indefinite" begin="0.75s" keySplines="0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8" calcMode="spline" />\n            </circle>\n            <circle transform="rotate(315 16 16)" cx="16" cy="3" r="0.60761">\n                <animate attributeName="r" values="0;3;0;0" dur="1s" repeatCount="indefinite" begin="0.875s" keySplines="0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8" calcMode="spline" />\n            </circle>\n            <circle transform="rotate(180 16 16)" cx="16" cy="3" r="1.82452">\n                <animate attributeName="r" values="0;3;0;0" dur="1s" repeatCount="indefinite" begin="0.5s" keySplines="0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8" calcMode="spline" />\n            </circle>\n        </svg>\n        <div style="color: #D2D2D2; font-weight: bold; margin-top: 7px; font-size: 11px; letter-spacing: 1px;">\n            '+e.escapeExpression("function"==typeof(i=null!=(i=s(i,"text")||(null!=t?s(t,"text"):t))?i:e.hooks.helperMissing)?i.call(null!=t?t:e.nullContext||{},{name:"text",hash:{},data:o,loc:{start:{line:33,column:12},end:{line:33,column:20}}}):i)+"\n        </div>\n    </div>\n</div>"},useData:!0}),o.LoginHistoryDialog=e.template({compiler:[8,">= 4.3.0"],main:function(e,t,i,n,o){return'<div class="grid-div">\n</div>'},useData:!0}),o.MainToolbar=e.template({compiler:[8,">= 4.3.0"],main:function(e,t,i,n,o){var s,a=null!=t?t:e.nullContext||{},l=e.hooks.helperMissing,r=e.escapeExpression,c="function",e=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'<div class="main-toolbar">\n    <div class="logo"></div>\n\n    <div class="document-selector" style="display: inline-block;"></div>\n\t\n    <div class="main">\n        <a class="refresh-dash" style="display: inline-block;">'+r((e(i,"t")||t&&e(t,"t")||l).call(a,"Refresh Dashboard",{name:"t",hash:{},data:o,loc:{start:{line:7,column:63},end:{line:7,column:88}}}))+'</a>\n        <label for="'+r(typeof(s=null!=(s=e(i,"guid")||(null!=t?e(t,"guid"):t))?s:l)==c?s.call(a,{name:"guid",hash:{},data:o,loc:{start:{line:8,column:20},end:{line:8,column:28}}}):s)+'_customise">'+r((e(i,"t")||t&&e(t,"t")||l).call(a,"Customise Dashboard",{name:"t",hash:{},data:o,loc:{start:{line:8,column:40},end:{line:8,column:67}}}))+'</label>\n        <input id="'+r(typeof(s=null!=(s=e(i,"guid")||(null!=t?e(t,"guid"):t))?s:l)==c?s.call(a,{name:"guid",hash:{},data:o,loc:{start:{line:9,column:19},end:{line:9,column:27}}}):s)+'_customise" type="checkbox" class="customise-dash" />\n        <a class="save-dash" style="display: inline-block;">'+r((e(i,"t")||t&&e(t,"t")||l).call(a,"Save View State",{name:"t",hash:{},data:o,loc:{start:{line:10,column:60},end:{line:10,column:83}}}))+'</a>\n        <a class="default-dash" style="display: inline-block;">'+r((e(i,"t")||t&&e(t,"t")||l).call(a,"Reset View State",{name:"t",hash:{},data:o,loc:{start:{line:11,column:63},end:{line:11,column:87}}}))+'</a>\n        <a class="share-dash" style="display: inline-block">'+r((e(i,"t")||t&&e(t,"t")||l).call(a,"Share Dashboard",{name:"t",hash:{},data:o,loc:{start:{line:12,column:60},end:{line:12,column:83}}}))+'</a>\n        <a class="create-pdf" style="display: inline-block">'+r((e(i,"t")||t&&e(t,"t")||l).call(a,"Create Pdf",{name:"t",hash:{},data:o,loc:{start:{line:13,column:60},end:{line:13,column:78}}}))+'</a>\n    </div>\n\n    <div class="connectionStatus"></div>\n\n    <div class="profile">\n        <button>\n            <i class="fa fa-fw fa-user"></i>\n            <span class="user-name-wrap">\n                <span class="user-name"></span>\n            </span>\n        </button>\n\n        <div class="profile-menu"></div>\n    </div>\n</div>'},useData:!0}),o.Notificator=e.template({compiler:[8,">= 4.3.0"],main:function(e,t,i,n,o){return'<div class="panel ui-widget-content">\n    <div class="title"></div>\n    <div class="items"></div>\n    <button class="close-button">\n        Close\n    </button>\n</div>'},useData:!0}),o.ShareDashDialog=e.template({1:function(e,t,i,n,o){return"checked"},compiler:[8,">= 4.3.0"],main:function(e,t,i,n,o){var s,a=null!=t?t:e.nullContext||{},l=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'<div>\n    <input class="share-dash-url" value="'+e.escapeExpression("function"==typeof(s=null!=(s=l(i,"url")||(null!=t?l(t,"url"):t))?s:e.hooks.helperMissing)?s.call(a,{name:"url",hash:{},data:o,loc:{start:{line:2,column:41},end:{line:2,column:48}}}):s)+'" readonly />\n</div>\n<div class="share-meta">\n    <label class="share-shorten">Shorten <input class="share-shorten-checkbox" type="checkbox"\n            '+(null!=(s=l(i,"if").call(a,null!=t?l(t,"shortenUrl"):t,{name:"if",hash:{},fn:e.program(1,o,0),inverse:e.noop,data:o,loc:{start:{line:6,column:12},end:{line:6,column:44}}}))?s:"")+' /></label>\n    <span class="share-info"><i class="fa share-info-icon"></i> <span class="share-info-text"></span></span>\n</div>'},useData:!0}),o.app=e.template({compiler:[8,">= 4.3.0"],main:function(e,t,i,n,o){return'<div class="toolbar-div">\n</div>\n\n<div class="document-view-div">\n</div>\n\n<div class="dialog-panel">\n    <div class="document" />\n    <div class="environment" />\n</div>\n<div class="notifications-div">\n\n</div>'},useData:!0});var n=o;function o(){}var a=d.Model.extend({defaults:{api:null,components:null,deltaClient:null,documents:null,language:"en",publisherUrl:null,smartDrop:!0,websiteUrl:null,userName:null,paths:null,propertiesPinned:!0,isHelpDialogTabbed:!0},initialize:function(e){var t,i=[];for(t in e.versions)e.versions.hasOwnProperty(t)&&i.push({key:t,value:e.versions[t]});this.set({api:e.api,components:new c.ComponentDefinitionCollection,documents:e.documents,PackageName:e.PackageName,paths:_.sortBy(i,"key"),publisherUrl:e.publisherUrl,websiteUrl:e.websiteUrl})}}),l=d;function s(){return(65536*(1+Math.random())|0).toString(16).substring(1)}function r(e,t){var i;if(null!=e)return i=e[t],"function"==typeof i?e[t]():i}l.LocalStorage=window.Store=function(e,t){if(!this.localStorage)throw"Backbone.localStorage: Environment does not support localStorage.";this.name=e,this.serializer=t||{serialize:function(e){return e===Object(e)?JSON.stringify(e):e},deserialize:function(e){return e&&JSON.parse(e)}};e=this.localStorage().getItem(this.name);this.records=e&&e.split(",")||[]};var u,g=l.LocalStorage.prototype,m={save:function(){this.localStorage().setItem(this.name,this.records.join(","))},create:function(e){return e.id||0===e.id||(e.id=s()+s()+"-"+s()+"-"+s()+"-"+s()+"-"+s()+s()+s(),e.set(e.idAttribute,e.id)),this.localStorage().setItem(this._itemName(e.id),this.serializer.serialize(e)),this.records.push(e.id.toString()),this.save(),this.find(e)},update:function(e){this.localStorage().setItem(this._itemName(e.id),this.serializer.serialize(e));var t=e.id.toString();return function(e,t){for(var i=e.length;i--;)if(e[i]===t)return 1}(this.records,t)||(this.records.push(t),this.save()),e.attributes},find:function(e){return this.serializer.deserialize(this.localStorage().getItem(this._itemName(e.id)))},findAll:function(){for(var e,t=[],i=0;i<this.records.length;i++)e=this.records[i],null!=(e=this.serializer.deserialize(this.localStorage().getItem(this._itemName(e))))&&t.push(e);return t},destroy:function(e){this.localStorage().removeItem(this._itemName(e.id));for(var t=e.id.toString(),i=0;i<this.records.length;i++)this.records[i]===t&&this.records.splice(i,1);return this.save(),e},localStorage:function(){return localStorage},_clear:function(){var e,t=this.localStorage(),i=new RegExp("^"+this.name+"-");for(e in t.removeItem(this.name),t)i.test(e)&&t.removeItem(e);this.records.length=0},_storageSize:function(){return this.localStorage().length},_itemName:function(e){return this.name+"-"+e}};for(u in m)g[u]=m[u];l.LocalStorage.sync=window.Store.sync=l.localSync=function(e,t,i){var n,o,s=r(t,"localStorage")||r(t.collection,"localStorage"),a=l.$?l.$.Deferred&&l.$.Deferred():l.Deferred&&l.Deferred();try{switch(e){case"read":n=null!=t.id?s.find(t):s.findAll();break;case"create":n=s.create(t);break;case"update":n=s.update(t);break;case"delete":n=s.destroy(t)}}catch(e){o=22===e.code&&0===s._storageSize()?"Private browsing is unsupported":e.message}return n?(i&&i.success&&("0.9.10"===l.VERSION?i.success(t,n,i):i.success(n)),a&&a.resolve(n)):(o=o||"Record Not Found",i&&i.error&&("0.9.10"===l.VERSION?i.error(t,o,i):i.error(o)),a&&a.reject(o)),i&&i.complete&&i.complete(n),a&&a.promise()},l.ajaxSync=l.sync,l.getSyncMethod=function(e,t){return t&&t.ajaxSync||!r(e,"localStorage")&&!r(e.collection,"localStorage")?l.ajaxSync:l.localSync},l.sync=function(e,t,i){return l.getSyncMethod(t,i).apply(this,[e,t,i])},l.LocalStorage;var p,f,v,w,D=d.View.extend({className:"quick-dash loadingScreen",loadText:null,initialize:function(e){this.loadText=e.loadingText,this.render()},render:function(){return this.$el.html(n.LoadingScreen({text:this.loadText})),this.$el.hide(),this.$el.fadeIn(),this}}),C=d.View.extend({$dialog:null,close:function(){this.$dialog.dialog("close")},dataGridStuff:(p=["pk","time","machineID","status","url"],f=[11,15,11,11,11],v=["pk","Time","Machine Id","Status","Url"],{generateDatagridConfig:function(e){return this.Datagrid=e,(e=new c.DocumentDataModel({_subscriptionKey:"pk",_dataType:"copy",_maxRows:1e6})).apply(),e.onExecuteSuccess(this.getResponse(),!0),new d.Model({data:e,columnsConfig:this.getColumnsConfiguration(),datagridConfig:this.datagridConfiguration(),sortColumns:this.sortColumns})},datagridConfiguration:function(){return{Selection:{Mode:"Multi Row"}}},columnsConfiguration:function(){var i;return MAP={1:"Boolean",14:"Date",15:"DateTime",19:"Time"},i=function(e){return MAP[e]||"General"},_.map(p,function(e,t){return{Field:e,DisplayName:v[t],Sortable:!0,Hidden:_.includes(w,p[t]),Format:i(f[t])}})},getResponse:function(e){return{rows:e||[],columns:p,meta:_.zipObject(p,f)}},getColumnsConfiguration:function(){var e=this.columnsConfiguration(),t=this;return _.map(e,function(e){return _.extend({},t.Datagrid.getColumnSettingsModel(),{DisplayName:e.Field,TextAlign:"left",IsReadonly:!0,MinWidthAbsolute:100},e)})},sortColumns:[{sortCol:"time",sortAsc:!(w=["pk"])}]}),getLoginHistory:function(){var t=this;c.DeltaClientLib.getAPIQueryData("kdb",void 0,".session.getLogins",[{IsKdbParam:!0,i:0,index:0,name:"user",type:"symbol",value:c.DeltaClientLib.deltaClient.user()},{IsKdbParam:!0,i:1,index:1,name:"clientType",type:"symbol"}],function(e){t.dgSourceModel.onExecuteSuccess(t.dataGridStuff.getResponse(_.map(e.rows,function(e){return _.extend({pk:_.uniqueId()},_.pick(e,"machineID","status","time","url"))})),!0),t.hideLoadingScreen(),t.onResize()},function(e){console.log("getLoginHistory session get logins error",e)},100,!1)},hideLoadingScreen:function(){this.$loadingScreen&&(this.$loadingScreen.fadeOut(function(){$(this).remove()}),this.$loadingScreen=null)},initialize:function(e){var i=this;i.$el.html(n.LoginHistoryDialog()),i.showLoadingScreen(),i.initializeDataGrid(),this.$dialog=this.$el.dialog(_.extend({dialogClass:"quick-base login-history-dialog",title:t("Login History"),resizable:!0,height:302,width:552,modal:!0,autoOpen:!0,draggable:!0,buttons:[{text:t("OK"),click:$.proxy(i.close,i),icons:{primary:"fa fa-check"}}],open:function(){$('<i class="fa fa-history" />').insertBefore(i.$el.parent().find(".ui-dialog-title"))},close:function(){_.isFunction(e.onClose)&&e.onClose(),i.remove()},resize:$.proxy(this.onResize,this)},e))},initializeDataGrid:function(e){var i=this;require(["Datagrid"],function(e){var t=i.dataGridStuff.generateDatagridConfig(e);i.dgSourceModel=t.get("data"),i.dgSource=new e.Master({el:i.$(".grid-div"),model:t}),i.getLoginHistory()})},onResize:function(){this.dgSource&&this.dgSource.onResize()},remove:function(){this.dgSource.off(),this.dgSource.remove(),d.View.prototype.remove.apply(this)},showLoadingScreen:function(e){e=new D({loadingText:e});e.$el.appendTo(this.$el),this.$loadingScreen=e.$el}}),b=d.View.extend({ICONS:{error:"fa-times",loading:"fa-spinner fa-pulse",success:"fa-check"},$closeButton:null,$dialog:null,appModel:null,className:"quick-view window share-dash-dialog",closeArgs:null,viewModel:null,events:{"change .share-shorten-checkbox":"onToggleShorten","click .share-dash-url":"onClickUrl"},initialize:function(e){this.options=e,this.container=e.container,this.shortenUrl=e.shortenUrl,this.url=e.url,this.render()},onClickClose:function(){this.$dialog.dialog("close")},onClickCopy:function(){this.$urlInput.select();try{document.execCommand("copy")?this.showInfo("Link copied","success"):this.showInfo("Error: link not copied","error")}catch(e){this.showInfo("Error: link not copied ("+e.toString()+")","error")}},onClickPreview:function(){window.open(this.shortenUrl?this.shortUrl:this.url,"_blank")},onClickUrl:function(){this.$urlInput.select()},onToggleShorten:function(){function t(e){i.shortUrl=e[1],i.$urlInput.val(i.shortUrl),i.showInfo(null,"none")}function e(e){i.shortUrl=null,i.$urlInput.val(i.url),i.showInfo(e.toString(),"error"),i.shortenUrl=!1,i.$shareShortenCheckbox.prop("checked",!1),i.trigger("shortenUrlSetting",!1)}var i=this,n=window.location.protocol+"//"+window.location.host+"/",o=this.$shareShortenCheckbox.prop("checked");o?this.shortUrl?this.$urlInput.val(this.shortUrl):(i.showInfo("Shortening","loading"),this.options.isLite?c.DashClient.runAPI(".api.shortenUrl","gw",[{type:"string",value:this.url.substring(n.length)}],function(e){t([0,n+e.rows[0].symbol])},e):c.DeltaClientLib.deltaClient.request("UrlAPI.getShortUrl",t,e,this.url)):this.$urlInput.val(this.url),this.shortenUrl=o,this.trigger("shortenUrlSetting",o)},render:function(){var e,t=this;this.$el.html(n.ShareDashDialog({shortenUrl:this.shortenUrl,url:this.url})),this.$shareInfoIcon=this.$el.find(".share-info-icon"),this.$shareInfoText=this.$el.find(".share-info-text"),this.$urlInput=this.$el.find("input.share-dash-url"),this.$shareShortenCheckbox=this.$el.find("input.share-shorten-checkbox"),e=[{text:"Copy Link",click:_.bind(this.onClickCopy,this),icons:{primary:"fa fa-clipboard"}},{text:"Preview",click:_.bind(this.onClickPreview,this),icons:{primary:"fa fa-external-link"}},{text:"Close",click:_.bind(this.onClickClose,this),icons:{primary:"fa fa-times"}}],this.$dialog=this.$el.dialog(_.extend({appendTo:this.container,title:"Share Dashboard",resizable:!1,width:500,modal:!0,autoOpen:!0,draggable:!0,buttons:e,open:function(){$('<i class="fa fa-share-alt" />').insertBefore(t.$el.parent().find(".ui-dialog-title"))},close:function(){t.remove()}},this.options)),this.onToggleShorten()},showInfo:function(e,t){var i=this;"none"===t?this.$el.removeClass("show-info"):(this.$el.addClass("show-info"),_.delay(function(){i.$el.removeClass("show-info")},3e3),icon=this.ICONS[t],this.$shareInfoIcon.removeClass(function(e,t){return(t.match(/\bfa-\S+/g)||[]).join(" ")}).addClass(icon),this.$shareInfoText.text(e))}}),S=d.View.extend({AUTOSAVE_THROTTLE:5e3,$saveDash:null,initialize:function(e){var i=this,t=(this.appModel=e.appModel,this.dialogContainer=e.dialogContainer,this.themes=e.themes,this.viewModel=e.viewModel,this.currentDocViewModel=null,this.$el.html(n.MainToolbar({guid:_.uniqueId("toolbar_")})),this.documentSelector=new c.DocumentSelector({el:this.$el.find(".document-selector"),appModel:this.appModel,viewModel:this.viewModel}),this.listenTo(this.viewModel,"change:selectedDocumentId",this.onSelectedDocumentIdChanged),this.$refreshDash=this.$el.find(".refresh-dash"),this.$refreshDash.button({icons:{primary:"fa fa-refresh"},text:!1}).click($.proxy(this.onRefreshDash,this)),this.$customiseDash=this.$el.find(".customise-dash"),this.$customiseDash.button({icons:{primary:"fa fa-cog"},text:!1}).click($.proxy(this.onCustomiseDash,this)),this.onUserConfigurableChange(),this.listenTo(this.viewModel,"change:userConfigurable",this.onUserConfigurableChange),this.$saveDash=this.$el.find(".save-dash"),this.$saveDash.button({icons:{primary:"fa fa-floppy-o"},text:!1}).click($.proxy(this.onSaveDash,this)),$("<span />").addClass("save-pending fa fa-asterisk").appendTo(this.$saveDash),$("<span />").addClass("save-in-progress fa fa-spinner fa-pulse").appendTo(this.$saveDash),this.listenTo(this.viewModel,"widgets-configured",this.onWidgetsConfigured),this.throttledAutoSaveDash=_.throttle(this.onSaveDash.bind(this),this.AUTOSAVE_THROTTLE),this.$revertDash=this.$el.find(".default-dash"),this.$revertDash.button({icons:{primary:"fa fa-undo"},text:!1}).click($.proxy(this.onRevertDash,this)),this.$shareDash=this.$el.find(".share-dash"),this.$shareDash.button({icons:{primary:"fa fa-share-alt"},text:!1}).click($.proxy(this.onShareDash,this)),this.$createPdf=this.$el.find(".create-pdf"),this.$createPdf.button({icons:{primary:"fa fa-file-pdf-o"},text:!1}).click($.proxy(this.onCreatePdf,this)),this.appModel.get("isLite")&&this.appModel.get("PdfUrl")||this.$createPdf.hide(),$(c.DeltaClientLib).on("DeltaClientConnect",function(){"true"===c.DeltaClientLib.getDashboardProperty("pdf_enabled")&&i.$createPdf.show()}),this.$profileButton=this.$el.find(".profile > button"),this.$profileMenu=this.$el.find(".profile > .profile-menu"),this.$profileButton=this.$el.find(".profile > button").button({text:!0,icons:{secondary:"ui-icon-triangle-1-s"}}).click(function(){return i.$profileMenu.toggle(),i.$profileMenu.css("position","absolute"),i.$profileMenu.position({my:"right top",at:"right bottom",of:this}),$(document).one("click",function(){i.$profileMenu.hide()}),!1}),this.appModel.get("isLite")?this.initProfileMenu():$(c.DeltaClientLib).one("DeltaClientLogin",$.proxy(this.initProfileMenu,this)),this.listenTo(this.appModel,"change:userName",function(e,t){i.$el.find(".user-name").text(t)}),function(){$(c.DeltaClientLib).one("DeltaClientDisconnect",function(){i.changeConnectionStatus(!1),$(c.DeltaClientLib).one("DeltaClientConnect",function(){i.changeConnectionStatus(!0),t()})})});t()},changeConnectionStatus:function(e){var t=this;e?(t.$el.find(".connectionStatus").html('<span class="fa fa-info-circle"></span>Delta Client has reconnected'),t.$el.find(".connectionStatus").css({color:"#03B103",display:"inline-block"}),_.delay(function(){t.$el.find(".connectionStatus").hide()},7e3)):(t.$el.find(".connectionStatus").html('<span class="fa fa-warning"></span>Delta Client connection has been lost, reconnecting...'),t.$el.find(".connectionStatus").css({color:"#FF6262",display:"inline-block"}))},initProfileMenu:function(){this.profileMenu=new c.ProfileMenu({appModel:this.appModel,dialogContainer:this.dialogContainer,themes:this.themes,isQuickView:!0,viewModel:this.viewModel}),this.$profileMenu.html(this.profileMenu.$el),this.listenTo(this.profileMenu,"themeChange",function(){this.trigger("themeChange")}.bind(this)),this.listenTo(this.profileMenu,"login-history",function(){this.onLoginHistory()}.bind(this)),this.$profileMenu.hide()},onChangePassword:function(){new c.ChangePasswordDialog},getViewstate:function(){var e=this.viewModel.get("selectedDocumentId"),e=this.appModel.get("documents").get(e).get("viewState").getViewStateList(!0),t={};return _.each(e,function(e){t[e.path]=e.model.get("value")}),t},onCreatePdf:function(){var n,o,s,a,l,e=this.viewModel.get("selectedDocumentId"),t=this.appModel.get("documents").get(e),r="",c=this;t&&(o=t.get("viewState").getViewStateExport(),s="#"+e+"/"+this.viewModel.get("selectedScreenId"),t=new d.Model({printFilters:!1,width:"standard",fileName:this.appModel.get("documents").get(this.viewModel.get("selectedDocumentId")).get("name")+" "+h().format("YYYY-MM-DD HH:mm")}),c.appModel.get("NewPdf")?(a=$(".toolbar-div").width(),l=$(".grid-stack").height(),t.schema={fileName:{title:"File Name"},printFilters:{title:"Print Filters:",type:"Checkbox"},width:{title:"Pdf Width:",type:"Select",options:["standard","current preview ("+a+"px)"],default:"standard"}}):t.schema={},new i.NewObjectDialog({dialogTitle:"Create PDF",iconClass:"fa-file-pdf-o",model:t,userClass:"create-pdf-dialog",okBtnLabel:"Create PDF",okBtnIcon:"fa fa-file-pdf-o",width:350,callback:function(e){_.isEmpty(o)||(r="?viewstate="+encodeURIComponent(JSON.stringify(o))),c.appModel.get("NewPdf")&&(r=(r+=r?"&":"?")+"printfilters="+(e.get("printFilters")?1:0),0<$(".pdf-expandable").length?r+="&documentHeight=1080&documentWidth=1920":r=(r=(r+="&documentWidth="+a)+("standard"===e.get("width")?"&width=standard":"&width=other"))+"&documentHeight="+l);var t=c.appModel.get("isLite"),i=c.appModel.get("PdfUrl");n=(t?"index.html":"index.jsp")+r+s,url=(t?i:"pdf.jsp")+"?filename="+encodeURIComponent(e.get("fileName"))+"&url="+encodeURIComponent(n),window.open(url)}}))},onCustomiseDash:function(){this.viewModel.get("userConfigurable")&&this.viewModel.set("buildMode",!this.viewModel.get("buildMode"),{userInitiated:!0})},onDocumentViewStateChanged:function(){var e=this.viewModel.get("selectedDocumentId"),e=this.appModel.get("documents").get(e),e=e?e.get("saveViewerState"):"";0===e.indexOf("enabled")&&(this.currentDocViewModel.wasChanged=!0,this.$saveDash.addClass("changed")),"enabled_auto"===e&&this.throttledAutoSaveDash()},onDocumentViewStateSaved:function(e){this.$saveDash.removeClass("saving changed")},onLoginHistory:function(){new C({appModel:this.appModel})},onLogout:function(){location.reload()},onRefreshDash:function(){var e=this.appModel.get("documents").get(this.viewModel.get("selectedDocumentId"));e&&e.get("data").getTreeList().forEach(function(e){e.stop(),e.isDirty=!0,e.start()})},onResize:function(){this.documentSelector.onResize()},onRevertDash:function(){var e=this,t=this.viewModel.get("selectedDocumentId"),i=this.appModel.get("documents").get(t),n=i.get("viewState");c.ConfirmDialog.ShowConfirm({dialogTitle:"Confirm Reset",renderTemplate:function(){return"Are you sure you want to revert all settings for this Dashboard to the Editor defaults?"},callback:function(){n instanceof c.DocumentViewModel&&(n.isNew()&&n.set(n.idAttribute,t,{silent:!0}),n.destroyOnServer({success:function(){e.appModel.get("router").navigate(t,{trigger:!0}),_.each(n.getViewStateList(),function(e){valueToSet=e.model.get("_rolling")?c.Helpers.convertRollingToDate(e.model.get("_default"),e.model.get("_type")):e.model.get("_default"),e.model.set("value",valueToSet)})},error:function(){console.log("can't delete user settings",arguments)},dashboardId:i.id}))}})},onSaveDash:function(){var e,i=this,t=this.viewModel.get("selectedDocumentId"),n=this.appModel.get("documents").get(t);this.$saveDash.addClass("saving"),n&&_.includes(["enabled","enabled_auto"],n.get("saveViewerState"))?((e=n.get("viewState")).withAllProperties=!0,n.get("viewState").save({id:t},{error:function(e){var t;i.$saveDash.removeClass("saving"),t=arguments[1]||"No error information returned from the server.",y.Error("ERROR DIALOG: ",e,arguments),c.ErrorDialog.ShowError(t)},success:function(){delete n.get("viewState").wasChanged,i.$saveDash.removeClass("saving changed")}}),e.withAllProperties=!1):console.log("no document to save!",t)},onSelectedDocumentIdChanged:function(){var e=this.viewModel.previous("selectedDocumentId"),t=this.viewModel.get("selectedDocumentId");this.$shareDash.hide(),e&&(e=this.appModel.get("documents").get(e))&&(this.stopListening(e.get("viewState"),"change",this.onDocumentViewStateChanged),this.stopListening(e.get("viewState"),"sync",this.onDocumentViewStateSaved),this.onDocumentViewStateSaved()),t&&(e=this.appModel.get("documents").get(t))&&(this.currentDocViewModel=e.get("viewState"),this.currentDocViewModel&&!this.currentDocViewModel.id&&(this.currentDocViewModel.id=t),this.listenTo(e.get("viewState"),"change",this.onDocumentViewStateChanged),this.listenTo(e.get("viewState"),"sync",this.onDocumentViewStateSaved),this.$saveDash.toggle(_.includes(["enabled","enabled_auto"],e.get("saveViewerState"))),this.$shareDash.toggle(e.get("enableShareDashboard")))},onShareDash:function(){var e,t=this.viewModel.get("selectedDocumentId"),i=this.appModel.get("documents").get(t),n=this.viewModel.get("selectedScreenId");this.appModel.has("shortenShareUrl")||this.appModel.set("shortenShareUrl",!0,{silent:!0}),i&&i.get("enableShareDashboard")?(0===(e=this.appModel.get("websiteUrl")+"#"+i.id).indexOf("//")&&(e=location.protocol+e),n&&(e+="/"+n),(n=i.get("viewState").getViewStateExport())&&(e+="?viewstate="+encodeURIComponent(JSON.stringify(n))),i=new b({isLite:this.appModel.get("isLite"),shortenUrl:this.appModel.get("shortenShareUrl"),url:e}),this.listenTo(i,"shortenUrlSetting",function(e){this.appModel.set("shortenShareUrl",e,{silent:!0})})):console.log("no document to share",t)},onUserConfigurableChange:function(){this.$customiseDash.button("widget").toggle(this.viewModel.get("userConfigurable"))},onWidgetsConfigured:function(){this.$saveDash.addClass("changed")}}),y=c.Log,M=c.AreYouSureDialog.extend({className:"quick-view window are-you-sure",viewModel:null,initialize:function(e){c.AreYouSureDialog.prototype.initialize.apply(this,arguments),this.dashboardId=e.dashboardId},doSave:function(){var e=$.Deferred(),t=this.model.get("viewState");return t.withAllProperties=!0,this.model.get("viewState").save(null,{dashboardId:this.dashboardId,error:e.reject,success:e.resolve}),t.withAllProperties=!1,e.promise()},getPromptMessage:function(){return"There are unsaved view state changes in this dashboard."}}),k=d.Router.extend({model:null,previousRoutes:null,viewModel:null,routes:{":dashboardId(/)(:screenId)":"onDashboard"},initialize:function(e){this.model=e.model,this.viewModel=e.viewModel,this.dialogContainer=e.dialogContainer,this.previousRoutes=[],this.initializeEvents()},initializeEvents:function(){this.on("route",function(){this.previousRoutes.push(d.history.fragment)})},getUserViewState:function(e,i,n){var o=this,e=new c.DocumentViewModel({id:e.id});c.Log.Log("User Settings Get"),e.fetch({success:function(e){c.Log.Log("User Settings Completed",e);var t=o.getViewstateFromQueryString(i);t&&e.set(t),n(e)},error:function(e,t){"Record Not Found"===t?c.Log.Log("User Settings Not Found"):c.Log.Error("User Settings Error"),n(null)}})},getViewstateFromQueryString:function(e){var e=/(^|&)viewstate=([^&;]+?)(&|;|$)/.exec(e),t=null;return e&&(t=JSON.parse(decodeURIComponent(e[2])))[".csettings"]&&(t[".settings"]=JSON.parse(c.Tools.decompress(c.Tools.decodeFromBase64(t[".csettings"]))),delete t[".csettings"]),t},navigateToDash:function(i,n,o){var s,a=this,l=this.viewModel.get("selectedDocumentId"),e=this.model.get("documents").get(i);e?(s=function(e){var t=a.getViewstateFromQueryString(o);a.viewModel.set("incomingViewState",t,{silent:!0}),l===i&&t&&a.viewModel.trigger("processIncomingViewState",e),n||((t=e.get("screens").findWhere({isDefault:!0})||e.get("screens").first())?n=t.id:y.Error("no default screen, no screens at all")),a.viewModel.set({selectedDocumentId:i,selectedScreenId:n}),e.trigger("view-state-init")},l!==i?e.fetch({success:function(t){a.getUserViewState(t,o,function(e){a.updateDocumentViewState(t,e),s(t)})},error:function(){alert(t("error downloading dashboard"))},silent:!0}):s(e)):(y.Error("dashboard NOT found (?)"),l?y.Error("dashboard doesn't exist or user doesnt have required permissions. (2)"):0<this.model.get("documents").length?this.navigate(this.model.get("documents").first().id,{trigger:!0}):(y.Error("dashboard doesn't exist or user doesnt have required permissions. (1)"),$(document).find(".loadingScreen").css({display:"none"}),this.dialog=$("<div>The Selected dashboard does not exist or user does not have required permissions or no dashboards are permissioned to this user.</div>").dialog({autoOpen:!0,height:350,width:350,modal:!0,title:"Error loading Dashboard"})))},onDashboard:function(t,i,n){var o=this.viewModel.get("selectedDocumentId"),e=this.model.get("documents").find(function(e){return e.id===o});e&&o!==t&&e.get("unsavedViewerPrompt")&&e.get("viewState").wasChanged?new M({container:this.dialogContainer,dashboardId:o,model:e,userClass:"quick-view"}).on("close",function(e){"cancel"==e?(this.previousRoutes.pop(),this.navigate(_.last(this.previousRoutes),{replace:!0}),this.onNavCancel&&(this.onNavCancel(),this.onNavCancel=null)):(this.navigateToDash(t,i,n),this.previousRoutes=[d.history.fragment])}.bind(this)):this.navigateToDash(t,i,n)},updateDocumentViewState:function(e,t){var i,o=e.get("viewState"),n=o.get(".settings"),s=function(e,i){var t,n=o.getByPath(i);if(_.isObject(e))if(_.isFunction(e.get))t=e.get("value");else{if(!e._viewType)return _.each(e,function(e,t){s(e,i+"/"+t)}),!1;t=e.value}else t=e;n&&!_.isUndefined(t)&&(n instanceof d.Model?n.set("value",t):y.Warn('AppRouter: Invalid view state at "'+i+'"',n))};t&&_.each(t.attributes,function(e,t){".settings"!==t?s(e,t):n&&_.each(e.attributes,function(e,t){i=n.get(t),_.isUndefined(i)&&(i=new d.Model,n.set(t,i)),i.set(e.attributes)})})}}),x=d.View.extend({className:"notificator",initialize:function(e){this.appModel=e.appModel,this.render()},notify:function(e,t){this.$title.text(e),this.$items.append(t),this.$panel.fadeIn("slow")},onClose:function(){var e=this;this.$panel.fadeOut("slow",function(){e.$items.html("")})},render:function(){return this.$el.addClass(this.className),this.$el.html(n.Notificator()),this.$title=this.$(".title"),this.$items=this.$(".items"),this.$panel=this.$(".panel"),this.$close=this.$(".close-button"),this.$close.button({text:!1,icons:{primary:"fa fa-times"}}).click($.proxy(this.onClose,this)),this.$panel.hide(),this}}),L=d.View.extend({className:"failed-logins",initialize:function(e){this.appModel=e.appModel,this.render()},render:function(){var e=this.model.toJSON();return _.each(e.rows,function(e){var t=I.convertKDBTemporalToMoment(e.time);e.time=t.format("YYYY-MM-DD HH:mm:ss"),e.timeSort=t.valueOf()}),e.rows=_.sortBy(e.rows,"timeSort").reverse(),$(this.$el).css("max-height",$(".quick-base").height()/2),this.$el.addClass(this.className),this.$el.html(n.FailedLoginsNotification(e)),this}}),I=c.Tools;return d.View.extend({DOCUMENT_TITLE:{SEPARATOR:" - ",SUFFIX:"Dashboards"},THEMES:[{id:"kx-darkroom",name:"Dark"},{id:"kx-light",name:"Light"}],$documentDialogPanel:null,$documentViewDiv:null,$environmentDialogPanel:null,loadingScreen:null,documentView:null,environmentTheme:null,viewModel:null,router:null,appid:"dashboards",hideLoadingScreen:function(){this.loadingScreen&&this.loadingScreen.remove()},initialize:function(t){var i,s=this;-1!==document.location.href.indexOf("auth=saml")&&(this.saml=!0),window.resizeHandler=function(){window.dispatchEvent(new Event("resize"))},c.Helpers.preventBackspaceBack(),i=(i=-1!==document.location.pathname.indexOf(".")?document.location.pathname.substr(0,document.location.pathname.lastIndexOf("/")+1):document.location.pathname).replace("quickview/",""),t.isLite?(c.Document.prototype.sync=c.DashClientLib.documentSync,c.DocumentCollection.prototype.sync=c.DashClientLib.documentCollectionSync,c.DocumentViewModel.prototype.localStorage=new d.LocalStorage("viewstate"),_.extend(c.DocumentDataModel.prototype,c.DashClientLib),c.DeltaClientLib.PIVOT_SOURCE_CODE=c.DashClientLib.PIVOT_SOURCE_CODE):(c.Document.prototype.sync=c.DeltaClientLib.documentSync,c.DocumentCollection.prototype.sync=c.DeltaClientLib.documentCollectionSync,c.DocumentViewModel.prototype.sync=c.DeltaClientLib.documentViewSync),this.model=new a($.extend({documents:new c.DocumentCollection,websiteUrl:"//"+document.location.host+i,saml:this.saml},t)),this.viewModel=new c.AppViewModel({buildMode:!1}),t.printMode&&this.$el.addClass("print-mode"),i=function(e){s.model.set("language",e.language||"en"),s.render(),$.extend($.ui.dialog.prototype.options,{appendTo:s.$documentDialogPanel}),s.setThemeFromCookie(),s.model.get("components").reset(t.components),t.deltaToken=t.deltaToken||$.cookie("deltaToken"),s.model.get("isLite")?(c.DashClient.client=new c.DashClient(t),c.DeltaClientLib=c.DashClient):s.saml?s.initializeDeltaClient(null,null,function(e){alert(e)},null,!0):t&&t.delta?(s.model.set({userName:t.delta.username,DeltaClientHost:t.delta.options.host,DeltaClientPort:t.delta.options.port,DeltaClientSecure:t.delta.options.secure,DeltaClientFromUrl:t.delta.options.fromURL}),c.DeltaClientLib.initializeDeltaClientCopy(t.delta.client,s.model.get("DeltaClientHost"),s.model.get("DeltaClientPort"),s.model.get("DeltaClientSecure"),s.model.get("DeltaClientFromUrl"),t.delta.username,t.delta.password,null,function(e){alert(e)},s.appid)):t.deltaToken||t.credentials?($(c.DeltaClientLib).one("DeltaClientLogin",function(e){s.model.set("userName",c.DeltaClientLib.deltaClient.user()),t.deltaToken&&$.cookie("deltaToken",t.deltaToken,{expires:30,path:"/"})}),s.initializeDeltaClient(t.credentials?t.credentials.username:null,t.credentials?t.credentials.password:null,null,t.deltaToken)):s.showLogin(),"MutationObserver"in window&&(s.observer=new MutationObserver(function(e){for(var t=0;t<e.length;t++){var i=e[t].addedNodes;if(i)for(var n=0;n<i.length;n++){var o=i[n];"ui-datepicker-div"===o.id?s.$documentDialogPanel[0].appendChild(o):_.isString(o.className)&&-1!==o.className.indexOf("select2-container")&&(-1!==o.className.indexOf("select2-container--document-selector")||-1!==o.className.indexOf("select2-container--dashboards-properties")||-1!==o.className.indexOf("select2--environment")?s.$environmentDialogPanel:s.$documentDialogPanel)[0].appendChild(o)}}}),s.observer.observe(document.querySelector("body"),{attributes:!1,childList:!0,characterData:!1})),s.initializeEvents(),s.fixSelect2DialogIssue()};try{c.InitializeQuickbase(i)}catch(e){console.log("error loading quickbase",e),_.isFunction()&&(window.t=function(e){return e},i())}window.startPdfCreation=this.startPdfCreation},initializeEvents:function(){var o=this,e=this.model.get("isLite")?c.DashClient.client:c.DeltaClientLib;$(window).resize($.proxy(this.onResize,this)),this.listenTo(this.toolbar,"themeChange",this.setThemeFromCookie),$(e).one("DeltaClientConnect",function(){o.hideLoadingScreen(),$(e).on("DeltaClientConnect",function(){o.hideLoadingScreen();var e=o.getCurrentDocument();e&&e.get("data").getTreeList().forEach(function(e){e.stop(),e.start()})})}),$(e).on("DeltaClientDisconnect",function(e,i){var n=o.getCurrentDocument();i=i?_.startCase(i)+": ":"",o.showLoadingScreen(i+t("reconnecting...")),n&&o.getCurrentDocument().get("data").getTreeList().forEach(function(e){e.stop()})}),$(e).one("DeltaClientLogin",$.proxy(this.onDeltaClientLogin,this)),this.listenTo(this.viewModel,"change:buildMode",this.onBuildModeChange),this.listenTo(this.viewModel,"change:selectedDocumentId",this.onDocumentChanged),this.listenTo(this.viewModel,"processIncomingViewState",this.processIncomingViewState),window.onbeforeunload=function(e){var t=o.getCurrentDocument(),i="There are unsaved changes in this dashboard.",n=!1;if(t&&t.get("data").getTreeList().forEach(function(e){e.stop()}),n=t&&t.get("unsavedViewerPrompt")&&(t.get("viewState").wasChanged||_.some(c.ComponentView.getInstances(),function(e){return e.beforeRemove()}))?!0:n)return(e||window.event).returnValue=i}},initializeDeltaClient:function(i,n,o,s,a,l){var r=this;c.DeltaClientLib.initializeDeltaClient(r.model.get("DeltaClientHost"),r.model.get("DeltaClientPort"),r.model.get("DeltaClientSecure"),r.model.get("DeltaClientFromUrl"),i,n,null,function(e){var t;_.isFunction(o)?o(e):(t=_.isString(e)?e.toLowerCase():null,"loginRequired"===e?r.showLogin():"userSessionLimit"===e?r.showForceLoginPrompt(function(){r.initializeDeltaClient(i,n,o,s,a,l)}):(t&&_.some(["login","token","session","websocket"]),r.showLogin(e)))},s,r.appid,!0,!!a,!!l)},fixSelect2DialogIssue:function(){var t;$.ui&&$.ui.dialog&&$.ui.dialog.prototype._allowInteraction&&(t=$.ui.dialog.prototype._allowInteraction,$.ui.dialog.prototype._allowInteraction=function(e){return!!$(e.target).closest(".select2-dropdown").length||t.apply(this,arguments)})},getAPIPrefix:function(){return"file:"===location.protocol||"FSBL"in window?"http://localhost:10001/api/":"/api/"},getCurrentDocument:function(){var t=this.viewModel.get("selectedDocumentId");return this.model.get("documents").find(function(e){return e.id===t})},onBuildModeChange:function(){this.$el.toggleClass("buildMode",this.viewModel.get("buildMode"))},onDocumentChanged:function(){var e,t,i;this.viewModel.get("selectedDocumentId")&&(i=(t=this.model.get("documents").get(this.viewModel.get("selectedDocumentId"))).get("themeSwitchable"),this.viewModel.set("themeSwitchable",i),window.isPDF?((e=this.model.get("documents").get(this.viewModel.get("selectedDocumentId")))&&$("html").addClass(e.get("dashboardTheme")),t.get("relativeHeight")?$("html").toggleClass("one-page",!0):$("html").toggleClass("one-page",!1)):$("html").toggleClass("one-page",!1),this.resetDocumentView(t),this.onResize(),this.processIncomingViewState(t),this.viewModel.set("userConfigurable",!1)),i=t?(i?this.setThemeFromCookie():"None"!==(e=t.get("dashboardTheme"))&&(this.viewModel.set("DashboardTheme",e),this.setDocumentTheme(e),this.setEnvironmentTheme(e)),t.get("name")+this.DOCUMENT_TITLE.SEPARATOR+this.DOCUMENT_TITLE.SUFFIX):this.DOCUMENT_TITLE.SUFFIX,$(document).attr("title",i)},onDeltaClientLogin:function(){y.Log("Dash Documents Fetch"),this.model.get("documents").fetch({success:$.proxy(this.onDocumentsFetched,this),error:function(){alert("document fetch error")},reset:!0}),this.model.get("isLite")?this.model.set("userName","User"):(this.model.set("userName",c.DeltaClientLib.username),this.updateUserComponents(),this.onPopulateDeltaClientInformation(),c.DeltaClientLib.showLastLoginAttempts&&this.onShowLastLoginAttempts())},onPopulateDeltaClientInformation:function(){var t=this;c.DeltaClientLib.getAPIQueryData("kdb",void 0,".ui.controlDetails",[],function(e){t.model.set("dashboardControlDetails",e.rows.reduce(function(e,t){return e[t.Property]=_.isArray(t.Value)?t.Value.join(""):t.Value,e},{}))},function(e){console.log("Error Fetching Delta Client Information:",e)},100,!1)},onDocumentsFetched:function(){y.Log("Dash Documents Complete"),this.router=new k({dialogContainer:this.$environmentDialogPanel,model:this.model,viewModel:this.viewModel}),this.model.set("router",this.router);var e,t=this.model.get("pushStateBase");t&&((e=document.createElement("base")).setAttribute("href",t),document.getElementsByTagName("head")[0].appendChild(e)),d.history.start(t?{pushState:!!t,root:t}:void 0),d.history.fragment.length<=0&&((e=this.viewModel.get("selectedDocumentId"))||0<(t=this.model.get("documents").getSortedDocuments()).length&&(e=t[0].id),e?this.router.navigate(e,{trigger:!0}):y.Error("this user doesn't have any dashboards")),this.hideLoadingScreen()},onResize:function(){this.documentView&&this.documentView.onResize(),this.toolbar&&this.toolbar.onResize&&this.toolbar.onResize()},onShowLastLoginAttempts:function(){var e,t=c.DeltaClientLib.showLastLoginAttempts,i="",n=this;if("failures"===t||"true"===t)e=".session.getFailedLoginsUI",i="Unsuccessful login attempts:";else{if("all"!==t)return;e=".session.getLoginsUI",i="Last 10 login attempts:"}c.DeltaClientLib.getAPIQueryData("kdb",void 0,e,[],function(e){var e=_.filter(e.rows,function(e){return e.machineID&&0<e.machineID.length});0<e.length&&(e=new L({appModel:n.model,model:new d.Model({rows:e})}),n.notificator.notify(i,e.$el))},function(e){console.log("show last login attempts error:",e)},100,!1)},processIncomingViewState:function(i){var e=this.viewModel.get("incomingViewState");e&&(_.each(e,function(e,t){var n=i.get("viewState").getByPath(t);n&&(".settings"===t?_.each(e,function(e,t){var i=n.get(t);i?i.set(e):(i=new d.Model(e),n.set(t,i))}):n.set("value",e))}),this.viewModel.unset("incomingViewState"))},remove:function(){this.observer.disconnect(),d.View.prototype.remove.call(this)},render:function(){this.model.get("isLite")?this.$el.addClass("quick-view quick-base is-lite"):this.$el.addClass("quick-view quick-base"),this.$el.html(n.app()),this.$notificationsDiv=this.$(".notifications-div"),this.notificator=new x({el:this.$notificationsDiv}),this.$documentDialogPanel=this.$el.find("> .dialog-panel .document"),this.$documentViewDiv=this.$el.find(".document-view-div"),this.$environmentDialogPanel=this.$el.find("> .dialog-panel .environment"),this.toolbar=new S({el:this.$el.find(".toolbar-div"),appModel:this.model,dialogContainer:this.$environmentDialogPanel,themes:this.THEMES,viewModel:this.viewModel})},resetDocumentView:function(e){var t,i;this.documentView&&(this.documentView.remove(),this.documentView=null),(i=c.NotificationManager).setDocumentDataModel(e.get("data")),t=i.CONFIG.upgradeConfig(e.get("notifications")),i.setOptions(t),this.documentView=new c.DocumentView({appModel:this.model,model:e,quickView:!0,viewModel:this.viewModel}),this.$documentViewDiv.append(this.documentView.$el)},setThemeFromCookie:function(){this.environmentTheme=$.cookie("dashboard-viewer-theme")||this.THEMES[0].id,this.setEnvironmentTheme(this.environmentTheme),this.setDocumentTheme(this.environmentTheme),_.includes(self.THEMES,this.environmentTheme)&&require(["css!"+this.environmentTheme])},setDocumentTheme:function(e){var t,i;switch(e){case"kx-darkroom":case"Dark":t="kx-darkroom",i="Dark";break;case"kx-light":case"Light":t="kx-light",i="Light"}"None"!==e&&(this.viewModel.set("DashboardTheme",i),_.each([this.$documentViewDiv,this.$documentDialogPanel],function(e){e&&(e.removeClass("Dark Light kx-darkroom kx-light"),e.addClass(i),e.addClass(t))}))},setEnvironmentTheme:function(t){switch(t){case"Dark":t="kx-darkroom";break;case"Light":t="kx-light"}_.each([this.toolbar.$el,this.$environmentDialogPanel,this.$notificationsDiv],function(e){e&&e.removeClass("Dark Light kx-darkroom kx-light").addClass(t)})},showForceLoginPrompt:function(e){c.ConfirmDialog.ShowConfirm({dialogTitle:"Session Limit exceeded",renderTemplate:function(){return t("User session limit has been reached, terminate oldest open session?")},callback:e,cancelBtnCallback:this.showLogin.bind(this),container:this.$environmentDialogPanel})},showLoadingScreen:function(e){this.loadingScreen&&this.loadingScreen.remove(),this.loadingScreen=new D({loadingText:e}),this.$el.append(this.loadingScreen.$el)},showLogin:function(e){var o=this;new c.LoginDialog({appModel:this.model,container:this.$environmentDialogPanel,errorMessage:e,doLogin:function(t,i,n){o.initializeDeltaClient(t,i,function(e){"loginRequired"===e?o.showLogin():"userSessionLimit"===e?o.showForceLoginPrompt(function(){o.initializeDeltaClient(t,i,n,null,null,!0)}):n(e)})}})},startPdfCreation:function(){0<$("body.pdf").length&&0<$(".pdf-expandable").length&&($(".fillHeightMode").toggleClass("fillHeightMode",!1),$("html").toggleClass("pdf-flow-layout",!0))},updateUserComponents:function(){var t=this.model.get("components");c.DeltaClientLib.getComponents(function(e){t.remove(t.where({user:!0})),_.each(e,function(e){e=$.parseJSON(e.dataJSON);e.user=!0,t.add(e)})},function(e){y.Error("DeltaClientLib.getComponents: Error",e)})}})});