define(["backbone","Handlebars","QuickBase","moment","vega","xlsx","css!./css/app.css"],function(i,t,n,e,a,s){"use strict";var o,r=this&&this.__extends||(o=function(t,e){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)},function(t,e){function i(){this.constructor=t}o(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}),h={JSON:null,isLoading:!1},u=(c.getComponentDefinition=function(t){var e={id:1,componentName:"Chart Vega",componentDescription:"",appKey:"ChartVega",appArgs:{quickStart:[{path:"Basics.Data",message:"populate Data"},{path:"Basics.Config",message:"set Config"}],json:{version:"4.3.1",Basics:{Data:"",Config:"",Renderer:"canvas"},Style:{advanced:""}},schema:{type:"object",title:"Properties",properties:{Basics:{type:"object",title:"Basics",options:{collapsed:!1},properties:{Data:{type:"data",title:"Data Source",default:"",format:"data"},Config:{type:"json",title:"Vega Config",options:{jsonSchema:function(){return h.JSON}},default:""},Renderer:{type:"string",title:"Render Type",default:"canvas",enum:["canvas","svg"]}}},Style:{type:"object",options:{collapsed:!0},properties:{advanced:{type:"css",title:"Advanced CSS",default:""}}}}}}};if(0<_.keys(t.settingsModel.attributes).length)for(var i=c.upgrades.indexOf(_.find(c.upgrades,{version:t.settingsModel.get("version")}))+1;i<c.upgrades.length;i+=1){var n=c.upgrades[i];n.fn(t.settingsModel),t.settingsModel.set("version",n.version)}return e},c);function c(){}u.upgrades=[];l.app=t.template({compiler:[8,">= 4.3.0"],main:function(t,e,i,n,a){var s=t.lookupProperty||function(t,e){if(Object.prototype.hasOwnProperty.call(t,e))return t[e]};return'<div class="chartVega">\n    <div id="'+t.escapeExpression("function"==typeof(i=null!=(i=s(i,"chartId")||(null!=e?s(e,"chartId"):e))?i:t.hooks.helperMissing)?i.call(null!=e?e:t.nullContext||{},{name:"chartId",hash:{},data:a,loc:{start:{line:2,column:13},end:{line:2,column:24}}}):i)+'" class="pnlChart"></div>\n</div>'},useData:!0});var p,d=l;function l(){}function g(t){var e=p.call(this,t)||this;return e.chartId=_.uniqueId("chartVega"),e.currentData=null,e.hasInit=!1,e.useAutoResizeWidth=!1,e.useAutoResizeHeight=!1,e.vegaView=null,e.vegaPadding=0,e.viewModel=new i.DeepModel,e.$chart=null,e.api=t.api,e.render(),t.api.isBuildMode()&&e.loadEditorSchema(),e}return p=i.View,r(g,p),g.prototype.initializeEvents=function(){this.listenTo(this.viewModel,"change:Basics.Config",this.onPropChange_Config),this.listenTo(this.viewModel,"change:Basics.Data",this.onPropChange_Data),this.listenTo(this.viewModel,"change:Basics.Renderer",this.onPropChange_Renderer)},g.prototype.loadEditorSchema=function(){h.JSON||h.isLoading||(h.isLoading=!0,require(["json!vegaSchema"],function(t){h.JSON=t,h.isLoading=!1}))},g.prototype.onData=function(t,e,i){this.currentData=e.items(),this.renderChart()},g.prototype.onSettingsChange=function(t){var i=this;_.each(t,function(t,e){i.viewModel.set(e,t)}),this.hasInit||(this.hasInit=!0,this.initializeEvents(),this.viewModel.get("Basics.Data")?this.onPropChange_Data():this.onPropChange_Config())},g.prototype.onPropChange_Config=function(){this.renderChart()},g.prototype.onPropChange_Data=function(){this.unsubscribeFromModel();var t=this.viewModel.get("Basics.Data");t?(this.model=t,this.api.subscribe(this.model,this.onData.bind(this))):this.renderChart()},g.prototype.onPropChange_Renderer=function(){this.renderChart()},g.prototype.onResize=function(){var t=this;this.onResize=_.debounce(function(){t.updateChartSize()},500),this.onResize()},g.prototype.remove=function(){return this.unsubscribeFromModel(),this.removeChart(),i.View.prototype.remove.apply(this)},g.prototype.removeChart=function(){this.vegaView&&(this.vegaView.finalize().run(),this.vegaView=null,this.$chart&&(this.$chart.remove(),this.$chart=null),this.render())},g.prototype.render=function(){return this.$el.html(d.app({chartId:this.chartId})),this.$chart=this.$("#"+this.chartId),this},g.prototype.renderChart=function(){this.removeChart();var e=this.api.getProperty("Basics.Config"),t=this.api.getProperty("Basics.Renderer");if(e){var i=void 0;try{i=JSON.parse(e)}catch(t){return void n.Log.Error("ChartVega: JSON config",t)}this.currentData&&(_.set(i,"data[0].values",this.currentData),_.unset(i,"data[0].url"),_.unset(i,"data[0].format")),this.setupAutoResize(i);e=void 0;try{e=a.parse(i)}catch(t){e=null,n.Log.Error("ChartVega: Vega config",t)}e&&(this.vegaView=new a.View(e,{container:"#"+this.chartId,logLevel:a.Warn,renderer:t||"canvas",hover:!0}),this.updateChartSize(!0))}},g.prototype.setupAutoResize=function(t){this.vegaPadding=t.padding||0,this.useAutoResizeWidth=void 0===t.width,this.useAutoResizeHeight=void 0===t.height,void 0===t.autosize&&(this.useAutoResizeWidth||this.useAutoResizeHeight)&&(t.autosize="fit")},g.prototype.unsubscribeFromModel=function(){this.model&&(this.currentData=null,this.api.unsubscribe(this.model),this.model=null)},g.prototype.updateChartSize=function(t){var e;this.vegaView&&this.$chart&&((this.useAutoResizeWidth||this.useAutoResizeHeight)&&(this.useAutoResizeWidth&&(e=Math.max(0,(this.$chart.innerWidth()||0)-2*this.vegaPadding),this.vegaView.width(e)),this.useAutoResizeHeight&&(e=Math.max(0,(this.$chart.innerHeight()||0)-2*this.vegaPadding),this.vegaView.height(e)),t=!0),t&&this.vegaView.run())},g.getComponentDefinition=u.getComponentDefinition,g});