define(["backbone","Handlebars","QuickBase","css!./css/app.css"],function(e,t,l){"use strict";var n,i=this&&this.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)},function(e,t){function i(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}),s=(a.getComponentDefinition=function(e){var t,i,n={id:667,componentName:"Editable Dropdown",componentDescription:"Editable dropdown",appKey:"EditableList",css:"EditableList",appArgs:{quickStart:[{path:"Basics.Data",message:"populate Data Source"}],json:{version:"4.7.1p1",Style:{advanced:""},Validation:{NewKey:"",ValidationAnalytic:""},Basics:{Data:"",Dropdown:!0,SelectedKey:"",SelectedValue:"",Vertical:"Middle",ShowNew:!0,ShowSave:!0,ShowDelete:!0,PromptToSave:!0,ConfirmDelete:!0,isEnabled:!0,Template:""}},schema:{type:"object",title:"Properties",properties:{Basics:{type:"object",title:"Basics",propertyOrder:1,properties:{Data:{title:"Data Source",type:"data",default:""},Dropdown:{title:"Dropdown",type:"boolean",default:!0},SelectedKey:{title:"Selected Key",type:"string",default:""},SelectedValue:{title:"Selected Value",type:"string",default:""},Vertical:{type:"string",title:"Vertical",enum:["Top","Middle","Bottom"],default:"Middle"},ShowNew:{title:"Show New",type:"boolean",default:!0},ShowSave:{title:"Show Save",type:"boolean",default:!0},ShowDelete:{title:"Show Delete",type:"boolean",default:!0},PromptToSave:{title:"Prompt To Save",type:"boolean",default:!0},ConfirmDelete:{title:"Confirm Before Deleting",type:"boolean",default:!0},isEnabled:{type:"boolean",title:"Is Enabled",format:"checkbox",default:!0},Template:{type:"handlebar",title:"Template",default:""}}},Validation:{type:"object",title:"Validation",options:{collapsed:!0},propertyOrder:110,properties:{NewKey:{title:"New Key",type:"string",default:""},ValidationAnalytic:{type:"data",title:"Validation Analytic",default:""}}},Style:{type:"object",title:"Style",options:{collapsed:!0},propertyOrder:210,properties:{advanced:{type:"css",title:"Advanced CSS",default:""}}}},_transform:function(e,t,i,n){"Basics.ShowNew"===i?(_.set(t,"properties.Validation.options.hidden",!e.Basics.ShowNew),n(e,t)):n()}}}};if(0<_.keys(e.settingsModel.attributes).length)for(i=a.upgrades.indexOf(_.find(a.upgrades,{version:e.settingsModel.get("version")}))+1;i<a.upgrades.length;i+=1)(t=a.upgrades[i]).fn(e.settingsModel,e),e.settingsModel.set("version",t.version);return n},a);function a(){}s.upgrades=[{version:0,fn:_.noop.bind(this)},{version:"4.6.1",fn:function(e){e.set("Basics.isEnabled",!0)}},{version:"4.7.1p1",fn:function(e){e.set("Validation.NewKey",""),e.set("Validation.ValidationAnalytic","")}}];c.app=t.template({1:function(e,t,i,n,s){return'        <div class="top-row">\n            <div class="dropdown-div">\n                <select class="dropdown-select"></select>\n            </div>\n            <div class="edit-action-buttons">\n                <button class=\'new\'><i class="fa fa-file"></i></button>\n                <button class=\'save\'><i class="fa fa-save"></i><span class="save-pending fa fa-asterisk"></span></button>\n                <button class=\'delete\'><i class="fa fa-trash"></i></button>\n            </div>\n        </div>\n'},3:function(e,t,i,n,s){return"        <div class=\"table\">\n            <span class='searchSpan'><input type='text' class='search' placeholder='search here...'/></span>\n            <div class=\"items\"></div>\n        </div>\n        <div class=\"bottom-row-buttons\">\n            <button class='new'><i class=\"fa fa-file\"></i><span>New</span></button>\n            <button class='save'><span class='save-icon'><i class=\"fa fa-save\"></i><span class=\"save-pending fa fa-asterisk\"></span></span><span>Save</span></button>\n            <button class='delete'><i class=\"fa fa-trash\"></i><span>Delete</span></button>\n        </div>\n"},compiler:[8,">= 4.3.0"],main:function(e,t,i,n,s){var a=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'<div class="editable-dropdown-container">\n'+(null!=(i=a(i,"if").call(null!=t?t:e.nullContext||{},null!=t?a(t,"dropdown"):t,{name:"if",hash:{},fn:e.program(1,s,0),inverse:e.program(3,s,0),data:s,loc:{start:{line:2,column:4},end:{line:23,column:11}}}))?i:"")+"</div>\n\t\t\n\n"},useData:!0});var o,r=c;function c(){}function d(e){var t=o.call(this,e)||this;return t.keyColName="",t.valueColName="",t.columnTypes=[],t.columnNames=[],t.datasource=null,t.iconMap={},t.keyUpdateRequired=!1,t.rendering=!1,t.savePending=!1,t.subscriptionKeys=[],t.api=e.api,t}return o=e.View,i(d,o),d.prototype.onSettingsChange=function(e){this.callIfDef(e,d.PROP_DATA,this.onDataSourceChange.bind(this)),this.callIfDef(e,d.PROP_DROPDOWN,this.onDropdownChange.bind(this)),this.callIfDef(e,d.PROP_SELECTEDKEY,this.onSelectedKeyChange.bind(this)),this.callIfDef(e,d.PROP_SELECTEDVALUE,this.onSelectedValueChange.bind(this)),this.callIfDef(e,d.PROP_NEW,this.onIconChange.bind(this)),this.callIfDef(e,d.PROP_SAVE,this.onIconChange.bind(this)),this.callIfDef(e,d.PROP_DELETE,this.onIconChange.bind(this)),this.callIfDef(e,d.PROP_TEMPLATE,this.onTemplateChange.bind(this)),this.callIfDef(e,d.PROP_VERTICAL,this.onVerticalChange.bind(this)),this.callIfDef(e,d.PROP_ENABLED,this.toggleList.bind(this))},d.prototype.remove=function(){return this.unsubscribe(),this.unsubscribeTemplateViewStates(),e.View.prototype.remove.apply(this)},d.prototype.setTheme=function(e){"Light"===e?this.$el.addClass("Light"):this.$el.removeClass("Light")},d.prototype.convertRowsToColumns=function(e){var i={};return _.each(e,function(e){_.each(e,function(e,t){_.has(i,t)||(i[t]=[]),e&&"string"==typeof(e=e.class&&"1216"===e.class?e.i:e)&&0===e.length&&(e=null),i[t].push(e)})}),i},d.prototype.createAndAppendItem=function(e,t,i,n){var s=document.createElement("div");return s.innerHTML=e,s.className=t,s.setAttribute(i,n),null!=(e=this.$items)&&e.append(s),$(s)},d.prototype.createItems=function(e,t){e.empty().trigger("change"),_.each(this.items,t),this.setSelectedItemValue(this.api.getProperty(d.PROP_SELECTEDKEY)),this.data&&this.setSelectedValueFromKey(this.api.getProperty(d.PROP_SELECTEDKEY)),!this.rendering&&this.savePending&&this.$saveIcon&&this.$saveIcon.click()},d.prototype.findItemFromDatasource=function(e){var t;return this.data?this.data.collection.find(((t={})[this.keyColName]=e,t)):void 0},d.prototype.getSelectedItemValue=function(){return this.$dropdownSelect&&this.api.getProperty(d.PROP_DROPDOWN)?this.$dropdownSelect.val():this.$items&&0<this.$items.find(".selected").length?this.$items.find(".selected")[0].getAttribute("key"):""},d.prototype.handleKeyChange=function(e){var t;e?(t=this.api.getProperty(d.PROP_SELECTEDKEY),this.setSelectedItemValue(t)):(t=this.getSelectedItemValue(),this.api.setProperty(d.PROP_SELECTEDKEY,t),this.setSelectedValueFromKey(t))},d.prototype.hideOrShowElement=function(e,t){t?e.show():e.hide()},d.prototype.initializeSelect2=function(){var e;null!=(e=this.$dropdownSelect)&&e.select2({theme:"dashboards",width:"100%",escapeMarkup:function(e){return e}})},d.prototype.onDataSourceChange=function(e){var i=this;this.unsubscribe(),this.datasource=e,this.data=null,this.datasource&&this.api.subscribe(this.datasource,function(e,t){i.columnNames=e.columns.collection.pluck("id"),i.columnTypes=e.columns.collection.pluck("kdbType"),i.keyColName=-1<i.columnNames.indexOf("key")?"key":i.columnNames[0],i.valueColName=-1<i.columnNames.indexOf("value")?"value":i.columnNames[1],i.data=t,i.api.setProperty("keyColPossibleValues",i.columnNames),i.api.setProperty("valueColPossibleValues",i.columnNames),_.isEmpty(i.api.getProperty(d.PROP_TEMPLATE))&&i.api.setProperty(d.PROP_TEMPLATE,"{{"+i.columnNames[0]+"}}"),i.keyUpdateRequired&&(t.add&&0<t.add.length||t.reset&&0<t.reset.length)&&(i.setSelectedItemValue(),e=(t.add||t.reset)[0][i.keyColName],i.api.setProperty(d.PROP_SELECTEDKEY,e),i.keyUpdateRequired=!1),i.renderItems()})},d.prototype.onDelete=function(){var e,t=this.getSelectedItemValue(),t=this.findItemFromDatasource(t);this.setSavePending(!1),t&&(e=1<=t.id?t.id-1:t.id+1,(e=this.data.collection.get(e))?(e=e.get(this.keyColName),this.setSelectedItemValue(e),this.api.setProperty(d.PROP_SELECTEDKEY,e)):this.api.setProperty(d.PROP_SELECTEDKEY,null),this.updateData({},{},[t.attributes]))},d.prototype.onDeleteClicked=function(){var e=this;this.api.getProperty("Basics.ConfirmDelete")?l.ConfirmDialog.ShowDelete(function(){return e.onDelete()},"Are you sure you want to delete this item?"):this.onDelete()},d.prototype.onDropdownChange=function(){this.renderLayout()},d.prototype.toggleList=function(){var e=this.api.getProperty(d.PROP_ENABLED),t=this.$el.find(".editable-dropdown-container");e?(t.css("pointer-events","auto"),t.fadeTo(10,1)):(t.css("pointer-events","none"),t.fadeTo(10,.2))},d.prototype.onTemplateChange=function(){this.unsubscribeTemplateViewStates(),this.handlebar=t.compile(this.api.getProperty(d.PROP_TEMPLATE)),this.data&&this.renderItems()},d.prototype.onIconChange=function(e,t){this.hideOrShowElement(this.iconMap[t],e)},d.prototype.onNewClicked=function(){var o=this,t=this.setSavePending.bind(this),e=_.bind(function(){return l.SimpleInputDialog.ShowInput(function(){var n,s,a,e;(n=void 0===(n=this.inputValue)?"":n)&&(o.findItemFromDatasource(n)?new l.ErrorDialog.ShowError("An item already exists with that key. You must choose a different key",o.onNewClicked.bind(o)):(o.api.setProperty(d.PROP_NEWKEY,n),s=o.api.getProperty("Validation").ValidationAnalytic,a=function(e){var t={};_.each(o.columnNames,function(e){t[e]=null}),t[o.keyColName]=e,o.updateData([t],{},{})},s?(e=s.get("_queryString"),_.isUndefined(e)||0!==e.length?(o.api.hideQueryStatus(),o.api.subscribe(s,function(e,t,i){i?o.api.showQueryStatus(i):(o.api.hideQueryStatus(),t.reset&&0<t.reset.length&&(i=e.columns.collection.models[0].id,""!==t.reset[0][i]?(e=0<t.reset[0][i].length?t.reset[0][i]:"Unexpected error. Please check validation analytic.",new l.ErrorDialog.ShowError(e,o.onNewClicked.bind(o))):a(n)),o.api.unsubscribe(s))})):new l.WarningDialog.ShowWarning("Empty Validation Analytic : "+s.path+"<br>The provided key will be accepted.",a.bind(o,n))):a(n))),t(!1)},"Create New Key...",o.keyColName+":","fa-save","","create-new-item",!1)},this);this.saveAndExecute(e,function(){o.onSaveClicked(),e()},e,_.noop.bind(this))},d.prototype.onSaveClicked=function(e){_.isUndefined(e)&&(e=this.api.getProperty(d.PROP_SELECTEDKEY));var t,e=this.findItemFromDatasource(e);e&&(e.set(((t={})[this.valueColName]=this.api.getProperty(d.PROP_SELECTEDVALUE),t)),this.updateData({},[e.attributes],{})),this.setSavePending(!1)},d.prototype.onSelectedKeyChange=function(){var e=this.api.getProperty(d.PROP_SELECTEDKEY),t=this.getSelectedItemValue();_.isNull(t)||t===e||(this.onSaveClicked(t),this.setSelectedItemValue(e),this.setSelectedValueFromKey(e))},d.prototype.onSelectedValueChange=function(e){this.showSavePendingIfNecessary(e)},d.prototype.onVerticalChange=function(e){var t=this.$el.find(".editable-dropdown-container");switch(t.toggleClass("bottom",!1),t.toggleClass("middle",!1),t.toggleClass("top",!1),e){case"Bottom":t.toggleClass("bottom",!0);break;case"Middle":t.toggleClass("middle",!0);break;case"Top":t.toggleClass("top",!0)}},d.prototype.callIfDef=function(e,t,i){void 0!==e[t]&&i.call(this,e[t],t)},d.prototype.populateItems=function(){var i=this;this.data&&(this.items=_.reduce(this.data.collection.models,function(e,t){return _.isEmpty(i.keyColName)||_.isEmpty(i.valueColName)||(e[t.get(i.keyColName)]={text:t.get(i.keyColName),value:t.get(i.valueColName)}),e},{}))},d.prototype.renderItems=function(){this.api.getProperty(d.PROP_DROPDOWN)?this.renderDropdown():this.renderTable()},d.prototype.renderDropdown=function(){var s=this;this.populateItems(),this.unsubscribeTemplateViewStates(),this.$dropdownSelect&&this.createItems(this.$dropdownSelect,function(e,n){var t;null!=(t=s.$dropdownSelect)&&t.append(new Option(e.text,n)).trigger("change"),s.subscriptionKeys.push(s.api.subscribeTemplateViewStates(s.api.getProperty(d.PROP_TEMPLATE),function(e){var t,i=s.findItemFromDatasource(n);i&&s.handlebar&&(null!=(t=s.$dropdownSelect)&&t.select2("destroy"),null!=(t=s.$dropdownSelect)&&t.find('option[value="'+n+'"]').text(s.handlebar(_.extend(i.attributes,e))),s.initializeSelect2())}))})},d.prototype.renderLayout=function(){var e,s=this;this.rendering=!0,this.$el.html(r.app({dropdown:this.api.getProperty(d.PROP_DROPDOWN)})),this.onVerticalChange(this.api.getProperty(d.PROP_VERTICAL)),this.savePending||this.setSavePending(!1),this.iconMap=((e={})[d.PROP_NEW]=this.$newIcon=this.$el.find(".new"),e[d.PROP_SAVE]=this.$saveIcon=this.$el.find(".save"),e[d.PROP_DELETE]=this.$deleteIcon=this.$el.find(".delete"),e),_.each(this.iconMap,function(e,t){e.button(),s.hideOrShowElement(e,s.api.getProperty(t))}),this.$newIcon.on("click",function(){return s.onNewClicked()}),this.$deleteIcon.on("click",function(){return s.onDeleteClicked()}),this.$saveIcon.on("click",function(){return s.onSaveClicked()}),this.api.getProperty(d.PROP_DROPDOWN)?(this.$dropdownSelect=this.$el.find(".dropdown-select"),this.initializeSelect2(),this.$dropdownSelect.on("select2:select",function(){return s.selectItem()}),this.renderDropdown()):(this.$table=this.$el.find(".table"),this.$search=this.$el.find(".search"),this.$items=this.$el.find(".items"),this.$search.keyup(function(i){var n=!1;_.each($(i.target).parent().parent().find(".item:not(#noResults)"),function(e){var t=i.target.value.toLowerCase(),t=e.innerText.toLowerCase().includes(t);s.hideOrShowElement($(e),t),n=n||t}),s.$noResults&&s.hideOrShowElement(s.$noResults,!n)}),this.renderTable()),this.rendering=!1},d.prototype.renderTable=function(){var e,s=this;this.populateItems(),this.unsubscribeTemplateViewStates(),this.$items&&this.createItems(this.$items,function(e,n){e=s.createAndAppendItem(e.text,"item","key",n);s.subscriptionKeys.push(s.api.subscribeTemplateViewStates(s.api.getProperty(d.PROP_TEMPLATE),function(e){var t,i=s.findItemFromDatasource(n);i&&s.handlebar&&null!=(t=s.$items)&&t.find('[key="'+n+'"]').html(s.handlebar(_.extend(i.attributes,e)))})),e.click(function(e){var t=null==(t=s.$items)?void 0:t.find(".selected");t&&t.removeClass("selected"),e.target.className+=" selected",s.selectItem()})}),this.$noResults=this.createAndAppendItem("No results found","item","id","noResults"),this.$noResults.hide(),null!=(e=this.$search)&&e.val("")},d.prototype.saveAndExecute=function(e,t,i,n){this.savePending?this.api.getProperty(d.PROP_SAVEPROMPT)?new l.AreYouSureDialog({saveCb:t,noSaveCb:i,dialogTitle:"Save changes?"}).on("close",n):(this.setSavePending(!1),e()):e()},d.prototype.selectItem=function(){var t=this;this.saveAndExecute(function(){t.handleKeyChange(!1)},function(){t.onSaveClicked(),t.handleKeyChange(!1)},function(){t.setSavePending(!1),t.handleKeyChange(!1)},function(e){"cancel"===e&&t.handleKeyChange(!0)})},d.prototype.setSavePending=function(e){this.$el.find(".save-pending").toggle(e),this.savePending=e},d.prototype.setSelectedItemValue=function(e){var t;void 0===e&&(e=""),this.api.getProperty(d.PROP_DROPDOWN)?null!=(t=this.$dropdownSelect)&&t.val(e).trigger("change"):this.$items&&(this.$items.find(".selected").removeClass("selected"),this.$items.find("[key='"+(e||"").replace(/'/g,"\\'")+"']").addClass("selected"))},d.prototype.setSelectedValueFromKey=function(e){this.items&&(e=this.items[e])&&this.api.setProperty(d.PROP_SELECTEDVALUE,e.value)},d.prototype.showSavePendingIfNecessary=function(e){var t;this.data&&(t=this.findItemFromDatasource(this.api.getProperty(d.PROP_SELECTEDKEY)),this.setSavePending(!!t&&!_.isEqual(e,t.get(this.valueColName))))},d.prototype.unsubscribe=function(){this.api.unsubscribe(this.datasource)},d.prototype.unsubscribeTemplateViewStates=function(){var t=this;0<this.subscriptionKeys.length&&(_.each(this.subscriptionKeys,function(e){t.api.unsubscribeTemplateViewStates(e)}),this.subscriptionKeys=[])},d.prototype.updateData=function(e,t,i){function n(e){return _.map(e,function(e){return _.omit(e,"_rowIndex")})}var s=this,a=(this.addedItems=e,{}),e=(_.each(this.columnNames,function(e,t){a[e]=s.columnTypes[t]}),{typeConfig:a,addedDict:{items:this.convertRowsToColumns(n(e))},updatedDict:{items:this.convertRowsToColumns(n(t))},deletedDict:{items:this.convertRowsToColumns(n(i))}});this.api.updateTable(this.datasource,e,function(){_.isEmpty(s.addedItems)||(s.keyUpdateRequired=!0)},_.noop.bind(this))},d.getComponentDefinition=s.getComponentDefinition,d.PROP_DATA="Basics.Data",d.PROP_DELETE="Basics.ShowDelete",d.PROP_DROPDOWN="Basics.Dropdown",d.PROP_NEW="Basics.ShowNew",d.PROP_SAVE="Basics.ShowSave",d.PROP_SAVEPROMPT="Basics.PromptToSave",d.PROP_SELECTEDKEY="Basics.SelectedKey",d.PROP_SELECTEDVALUE="Basics.SelectedValue",d.PROP_TEMPLATE="Basics.Template",d.PROP_VERTICAL="Basics.Vertical",d.PROP_ENABLED="Basics.isEnabled",d.PROP_NEWKEY="Validation.NewKey",d.PROP_VALIDATION_ANALYTIC="Validation.ValidationAnalytic",d});