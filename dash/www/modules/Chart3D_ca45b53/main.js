define(["Handlebars","QuickBase","vis","moment","xlsx","backbone","css!./css/app.css"],function(c,t,h,p,e,i){"use strict";var r,a,o=this&&this.__extends||(r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)},function(t,e){function i(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}),s=(a=i.DeepModel,o(n,a),n.prototype.initialize=function(){},n.prototype.updateData=function(o){var s=this,n=new h.DataSet,l=this.get("X.Data"),p=this.get("Y.Data"),u=this.get("Z.Data"),c=this.get("Volume.Data"),t=this.get("X.AxisType"),e=this.get("Y.AxisType"),i=this.get("Z.AxisType"),r=this.get("Style.ColorPalette.ColorScheme"),d=_.reverse(_.map(r,function(t){return t.type}));o?(this.axisLabels={},this.axisCache={},this.chartData=void 0,"Category"===t&&this.possibeLabels(o,l,"x"),"Category"===e&&this.possibeLabels(o,p,"y"),"Category"===i&&this.possibeLabels(o,u,"z"),-1<_.indexOf(["dot-color","dot-size","dot-line","bar-color","bar-size","bar-line"],this.get("Basics.Type"))?(this.columns=[this.get("X.Label"),this.get("Y.Label"),this.get("Z.Label"),"value"],_.each(o.getData().models,function(t){var e=void 0===(e=t.get(o.getPropertyFromColumn(l)))?0:e,i=void 0===(i=t.get(o.getPropertyFromColumn(p)))?0:i,r=void 0===(r=t.get(o.getPropertyFromColumn(u)))?0:r,a=void 0===(a=t.get(o.getPropertyFromColumn(c)))?0:a;n.add({x:s.axisLabels.x?s.axisLabels.x[e]:parseFloat(e),y:s.axisLabels.y?s.axisLabels.y[i]:parseFloat(i),z:s.axisLabels.z?s.axisLabels.z[r]:parseFloat(r),style:void 0===parseFloat(a)?0:parseFloat(a),data:t.attributes,colorScheme:d})})):(this.columns=[this.get("X.Label"),this.get("Y.Label"),this.get("Z.Label")],_.each(o.getData().models,function(t){var e=void 0===(e=t.get(o.getPropertyFromColumn(l)))?0:e,i=void 0===(i=t.get(o.getPropertyFromColumn(p)))?0:i,r=void 0===(r=t.get(o.getPropertyFromColumn(u)))?0:r;n.add({x:s.parseAxis(e,"x"),y:s.parseAxis(i,"y"),z:s.parseAxis(r,"z"),style:s.parseAxis(r,"z"),data:t.attributes})})),this.chartData=n):this.initialize()},n.prototype.possibeLabels=function(t,e,i){var e=t.getPropertyFromColumn(e),t=_.sortedUniq(t.getData().pluck(e)),r={},a={},o=0;_.each(t,function(t){void 0===r[t]&&(r[t]=o,o++)}),_.each(r,function(t,e){a[t]=e}),this.axisLabels[i]=r,this.axisCache[i]=a},n.prototype.parseAxis=function(t,e){if("Time"===this.get(e.toUpperCase()+".AxisType"))return t.i||0;e=this.axisLabels[e]?this.axisLabels[e][t]:parseFloat(t);return isNaN(e)?0:e},n);function n(){var t=null!==a&&a.apply(this,arguments)||this;return t.colorCache={},t.columns=[],t.labels=[],t.labelData=[],t.chartType="chart3D",t.previousChartData={},t.axisLabels={},t.axisCache={},t}l=i.Collection,o(d,l),d.prototype.modelId=function(t){return t};var l,u=d;function d(){var t=null!==l&&l.apply(this,arguments)||this;return t.model=s,t}y.sourceKey=function(t){return t.getPath()},y.mergeChanges=function(e,i,t,r,a,o){return t&&(e=_.fromPairs(_.map(t,function(t){return[i(t),t]}))),r&&_.each(r,function(t){return _.extend(e[i(t)],t)}),a&&_.each(a,function(t){e[i(t)]=t}),o&&_.each(o,function(t){delete e[i(t)]}),e},y.prototype.setFocus=function(t){this.focus=t,this.updateChildren(),this.childDataSource&&this.childDataSource.setFocus(t)},y.prototype.isFocused=function(){return this.focus.length===this.depth&&(0===this.depth||this.source.id===this.focus[this.depth])},y.prototype.getColumnNames=function(){if(this.breakdownColumns&&this.breakdownColumns.length)return[y.BREAKDOWN_ID,this.breakdownColumns[0]].concat(_.difference(_.keys(this.meta),this.breakdownColumns));try{return _.map(this.meta,function(t){return[t.id,t.index]}).sort(function(t,e){return t[1]-e[1]}).map(function(t){return t[0]})}catch(t){return _.keys(this.meta)}},y.prototype.getColumnType=function(t){return this.childDataSource?this.childDataSource.getColumnType(t):t===y.BREAKDOWN_ID?this.meta[this.primaryKey].kdbType:this.meta[t]?this.meta[t].kdbType:11},y.prototype.getData=function(){return this.childDataSource?this.childDataSource.getData():this.source.dataSet&&this.source.dataSet.collection},y.prototype.getDepth=function(){return this.childDataSource?this.childDataSource.getDepth():this.depth},y.prototype.getKey=function(){return this.source.cid},y.prototype.getPrimaryKey=function(){return this.childDataSource?this.childDataSource.getPrimaryKey():this.primaryKey},y.prototype.getPropertyFromColumn=function(t){return t===y.BREAKDOWN_ID?this.getPrimaryKey():t},y.prototype.getPath=function(){return this.source.path},y.prototype.getSource=function(){return this.source},y.prototype.hasData=function(){return this.childDataSource?this.childDataSource.hasData():this.hasDataFlag},y.prototype.onData=function(t,e,i){t.primaryKey!==this.primaryKey&&(this.primaryKey=t.primaryKey),this.meta=y.mergeChanges(this.meta,function(t){return t.id},t.columns.reset,t.columns.change,t.columns.add,t.columns.remove),0!==this.depth||_.isEqual(t.breakdownColumns,this.breakdownColumns)||(this.breakdownColumns=t.breakdownColumns,this.removeChild()),e.reset&&0<e.reset.length&&this.removeChild(),i?this.updateError(this,i):this.listener&&this.listener.updateError(this,void 0),this.hasDataFlag=!0,this.updateChildren()&&this.listener.updateDataSource(this)},y.prototype.subscribe=function(){this.api.subscribe(this.source,this.onData.bind(this))},y.prototype.updateDataSource=function(){this.listener.updateDataSource(this)},y.prototype.updateError=function(t,e){this.listener.updateError(this,e)},y.prototype.unsubscribe=function(){this.childDataSource&&(this.childDataSource.unsubscribe(),delete this.childDataSource),this.api.unsubscribe(this.source)},y.prototype.removeChild=function(){this.childDataSource&&(this.childDataSource.unsubscribe(),delete this.childDataSource)},y.prototype.updateChildren=function(){var t;return!(this.breakdownColumns&&this.breakdownColumns.length&&this.depth<this.breakdownColumns.length-1)||(this.focus.length>this.depth?(this.childDataSource&&this.focus[this.depth]!==this.childDataSource.getSource().id&&this.removeChild(),this.childDataSource||(0!==this.depth&&(this.focus[this.depth-1],this.source.id.toString()),(t=this.source.dataSet&&this.source.dataSet.collection.get(this.focus[this.depth]))&&(this.childDataSource=new y(t,this,this.api,this.focus,this.depth+1,this.breakdownColumns),this.childDataSource.subscribe()))):(this.removeChild(),this.focus.length!==this.depth||!this.hasDataFlag||0!==this.depth&&this.focus[this.depth-1]!=this.source.id||this.listener.updateDataSource(this)),!1)},y.BREAKDOWN_ID="{breakdownId}";var m=y;function y(t,e,i,r,a,o){this.hasDataFlag=!1,this.focus=[],this.meta={},this.source=t,this.listener=e,this.api=i,this.depth=a||0,this.breakdownColumns=o,this.setFocus(r)}var f=t.Tools,g=("function"!=typeof Object.assign&&Object.defineProperty(Object,"assign",{value:function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];if(null===t)throw new TypeError("Cannot convert undefined or null to object");for(var r=Object(t),a=1;a<arguments.length;a++){var o=e[a];if(null!==o)for(var s in o)Object.prototype.hasOwnProperty.call(o,s)&&(r[s]=o[s])}return r},writable:!0,configurable:!0}),b.expandNestedViewStates=function(t,e){var i,r=/([a-zA-Z]+)\.[0-9]+\./,a=Object.keys(t),o=[];return(o=_.every(a,function(){var t=e.getPropertyMeta(a[0]);return t&&"viewstate"===t.type})?_.uniq(_.filter(_.map(a,function(t){t=r.exec(t);return t?t[1]:null}))):o).length?(i={},_.each(o,function(t){return i[t]=e.getProperty(t)}),i):t},b.focus2Array=function(t){var e=[],i=/"([^"]*)"/g,t=t.toString?t.toString():"",r=/^\[([^\]]*)]$/.exec(t);if(null!==r){if(/^(?:"[^"\\]*(?:\\[\S\s][^"\\]*)*")(?:,"[^"\\]*(?:\\[\S\s][^"\\]*)*")*/.test(r[1]))for(var a=void 0;null!==(a=i.exec(r[1]));)e.push(_.map(a[1].split(","),function(t){return t.replace(/&#44;/g,",")}))}else e.push(t.split(","));return _.filter(e,function(t){return 0<(""+t).length})},b.hex2RGB=function(t){t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return t?[parseInt(t[1],16),parseInt(t[2],16),parseInt(t[3],16)]:[0]},b.clamp=function(t,e,i){return i<t?i:t<e?e:t},b.getFormatter=function(r,a,o,s){return"Number"===r||"Formatted Number"===r||"Smart Number"===r||"Datetime"===r||"Currency"===r||"SmartCurrency"===r?function(t){var e,i=t;if(null==(t="Smart Number"!==r&&"Formatted Number"!==r||_.isNumber(t)?t:_.isNumber(parseFloat(t))?parseFloat(t):t))return"";if("Smart Number"===r)i=_.isNumber(t)?f.smartFormatNumber(t,a):_.escape(t);else{if("Datetime"===r)return e=t,p.isMoment(t)||p.isDuration(t)?(b.isDuration(t)?f.convertValueToMoment(t.valueOf()):t).format(s):f.isKDBTemporal(t)?f.convertKDBTemporalToMoment(t).format(s):("number"==typeof t&&(e=new Date(t)),f.convertDateStringValueToMoment(e.toString()).format(s));i="Formatted Number"===r&&t.toFixed?_.isNaN(t)?"":f.formatNumber(t,a):t.toFixed?t.toFixed(a):_.escape(i)}if(o&&0<=i.toString().indexOf(".")){for(;"0"===i[i.length-1];)i=i.slice(0,-1);"."===i[i.length-1]&&(i=i.slice(0,-1))}return i}:"Boolean"===r?function(t){return _.escape(t)}:function(t){return p.isMoment(t)||p.isDuration(t)?t.format(r,void 0):_.escape(t)}},b.isDuration=function(t){return _.get(t,"_kdbType")&&0<=["1216","1217","1218","1219"].indexOf(t._kdbType)},b.pump=function(i){if(null==i)return i;if(!_.isObject(i))return i;var t=Object.getPrototypeOf(i);if(_.isObject(i)&&t!==Object.prototype&&t!==Array.prototype)return i;if(t===Array.prototype&&_.isArray(i))return i.map(b.pump);var r=/^(\d+)((?:\.\w+)+)$/;if(Object.keys(i).every(function(t){return r.test(t)}))return Object.keys(i).map(function(t){var e=r.exec(t);return _.isNil(e)?{index:0,tail:void 0,value:void 0}:{index:Number(e[1]),tail:e[2].substring(1),value:i[t]}}).reduce(function(t,e){var i={},r=void 0===e.index?0:e.index;return i[r]={},i[r][e.tail]=e.value,$.extend(!0,t,b.pump(i))},[]);var a={greedy:/^(\w+)((?:\.\w+)*)$/,nonGreedy:/^(\w+)((?:\.\w+)+)$/};return Object.keys(i).some(function(t){return a.nonGreedy.test(t)})?Object.keys(i).map(function(t){var e=a.greedy.exec(t);return{head:_.isNil(e)?null:e[1],tail:_.isNil(e)||""===e[2]?null:e[2].substring(1),value:i[t]}}).reduce(function(t,e){var i={},r=null!==e.tail,a=_.isNil(e.head)?0:e.head,o=_.isNil(e.tail)?0:e.tail;return r?(i[a]={},i[a][o]=e.value):i[a]=e.value,$.extend(!0,t,b.pump(i))},{}):_.mapValues(i,b.pump)},b.replaceViewStatesWithValue=function(t,e,i){return b.replaceViewStates(t,e,function(t,e,i,r){return _.get(r,"value")!==i&&console.warn("viewModel value has changed"),_.get(r,"value")},i)},b.safeHandle=function(i){return function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];try{i.apply(this,t)}catch(t){console.error("oupsies..",t)}}},b.alpha=function(t,e){var i=this.hex2RGB(t);return i?"rgba("+i[0]+","+i[1]+","+i[2]+","+e/100+")":new Color(t).alpha(e/100).rgbaString()},b.replaceViewStates=function(i,t,l,p){var u;return u=function(t,e){return function i(t,e,r){r=r?r+".":"";var a,o,s=p.getPropertyMeta(r+(e+="")),n=t&&t.has&&t.has("_dataSource")&&t.has("_dataType"),n=(_.isArray(t)||_.isObject(t))&&!n;return s&&"data"===s.type?t:s&&"viewstate"===s.type?(a=(o=(r+e).split(".")).pop(),o=o.join("."),l(o,void 0===a?"":a,t,s)):n?(r+=e,u=function(t,e){return i(t,e,r)},(_.isArray(t)?_.map:_.mapValues)(t,u)):t}(t,e,i||"")},(_.isArray(t)?_.map:_.mapValues)(t,u)},b);function b(){}x.getComponentDefinition=function(t){var e,i;if(0<_.keys(t.settingsModel.attributes).length)for(i=x.upgrades.indexOf(_.find(x.upgrades,{version:t.settingsModel.get("version")}))+1;i<x.upgrades.length;i+=1)(e=x.upgrades[i]).fn(t.settingsModel,t),t.settingsModel.set("version",e.version);return{id:1,componentName:"3D Chart",componentDescription:"",version:"4.5.0",appArgs:{quickStart:[{path:"Basics.Data",message:"populate Data Source"}],json:{version:"4.5.0",possibleAxis:[],possibleColumns:[],possibleLabels:[],possibleRules:[],Basics:{Focus:"",Theme:"Dark",Type:"dot",Data:"",Selected:"",SelectedAttr:""},X:{Data:"",AxisType:"Linear",Label:"",Format:"",DateFormat:"YYYY-MM-DD",Prefix:"",Suffix:"",UseMin:!1,AxisMin:0,UseMax:!1,AxisMax:10},Y:{Data:"",AxisType:"Linear",Label:"",Format:"",DateFormat:"YYYY-MM-DD",Prefix:"",Suffix:"",UseMin:!1,AxisMin:0,UseMax:!1,AxisMax:10},Z:{Data:"",AxisType:"Linear",Label:"",Format:"",DateFormat:"YYYY-MM-DD",Prefix:"",Suffix:"",UseMin:!1,AxisMin:0,UseMax:!1,AxisMax:10},Volume:{Data:"",UseMin:!1,AxisMin:0,UseMax:!1,AxisMax:10},Position:{Horizontal:1.39,Vertical:.079,Distance:50},Style:{fill:"transparent",stroke:"#ffffff",advanced:"",VerticalRatio:70,KeepAspectRatio:!1,advancedTooltip:"<table>{{#each points}}<tr><td>{{xLabel}}</td><td>{{x}}</td></tr><tr><td>{{yLabel}}</td><td>{{y}}</td></tr><tr><td>{{zLabel}}</td><td>{{z}}</td></tr>{{/each}}</table>",ColorPalette:{ColorScheme:[{type:"#F8696B"},{type:"#F98570"},{type:"#FBA276"},{type:"#FCBF7B"},{type:"#FEDC81"},{type:"#EEE683"},{type:"#CCDD82"},{type:"#A9D27F"},{type:"#86C97E"},{type:"#63BE7B"}]}},Alignment:{paddingLeft:"0",paddingRight:"0",paddingTop:"0",paddingBottom:"0"},format:{widgetTitle:"",titleFontSize:"16",titleHorizontal:"Center",titlePaddingLeft:0,titlePaddingRight:0,titlePaddingTop:0,titlePaddingBottom:0}},schema:{type:"object",title:"Properties",properties:{possibleAxis:{type:"array",format:"table",items:{type:"string"},default:["bid","ask"],options:{collapsed:!0,hidden:!0}},possibleRules:{type:"array",format:"table",items:{type:"string"},default:["bid","ask"],options:{collapsed:!0,hidden:!0}},possibleColumns:{type:"array",format:"table",items:{type:"string"},default:["bid","ask"],options:{collapsed:!0,hidden:!0}},possibleLabels:{type:"array",format:"table",items:{type:"string"},default:["bid","ask"],options:{collapsed:!0,hidden:!0}},Basics:{type:"object",title:"Basics",propertyOrder:1,properties:{Focus:{type:"viewstate",title:"Focus",default:"",propertyOrder:2},Theme:{type:"string",title:"Theme",propertyOrder:3,enum:["Light","Dark"],options:{hidden:!0}},Type:{type:"string",propertyOrder:4,enum:["surface","dot","bar","bar-color","bar-size","grid","dot-color","dot-line","dot-size","line"]},Data:{type:"data",propertyOrder:1,format:"string",title:"Data Source",default:""},Selected:{type:"viewstate",title:"Selected Value",default:""},SelectedAttr:{type:"string",title:"Selected Value Attribute",enumSource:"possible_axis",watch:{possible_axis:"root.possibleAxis"}}}},X:{type:"object",title:"X",propertyOrder:3,options:{collapsed:!0},properties:{Data:{type:"string",title:"Data Description",propertyOrder:1,enumSource:"possible_axis",watch:{possible_axis:"root.possibleAxis"}},AxisType:{type:"string",propertyOrder:2,enum:["Linear","Category","Time"],default:"Linear"},Label:{type:"string",propertyOrder:3},Format:{type:"string",propertyOrder:4,enum:["General","Number","Smart Number","Formatted Number","Datetime"],default:"General"},Precision:{type:"number",propertyOrder:11,title:"Decimal Places",format:"number",minimum:0,maximum:10,default:2},DateFormat:{type:"string",propertyOrder:12,title:"Date/Time format",enum:["YYYY-MM-DD","YYYY-MMM-DD","YYYY-MMMM-DD","YYYY-MM","YYYY-MMM","YYYY-MMMM","MMM DD","MMM Do","YYYY-MM-DD HH:mm:ss","YYYY-MM-DD hh:mm:ss","YYYY-MM-DD kk:mm:ss","hh:mm:ss","kk:mm:ss","hh:mm:ss.SS","hh:mm","kk:mm","mm:ss","mm:ss.SS"],default:"YYYY-MM-DD"},Prefix:{type:"string",propertyOrder:13,default:""},Suffix:{type:"string",propertyOrder:14,default:""},UseMin:{type:"boolean",title:"Set Min Axis Value",format:"checkbox",propertyOrder:4},AxisMin:{type:"number",format:"number",default:0,propertyOrder:6},UseMax:{type:"boolean",title:"Set Max Axis Value",format:"checkbox",propertyOrder:7},AxisMax:{type:"number",format:"number",default:10,propertyOrder:8}}},Y:{type:"object",title:"Y",propertyOrder:4,options:{collapsed:!0},properties:{Data:{type:"string",title:"Data Description",propertyOrder:1,enumSource:"possible_axis",watch:{possible_axis:"root.possibleAxis"}},AxisType:{type:"string",propertyOrder:2,enum:["Linear","Category","Time"],default:"Linear"},Label:{type:"string",propertyOrder:3},Format:{type:"string",propertyOrder:4,enum:["General","Number","Smart Number","Formatted Number","Datetime"],default:"General"},Precision:{type:"number",propertyOrder:11,title:"Decimal Places",format:"number",minimum:0,maximum:10,default:2},DateFormat:{type:"string",propertyOrder:12,title:"Date/Time format",enum:["YYYY-MM-DD","YYYY-MMM-DD","YYYY-MMMM-DD","YYYY-MM","YYYY-MMM","YYYY-MMMM","MMM DD","MMM Do","YYYY-MM-DD HH:mm:ss","YYYY-MM-DD hh:mm:ss","YYYY-MM-DD kk:mm:ss","hh:mm:ss","kk:mm:ss","hh:mm:ss.SS","hh:mm","kk:mm","mm:ss","mm:ss.SS"],default:"YYYY-MM-DD"},Prefix:{type:"string",propertyOrder:13,default:""},Suffix:{type:"string",propertyOrder:14,default:""},UseMin:{type:"boolean",title:"Set Min Axis Value",format:"checkbox",propertyOrder:4},AxisMin:{type:"number",format:"number",default:0,propertyOrder:6},UseMax:{type:"boolean",title:"Set Max Axis Value",format:"checkbox",propertyOrder:7},AxisMax:{type:"number",format:"number",default:10,propertyOrder:8}}},Z:{type:"object",propertyOrder:5,title:"Z",options:{collapsed:!0},properties:{Data:{type:"string",title:"Data Description",propertyOrder:1,enumSource:"possible_axis",watch:{possible_axis:"root.possibleAxis"}},AxisType:{type:"string",propertyOrder:2,enum:["Linear","Category"],default:"Linear"},Label:{type:"string",propertyOrder:3},Format:{type:"string",propertyOrder:4,enum:["General","Number","Smart Number","Formatted Number","Datetime"],default:"General"},Precision:{type:"number",propertyOrder:11,title:"Decimal Places",format:"number",minimum:0,maximum:10,default:2},DateFormat:{type:"string",propertyOrder:12,title:"Date/Time format",enum:["YYYY-MM-DD","YYYY-MMM-DD","YYYY-MMMM-DD","YYYY-MM","YYYY-MMM","YYYY-MMMM","MMM DD","MMM Do","YYYY-MM-DD HH:mm:ss","YYYY-MM-DD hh:mm:ss","YYYY-MM-DD kk:mm:ss","hh:mm:ss","kk:mm:ss","hh:mm:ss.SS","hh:mm","kk:mm","mm:ss","mm:ss.SS"],default:"YYYY-MM-DD"},Prefix:{type:"string",propertyOrder:13,default:""},Suffix:{type:"string",propertyOrder:14,default:""},UseMin:{type:"boolean",title:"Set Min Axis Value",format:"checkbox",propertyOrder:4},AxisMin:{type:"number",format:"number",default:0,propertyOrder:6},UseMax:{type:"boolean",title:"Set Max Axis Value",format:"checkbox",propertyOrder:7},AxisMax:{type:"number",format:"number",default:10,propertyOrder:8}}},Volume:{type:"object",title:"Volume",propertyOrder:6,options:{collapsed:!0},properties:{Data:{type:"string",enumSource:"possible_axis",propertyOrder:1,watch:{possible_axis:"root.possibleAxis"}},UseMin:{type:"boolean",title:"Set Min Axis Value",format:"checkbox",propertyOrder:2},AxisMin:{type:"number",format:"number",default:0,propertyOrder:3},UseMax:{type:"boolean",title:"Set Max Axis Value",format:"checkbox",propertyOrder:4},AxisMax:{type:"number",format:"number",default:10,propertyOrder:5}}},Position:{type:"object",propertyOrder:7,title:"Position",options:{collapsed:!0},properties:{Horizontal:{type:"number",default:10,minimum:0,maximum:100,step:1,format:"range"},Vertical:{type:"number",default:500,minimum:0,maximum:1e3,step:1,format:"range"},Distance:{type:"number",default:10,minimum:0,maximum:100,step:1,format:"range"}}},Style:{type:"object",propertyOrder:8,title:"Style",options:{collapsed:!0},properties:{stroke:{type:"gradient",options:{gradient:!1,noColor:!0},title:"Stroke",default:"#ffffff"},fill:{type:"gradient",options:{gradient:!1,noColor:!0},title:"Fill",default:"transparent"},advanced:{type:"css",title:"Advanced CSS",default:""},advancedTooltip:{data:["series","values"],default:"",templateItems:{points:{items:{cols:null,style:"style",x:"x",xLabel:"xLabel",y:"y",yLabel:"yLabel",z:"z",zLabel:"zLabel"},type:"array"}},type:"tooltipTemplate",title:"Custom tooltip"},VerticalRatio:{title:"Vertical Ratio",type:"number",default:70,format:"range",minimum:0,maximum:100},KeepAspectRatio:{type:"boolean",format:"checkbox",title:"Keep Aspect Ration",default:!1},ColorPalette:{type:"object",propertyOrder:5,title:"Contour Palette",options:{collapsed:!0},properties:{ColorScheme:{propertyOrder:5,title:"Color Scheme",type:"array",format:"table",options:{collapsed:!1},uniqueItems:!1,items:{type:"object",title:"Color",properties:{type:{type:"gradient",default:"#5B9BD5",title:"Color",options:{gradient:!1}}}}}}}}},Alignment:{type:"object",propertyOrder:9,title:"Margins",options:{collapsed:!0},properties:{paddingLeft:{type:"number",title:"Padding Left",default:0,format:"number"},paddingRight:{type:"number",title:"Padding Right",default:0,format:"number"},paddingTop:{type:"number",title:"Padding Top",default:0,format:"number"},paddingBottom:{type:"number",title:"Padding Bottom",default:0,format:"number"}}},format:{type:"object",propertyOrder:10,title:"Format",options:{collapsed:!0},properties:{widgetTitle:{type:"string",propertyOrder:13,title:"Title"},titleFontSize:{type:"number",propertyOrder:15,title:"Title Font Size",format:"number"},titleHorizontal:{type:"string",propertyOrder:16,title:"Title Horizontal Align",enum:["Left","Center","Right"]},titlePaddingLeft:{type:"number",propertyOrder:17,title:"Title Padding Left",default:0,format:"number"},titlePaddingRight:{type:"number",propertyOrder:18,title:"Title Padding Right",default:0,format:"number"},titlePaddingTop:{type:"number",propertyOrder:19,title:"Title Padding Top",default:0,format:"number"},titlePaddingBottom:{type:"number",propertyOrder:20,title:"Title Padding Bottom",default:0,format:"number"}}}}}}}};t=x;function x(){}t.upgrades=[{version:0,fn:function(){}},{version:"4.1.0s1",fn:function(){}},{version:"4.1.0s2",fn:function(){}},{version:"4.3.0.2",fn:function(t){var e=t.get("Style"),i=t.get("X"),r=t.get("Y"),a=t.get("Z");e.stroke=void 0===e.stroke?"#ffffff":e.stroke,e.fill=void 0===e.fill?"transparent":e.fill,t.set("Style",e),i.Format=-1===_.indexOf(["General","Number","Smart Number","Formatted Number","Datetime"],i.Format)?"General":i.Format,i.Precision=void 0===i.Precision?0:i.Precision,i.DateFormat=void 0===i.DateFormat?"":i.DateFormat,i.Prefix=void 0===i.Prefix?"":i.Prefix,i.Suffix=void 0===i.Suffix?"":i.Suffix,i.AxisType=void 0===i.AxisType?"Linear":i.AxisType,r.Format=-1===_.indexOf(["General","Number","Smart Number","Formatted Number","Datetime"],r.Format)?"General":r.Format,r.Precision=void 0===r.Precision?0:r.Precision,r.DateFormat=void 0===r.DateFormat?"":r.DateFormat,r.Prefix=void 0===r.Prefix?"":r.Prefix,r.Suffix=void 0===r.Suffix?"":r.Suffix,r.AxisType=void 0===r.AxisType?"Linear":r.AxisType,a.Format=-1===_.indexOf(["General","Number","Smart Number","Formatted Number","Datetime"],a.Format)?"General":a.Format,a.Precision=void 0===a.Precision?0:a.Precision,a.DateFormat=void 0===a.DateFormat?"":a.DateFormat,a.Prefix=void 0===a.Prefix?"":a.Prefix,a.Suffix=void 0===a.Suffix?"":a.Suffix,a.AxisType=void 0===a.AxisType?"Linear":a.AxisType,t.set("X",i),t.set("Y",r),t.set("Z",a)}},{version:"4.5.0",fn:function(t){var e=t.get("Style"),i=t.get("X"),r=t.get("Y"),a=t.get("Z"),o=t.get("Volume");i.DateFormat=void 0===i.DateFormat||""===i.DateFormat?"YYYY-MM-DD":i.DateFormat,r.DateFormat=void 0===r.DateFormat||""===i.DateFormat?"YYYY-MM-DD":i.DateFormat,a.DateFormat=void 0===a.DateFormat||""===i.DateFormat?"YYYY-MM-DD":i.DateFormat,o.UseMax=void 0!==o.UseMax&&o.UseMax,o.UseMin=void 0!==o.UseMin&&o.UseMin,o.AxisMax=void 0===o.AxisMax?10:o.AxisMax,o.AxisMin=void 0===o.AxisMin?0:o.AxisMin,e.VerticalRatio=void 0===e.VerticalRatio?70:e.VerticalRatio,e.KeepAspectRatio=void 0!==e.KeepAspectRatio&&e.KeepAspectRatio,e.ColorPalette=void 0===e.ColorPalette?{ColorScheme:[{type:"#F8696B"},{type:"#F98570"},{type:"#FBA276"},{type:"#FCBF7B"},{type:"#FEDC81"},{type:"#EEE683"},{type:"#CCDD82"},{type:"#A9D27F"},{type:"#86C97E"},{type:"#63BE7B"}]}:e.ColorPalette,t.set("Style",e),t.set("X",i),t.set("Y",r),t.set("Z",a),t.set("Volume",o)}}];S.app=c.template({compiler:[8,">= 4.3.0"],main:function(t,e,i,r,a){var o,s=null!=e?e:t.nullContext||{},n=t.hooks.helperMissing,l="function",p=t.escapeExpression,t=t.lookupProperty||function(t,e){if(Object.prototype.hasOwnProperty.call(t,e))return t[e]};return'<div class="Chart3D">\n\n    <div class="title">\n    </div>\n\n    <div class="frame">\n        <div id="Chart3D_'+p(typeof(o=null!=(o=t(i,"id")||(null!=e?t(e,"id"):e))?o:n)==l?o.call(s,{name:"id",hash:{},data:a,loc:{start:{line:7,column:25},end:{line:7,column:31}}}):o)+'" class="graph '+p(typeof(o=null!=(o=t(i,"id")||(null!=e?t(e,"id"):e))?o:n)==l?o.call(s,{name:"id",hash:{},data:a,loc:{start:{line:7,column:46},end:{line:7,column:52}}}):o)+'" style="height:100%" >\n          <div style="height:100%;width:100%"></div>\n\n        </div>\n    </div>\n\n</div>'},useData:!0});var D,M=S;function S(){}function v(t){var e=D.call(this,t)||this,i=(e.focus=[],e.isReadyForThemeChange=!1,e.layers=new u,e.dataSources={},e.api=t.api,_.extend(e,_.pick(t,["api","dashboardViewModel"])),e.onSettingsChange.bind(e));return e.onSettingsChange=function(t){var e=this.onSettingsChange!==(this.onSettingsChange=i);this.onSettingsChange(t),e&&(this.isReadyForThemeChange=!0,this.setThemeAccordingToDashboardSettings())}.bind(e),e.$el.html(M.app({id:e.cid})),e.listenTo(e.layers,"add",function(t){this.setThemeAccordingToDashboardSettings()}),e.listenTo(e.layers,"reset",function(t){this.setThemeAccordingToDashboardSettings()}),e.listenTo(e.layers,"remove",function(t){t.stopListening()}),e.listenTo(e.layers,"update",function(t,e){this.updatePossibleLayers();e.changes.added.length,e.changes.removed.length;g.safeHandle(this.initializeChart).call(this)}),e}return D=i.View,o(v,D),v.prototype.onSettingsChange=function(t){t=g.expandNestedViewStates(t,this.api),t=g.replaceViewStatesWithValue("",t,this.api),t=g.pump(t);this.onSettingsChangeProcessed.call(this,t)},v.prototype.updateDataSource=function(i){var r=this;this.dataSources[i.getKey()]&&this.layers.filter(function(t){t=t.get("Basics.Data");return t&&t.cid===i.getKey()}).forEach(function(t){t.updateData(i);var e=i.getColumnNames();t.set("possibleAxis",e),t.set("possibleColumns",e),r.api.setProperty("possibleAxis",t.get("possibleAxis")),r.api.setProperty("possibleColumns",t.get("possibleColumns"))}),g.safeHandle(this.initializeChart.bind(this)).call(this)},v.prototype.updateError=function(t,e){function i(t){return"Error"===t?3:"Loading"===t?2:"NoResults"===t?1:0}var r=this,t=t.getKey(),a={},t=(e&&(a[t]=e),_.reduce(a,function(t,e){e=e.type;return i(e)>i(t)?e:t},""));t&&("NoResults"!==t||Object.keys(this.dataSources).length===Object.keys(a).length)?(e=_.map(a,function(t,e){t=t.error,e=r.dataSources[e];return t?"["+e.getPath()+"]: "+t:null}).filter(function(t){return t}),this.api.showQueryStatus({error:e.join("\n"),type:t})):this.api.hideQueryStatus()},v.prototype.onSettingsChangeProcessed=function(t){_.isObject(t.Basics)&&this.onSettingsBasicsChanged.call(this,t.Basics),_.isObject(t.Basics)&&t.Basics.Data&&this.onSettingsLayersChanged.call(this,t),_.isObject(t.Basics)&&t.Basics.Type&&this.onSettingsOnType(t),_.isObject(t.Position)&&this.setCameraPosition(),_.isObject(t.X)&&this.onSettingsOnData(t,"X"),_.isObject(t.Y)&&this.onSettingsOnData(t,"Y"),_.isObject(t.Z)&&this.onSettingsOnData(t,"Z"),_.isObject(t.Volume)&&this.onSettingsOnData(t,"Volume"),_.isObject(t.Style)&&this.onSettingsOnData(t,"Style"),_.isObject(t.format)&&this.onSettingsOnFormat(t)},v.prototype.onSettingsLayersChanged=function(t){this.layers.set(t);var t=t.Basics.Data,e=this.dataSources[t.cid];e?e.hasData()&&this.updateDataSource(e):(e=new m(t,this,this.api,this.focus),(this.dataSources[t.cid]=e).subscribe())},v.prototype.onSettingsOnFormat=function(t){var e;this.layers&&0<this.layers.models.length&&(void 0===(e=this.layers.models[0]).get("format")?e.set("format",this.api.getProperty("format")):(e.set(t),this.initializeChart()))},v.prototype.onSettingsOnData=function(t,e){var i,r=this;0<this.layers.models.length&&(i=this.layers.models[0],"X"===e&&i.set("X",t.X),"Y"===e&&i.set("Y",t.Y),"Z"===e&&i.set("Z",t.Z),"Volume"===e&&i.set("Volume",t.Volume),_.each(this.dataSources,function(t){(i.chartData=void 0)===i.get("Style")&&i.set("Style",r.api.getProperty("Style")),i.updateData(t)}),this.initializeChart())},v.prototype.onSettingsOnType=function(t){var e;0<this.layers.models.length&&(e=this.layers.models[0],_.each(this.dataSources,function(t){e.updateData(t)}),e.set("Basics.Type",t.Basics.Type),this.initializeChart())},v.prototype.onSettingsBasicsChanged=function(t){var e=this;void 0!==t.Focus&&(this.focus=_.first(g.focus2Array(t.Focus))||[],_.each(this.dataSources,function(t){t.setFocus(e.focus)}))},v.prototype.labelFormat=function(t,e){var i=this.api.getProperty(t+".Format"),r=this.api.getProperty(t+".Precision"),a=this.api.getProperty(t+".DateFormat"),o=this.api.getProperty(t+".AxisType"),s=this.api.getProperty(t+".DateFormat"),n=this.api.getProperty(t+".Prefix"),l=this.api.getProperty(t+".Suffix");return"Category"===o&&this.layers.models[0]&&_.get(this.layers.models[0],"axisCache")&&(e=(t=this.layers.models[0].axisCache[t.toLowerCase()])?t[e]:e),"Time"===o&&_.isNumber(e)?p(e).format(s):n+g.getFormatter(""===i?"General":i,""===r?0:r,!1,a)(e)+l},v.prototype.initializeChart=function(){var s=this,t=this.api.getProperty("Basics.Type"),e=this.api.getProperty("Style.VerticalRatio"),i=this.layers.models[0],i=_.get(i,"chartData"),r=this.$el.find("."+this.cid),a=r.get(0),o=this.api.getProperty("Style.fill"),n=this.api.getProperty("Style.KeepAspectRatio"),l=this.api.getProperty("Style.ColorPalette.ColorScheme"),p=0<l.length?l[0].type:"#F8696B",l="dot-color"===t?_.reverse(_.map(l,function(t){return t.type})):p,u=this.api.getProperty("Style.stroke");i&&i.length&&(o={axisColor:u,backgroundColor:{fill:o,stroke:"rgba(0,0,0,0)"},dataColor:{fill:l.toString(),stroke:"line"===t?p:u},height:r.height()+"px",keepAspectRatio:n,onclick:function(t){s.onClick(t)},showGrid:!0,showPerspective:!0,showShadow:!1,style:t,tooltip:function(t){var e="",i=s.api.getProperty("Style.advancedTooltip"),r=c.compile(i);try{var a=s.api.getTemplateViewStates(i),o=s.getTooltipData(t.data),e=r(_.assignIn(o,a))}catch(t){e=""}return e},tooltipStyle:{content:{background:"rgba(0, 0, 0, 0.8)",borderRadius:"6px",color:"white"}},valueMax:this.axisMax("Volume"),valueMin:this.axisMin("Volume"),verticalRatio:e/100,width:r.width()+"px",xLabel:this.api.getProperty("X.Label"),xMax:this.axisMax("X"),xMin:this.axisMin("X"),xValueLabel:function(t){return s.labelFormat("X",t)},yLabel:this.api.getProperty("Y.Label"),yMax:this.axisMax("Y"),yMin:this.axisMin("Y"),yValueLabel:function(t){return s.labelFormat("Y",t)},zLabel:this.api.getProperty("Z.Label"),zMax:_.isNil(this.axisMax(""))?this.getRoundedMax(i._data,"z"):this.axisMax("Volume"),zMin:this.axisMin("Z"),zValueLabel:function(t){return s.labelFormat("Z",t)}},(l=new h.Graph3d(a,i,o)).off("cameraPositionChange",null),l.on("cameraPositionChange",$.proxy(this.onCameraPositionChange.bind(this),this)),this.chart=l,this.setCameraPosition())},v.prototype.getRoundedMax=function(t,e){t=_.get(_.maxBy(_.values(t),e),e)+1;return 4<Math.log10(t)?5*Math.ceil(t/5):t},v.prototype.getTooltipData=function(t){var e=this.api.getProperty("X.Label"),i=this.api.getProperty("Y.Label"),r=this.api.getProperty("Z.Label");return{points:[{cols:t.data,style:t.style,x:t.x,xLabel:e,y:t.y,yLabel:i,z:t.z,zLabel:r}]}},v.prototype.onClick=function(t){var e=this.api.getProperty("Basics.SelectedAttr"),t=t.data[e];this.api.setProperty("Basics.Selected",t,!0);var e=this.layers.models[0].get("Basics.Data"),e=this.dataSources[e.cid].getDepth(),i=_.clone(this.focus);i[e]=t&&t.toString?t.toString():""+t,this.api.setProperty("Basics.Focus",i.join(","),!0)},v.prototype.onCameraPositionChange=function(t){this.api.setProperty("Position.Horizontal",t.horizontal),this.api.setProperty("Position.Vertical",t.vertical),this.api.setProperty("Position.Distance",t.distance)},v.prototype.axisMin=function(t){var e=this.api.getProperty(t+".UseMin"),t=this.api.getProperty(t+".AxisMin");return e?parseFloat(t):void 0},v.prototype.axisMax=function(t){var e=this.api.getProperty(t+".UseMax"),t=this.api.getProperty(t+".AxisMax");return e?parseFloat(t):void 0},v.prototype.setCameraPosition=function(){var t,e,i;this.layers&&0<this.layers.models.length&&(t=this.api.getProperty("Position.Horizontal"),e=this.api.getProperty("Position.Vertical"),i=this.api.getProperty("Position.Distance"),this.chart&&this.chart.setCameraPosition({distance:_.isNaN(i)?2.5:i,horizontal:_.isNaN(t)?.0873:t,vertical:_.isNaN(e)?.001241:e}))},v.prototype.onResizeStop=function(){g.safeHandle(this.initializeChart.bind(this)).call(this)},v.prototype.onLayerDataEvents=function(t){var e=t.get("Basics.Data"),e=e?this.dataSources[e.cid]:void 0;e&&(t.updateData(e),t.set("_Hidden._PossibleColumns",e?e.getColumnNames():[]))},v.prototype.setTheme=function(t){var e="";"Light"===t?e="#000000":"Dark"===t&&(e="#FFFFFF"),t=t.toLowerCase(),this.api.setProperty("Style.stroke",e),this.$el.removeClass("dark light"),this.$el.addClass(t)},v.prototype.setThemeAccordingToDashboardSettings=function(){this.isReadyForThemeChange&&this.setTheme(this.dashboardViewModel.get("DashboardTheme"))},v.prototype.updatePossibleLayers=function(){this.layers.filter(function(t){return"Line"===t.get("_Hidden._Type")}).forEach(function(r){var t=r.collection.reduceRight(function(t,e,i){return[r===e?"nofill":"Layer "+(i+1)].concat(t)},["origin"]);r.set("_Hidden._PossibleLayers",t)})},v.getComponentDefinition=t.getComponentDefinition,v});