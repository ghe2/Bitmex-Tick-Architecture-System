define(["Handlebars","QuickBase","moment","xlsx","chartjs","backbone","css!./css/app.css"],function(b,h,s,A,H,i){"use strict";var a,e,o=this&&this.__extends||(a=function(t,e){return(a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])})(t,e)},function(t,e){function o(){this.constructor=t}a(t,e),t.prototype=null===e?Object.create(e):(o.prototype=e.prototype,new o)}),r=this&&this.__assign||function(){return(r=Object.assign||function(t){for(var e,o=1,a=arguments.length;o<a;o++)for(var i in e=arguments[o])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)},j=(e=i.DeepModel,o(n,e),n.prototype.initialize=function(){this.labelPlugin={afterDatasetsUpdate:function(e){_.each(e.config.layers.models,function(t){t.setPopoutSegment(e)})},beforeDraw:function(t){function e(l,t,c,d,p,h,u){for(var e=1.2*l.measureText("M").width,o=t?t.split("<br>"):"",f={style:{}},a=0;a<o.length;++a)!function(t){var t=o[t].split("</span>"),s=0;_.each(t,function(t){var e=/(<([^>]+)>)/gi;if(e.test(t)){var o=$(t);if(o&&o.attr("style"))for(var a,i,o=o.attr("style"),r=void 0===o?[]:o.split(";"),n=r.length;n--;)i=r[n].split(":"),a=$.trim(i[0]),i=$.trim(i[1]),0<a.length&&0<i.length&&(f.style[a]=i)}o=t.replace(e,"");l.fillStyle=_.get(f,"style.color")?_.get(f,"style.color"):p,l.font=f.style["font-size"]?f.style["font-size"]+" "+u:h+"px "+u,l.fillText(o,c+s,d),s=l.measureText(o).width}),d+=e}(a)}var o,a,i,r,n,s,l,c;t.config.options.elements.center&&(o=t.chart.ctx,n=(c=t.config.options.elements.center).fontSize,a=c.fontStyle||"Arial",i=c.text,r=c.color||"#000",s=(c.sidePadding||20)/100*(2*t.innerRadius),o.font=n+"px "+a,l=o.measureText(i).width,s=2*t.innerRadius-s,s=Math.floor(n*(s/l)),l=2*t.innerRadius,n=n||Math.min(s,l),o.textAlign="center",o.textBaseline="middle",s=(t.chartArea.left+t.chartArea.right)/2,l=(t.chartArea.top+t.chartArea.bottom)/2,o.font=n+"px "+a,o.fillStyle=r,"fontawesome"===c.fontStyle?o.fillText((t=i,(c=document.createElement("i")).className="fa fa-"+t,c.style.display="none",document.body.appendChild(c),t=window.getComputedStyle(c,":before").getPropertyValue("content"),document.body.removeChild(c),t.replace(/([.\"])/g,"")),s,l):e(o,i,s,l,r,n,a))}}},n.prototype.setPopoutSegment=function(t,e){var o,a=this;this.resetLayerPopout(t),0<t.data.datasets.length&&(e=_.isNaN(e)?e:-1,_.each(t.config.dataSource,function(t){t=_.find(t.getData().models,function(t){return t.get(a.get("Basics.SelectedAttr"))===a.get("Basics.Selected")});t&&null!==t.id&&(e=t.id)}),-1!==e&&(o=t.getDatasetMeta(0).data[e])&&this.get("Basics.PopoutSelected")&&(o._model.outerRadius=t.outerRadius+parseFloat(this.get("Basics.PopoutSelectedSize")),o._model.innerRadius=t.innerRadius+parseFloat(this.get("Basics.PopoutSelectedSize"))))},n.prototype.resetLayerPopout=function(e){this.get("Basics.PopoutSelected")&&0<e.data.datasets.length&&_.each(e.getDatasetMeta(0).data,function(t){t._model.outerRadius=e.outerRadius,t._model.innerRadius=e.innerRadius})},n.prototype.computeConfigProps=function(){var t=void 0===this.get("DataSet.DonutRatio")?35:this.get("DataSet.DonutRatio"),e=void 0===this.get("DataSet.Circumference")?100:this.get("DataSet.Circumference"),o=void 0===this.get("DataSet.Rotation")?50:this.get("DataSet.Rotation"),a=this.get("InnerLabel.labelPosition");return this.get("InnerLabel.ShowPieceLabel")?{cutoutPercentage:t,circumference:this.calcRange(e,0,2)*Math.PI,rotation:(this.calcRange(o,0,2)-1)*Math.PI,labelPosition:a,pieceLabel:this.computePieceLabel(),elements:this.computeElementCenter()}:{cutoutPercentage:t,circumference:this.calcRange(e,0,2)*Math.PI,rotation:(this.calcRange(o,0,2)-1)*Math.PI,labelPosition:a,elements:this.computeElementCenter()}},n.prototype.updateData=function(i){var e,t,r=this;i?(this.setPreviousChartData(),this.chartData={},this.dataSource=i,void 0!==(t=this.get("DataSet.Label"))&&(t=0===t.indexOf("/")?t.substring(1):"^"+t.replace(/\*/g,"(.*)")+"$",e=new RegExp(t),t=i.getColumnNames().filter(function(t){return t.match(e)}),_.each(t,function(a){_.each(r.get("DataSet.Layers"),function(t){var e,o=t.Segment;void 0!==o&&(o=0===o.indexOf("/")?o.substring(1):"^"+o.replace(/\*/g,"(.*)")+"$",e=new RegExp(o),o=i.getColumnNames().filter(function(t){return t.match(e)}),r.labelData=i.getData().map(function(t){return t.get(i.getPropertyFromColumn(a))}),_.each(o,function(e){r.chartData[r.getDisplayName(e)]={data:_.map(i.getData().models,function(t){return t.get(e)}),color:t.Color||i.api.getProperty("DataSet.Layers.0.Color"),borderColor:t.BorderColor||i.api.getProperty("DataSet.Layers.0.BorderColor"),colorOpacity:t.ColorOpacity||i.api.getProperty("DataSet.Layers.0.ColorOpacity"),usePallette:t.UseColor}}),r.updateVisuals())})})),this.updateVisuals()):this.initialize()},n.prototype.updateVisuals=function(){var t=this.computeDataSetProps(),e=this.computeConfigProps();this.dataset=_.map(t,function(t){return _.extend({},e,t)})},n.prototype.setPreviousChartData=function(){this.previousChartData=_.extend({},this.chartData)},n.prototype.calcRange=function(t,e,o){return e+t/100*(Math.abs(o)-Math.abs(e))},n.prototype.computeDataSetProps=function(){var i=this;return _.map(this.chartData,function(t,e){0;var o=i.getBackgroundColor(t.usePallette,t.color,t.colorOpacity),a=_.isString(t.borderColor)&&""===t.borderColor?o:t.borderColor;return{label:i.labelData,id:i.id,data:t.data,backgroundColor:i.computeHightlightColor(o,t.colorOpacity,t,e),borderColor:a,defaultBackgroundColor:o,defaultBorderColor:a}})},n.prototype.computeElementCenter=function(){return{center:{text:this.get("InnerLabel.Innertitle"),color:this.get("InnerLabel.InnertitleColor"),fontStyle:this.get("InnerLabel.InnertitleFont"),fontSize:this.get("InnerLabel.InnertitleSize"),sidePadding:15}}},n.prototype.computePieceLabel=function(){var t=this.get("InnerLabel"),e=t.Precision,o=t.HideTrailingZeroes,a=t.DateFormat,i=t.Format,r=t.PieceLabelRender,n=t.Prefix,s=t.Suffix,l=t.PieceLabelArc,c=t.PieceLabelOverlap,d=t.ShowZero,p=t.FontSize,h=t.PieceLabelColor,u=t.PieceLabelPosition,f=t.PieceLabelTemplate,g=D.getFormatter(i,e,o,a),m=this.dataSource,y=m?m.getData():null;return{precision:e||0,showZero:d,fontSize:p,fontColor:h,fontStyle:"normal",fontFamily:"'Helvetica Neue', 'Helvetica', 'Arial', sans-serif",arc:l,position:u,overlap:c,render:function(t){var e=t[r];if(f){var o,a,i=b.compile(f);try{y&&0<y.models.length&&y.models[t.index]&&(o=_.assignIn(t,y.models[t.index].attributes),m&&(a=m.api.getTemplateViewStates(f),e=i(_.assignIn(o,a))))}catch(t){console.log("Handlebar Error",t)}return e}if(_.indexOf(["percentage","value","label"],r)<0){i=b.compile(r);e=r;try{y&&0<y.models.length&&y.models[t.index]&&(e=i(y.models[t.index].attributes))}catch(t){console.log("Handlebar Error",t)}t.advanced=e}return"Invalid date"===(e=g(e))&&(e=t[r]),n+e+s}}},n.prototype.getBackgroundColor=function(t,e,o){t=t?this.getColorScheme(o):D.alpha(e,o);return t},n.prototype.computeHightlightColor=function(t,e,o,a){_.extend([],t);return this.computeHighlightRules(t,e,"RuleColor",a)},n.prototype.getColorScheme=function(e){var o=[];if(_.each(_.map(this.get("Style.chartBarColors"),"type"),function(t){o.push(D.alpha(t,e))}),0<o.length&&o.length<this.labelData.length)for(var t=_.extend([],o),a=0;a<=this.labelData.length/t.length+1;a++)o=_.concat(o,t);return o},n.prototype.getDisplayName=function(t){var e=t;return e=(t=_.fromPairs(_.map(this.get("DataSet.Layers"),function(t){return[t.Segment,t.Display]}))[t])?t:e},n.prototype.computeHighlightRules=function(n,s,l,c){var o,a,i,d=this,p=[],r=0,t=_.map(this.get("DataSet.Layers"),"Segment"),e=this.get("Basics"),h=e.Focus,e=e.Data,h=h?_.first(D.focus2Array(h)):[],u=void 0===h?0:h.length,f=(e.dataSet&&e.dataSet.breakdownColumns&&(a=e.dataSet.breakdownColumns),_.get(a,"attributes")&&(a=a.get("value")),0<=_.indexOf(t,c)?r=_.indexOf(t,c):_.each(t,function(t,e){t.match(c)&&(r=e)}),"DataSet.Layers."+r+".HighlightRules");return this.chartData[c]&&this.dataSource&&(i=this.dataSource,_.each(i.api.getProperty(f),function(t,r){var e=i.api.getProperty(f+"."+r+".RuleSource");e?("{breakdownId}"===t.RuleSource&&(e=a&&a[u]?a[u]:t.RuleSource),d.dataSource&&(o=d.dataSource.getData().pluck(e))):o=_.get(d.chartData[c],"data"),o&&0<o.length&&_.each(o,function(t,e){var o,a,i;d.dataSource&&(o=d.dataSource.api.getProperty(f+"."+r+".RuleValue"),a=d.dataSource.api.getProperty(f+"."+r+"."+l),i=d.dataSource.api.getProperty(f+"."+r+".RuleOperation"),"previous"===o&&(o=d.getPreviousChartData(c,e)),t=D.getConditionResult(t,o,i),p[e]?p[e]=t?D.alpha(a,s):p[e]:t?p.push(D.alpha(a,s)):p.push("string"==typeof n?n:n[e]))})})),0<f.length&&0<p.length?p:n},n.prototype.getPreviousChartData=function(t,e){if(this.previousChartData&&this.previousChartData[t]){t=_.get(this.previousChartData[t],"data")[e];if(t)return t}},n);function n(){var t=null!==e&&e.apply(this,arguments)||this;return t.colorCache={},t.columns=[],t.labels=[],t.chartData={},t.labelData=[],t.chartType="pie",t.previousChartData={},t}l=i.Collection,o(c,l),c.prototype.modelId=function(t){return t};var l,Y=c;function c(){var t=null!==l&&l.apply(this,arguments)||this;return t.model=j,t}d=i.DeepModel,o(p,d),p.prototype.initialize=function(){},p.prototype.toPieJSON=function(){return _.chain(this.toJSON()).toPairs().reduce(function(t,e){return t[e[0].toLowerCase()]=e[1],t},{}).value()},p.Enabled=!1;var d,z=p;function p(){return null!==d&&d.apply(this,arguments)||this}u.sourceKey=function(t){return t.getPath()},u.mergeChanges=function(e,o,t,a,i,r){return t&&(e=_.fromPairs(_.map(t,function(t){return[o(t),t]}))),a&&_.each(a,function(t){return _.extend(e[o(t)],t)}),i&&_.each(i,function(t){e[o(t)]=t}),r&&_.each(r,function(t){delete e[o(t)]}),e},u.prototype.setFocus=function(t){this.focus=t,this.updateChildren(),this.childDataSource&&this.childDataSource.setFocus(t)},u.prototype.getColumnNames=function(){if(this.breakdownColumns&&this.breakdownColumns.length)return[u.BREAKDOWN_ID,this.breakdownColumns[0]].concat(_.difference(_.keys(this.meta),this.breakdownColumns));try{return _.map(this.meta,function(t){return[t.id,t.index]}).sort(function(t,e){return t[1]-e[1]}).map(function(t){return t[0]})}catch(t){return _.keys(this.meta)}},u.prototype.getColumnType=function(t){return this.childDataSource?this.childDataSource.getColumnType(t):t===u.BREAKDOWN_ID&&this.primaryKey?this.meta[this.primaryKey].kdbType:this.meta[t]?this.meta[t].kdbType:11},u.prototype.getData=function(){return this.childDataSource?this.childDataSource.getData():this.source.dataSet&&this.source.dataSet.collection},u.prototype.getDepth=function(){return this.childDataSource?this.childDataSource.getDepth():this.depth},u.prototype.getKey=function(){return this.source.cid},u.prototype.getPrimaryKey=function(){return this.childDataSource?this.childDataSource.getPrimaryKey():this.primaryKey},u.prototype.getPropertyFromColumn=function(t){return t===u.BREAKDOWN_ID?this.getPrimaryKey():t},u.prototype.getPath=function(){return this.source.path},u.prototype.getSource=function(){return this.source},u.prototype.hasData=function(){return this.childDataSource?this.childDataSource.hasData():this.hasDataFlag},u.prototype.onData=function(t,e,o){t.primaryKey!==this.primaryKey&&(this.primaryKey=t.primaryKey);var a=t.columns,i=a.reset,r=a.change,n=a.add,a=a.remove;this.meta=u.mergeChanges(this.meta,function(t){return t.id},i,r,n,a),0!==this.depth||_.isEqual(t.breakdownColumns,this.breakdownColumns)||(this.breakdownColumns=t.breakdownColumns,this.removeChild()),e.reset&&0<e.reset.length&&this.removeChild(),o&&this.updateError(this,o),this.hasDataFlag=!0,this.updateChildren()&&this.listener.updateDataSource(this)},u.prototype.subscribe=function(){this.api.subscribe(this.source,this.onData.bind(this))},u.prototype.updateDataSource=function(){this.listener.updateDataSource(this)},u.prototype.updateError=function(t,e){this.listener.updateError(this,e)},u.prototype.unsubscribe=function(){this.childDataSource&&(this.childDataSource.unsubscribe(),delete this.childDataSource),this.api.unsubscribe(this.source)},u.prototype.removeChild=function(){this.childDataSource&&(this.childDataSource.unsubscribe(),delete this.childDataSource)},u.prototype.updateChildren=function(){var t;return!(this.breakdownColumns&&this.breakdownColumns.length&&this.depth<this.breakdownColumns.length-1)||(this.focus.length>this.depth?(this.childDataSource&&this.focus[this.depth]!==this.childDataSource.getSource().id&&this.removeChild(),this.childDataSource||(0!==this.depth&&(this.focus[this.depth-1],this.source.id),(t=this.source.dataSet&&this.source.dataSet.collection.get(this.focus[this.depth]))&&(this.childDataSource=new u(t,this,this.api,this.focus,this.depth+1,this.breakdownColumns),this.childDataSource.subscribe()))):(this.removeChild(),this.focus.length!==this.depth||!this.hasDataFlag||0!==this.depth&&this.focus[this.depth-1].toString()!==this.source.id.toString()||this.listener.updateDataSource(this)),!1)},u.BREAKDOWN_ID="{breakdownId}";var V=u;function u(t,e,o,a,i,r){this.breakdownColumns=[],this.hasDataFlag=!1,this.focus=[],this.meta={},this.source=t,this.listener=e,this.api=o,this.depth=i||0,this.breakdownColumns=r,this.setFocus(a)}f=i.DeepModel,o(g,f),g.prototype.initialize=function(t){this.el=t.el,this.api=t.api,this.computeHighlightRulesHTML()},g.prototype.computeHighlightRulesHTML=function(){var a=[],t="",i=this.api;_.each(this.api.getProperty("DataSet.Layers"),function(t,o){_.each(t.HighlightRules,function(t,e){t.Show&&a.push({layer:i.getProperty("DataSet.Layers."+o+".Basics.Name"),ruleName:i.getProperty("DataSet.Layers."+o+".HighlightRules."+e+".RuleName"),ruleColor:i.getProperty("DataSet.Layers."+o+".HighlightRules."+e+".RuleColor"),ruleBorder:i.getProperty("DataSet.Layers."+o+".HighlightRules."+e+".RuleBorderColor")})})}),0<a.length&&(t=O.highlighRule(a)),this.el.find(".highlight-rules-dialog").html(t)};var f,K=g;function g(){return null!==f&&f.apply(this,arguments)||this}m=i.DeepModel,o(y,m),y.prototype.initialize=function(t){this.chart="function"==typeof Chart?Chart:window.Chart,this.externalDiv=t.externalDiv,this.toolsEnabled=!1,this.app=t.app},y.prototype.computeLegendProp=function(){var c=this.chart.helpers,a=this.app,i=this.get("Mode");return{display:!this.get("LegendScroll")&&this.get("Display"),position:this.get("Position")?this.get("Position"):"top",fullWidth:!!this.get("FullWidth"),reverse:!!this.get("Reverse"),labels:{boxWidth:this.get("BoxWidth"),fontSize:parseFloat(this.get("LabelFontSize"))||0,fontColor:this.get("LabelColor"),fontFamily:"'Helvetica Neue', 'Helvetica', 'Arial', sans-serif",padding:this.get("Padding"),usePointStyle:this.get("UsePointStyle"),generateLabels:function(s){var l=s.data;return l.labels.length&&l.datasets.length?l.labels.map(function(t,e){var o=s.getDatasetMeta(0),a=l.datasets[0],i=o.data[e],i=i&&i.custom||{},r=c.getValueAtIndexOrDefault,n=s.options.elements.arc;return{text:t,fillStyle:i.backgroundColor||r(a.defaultBackgroundColor,e,n.backgroundColor),strokeStyle:i.borderColor||r(a.defaultBorderColor,e,n.borderColor),lineWidth:i.borderWidth||r(a.borderWidth,e,n.borderWidth),hidden:isNaN(a.data[e])||o.data[e].hidden,index:e}}):{}}},onClick:function(t,e){var o;"Select Only"===i?a.onClick(e.index):(o=e.index,(e=a.chart).data.datasets.forEach(function(t){_.each(t._meta,function(t){var e=t.data[o];t.data&&t.data[o]&&(e.hidden=!e.hidden)})}),e.update())}}},y.prototype.renderhtmlLegend=function(o){var t=this;this.get("LegendScroll")&&this.get("Display")?(this.externalDiv.html(this.computeLegendHTML(o.legend.legendItems)),this.externalDiv.find("ul > li").on("click",function(){var e=$(t.externalDiv).index();o.options.legend.reverse&&(e=o.legend.legendItems.length-1-e),$(t).toggleClass("strike"),_.each(o.data.datasets,function(t){_.each(t._meta,function(t){t.data[e].hidden=!t.data[e].hidden}),o._meta&&o._meta.data&&o._meta.data[e]}),o.update()}),this.computehtmlLegendStyle()):this.externalDiv.html("")},y.prototype.computePaddingAdjustment=function(){var t=this.get("Position"),e=this.toolsEnabled?30:0;return this.computehtmlLegendStyle(),this.get("LegendScroll")&&this.get("Display")?{top:"top"===t?30+e:50,left:"left"===t?100:0,right:"right"===t?100:0,bottom:"bottom"===t?60:5}:{top:e||5,left:0,right:0,bottom:0}},y.prototype.computehtmlLegendStyle=function(){var t=this.toolsEnabled?30:0;this.get("LegendScroll")?("bottom"===this.get("Position")?this.externalDiv.css({bottom:0,top:"",left:"",right:"",width:"auto",height:"30px"}):"top"===this.get("Position")?this.externalDiv.css({top:t||10,bottom:"",left:"",right:"",width:"auto",height:"30px"}):"left"===this.get("Position")?this.externalDiv.css({top:t||10,bottom:"",left:0,right:"",width:"100px",height:"auto"}):"right"===this.get("Position")&&this.externalDiv.css({top:t||10,bottom:"",left:"",right:5,width:"100px",height:"auto"}),this.externalDiv.css({color:this.get("LabelColor"),"font-size":this.get("LabelFontSize"),"font-family":"'Helvetica Neue', 'Helvetica', 'Arial', sans-serif"}),this.externalDiv.find("span").css({width:this.get("BoxWidth"),"margin-right":this.get("Padding")+"px","margin-left":this.get("Padding")+"px"})):this.externalDiv.css({top:"",bottom:20,left:"",right:""})},y.prototype.computeLegendHTML=function(t){return O.externalLegend(t)};var m,W=y;function y(){var t=null!==m&&m.apply(this,arguments)||this;return t.toolsEnabled=!0,t}S=i.DeepModel,o(v,S),v.prototype.toPieJSON=function(){return _.chain(this.toJSON()).toPairs().reduce(function(t,e){return t[e[0].toLowerCase()]=e[1],t},{}).value()},v.prototype.customTooltip=function(t,e,o){var a,i=t._model,r=t._view,n={},s=this.api.getProperty("Style.advancedTooltip"),l=_.get(t,"_chart.active[0]._datasetIndex");this.tooltip&&(this.api.removeTooltip(),delete this.tooltip),i.dataPoints&&(a=i.dataPoints[0].index,i&&(n=this.getHandleBarParams(o,t,a,l)),this.tooltip=this.api.setTooltip({data:n,text:s,anchorEl:t._chart.canvas,position:{left:r.caretX||t._eventPosition.x,top:r.caretY||t._eventPosition.y}}))},v.prototype.getHandleBarParams=function(s,l,c,d){var o={},p=s.get("Basics.Data").dataSet.collection,t=p.models[0],t=_.get(t,"attributes")?t.attributes:{},h=[],t=(_.each(l._data.datasets,function(t,e){var o=l._chart.getDatasetMeta(e),a=_.sum(_.map(t.data,function(t,e){return o.data[e].hidden?0:parseFloat(t)})),i=parseFloat(t.data[c]),r=Object.keys(s.chartData)[e],n=s.get("DataSet.Layers."+e+".Segment");void 0!==d&&d!==e||(e=p.models[c],h.push({color:_.isArray(t.backgroundColor)?t.backgroundColor[c]:t.backgroundColor,cols:e?e.attributes:{},isLayerEnabled:!0,label:t.label[c],layerData:i,layerDataFormatted:t.label[c],layerName:""===r?n:r,percent:i/a*100,value:i}))}),_.each(t,function(t,e){o[e]=t}),{dataSet:h,points:h});return _.extend(t,o)},v.Enabled=!1;var S,Z=v;function v(t){var e=S.call(this,t)||this;return e.api=t,b.registerHelper("toFixed",function(t,e){return parseFloat(t).toFixed(e)}),b.registerHelper("commaFormat",function(t){return t.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}),b.registerHelper("smartNumber",function(t){t=parseFloat(t);return isNaN(t)?t:h.Tools.smartFormatNumber(t,0)}),e}x=i.DeepModel,o(C,x),C.prototype.computeLayoutProp=function(t){var e=void 0===this.get("Padding.Top")?0:this.get("Padding.Top"),o=void 0===this.get("Padding.Left")?0:this.get("Padding.Left"),a=void 0===this.get("Padding.Bottom")?0:this.get("Padding.Bottom"),i=void 0===this.get("Padding.Right")?0:this.get("Padding.Right");return{padding:{top:e+t.top,left:o+t.left,right:i+t.right,bottom:a+t.bottom}}};var x,U=C;function C(){return null!==x&&x.apply(this,arguments)||this}"function"!=typeof Object.assign&&Object.defineProperty(Object,"assign",{value:function(t){if(null===t)throw new TypeError("Cannot convert undefined or null to object");var o=Object(t);return _.each(arguments,function(t){if(null!==t)for(var e in t)Object.prototype.hasOwnProperty.call(t,e)&&(o[e]=t[e])}),o},writable:!0,configurable:!0});P.cache=function(l,c,d,p){var t;_.isArray(d.load)&&(t=d.load.reduce(function(t,e,o){if(!l.cache)return t;var a,i,r,n,s=l.cache[e];return s.get("_viewType")&&(s=(a=s).get("value"),i=(r=(c+e).split(".")).pop(),r=r.join("."),n={},i&&(n[i]=a,p.setProperty(r,n,{bypass:!0}))),t[e]=s||d.defaults&&d.defaults[o],t},{}),l.set(t)),_.isArray(d.store)&&(t=d.store.reduce(function(t,e){var o=(c+e).split("."),a=o.pop();return a&&(t[e]=p.getProperty(o.join("."))[a]),t},{}),_.extend(l.cache,t),t=d.store.reduce(function(t,e){return t[e]=void 0,t},{}),l.set(t))},P.expandNestedViewStates=function(t,e){var o,a=/([a-zA-Z]+)\.[0-9]+\./,i=Object.keys(t),r=[];return(r=_.every(i,function(){var t=e.getPropertyMeta(i[0]);return t&&"viewstate"===t.type})?_.uniq(_.filter(_.map(i,function(t){t=a.exec(t);return t?t[1]:null}))):r).length?(o={},_.each(r,function(t){return o[t]=e.getProperty(t)}),o):t},P.focus2Array=function(t){var e=[],o=/"([^"]*)"/g,t=t.toString?t.toString():"",a=/^\[([^\]]*)]$/.exec(t);if(null!==a){if(/^(?:"[^"\\]*(?:\\[\S\s][^"\\]*)*")(?:,"[^"\\]*(?:\\[\S\s][^"\\]*)*")*/.test(a[1]))for(var i=void 0;null!==(i=o.exec(a[1]));)e.push(_.map(i[1].split(","),function(t){return t.replace(/&#44;/g,",")}))}else e.push(t.split(","));return _.filter(e,function(t){return 0<(""+t).length})},P.getConditionResult=function(t,e,o){var a,i,r={isMatch:function(t,e){var o,a=!1,i=t.split(/ +and +| +/);for(_.includes(i,"or")&&(i=_.without(i,"or"),a=!0),o=0;o<i.length;o++)0!==i[o].indexOf("-")&&i[o].indexOf("*")<0&&(i[o]="*"+i[o]+"*");return _[a?"some":"every"](i,function(t){return r.isSimpleMatch(t,e)})},isSimpleMatch:function(t,e){var o=!1,t=(0===t.indexOf("-")&&(t=t.replace("-",""),o=!0),new RegExp("^"+t.replace(/\*/g,".*")+"$").test(e));return o?!t:t}},n=!1,s=isNaN(parseFloat(t))||_.isObject(t)?(""+t).toLowerCase():parseFloat(t),l=isNaN(parseFloat(e))||_.isObject(e)?(""+e).toLowerCase():parseFloat(e);switch(t&&t.class&&0<=["1212","1213","1214","1215"].indexOf(t.class)?(s=h.Tools.convertKDBTemporalToMoment(t).unix(),"in"===o?(a=[],_.each(e.toString().split(","),function(t){a.push(h.Tools.convertDateStringValueToMoment(t).unix()),l=a.toString()})):l=h.Tools.convertDateStringValueToMoment(e).unix()):t&&t.class&&0<=["1216","1217","1218","1219"].indexOf(t.class)&&(s=h.Tools.convertKDBTemporalToMoment(t).valueOfNano(),"in"===o?(i=[],_.each(e.toString().split(","),function(t){i.push(h.Tools.convertDateStringValueToMoment(t).valueOfNano()),l=i.toString()})):l=h.Tools.convertDateStringValueToMoment(e).valueOfNano()),o){case"contains":n=0<=s.toString().indexOf(l.toString());break;case"starts with":n=0===s.toString().indexOf(l.toString());break;case"ends with":n=-1!==s.toString().indexOf(l.toString(),s.toString().length-l.toString().length);break;case"==":n=s===l;break;case"<":n=s<l;break;case">":n=l<s;break;case"<=":n=s<=l;break;case">=":n=l<=s;break;case"!=":n=s!==l;break;case"in":n=0<=l.toString().split(",").indexOf(s.toString());break;case"search":n=r.isMatch(l,s);break;case"regexp":n=new RegExp(e.toString()).test(t?t.toString():"")}return n},P.isDuration=function(t){return _.get(t,"_kdbType")&&0<=["1216","1217","1218","1219"].indexOf(t._kdbType)},P.getFormatter=function(a,i,r,n){return"Number"===a||"Formatted Number"===a||"Smart Number"===a||"Datetime"===a||"Currency"===a||"SmartCurrency"===a?function(t){var e,o=t;if(null==(t="Smart Number"!==a&&"Formatted Number"!==a||_.isNumber(t)?t:_.isNumber(parseFloat(t))?parseFloat(t):t))return"";if("Smart Number"===a)o=_.isNumber(t)?h.Tools.smartFormatNumber(t,i):_.escape(t);else{if("Datetime"===a)return e=t,s.isMoment(t)||s.isDuration(t)?(P.isDuration(t)?h.Tools.convertValueToMoment(t.valueOf()):t).format(n):h.Tools.isKDBTemporal(t)?h.Tools.convertKDBTemporalToMoment(t).format(n):("number"==typeof t&&(e=new Date(t)),h.Tools.convertDateStringValueToMoment(e.toString()).format(n));o="Formatted Number"===a&&t.toFixed?_.isNaN(t)?"":h.Tools.formatNumber(t,i):t.toFixed?t.toFixed(i):_.escape(o)}if(r&&0<=o.toString().indexOf(".")){for(;"0"===o[o.length-1];)o=o.slice(0,-1);"."===o[o.length-1]&&(o=o.slice(0,-1))}return o}:"Boolean"===a?function(t){return _.escape(t)}:function(t){return s.isMoment(t)||s.isDuration(t)?t.format(n,void 0):_.escape(t)}},P.pump=function(o){if(null==o)return o;if(!_.isObject(o))return o;var t=Object.getPrototypeOf(o);if(_.isObject(o)&&t!==Object.prototype&&t!==Array.prototype)return o;if(t===Array.prototype&&_.isArray(o))return o.map(P.pump);var a=/^(\d+)((?:\.\w+)+)$/;if(Object.keys(o).every(function(t){return a.test(t)}))return Object.keys(o).map(function(t){var e=a.exec(t);return _.isNil(e)?{index:0,tail:void 0,value:void 0}:{index:Number(e[1]),tail:e[2].substring(1),value:o[t]}}).reduce(function(t,e){var o={},a=void 0===e.index?0:e.index;return o[a]={},o[a][e.tail]=e.value,$.extend(!0,t,P.pump(o))},[]);var i={greedy:/^(\w+)((?:\.\w+)*)$/,nonGreedy:/^(\w+)((?:\.\w+)+)$/};return Object.keys(o).some(function(t){return i.nonGreedy.test(t)})?Object.keys(o).map(function(t){var e=i.greedy.exec(t);return{head:_.isNil(e)?null:e[1],tail:_.isNil(e)||""===e[2]?null:e[2].substring(1),value:o[t]}}).reduce(function(t,e){var o={},a=null!==e.tail,i=_.isNil(e.head)?0:e.head,r=_.isNil(e.tail)?0:e.tail;return a?(o[i]={},o[i][r]=e.value):o[i]=e.value,$.extend(!0,t,P.pump(o))},{}):_.mapValues(o,P.pump)},P.replaceViewStatesWithValue=function(t,e,o){return P.replaceViewStates(t,e,function(t,e,o,a){return a.value!==o&&console.warn("viewModel value has changed"),a.value},o)},P.alpha=function(t,e){return new Color(t).alpha(e/100).rgbaString()},P.replaceViewStates=function(o,t,l,c){var d;return d=function(t,e){return function o(t,e,a){a=a?a+".":"";var i,r,n=c.getPropertyMeta(a+(e+="")),s=t&&t.has&&t.has("_dataSource")&&t.has("_dataType"),s=(_.isArray(t)||_.isObject(t))&&!s;return n&&"data"===n.type?t:n&&"viewstate"===n.type?(i=(r=(a+e).split(".")).pop(),r=r.join("."),l(r,void 0===i?"":i,t,n)):s?(a+=e,d=function(t,e){return o(t,e,a)},(_.isArray(t)?_.map:_.mapValues)(t,d)):t}(t,e,o||"")},(_.isArray(t)?_.map:_.mapValues)(t,d)};var D=P;function P(){}var w={Trigger:{type:"string",enum:["Click","Hover"],default:"Click",title:"Trigger Action",propertyOrder:2,options:{hidden:!0}}},L=(E.getComponentDefinition=function(t){var e,o,a={id:1,componentName:"PieJS",componentDescription:"",version:"4.5.1",appArgs:{quickStart:[{path:"Basics.Data",message:"populate Data Source"}],json:{version:"4.5.1",Basics:{Data:"",Theme:"Dark",Focus:"",Selected:"",SelectedAttr:"",PopoutSelected:!1,PopoutSelectedSize:10,Actions:[]},DataSet:{Label:"",DonutRatio:50,Rotation:50,Circumference:100,BorderWidth:1,Layers:[{Segment:"",Display:"",UseColor:!0,Color:"#0061FF",BorderColor:"#ffffff",ColorOpacity:85,HighlightRules:[]}]},Legend:{Display:!0,FullWidth:!0,Reverse:!1,Position:"top",LabelColor:"#ffffff",LabelFontFamily:"Helvetica",LabelFontSize:12,BoxWidth:40,Padding:10,UsePointStyle:!0,Mode:"Toggle Hidden",LegendScroll:!1},InnerLabel:{Innertitle:"",InnertitleColor:"#ffffff",InnertitleFont:"Verdana",InnertitleSize:12,ShowPieceLabel:!1,ShowZero:!1,PieceLabelArc:!1,PieceLabelColor:"#ffffff",PieceLabelOverlap:!1,PieceLabelRender:"percentage",PieceLabelPosition:"default",PieceLabelTemplate:"",FontSize:10,Format:"General",Precision:2,HideTrailingZeroes:!1,Prefix:"",Suffix:"",DateFormat:"YYYY-MM-DD"},Padding:{Top:2,Bottom:2,Left:2,Right:2},Animations:{Enabled:!1},Style:{chartBarColors:[{type:"#0061FF"},{type:"#F23A66"},{type:"#009BAB"},{type:"#7647CC"},{type:"#FFC300"},{type:"#9FA3A6"},{type:"#003A99"},{type:"#A90B31"},{type:"#005D67"},{type:"#452481"}],advanced:"",advancedTooltip:'<div> <table>{{#each dataSet}} <tbody> {{#eq @index 0}} <tr> <td colspan="2">{{label}}</td> </tr> {{/eq}} <tr><td>{{xaxis}}</td> <td><svg style="width:20px;height:20px"> <circle fill="{{color}}" stroke-width="2" stroke="white" r="8" cy="10" cx="10"> </circle> </svg></td> <td>{{layerName}} :</td> <td>{{toFixed value 2}} ({{toFixed percent 2}}%)</td> </tr> {{/each}} </tbody> </table> </div>'},FileExport:{ShowScreenshot:!1,ShowExportCsvButton:!1,ShowExportExcelButton:!1,FileName:[]},possibleColumns:[""],possibleLabels:[""]},schema:{type:"object",title:"Properties",properties:{possibleLabels:{type:"array",propertyOrder:1,format:"table",default:["sym"],options:{collapsed:!0,hidden:!0}},possibleColumns:{propertyOrder:2,type:"array",format:"table",default:["sym"],options:{collapsed:!0,hidden:!0}},possibleRules:{type:"array",propertyOrder:1,format:"table",default:[],options:{collapsed:!0,hidden:!0}},Basics:{type:"object",propertyOrder:3,title:"Basics",options:{collapsed:!1},properties:{Data:{type:"data",format:"string",title:"Data Source",default:""},Theme:{type:"string",title:"Theme",options:{hidden:!0},enum:["Light","Dark"]},DashboardTheme:{options:{hidden:!0}},Focus:{type:"viewstate",title:"Focus",default:""},Selected:{type:"viewstate",title:"Selected Value",default:""},SelectedAttr:{type:"string",title:"Selected Value Attribute",enumSource:"possible_labels",watch:{possible_labels:"root.possibleLabels"}},PopoutSelected:{type:"boolean",title:"Popout on selection",default:!1,format:"checkbox"},PopoutSelectedSize:{title:"Popout Size",default:10,minimum:1,maximum:100,type:"number",step:1,format:"range"},FixedColumn:{type:"string",title:"Column Def"},Actions:{type:"actions",options:{collapsed:!0},fields:{map:_.extend({Current:{title:"Source",type:"string",enumSource:"possible_columns",watch:{possible_columns:"root.possibleColumns"}},ViewstateProperty:{title:"Viewstate",type:"viewstate"}},w),nav:w,query:w,url:w}}}},DataSet:{type:"object",propertyOrder:4,title:"Data",options:{collapsed:!0},properties:{Label:{propertyOrder:1,default:"",title:"Series Key",type:"customDropdown",data:"possible_labels",watch:{possible_labels:"root.possibleLabels"}},DonutRatio:{title:"Cut out %",propertyOrder:2,default:35,minimum:1,maximum:100,type:"number",step:1,format:"range"},Rotation:{title:"Rotation",propertyOrder:3,default:50,minimum:0,maximum:100,type:"number",step:1,format:"range"},Circumference:{title:"Circumference",propertyOrder:4,default:100,minimum:0,maximum:100,type:"number",step:1,format:"range"},BorderWidth:{title:"Border Width",propertyOrder:5,default:1,minimum:0,maximum:10,type:"number",step:1,format:"range",options:{hidden:!0}},Layers:{type:"array",propertyOrder:8,format:"object",title:"Layers",uniqueItems:!1,options:{collapsed:!0,reset:!0},items:{type:"object",title:"Layer",properties:{Segment:{default:"",title:"Series Data",type:"customDropdown",data:"possible_columns",watch:{possible_columns:"root.possibleColumns"}},Display:{type:"string",default:"",title:"Display"},UseColor:{type:"boolean",title:"Use Colour Palette",default:!0,format:"checkbox"},Color:{type:"gradient",options:{gradient:!1},title:"Color",default:"#0061FF"},BorderColor:{title:"Border Color",type:"gradient",options:{gradient:!1,noColor:!0},default:"#ffffff"},ColorOpacity:{title:"Color Opacity",default:85,minimum:1,maximum:100,type:"number",step:1,format:"range"},HighlightRules:{type:"array",title:"Highlight Rules",options:{collapsed:!0},items:{type:"object",title:"Highlight Rule",properties:{RuleName:{type:"string",title:"Rule Name",default:""},RuleSource:{type:"string",title:"Rule Source",default:"",enumSource:"possible_cols",watch:{possible_cols:"root.possibleColumns"}},RuleOperation:{type:"string",title:"Rule Operation",default:"",enum:["","search","contains","starts with","ends with","==","<",">","<=",">=","!=","Fill Left-to-Right","Fill Right-to-Left"]},RuleValue:{type:"string",title:"Rule Value",data:"possible_columns",default:""},RuleColor:{title:"Rule Colour",type:"gradient",options:{gradient:!1,noColor:!1},default:"#ffffff"},RuleBorderColor:{title:"Rule Border Color",type:"gradient",options:{gradient:!1,noColor:!1},default:"#ffffff"},Show:{title:"Show Rule in Legend",type:"boolean",format:"checkbox",default:!1}}}}}}}}},Legend:{type:"object",title:"Legend",propertyOrder:5,options:{collapsed:!0},properties:{Display:{type:"boolean",format:"checkbox",default:!0},FullWidth:{type:"boolean",title:"Full Width",format:"checkbox",default:!0},Reverse:{type:"boolean",title:"Reverse Order",format:"checkbox",default:!1},Position:{type:"string",default:"top",enum:["top","bottom","left","right"]},LabelColor:{title:"Label Colour",type:"gradient",options:{gradient:!1},default:"#898989"},LabelFontFamily:{type:"string",title:"Label Font Family",options:{hidden:!0},enum:["Helvetica","Arial","Times New Roman","Times","Courier New","Courier","Verdana","Georgia","Palatino","Garamond","Comic Sans MS"],default:"Helvetica"},LabelFontSize:{type:"number",title:"Label Font Size",default:12},BoxWidth:{type:"number",title:"Legend Box Width",default:40},Padding:{type:"number",title:"Legend Box Padding",default:10},UsePointStyle:{type:"boolean",title:"Use Point Style",format:"checkbox",default:!0},LegendScroll:{type:"boolean",title:"Scrolling legends",format:"checkbox",default:!0},Mode:{type:"string",title:"Mode",enum:["Toggle Hidden","Select Only"],default:"Toggle Hidden"}}},Padding:{type:"object",title:"Padding",propertyOrder:5,options:{collapsed:!0},properties:{Left:{type:"number",default:2},Right:{type:"number",default:2},Top:{type:"number",default:2},Bottom:{type:"number",default:2}}},Style:{type:"object",propertyOrder:7,title:"Style",options:{collapsed:!0},properties:{chartBarColors:{type:"array",format:"table",title:"Colour Palette",propertyOrder:1,options:{collapsed:!1},uniqueItems:!1,items:{type:"object",title:"Bar Colour",properties:{type:{type:"gradient",options:{gradient:!1},title:"color",default:"#ffa500"}}},default:[{type:"#0061FF"},{type:"#7995b8"},{type:"#808387"},{type:"#a69775"},{type:"#749450"},{type:"#51966a"},{type:"#e2c7c0"},{type:"#9acad6"},{type:"#1995a3"},{type:"#484d6e"}]},advanced:{type:"css",title:"Advanced CSS",propertyOrder:2,default:""},advancedTooltip:{data:["xaxis","yaxis","key","color"],default:"",propertyOrder:3,title:"Custom tooltip",templateItems:{points:{type:"array",items:{layerName:"layerName",layerData:"layerData",layerDataFormatted:"layerDataFormatted",colors:{backgroundColor:"backgroundColor",borderColor:"borderColor"},cols:null,isLayerEnabled:"isLayerEnabled"}}},type:"tooltipTemplate"}}},FileExport:{type:"object",propertyOrder:320,title:"File Export",options:{collapsed:!0},properties:{ShowExportCsvButton:{type:"boolean",title:"Show Export Csv Button",default:!1,format:"checkbox"},ShowExportExcelButton:{type:"boolean",title:"Show Export Excel Button",default:!1,format:"checkbox"},ShowScreenshot:{type:"boolean",title:"Show Screenshot Button",default:!1,format:"checkbox"},FileName:{type:"array",format:"table",title:"FileName",options:{hidden:!1,collapsed:!0},items:{type:"object",title:"Filename Part",options:{collapsed:!0},properties:{FileNamePart:{title:"FileName Part",type:"string"}}}}}},Animations:{type:"object",propertyOrder:6,options:{collapsed:!0},properties:{Enabled:{type:"boolean",format:"checkbox",default:!1},Easing:{type:"string",enum:["linear","easeInQuad","easeOutQuad","easeInOutQuad","easeInCubic","easeOutCubic","easeInOutCubic","easeInQuart","easeOutQuart","easeInOutQuart","easeInQuint","easeOutQuint","easeInOutQuint","easeInSine","easeOutSine","easeInOutSine","easeInExpo","easeOutExpo","easeInOutExpo","easeInCirc","easeOutCirc","easeInOutCirc","easeInElastic","easeOutElastic","easeInOutElastic","easeInBack","easeOutBack","easeInOutBack","easeInBounce","easeOutBounce","easeInOutBounce"],default:""},Duration:{type:"number",format:"number",default:0}}},InnerLabel:{type:"object",propertyOrder:5,title:"Labels",options:{collapsed:!0},properties:{Innertitle:{type:"string",title:"Inner Label",propertyOrder:1,default:""},InnertitleFont:{type:"string",title:"Inner Label Font",propertyOrder:2,enum:["Verdana","fontawesome","Arial","Helvetica","Times","Courier"],default:"Verdana"},InnertitleSize:{type:"number",title:"Inner Label Size",propertyOrder:3,default:12},InnertitleColor:{type:"gradient",title:"Inner Label Color",propertyOrder:6,default:"#ffffff"},ShowPieceLabel:{title:"Show Piece Label",propertyOrder:7,type:"boolean",format:"checkbox",default:!1},ShowZero:{title:"Piece Label Show Zero ",propertyOrder:8,type:"boolean",format:"checkbox",default:!1},PieceLabelArc:{title:"Piece Label Arc",propertyOrder:9,type:"boolean",format:"checkbox",default:!1},PieceLabelOverlap:{title:"Piece Label Overlap",propertyOrder:10,type:"boolean",format:"checkbox",default:!1},PieceLabelRender:{title:"Piece Label Type",propertyOrder:11,type:"string",enum:["label","value","percentage"],default:"percentage"},PieceLabelTemplate:{default:"",propertyOrder:12,templateItems:{values:{items:_.keyBy(["percentage","value","label"]),type:"object"}},title:"Piece Label Template",type:"tooltipTemplate"},PieceLabelPosition:{title:"Piece Label Position",propertyOrder:13,type:"string",enum:["default","border","outside"],default:"default"},PieceLabelColor:{title:"Piece Label Colour",propertyOrder:14,type:"gradient",default:"#ffffff"},FontSize:{title:"Piece Font Size",propertyOrder:15,type:"number",default:12},Format:{type:"string",propertyOrder:16,enum:["General","Number","Smart Number","Datetime"],default:"General"},Precision:{type:"number",propertyOrder:17,title:"Decimal Places",format:"number",minimum:0,maximum:10,default:2},HideTrailingZeroes:{type:"boolean",propertyOrder:18,title:"Hide Trailing Zeroes",format:"checkbox",default:!1},DateFormat:{type:"string",propertyOrder:19,title:"Date/Time format",enum:["YYYY-MM-DD","YYYY-MMM-DD","YYYY-MMMM-DD","YYYY-MM","YYYY-MMM","YYYY-MMMM","MMM DD","MMM Do","YYYY-MM-DD HH:mm:ss","YYYY-MM-DD hh:mm:ss","YYYY-MM-DD kk:mm:ss","hh:mm:ss","kk:mm:ss","hh:mm:ss.SS","hh:mm","kk:mm","mm:ss","mm:ss.SS"],default:"YYYY-MM-DD"},Prefix:{type:"string",propertyOrder:20,default:""},Suffix:{type:"string",propertyOrder:21,default:""}}}}}}};if(0<_.keys(t.settingsModel.attributes).length)for(o=E.upgrades.indexOf(_.find(E.upgrades,{version:t.settingsModel.get("version")}))+1;o<E.upgrades.length;o+=1)(e=E.upgrades[o]).fn(t.settingsModel),t.settingsModel.set("version",e.version);return a},E);function E(){}function F(){this.drawDataset=this.drawDataset.bind(this)}function k(t,e){if(function(t){if(t.options.pieceLabel){var e=1;if(Array.isArray(t.options.pieceLabel)&&(e=t.options.pieceLabel.length),!t.pieceLabel||e!==t.pieceLabel.length){t.pieceLabel=[];for(var o=0;o<e;++o)t.pieceLabel.push(new F)}}else t.pieceLabel&&delete t.pieceLabel;return t.pieceLabel}(t))for(var o=0;o<t.pieceLabel.length;++o)t.pieceLabel[o][e](t,o)}L.upgrades=[{version:0,fn:function(){}},{version:"4.1.0.3",fn:function(t){var e=t.get("InnerLabel");e.Format=void 0===e.Format?"General":e.Format,e.Precision=void 0===e.Precision?2:e.Precision,e.HideTrailingZeroes=void 0!==e.HideTrailingZeroes&&e.HideTrailingZeroes,e.Prefix=void 0===e.Prefix?"":e.Prefix,e.Suffix=void 0===e.Suffix?"":e.Suffix,e.DateFormat=void 0===e.DateFormat?"YYYY-MM-DD":e.DateFormat,t.set("InnerLabel",e)}},{version:"4.1.0s4b",fn:function(t){var e=t.get("FileExport"),o=t.get("Padding"),a=t.get("DataSet.Layers");void 0===e?(t.set("FileExport.ShowExportCsvButton",!1),t.set("FileExport.ShowExportExcelButton",!1),t.set("FileExport.ShowScreenshot",!1),t.set("FileExport.FileName",[])):t.set("FileExport",e),void 0===o&&t.set("Padding",{Right:2,Bottom:2,Left:2,Top:2}),_.each(a,function(t){t.BorderColor=void 0===t.BorderColor?"#ffffff":t.BorderColor})}},{version:"4.2.1",fn:function(t){t.set("InnerLabel.InnertitleSize",0)}},{version:"4.3.1",fn:function(t){var e=t.get("Basics"),o=t.get("Legend"),a=t.get("InnerLabel"),i=(e.PopoutSelected=void 0!==e.PopoutSelected&&e.PopoutSelected,e.PopoutSelectedSize=void 0===e.PopoutSelectedSize?10:e.PopoutSelectedSize,o.Mode=void 0===o.Mode?"Toggle Hidden":o.Mode,e.SelectedObjectRouting);if(!i)return t.set("Basics.Actions",[]),void t.unset("Basics.SelectedObjectRouting");i=_.map(i,function(t){return{_Type:"map",Trigger:"Click",Current:t.ColumnProperty,Target:t.ViewstateProperty}});t.set("Basics",e),t.set("Legend",o),t.set("Basics.Actions",i),t.unset("Basics.SelectedObjectRouting"),a.FontSize=void 0===a.FontSize?10:a.FontSize,t.set("InnerLabel",a)}},{version:"4.5.1",fn:function(t){var e=t.get("InnerLabel"),o=t.get("Style"),a=t.get("Legend");e.PieceLabelTemplate=void 0===e.PieceLabelTemplate?"":e.PieceLabelTemplate,t.set("InnerLabel",e);'<div><span>{{dataSet.0.label}}</span><br/><table>{{#each dataSet}}<tr><td>{{xaxis}}</td><td><svg style="width:20px;height:20px"><circle cx="10" cy= "10" r="8" stroke="white" stroke-width="2" fill= "{{color}}" > </circle></svg> </td><td>{{layerData}} :</td><td>{{toFixed value 2}} ({{toFixed percent 2}}%)</td> </tr>{{/each}} </table></div>'===o.advancedTooltip?o.advancedTooltip='<div> <table>{{#each dataSet}} <tbody> {{#eq @index 0}} <tr> <td colspan="2">{{label}}</td> </tr> {{/eq}} <tr><td>{{xaxis}}</td> <td><svg style="width:20px;height:20px"> <circle fill="{{color}}" stroke-width="2" stroke="white" r="8" cy="10" cx="10"> </circle> </svg></td> <td>{{layerName}} :</td> <td>{{toFixed value 2}} ({{toFixed percent 2}}%)</td> </tr> {{/each}} </tbody> </table> </div>':(e=new RegExp("{{layerData}}","g"),o.advancedTooltip=o.advancedTooltip.replace(e,"{{layerName}}")),t.set("Style",o),a.Mode="Toogle Hidden"===a.Mode?"Toggle Hidden":a.Mode,t.set("Legend",a)}}],"undefined"==typeof Chart?console.warn("Can not find Chart object."):(Array.isArray||(Array.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)}),F.prototype.beforeDatasetsUpdate=function(t,e){this.parseOptions(t,e),"outside"===this.position&&(e=1.5*this.fontSize+this.outsidePadding,t.chartArea.top+=e,t.chartArea.bottom-=e)},F.prototype.afterDatasetsDraw=function(t,e){this.parseOptions(t,e),this.labelBounds=[],t.config.data.datasets.forEach(this.drawDataset)},F.prototype.drawDataset=function(t){for(var e=this.ctx,o=this.chartInstance,a=t._meta[Object.keys(t._meta)[0]],i=0,r=0;r<a.data.length;r++){var n,s,l,c,d,p,h,u,f,g=a.data[r],m=g._view,y=void 0;if(0!==m.circumference||this.showZero){switch(this.render){case"value":var b=t.data[r],y=(b=this.format?this.format(b):b).toString();break;case"advanced":b=t.data[r];y=(b=this.format?this.format(b):b).toString();break;case"label":y=o.config.data.labels[r];break;case"image":y=this.images[r]?this.loadImage(this.images[r]):"";break;default:var S=m.circumference/this.options.circumference*100,S=parseFloat(S.toFixed(this.precision));this.showActualPercentages||100<(i+=S)&&(S-=i-100,S=parseFloat(S.toFixed(this.precision))),y=S+"%"}(y="function"==typeof this.render&&"object"==typeof(y=this.render({label:o.config.data.labels[r],value:t.data[r],percentage:S,dataset:t,index:r}))?this.loadImage(y):y)&&(e.save(),e.beginPath(),e.font=Chart.helpers.fontString(this.fontSize,this.fontStyle,this.fontFamily),"outside"===this.position||"border"===this.position?(s=m.outerRadius/2,d=this.fontSize+this.textMargin,c=m.startAngle+(m.endAngle-m.startAngle)/2,"border"===this.position?l=(m.outerRadius-s)/2+s:"outside"===this.position&&(this.arc||(d=this.textMargin),l=m.outerRadius-s+s+d),c={x:m.x+Math.cos(c)*l,y:m.y+Math.sin(c)*l},"outside"===this.position&&(this.arc||(d+=this.measureText(y).width/2),c.x<m.x?c.x-=d:c.x+=d,n=m.outerRadius+d)):(s=m.innerRadius,c=g.tooltipPosition()),"function"==typeof(d=this.fontColor)?d=d({label:o.config.data.labels[r],value:t.data[r],percentage:S,text:y,backgroundColor:t.backgroundColor[r],dataset:t,index:r}):"string"!=typeof d&&(d=d[r]||this.options.defaultFontColor),this.arc?(n=n||(s+m.outerRadius)/2,e.fillStyle=d,e.textBaseline="middle",this.drawArcText(y,n,m,this.overlap)):(f=this.measureText(y),p=c.x-f.width/2,h=c.x+f.width/2,u=c.y-f.height/2,f=c.y+f.height/2,(!!this.overlap||("outside"===this.position?this.checkTextBound(p,h,u,f):g.inRange(p,u)&&g.inRange(p,f)&&g.inRange(h,u)&&g.inRange(h,f)))&&this.fillText(y,c,d)),e.restore())}}},F.prototype.parseOptions=function(t,e){var o=t.options.pieceLabel;Array.isArray(o)&&(o=o[e]),this.chartInstance=t,this.ctx=t.chart.ctx,this.options=t.config.options,this.render=o.render||o.mode,this.position=o.position||"default",this.arc=o.arc,this.format=o.format,this.precision=o.precision||0,this.fontSize=o.fontSize||this.options.defaultFontSize,this.fontColor=o.fontColor||this.options.defaultFontColor,this.fontStyle=o.fontStyle||this.options.defaultFontStyle,this.fontFamily=o.fontFamily||this.options.defaultFontFamily,this.shadowOffsetX=o.shadowOffsetX||3,this.shadowOffsetY=o.shadowOffsetY||3,this.shadowColor=o.shadowColor||"rgba(0,0,0,0.3)",this.shadowBlur=o.shadowBlur||6,this.textShadow=o.textShadow||!1,this.hasTooltip=t.tooltip._active&&t.tooltip._active.length,this.showZero=o.showZero,this.overlap=o.overlap,this.images=o.images||[],this.outsidePadding=o.outsidePadding||2,this.textMargin=o.textMargin||2,this.showActualPercentages=o.showActualPercentages||!1},F.prototype.checkTextBound=function(t,e,o,a){for(var i=this.labelBounds,r=0;r<i.length;++r){for(var n=i[r],s=[[t,o],[t,a],[e,o],[e,a]],l=0;l<s.length;++l){var c=s[l][0],d=s[l][1];if(c>=n.left&&c<=n.right&&d>=n.top&&d<=n.bottom)return!1}for(s=[[n.left,n.top],[n.left,n.bottom],[n.right,n.top],[n.right,n.bottom]],l=0;l<s.length;++l){c=s[l][0],d=s[l][1];if(t<=c&&c<=e&&o<=d&&d<=a)return!1}}return i.push({left:t,right:e,top:o,bottom:a}),!0},F.prototype.measureText=function(t){if("object"==typeof t)return{width:t.width,height:t.height};for(var e=0,o=t.split("\n"),a=0;a<o.length;++a){var i=this.ctx.measureText(o[a]);i.width>e&&(e=i.width)}return{width:e,height:this.fontSize*o.length}},F.prototype.fillText=function(t,e,o){var a=this.ctx;if("object"==typeof t)a.drawImage(t,e.x-t.width/2,e.y-t.height/2,t.width,t.height);else{a.save(),a.fillStyle=o,a.textBaseline="top",a.textAlign="center",this.textShadow&&(a.shadowOffsetX=this.shadowOffsetX,a.shadowOffsetY=this.shadowOffsetY,a.shadowColor=this.shadowColor,a.shadowBlur=this.shadowBlur);for(var i=t.split("\n"),r=0;r<i.length;r++){var n=e.y-this.fontSize/2*i.length+this.fontSize*r;a.fillText(i[r],e.x,n)}a.restore()}},F.prototype.loadImage=function(t){var e=new Image;return e.src=t.src,e.width=t.width,e.height=t.height,e},F.prototype.drawArcText=function(t,e,o,a){var i=this.ctx,r=o.x,n=o.y,s=o.startAngle,o=o.endAngle,r=(i.save(),i.translate(r,n),o-s),n=s+=Math.PI/2;if(s+=((o+=Math.PI/2)-((h=this.measureText(t)).width/e+s))/2,!a&&r<o-s)i.restore();else{if("string"==typeof t){i.rotate(s);var l=t.split("\n"),c=0,d=[],p=0;"border"===this.position&&(p=(l.length-1)*this.fontSize/2);for(var h,u=0;u<l.length;++u)(h=i.measureText(l[u])).width>c&&(c=h.width),d.push(h.width);for(u=0;u<l.length;++u){var f=l[u],g=(l.length-1-u)*-this.fontSize+p,m=(i.save(),(c-d[u])/2);i.rotate(m/e);for(var y=0;y<f.length;y++){var b=f.charAt(y);h=i.measureText(b),i.save(),i.translate(0,-1*e),i.fillText(b,0,g),i.restore(),i.rotate(h.width/e)}i.restore()}}else i.rotate((n+o)/2),i.translate(0,-1*e),this.fillText(t,{x:0,y:0});i.restore()}},Chart.pluginService.register({beforeDatasetsUpdate:function(t){k(t,"beforeDatasetsUpdate")},afterDatasetsDraw:function(t){k(t,"afterDatasetsDraw")}}));T.app=b.template({compiler:[8,">= 4.3.0"],main:function(t,e,o,a,i){return'<div class="chart-container">\n    <canvas class="chart"></canvas>\n    <div class="chartjs-tooltip" style="display:none"></div>\n</div>\n<div class="highlight-rules-dialog" title="Highlight Rules"></div>\n<div class="chart-legend"></div>'},useData:!0}),T.externalLegend=b.template({1:function(t,e,o,a,i){var r,n=null!=e?e:t.nullContext||{},s=t.hooks.helperMissing,l="function",c=t.escapeExpression,t=t.lookupProperty||function(t,e){if(Object.prototype.hasOwnProperty.call(t,e))return t[e]};return'        <li><span style="background-color:'+c(typeof(r=null!=(r=t(o,"fillStyle")||(null!=e?t(e,"fillStyle"):e))?r:s)==l?r.call(n,{name:"fillStyle",hash:{},data:i,loc:{start:{line:3,column:42},end:{line:3,column:55}}}):r)+'; border-color:#fffff"></span>'+c(typeof(r=null!=(r=t(o,"text")||(null!=e?t(e,"text"):e))?r:s)==l?r.call(n,{name:"text",hash:{},data:i,loc:{start:{line:3,column:85},end:{line:3,column:93}}}):r)+"</li>\n"},compiler:[8,">= 4.3.0"],main:function(t,e,o,a,i){return'<ul class="5-legend">\n'+(null!=(o=(t.lookupProperty||function(t,e){if(Object.prototype.hasOwnProperty.call(t,e))return t[e]})(o,"each").call(null!=e?e:t.nullContext||{},e,{name:"each",hash:{},fn:t.program(1,i,0),inverse:t.noop,data:i,loc:{start:{line:2,column:4},end:{line:4,column:13}}}))?o:"")+"</ul>"},useData:!0}),T.fileExporter=b.template({compiler:[8,">= 4.3.0"],main:function(t,e,o,a,i){var r=null!=e?e:t.nullContext||{},n=t.hooks.helperMissing,s=t.escapeExpression,t=t.lookupProperty||function(t,e){if(Object.prototype.hasOwnProperty.call(t,e))return t[e]};return'<div class="tools-panel">\n    <div class="pnlButtons">\n        <span class="lnksExport link-disabled">\n            <i class="fa fa-fw fa-download" title="'+s((t(o,"t")||e&&t(e,"t")||n).call(r,"Data",{name:"t",hash:{},data:i,loc:{start:{line:4,column:51},end:{line:4,column:63}}}))+'"></i>\n            <a class="lnkExcelExport" title="'+s((t(o,"t")||e&&t(e,"t")||n).call(r,"Download the current dataset in Excel format",{name:"t",hash:{},data:i,loc:{start:{line:5,column:45},end:{line:5,column:97}}}))+'">'+s((t(o,"t")||e&&t(e,"t")||n).call(r,"Excel",{name:"t",hash:{},data:i,loc:{start:{line:5,column:99},end:{line:5,column:112}}}))+'</a>\n            <a class="lnkCsvExport" title="'+s((t(o,"t")||e&&t(e,"t")||n).call(r,"Download the current dataset in CSV format",{name:"t",hash:{},data:i,loc:{start:{line:6,column:43},end:{line:6,column:93}}}))+'">'+s((t(o,"t")||e&&t(e,"t")||n).call(r,"CSV",{name:"t",hash:{},data:i,loc:{start:{line:6,column:95},end:{line:6,column:106}}}))+'</a>\n            <a class="lnkDownloadScreenshot" title="'+s((t(o,"t")||e&&t(e,"t")||n).call(r,"Download a PNG image of the chart",{name:"t",hash:{},data:i,loc:{start:{line:7,column:52},end:{line:7,column:93}}}))+'">'+s((t(o,"t")||e&&t(e,"t")||n).call(r,"PNG",{name:"t",hash:{},data:i,loc:{start:{line:7,column:95},end:{line:7,column:106}}}))+"</a>\n        </span>\n    </div>\n</div>"},useData:!0}),T.highlighRule=b.template({1:function(t,e,o,a,i){var r,n=null!=e?e:t.nullContext||{},s=t.hooks.helperMissing,l="function",c=t.escapeExpression,t=t.lookupProperty||function(t,e){if(Object.prototype.hasOwnProperty.call(t,e))return t[e]};return'<div class="highlightRule-menu-item">\n    <svg>\n        <rect x="2" y="5" width="10" height="10" stroke="'+c(typeof(r=null!=(r=t(o,"ruleBorder")||(null!=e?t(e,"ruleBorder"):e))?r:s)==l?r.call(n,{name:"ruleBorder",hash:{},data:i,loc:{start:{line:4,column:57},end:{line:4,column:71}}}):r)+'" fill="'+c(typeof(r=null!=(r=t(o,"ruleColor")||(null!=e?t(e,"ruleColor"):e))?r:s)==l?r.call(n,{name:"ruleColor",hash:{},data:i,loc:{start:{line:4,column:79},end:{line:4,column:92}}}):r)+'" stroke-width="2"></rect>\n    </svg>\n    <span>&nbsp;'+c(typeof(r=null!=(r=t(o,"layer")||(null!=e?t(e,"layer"):e))?r:s)==l?r.call(n,{name:"layer",hash:{},data:i,loc:{start:{line:6,column:16},end:{line:6,column:25}}}):r)+"&nbsp;("+c(typeof(r=null!=(r=t(o,"ruleName")||(null!=e?t(e,"ruleName"):e))?r:s)==l?r.call(n,{name:"ruleName",hash:{},data:i,loc:{start:{line:6,column:32},end:{line:6,column:44}}}):r)+")</span>\n</div>\n"},compiler:[8,">= 4.3.0"],main:function(t,e,o,a,i){return null!=(o=(t.lookupProperty||function(t,e){if(Object.prototype.hasOwnProperty.call(t,e))return t[e]})(o,"each").call(null!=e?e:t.nullContext||{},e,{name:"each",hash:{},fn:t.program(1,i,0),inverse:t.noop,data:i,loc:{start:{line:1,column:0},end:{line:8,column:9}}}))?o:""},useData:!0}),T.htmlLegend=b.template({1:function(t,e,o,a,i){var r,n=null!=e?e:t.nullContext||{},s=t.hooks.helperMissing,l="function",c=t.escapeExpression,t=t.lookupProperty||function(t,e){if(Object.prototype.hasOwnProperty.call(t,e))return t[e]};return'        <li><span style="background-color:'+c(typeof(r=null!=(r=t(o,"fillStyle")||(null!=e?t(e,"fillStyle"):e))?r:s)==l?r.call(n,{name:"fillStyle",hash:{},data:i,loc:{start:{line:3,column:42},end:{line:3,column:55}}}):r)+'; border-color:#fffff"></span>'+c(typeof(r=null!=(r=t(o,"text")||(null!=e?t(e,"text"):e))?r:s)==l?r.call(n,{name:"text",hash:{},data:i,loc:{start:{line:3,column:85},end:{line:3,column:93}}}):r)+"</li>\n"},compiler:[8,">= 4.3.0"],main:function(t,e,o,a,i){return'<ul class="5-legend">\n'+(null!=(o=(t.lookupProperty||function(t,e){if(Object.prototype.hasOwnProperty.call(t,e))return t[e]})(o,"each").call(null!=e?e:t.nullContext||{},e,{name:"each",hash:{},fn:t.program(1,i,0),inverse:t.noop,data:i,loc:{start:{line:2,column:4},end:{line:4,column:13}}}))?o:"")+"</ul>"},useData:!0});var O=T;function T(){}M.getConfig=function(t){var o,a=this,e={".csv":"Csv",".xlsx":"Excel"}[t.fileFormat],i={configSets:{},fileFormat:t.fileFormat,fileName:h.ExportTools.getExportFileName(t.fileName,"",e),workSheetTitle:t.workSheetTitle,metaData:[],dataSet:{}},r=t.columnsConfig,n=r.dataSource;return i.fileName=h.ExportTools.getExportFileName(t.fileName,"",e),i.fileFormat=t.fileFormat,i.workSheetTitle=t.workSheetTitle,n&&(i.dataSet=n.getData().toJSON(),o=r.formats.PieceLabelRender,i.metaData=[this.getExportMetaData({colId:r.labelColId,colFormats:r.formats,kdbType:n.getColumnType(r.labelColId)},"label")],_.each(r.layersIds,function(t){var t="label"===o?r.labelColId:t,e=h.ExportTools.regExValidateColumnIDs(t,n.getColumnNames());0<e.length?e.forEach(function(t){i.metaData.push(a.getExportMetaData({colId:t,colFormats:r.formats,kdbType:n.getColumnType(t)},"layers"))}):console.log("Column with id: '"+t+"' not found")})),i},M.getExportMetaData=function(t,e){var o,a={},i=t.kdbType,r="",n="",s="",l=!1;if("label"===e)switch(i){case 1:o="Boolean";break;case 4:case 5:case 6:case 7:case 8:case 9:o="Number";break;case 15:o="Datetime",s="YYYY-MM-DD HH:mm:ss.SSS";break;case 13:o="Datetime",s="MMM YYYY";break;case 14:case 16:o="Datetime",s="YYYY-MM-DD";break;case 17:o="Datetime",s="HH:mm";break;case 18:o="Datetime",s="HH:mm:ss";break;case 19:o="Datetime",s="HH:mm:ss.SSS";break;default:o="String"}else r=t.colFormats.Prefix,n=t.colFormats.Suffix,o=t.colFormats.Format,s=t.colFormats.DateFormat,l=t.colFormats.HideTrailingZeroes;e=this.resolveColumnTypeAndFormat(o,s,t.colFormats.Precision,i);return a.colId=t.colId,a.colName=t.colId,a.dataType=e.dataType,a.dataKdbType=e.dataKdbType,a.dataFormat=e.dataFormat,a.hideTrailingZeroes=l,a.prefix=r,"percentage"===t.colFormats.PieceLabelRender?a.suffix="":a.suffix=n,a},M.resolveColumnTypeAndFormat=function(t,e,o,a){var i=11<a&&a<20,r=o?"."+Array(o+1).join("0"):"";switch((3===a||a<1||19<a)&&(a=11,e="TO_STRING",t="String"),t){case"Number":e="#0"+r;break;case"Smart Number":t="Number",e="SmartNumber"+r;break;case"Datetime":t=h.ExportTools.getTemporalTypeFromFormat(e),e=h.ExportTools.CHARTS_DATE_FORMAT_MAP[e],e=i?e||"":(t="String","");break;default:t="String",e=""}return{dataType:t=1===a?"Boolean":t,dataFormat:e,dataKdbType:a}},M.getValidPrecission=function(t){var e=void 0!==t?t:0;return e<0?(e=0,console.info("Invalid precission, should be between in range of 0 and 10, got: ",t)):10<e&&(e=10,console.info("Invalid precission, should be between in range of 0 and 10, got: ",t)),e};var Q=M;function M(){}B=i.View,o(I,B),I.prototype.remove=function(){return this.$lnkCsvExport&&this.$lnkCsvExport.off(),this.$lnkExcelExport&&this.$lnkExcelExport.off(),this.$lnkDownloadScreenshot&&this.$lnkDownloadScreenshot.off(),this.stopListening(),i.View.prototype.remove.apply(this)},I.prototype.initializeEvents=function(){this.listenTo(this.model,"change",this.displayChoiceLinkButtons.bind(this)),this.$lnkCsvExport&&this.$lnkExcelExport&&this.$lnkDownloadScreenshot&&(this.$lnkCsvExport.click(_.bind(this.fileExport.bind(this),this,".csv")),this.$lnkExcelExport.click(_.bind(this.fileExport.bind(this),this,".xlsx")),this.$lnkDownloadScreenshot.click(_.bind(this.downloadImage.bind(this),this,".png")))},I.prototype.displayChoiceLinkButtons=function(){var t=this.model.get("FileExport");!t||_.keys(t).length<5||(t.ShowExportCsvButton||t.ShowExportExcelButton||t.ShowScreenshot?(this.$lnkCsvExport&&this.$lnkExcelExport&&this.$lnkDownloadScreenshot&&this.$lnksExport&&(this.$lnksExport.removeClass("link-disabled"),this.$lnkCsvExport.toggleClass("link-disabled",!t.ShowExportCsvButton),this.$lnkExcelExport.toggleClass("link-disabled",!t.ShowExportExcelButton),this.$lnkDownloadScreenshot.toggleClass("link-disabled",!t.ShowScreenshot)),this.$chartContainer.toggleClass("links-enabled",!this.$chartContainer.hasClass("links-enabled")),t.Enabled||this.model.set("FileExport.Enabled",!0)):(this.$lnksExport&&this.$lnksExport.addClass("link-disabled"),this.$chartContainer.removeClass("links-enabled"),t.Enabled&&this.model.set("FileExport.Enabled",!1)))},I.prototype.downloadImage=function(t){var o=("string"==typeof(o=h.ExportTools.getExportFileName(this.getExportConfig().fileName,"","Screenshot"))?o:"Screenshot")+t;this.generateImage(function(t,e){h.Tools.fileSave(o,t,e)})},I.prototype.fileExport=function(t){var e=h.ExportTools,t=Q.getConfig(_.extend(this.getExportConfig(),{fileFormat:t}));e.openFileExportDialog(t)},I.prototype.generateImage=function(e){var t,o=this.getCanvas(),a=o.width,i=o.height,r=document.createElement("canvas"),n="Light"===this.getTheme()?"#F8F8F8":"#282828";o&&(r.width=a,r.height=i,(t=r.getContext("2d"))&&(t.fillStyle=n,t.fillRect(0,0,a,i),t.drawImage(o,0,0),this.isIE?(n=r.toDataURL("image/png"),e(h.Tools.convertDataUrlToBlob(n),"image/png")):t.canvas.toBlob(function(t){e(t,"application/octet-stream")})))},I.prototype.getTheme=function(){return this.appView.dashboardViewModel.get("DashboardTheme")},I.prototype.renderLinks=function(){this.$lnksExport=this.$el.find(".lnksExport"),this.$lnkCsvExport=this.$el.find("a.lnkCsvExport"),this.$lnkExcelExport=this.$el.find("a.lnkExcelExport"),this.$lnkDownloadScreenshot=this.$el.find("a.lnkDownloadScreenshot")};var B,R,q=I;function I(t){var e=B.call(this,t)||this;return e.api=t.api,e.getCanvas=t.getCanvas,e.appView=t.appView,e.getExportConfig=t.getExportConfig,e.isIE=!1,HTMLCanvasElement&&HTMLCanvasElement.prototype&&_.get(HTMLCanvasElement.prototype,"msToBlob")&&(e.isIE=!0),e.$chartContainer=e.appView.$el.find(".chart-container"),e.render(),e.renderLinks(),e.initializeEvents(),e}function N(t){var a=R.call(this,t)||this,o=(a.focus=[],a.isReadyForThemeChange=!1,a.layers=new Y,a.dataSources={},a.errors={},_.extend(a,_.pick(t,["api","dashboardViewModel"])),a.api=t.api,a.onSettingsChange.bind(a));return a.onSettingsChange=function(t){var e=this.onSettingsChange!==(this.onSettingsChange=o);this.onSettingsChange(t),e&&(this.isReadyForThemeChange=!0,this.setThemeAccordingToDashboardSettings())}.bind(a),a.$el.html(O.app({id:a.id})),a.ctx=a.$el.find(".chart-container")[0].querySelector("canvas").getContext("2d"),a.defaultOptions={maintainAspectRatio:!1,responsive:!0,animation:{duration:0}},a.listenTo(a.layers,"add",function(){this.setThemeAccordingToDashboardSettings()}),a.listenTo(a.layers,"reset",function(){this.setThemeAccordingToDashboardSettings()}),a.listenTo(a.layers,"remove",function(t){t.stopListening()}),a.listenTo(a.layers,"update",function(t,e){a.updatePossibleLayers();var o=0<e.changes.added.length+e.changes.removed.length;_.throttle(function(){!o&&a.animation&&a.animation.get("Enabled")?a.updateChart():a.initializeChart()})}),a.highlightRulesModel=new K({el:a.$el,api:a.api}),a.legendModel=new W({externalDiv:a.$el.find(".chart-legend"),app:a}),a.listenTo(a.legendModel,"change",a.initializeChart.bind(a)),a.layoutModel=new U,a.listenTo(a.layoutModel,"change",a.initializeChart.bind(a)),a.animation=new z,a.listenTo(a.animation,"change",a.updateChart.bind(a)),a.tooltips=new Z(a.api),a.fileExportModel=new i.DeepModel,a.fileExporterView=new q({model:a.fileExportModel,el:O.fileExporter({id:a.id}),api:a.api,appView:a,getCanvas:function(){return a.ctx.canvas},getExportConfig:function(){var t=a.layers.at(0);return{columnsConfig:{dataSource:a.dataSources[t.get("Basics.Data").cid],layersIds:_.map(t.get("DataSet.Layers"),"Segment"),labelColId:t.get("DataSet.Label"),formats:t.get("InnerLabel")},fileName:a.fileExportModel.get("FileExport.FileName"),altFileName:"",workSheetTitle:"ChartJs"}}}),a.$el.prepend(a.fileExporterView.$el),a.listenTo(a.fileExportModel,"change:FileExport.Enabled",a.toggleToolsPanel.bind(a)),a}return R=i.View,o(N,R),N.prototype.onSettingsChange=function(t){t=D.expandNestedViewStates(t,this.api),t=D.replaceViewStatesWithValue("",t,this.api),t=D.pump(t);this.onSettingsChangeProcessed.call(this,t)},N.prototype.updateError=function(t,e){function o(t){return"Error"===t?3:"Loading"===t?2:"NoResults"===t?1:0}var a=this,t=t.getKey(),e=(e?this.errors[t]=e:delete this.errors[t],_.reduce(this.errors,function(t,e){e=e.type;return o(e)>o(t)?e:t},""));e&&("NoResults"!==e||Object.keys(this.dataSources).length===Object.keys(this.errors).length)?(t=_.map(this.errors,function(t,e){t=t.error,e=a.dataSources[e];return t?"["+e.getPath()+"]: "+t:null}).filter(function(t){return t}),this.api.showQueryStatus({error:t.join("\n"),type:e})):this.api.hideQueryStatus()},N.prototype.updateDataSource=function(o){var a=this,i="DataSet.Layers.0.Segment";if(this.dataSources[o.getKey()]){var r=!1,e=this.layers.filter(function(t){t=t.get("Basics.Data");return t&&t.cid===o.getKey()}),n=h.HeuristicHelpers.getNumericColumns(o),s=h.HeuristicHelpers.getStringColumns(o),l=h.HeuristicHelpers.getListColumns(o),c=0===n.length?l:n,d=this.errors[o.getKey()],p=0===s.length?0===l.length?n:l:s;if(0===c.length&&(!d||"Loading"===_.get(d,"type")))return void this.api.showErrorMessage({error:t("Data Source provided is not valid for Pie Chart"),type:"Warning"});e.forEach(function(t,e){t.updateData(o),t.set("possibleColumns",o.getColumnNames()),t.set("possibleRules",o.getColumnNames()),t.set("possibleLabels",o.getColumnNames()),a.api.setProperty("possibleColumns",t.get("possibleColumns")),a.api.setProperty("possibleRules",t.get("possibleRules")),a.api.setProperty("possibleLabels",t.get("possibleLabels")),0===e&&""===a.api.getProperty(i)&&(t.set(i,c[0]),a.api.setProperty(i,c[0]),r=!0),0===e&&""===a.api.getProperty("DataSet.Label")&&(t.set("DataSet.Label",p[0]),a.api.setProperty("DataSet.Label",p[0]),r=!0)}),r&&this.api.setProperty("DataSet",{Label:p[0],DonutRatio:50,Rotation:50,Circumference:100,BorderWidth:1,Layers:[{Segment:c[0],Display:"",UseColor:!0,Color:"#0061FF",BorderColor:"#ffffff",ColorOpacity:85,HighlightRules:[]}]})}(this.animation&&this.animation.get("Enabled")?this.updateChart:this.initializeChart).bind(this).call(this)},N.prototype.onSettingsChangeProcessed=function(t){_.isObject(t.Basics)&&this.onSettingsBasicsChanged.call(this,t.Basics),_.isObject(t.Basics)&&t.Basics.Data&&this.onSettingsLayersChanged.call(this,t),(_.isObject(t.DataSet)||_.has(t,"Layers"))&&this.onSettingsOnData(t),_.isObject(t.InnerLabel)&&this.onSettingsOnInnerLabel(t),_.isObject(t.Legend)&&this.onSettingsLegendChanged.call(this,t.Legend),_.isObject(t.Style)&&this.onSettingsStyleChanged.call(this,t.Style),_.isObject(t.Padding)&&this.onSettingsPaddingChanged.call(this,t),_.isObject(t.FileExport)&&this.onSettingsFileExportChanged.call(this,t.FileExport),_.isObject(t.Animations)&&this.onSettingsAnimationChanged.call(this,t.Animations)},N.prototype.onSettingsFileExportChanged=function(t){var o=this;this.fileExportModel&&(_.each(t,function(t,e){o.fileExportModel.set("FileExport."+e,t)}),4===_.keys(t).length&&void 0===this.fileExportModel.get("FileExport.Enabled")&&(t.ShowExportCsvButton||t.ShowExportExcelButton||t.ShowScreenshot?this.fileExportModel.set("FileExport.Enabled",!0):this.fileExportModel.set("FileExport.Enabled",!1)))},N.prototype.onSettingsAnimationChanged=function(t){this.animation&&this.animation.set(t)},N.prototype.onSettingsPaddingChanged=function(t){this.layoutModel.set("Padding",t.Padding)},N.prototype.onSettingsLegendChanged=function(t){this.legendModel.set(t),this.chart&&this.legendModel.renderhtmlLegend(this.chart)},N.prototype.onSettingsStyleChanged=function(t){this.layers&&0<this.layers.models.length&&(this.layers.models[0].set("Style",t),t.chartBarColors&&this.layers.models[0].updateVisuals(),this.initializeChart())},N.prototype.onSettingsLayersChanged=function(t){var o=this,a=(this.layers.set(t),t.Basics.Data),t=this.dataSources[a.cid];t?t.hasData()&&this.updateDataSource(t):(t=new V(a,this,this.api,this.focus),this.dataSources[a.cid]=t,this.listenTo(a,"change:queryStatus",function(t,e){o.updateError(o.dataSources[a.cid],e)}),t.subscribe())},N.prototype.onSettingsOnData=function(t){var e=this,a=this.layers.models[0];_.each(t.DataSet,function(t,e){a&&"Layers"===e&&_.each(t,function(t,o){_.each(t,function(t,e){a.set("DataSet.Layers."+o+"."+e,t)})}),a&&"Label"===e&&a.set("DataSet.Label",t),a&&"DonutRatio"===e&&a.set("DataSet.DonutRatio",t),a&&"Rotation"===e&&a.set("DataSet.Rotation",t),a&&"Circumference"===e&&a.set("DataSet.Circumference",t),a&&"BorderWidth"===e&&a.set("DataSet.BorderWidth",t)}),_.each(this.dataSources,function(t){a.chartData={},void 0===a.get("Style")&&a.set("Style",e.api.getProperty("Style")),void 0===a.get("InnerLabel")&&a.set("InnerLabel",e.api.getProperty("InnerLabel")),a.dataSource=t,a.updateData(t)}),a&&a.set("Basics.Focus",this.api.getProperty("Basics.Focus")),this.initializeChart(),this.highlightRulesModel.computeHighlightRulesHTML()},N.prototype.onSettingsOnInnerLabel=function(t){var o=this.layers.models[0];o&&(_.each(t.InnerLabel,function(t,e){o.set("InnerLabel."+e,t)}),this.initializeChart())},N.prototype.toggleToolsPanel=function(){var t;this.fileExportModel.has("FileExport")&&this.legendModel&&(t=this.fileExportModel.get("FileExport.Enabled"),!this.legendModel.toolsEnabled&&t?(this.legendModel.toolsEnabled=!0,this.$el.find(".tools-panel").removeClass("disabled"),this.initializeChart()):t||(this.legendModel.toolsEnabled=!1,this.$el.find(".tools-panel").toggleClass("disabled",!this.$el.find(".tools-panel").hasClass("disabled")),this.initializeChart()))},N.prototype.onSettingsAnimationsChanged=function(t){var e=this;t.hasOwnProperty("Enabled")?(t.Enabled?D.cache(this.animation,"Animations.",{load:["Duration","Easing"],defaults:[0,"easeOutQuart"]},this.api):D.cache(this.animation,"Animations.",{store:["Duration","Easing"]},this.api),this.animation.set(t),_.defer(function(){e.api.setProperty("Animations",i.Model.prototype.toJSON.apply(e.animation))})):this.animation.set(t)},N.prototype.onSettingsTooltipsChanged=function(t){var e=this;t.hasOwnProperty("Enabled")?(t.Enabled?D.cache(this.tooltips,"Tooltips.",{load:["Mode"],defaults:[0,"index"]},this.api):D.cache(this.tooltips,"Tooltips.",{store:["Mode"]},this.api),this.tooltips.set(t),_.defer(function(){e.api.setProperty("Tooltips",i.Model.prototype.toJSON.apply(e.tooltips))})):this.tooltips.set(t)},N.prototype.onSettingsBasicsChanged=function(t){var e=this;void 0!==t.Focus&&(this.focus=_.first(D.focus2Array(t.Focus))||[],_.each(this.dataSources,function(t){t.setFocus(e.focus)})),void 0!==t.Selected&&0<this.layers.models.length&&this.api.getProperty("Basics.PopoutSelected")&&(this.layers.models[0].set("Basics.Selected",t.Selected),this.updateChart())},N.prototype.initializeChart=function(){this.chart&&(this.chart.destroy(),delete this.chart);var t=this.prepareChart(),e=t.datasets,o=t.labels,t=t.options;e&&o&&t&&(e={type:"doughnut",layers:this.layers,dataSource:this.dataSources,data:{datasets:e,labels:o},plugins:[this.layers.models[0].labelPlugin],options:$.extend(t,this.layers.models[0].computeConfigProps())},window.layers=this.layers,window.dataSources=this.dataSources,this.chart=new Chart(this.ctx,e),this.legendModel.renderhtmlLegend(this.chart))},N.prototype.updateChart=function(){var a=this;if(this.chart){var t=this.prepareChart(),e=t.datasets,o=t.labels,t=t.options;if(e&&o&&t){$.extend(!0,this.chart.options,t),e.forEach(function(t){var e,o=_.find(a.chart.data.datasets,{id:t.id});o?(e=t.data,$.extend(!0,o,t),o.data=e):a.chart.data.datasets.push(t)});for(var i=_.fromPairs(_.map(e,function(t){return[t.id,!0]})),r=0;r<this.chart.data.datasets.length;r++)i[this.chart.data.datasets[r].id]||(this.chart.data.datasets.splice(r,1),r--);_.get(this.chart,"config.data.labels")&&(this.chart.config.data.labels=o),this.chart.update()}}else this.initializeChart.bind(this).call(this)},N.prototype.prepareChart=function(){var o=this;if(!this.layers.length)return{};var t=_.flatten(_.map(this.layers.models,"dataset").filter(_.negate(_.isEmpty))),e=_.flatten(_.map(this.layers.models,"labelData").filter(_.negate(_.isEmpty))),a=this.layers.models[0],i=this.tooltips,r=this.legendModel.computePaddingAdjustment();return{datasets:t,labels:e,options:$.extend(!0,{},this.defaultOptions,{animation:this.animation.toPieJSON(),legend:this.legendModel.computeLegendProp(),layout:this.layoutModel.computeLayoutProp(r),onClick:function(t,e){e&&e.length&&(o.onClick(e[0]._index,t),o.chart.update())},tooltips:{enabled:!1,mode:"point",custom:function(t){i.customTooltip(this,t,a)}}})}},N.prototype.onClick=function(t,e){var o,a=this.layers.models[0],i=a.get("Basics.Data"),i=this.dataSources[i.cid],r=i.getData().at(t);a.setPopoutSegment(this.chart,t),void 0!==r&&(t=i.getPropertyFromColumn(a.get("Basics.SelectedAttr")),(t=r.get(t))===this.api.getProperty("Basics.Selected")&&(t=""),this.api.setProperty("Basics.Selected",t,!0),t=i.getDepth(),o=_.clone(this.focus),i=i.getPropertyFromColumn(a.get("DataSet.Label")),a=r.get(i),o[t]=a&&a.toString?a.toString():""+a,this.api.setProperty("Basics.Focus",o.join(","),!0),this.doActions(e))},N.prototype.doActions=function(t){var e,o,t=this.chart.getElementAtEvent(t);t.length&&(o=(t=t[0])._datasetIndex,t=t._index,((o=this.layers.models.length-1-o)<0||o>this.layers.models.length-1)&&(o=this.layers.models.length-1),o=this.layers.models[o].get("Basics.Data"),e=this.dataSources[o.cid].getData().at(t),o=this.api.getProperty("Basics.Actions").map(function(t){return r(r({},t),{Value:e.get(t.Current)})}),this.api.doActions(o,"Basics.Actions"))},N.prototype.onLayerDataEvents=function(t){var e=t.get("Basics.Data"),e=e?this.dataSources[e.cid]:void 0;e&&(t.updateData(e),t.set("_Hidden._PossibleColumns",e?e.getColumnNames():[]))},N.prototype.onLayerVisualEvents=function(t){t.updateVisuals()},N.prototype.setTheme=function(t){var e,o,a=this;if("Light"===t)e="#FFFFFF",o="#000000";else{if("Dark"!==t)return;e="#000000",o="#FFFFFF"}var t=t.toLowerCase(),i=this.layers.models[0];_.each(["Legend.LabelColor","InnerLabel.InnertitleColor","InnerLabel.PieceLabelColor"],function(t){i&&i.get(t)&&i.get(t).toLowerCase()===e.toLowerCase()&&i.set(t,o),a.api.getProperty(t).toLowerCase()&&e.toLowerCase()&&a.api.setProperty(t,o)}),this.$el.removeClass("dark light"),this.$el.addClass(t)},N.prototype.setThemeAccordingToDashboardSettings=function(){this.isReadyForThemeChange&&this.setTheme(this.dashboardViewModel.get("DashboardTheme"))},N.prototype.updatePossibleLayers=function(){this.layers.filter(function(t){return"Line"===t.get("_Hidden._Type")}).forEach(function(a){var t=a.collection.reduceRight(function(t,e,o){return[a===e?"nofill":"Layer "+(o+1)].concat(t)},["origin"]);a.set("_Hidden._PossibleLayers",t)}.bind(this))},N.getComponentDefinition=L.getComponentDefinition,N});