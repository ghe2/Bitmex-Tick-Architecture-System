define(["Handlebars","QuickBase","d3","moment","nv","xlsx","backbone","css!./css/app.css"],function(a,s,f,l,W,j,e){"use strict";var i,r,o=this&&this.__extends||(i=function(t,e){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)},function(t,e){function r(){this.constructor=t}i(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),n=this&&this.__assign||function(){return(n=Object.assign||function(t){for(var e,r=1,i=arguments.length;r<i;r++)for(var a in e=arguments[r])Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a]);return t}).apply(this,arguments)},c=(r=e.DeepModel,o(u,r),u.prototype.initialize=function(t){},u.prototype.updateData=function(o){var t,e,r,i,a,n,s,l;o?(this.chartData={},n=this.get("Labels.Label"),t=this.get("NodeLabels.Format")?this.get("NodeLabels.Format"):"General",e=this.get("NodeLabels.Precision")?this.get("NodeLabels.Precision"):0,r=!!this.get("NodeLabels.HideTrailingZeroes")&&this.get("NodeLabels.HideTrailingZeroes"),i=this.get("NodeLabels.DateFormat")?this.get("NodeLabels.DateFormat"):"YYYY-MM-DD",void 0!==n&&(n=0===n.indexOf("/")?n.substring(1):"^"+n.replace(/\*/g,"(.*)")+"$",a=new RegExp(n),n=o.getColumnNames().filter(function(t){return t.match(a)}),s=[],l=S.getFormatter(t,e,r,i),_.each(n,_.bind(function(r){_.each(this.get("Data"),_.bind(function(t){var e,i,a,t=t.Column;void 0!==t&&(t=0===t.indexOf("/")?t.substring(1):"^"+t.replace(/\*/g,"(.*)")+"$",e=new RegExp(t),t=o.getColumnNames().filter(function(t){return t.match(e)}),this.labelData=o.getData().map(function(t){return t.get(o.getPropertyFromColumn(r))}),i=this.labelData,a=_.fromPairs(_.map(this.get("Data"),function(t){return[t.Column,t.Display]})),_.each(t,function(r){o.getData().map(function(t,e){return[i[e],t.get(r),r,0]}),s=_.union(s,o.getData().map(function(t,e){return[l(i[e]),a[r]||r,t.get(r),0]}))}),this.chartData={data:s},this.updateVisuals())},this))},this))),this.updateVisuals()):this.initialize()},u.prototype.updateVisuals=function(){this.format=this.computeDataSetProps()},u.prototype.calcRange=function(t,e,r){return e+t/100*(Math.abs(r)-Math.abs(e))},u.prototype.getWidth=function(){var t=this.get("NodeLabels.Show")?"display":"none",e=this.get("NodePercentages.Show")?"display":"none",r=this.get("NodeValues.Show")?"display":"none",i=this.get("NodeLabels.Width")?this.get("NodeLabels.Width"):60,a=this.get("NodePercentages.Width")?this.get("NodePercentages.Width"):60,o=this.get("NodeValues.Width")?this.get("NodeValues.Width"):60;return 2*(("none"==t?0:i)+("none"==e?0:a)+("none"==r?0:o))},u.prototype.computeDataSetProps=function(){var e=[],t=(this.get("Style.chartBarColors")&&_.each(_.map(this.get("Style.chartBarColors"),"type"),function(t){e.push(t)}),this.get("Style.labelColor")?this.get("Style.labelColor"):"#eae6df"),r=(this.get("NodeLabels.Position")&&parseInt(this.get("NodeLabels.Position"),10),this.get("NodeLabels.Show")?"display":"none"),i=(this.get("NodePercentages.Position")&&parseInt(this.get("NodePercentages.Position"),10),this.get("NodePercentages.Show")?"display":"none"),a=(this.get("NodeValues.Position")&&parseInt(this.get("NodeValues.Position"),10),this.get("NodeValues.Show")?"display":"none"),o=this.get("NodeValues.Format")?this.get("NodeValues.Format"):"Number",n=this.get("NodeValues.Format")?this.get("NodeValues.Format"):"Number",s={b:this.get("Padding.Bottom")?this.get("Padding.Bottom"):20,t:this.get("Padding.Top")?this.get("Padding.Top"):5,l:this.get("Padding.Left")?this.get("Padding.Left"):0,r:this.get("Padding.Right")?this.get("Padding.Right"):40},l=this.get("NodeLabels.Width")?this.get("NodeLabels.Width"):60,c=this.get("NodePercentages.Width")?this.get("NodePercentages.Width"):60,u=this.get("NodeValues.Width")?this.get("NodeValues.Width"):60,l="none"==r?0:l,c="none"==i?0:c,u="none"==a?0:u,p="none"==i?0:c,d="none"==a?p:u+p;return{colors:e,labelColor:t,decimal:n,labelShow:r,valueShow:a,percentShow:i,c1:[d,20+l+c+u+d],c2:[p,20+l+c+u+p],c3:[0,20+l+c+u],partWidth:l+c+u,minWidth:20,yAxisFormat:"Smart Number"===o?A.smartFormatNumber:void 0,margin:s}},u);function u(){var t=null!==r&&r.apply(this,arguments)||this;return t.colorCache={},t.columns=[],t.labels=[],t.chartData={},t.labelData=[],t.chartType="compareChart",t.previousChartData={},t}p=e.Collection,o(h,p),h.prototype.modelId=function(t){return t};var p,d=h;function h(){var t=null!==p&&p.apply(this,arguments)||this;return t.model=c,t}y.mergeChanges=function(e,r,t,i,a,o){return t&&(e=_.fromPairs(_.map(t,function(t){return[r(t),t]}))),i&&_.each(i,function(t){return _.extend(e[r(t)],t)}),a&&_.each(a,function(t){e[r(t)]=t}),o&&_.each(o,function(t){delete e[r(t)]}),e},y.prototype.setFocus=function(t){this.focus=t,this.updateChildren(),this.childDataSource&&this.childDataSource.setFocus(t)},y.prototype.isFocused=function(){return this.focus.length===this.depth&&(0===this.depth||this.source.id===this.focus[this.depth])},y.prototype.getColumnNames=function(){if(this.breakdownColumns&&this.breakdownColumns.length)return[y.BREAKDOWN_ID,this.breakdownColumns[0]].concat(_.difference(_.keys(this.meta),this.breakdownColumns));try{return _.map(this.meta,function(t){return[t.id,t.index]}).sort(function(t,e){return t[1]-e[1]}).map(function(t){return t[0]})}catch(t){return _.keys(this.meta)}},y.prototype.getColumnType=function(t){return this.childDataSource?this.childDataSource.getColumnType(t):t===y.BREAKDOWN_ID?this.meta[this.primaryKey].kdbType:this.meta[t]?this.meta[t].kdbType:11},y.prototype.getData=function(){return this.childDataSource?this.childDataSource.getData():this.source.dataSet&&this.source.dataSet.collection},y.prototype.getDepth=function(){return this.childDataSource?this.childDataSource.getDepth():this.depth},y.prototype.getKey=function(){return this.source.cid},y.prototype.getPrimaryKey=function(){return this.childDataSource?this.childDataSource.getPrimaryKey():this.primaryKey},y.prototype.getPropertyFromColumn=function(t){return t===y.BREAKDOWN_ID?this.getPrimaryKey():t},y.prototype.getPath=function(){return this.source.path},y.prototype.getSource=function(){return this.source},y.prototype.hasData=function(){return this.childDataSource?this.childDataSource.hasData():this.hasDataFlag},y.prototype.onData=function(t,e,r){t.primaryKey!==this.primaryKey&&(this.primaryKey=t.primaryKey),this.meta=y.mergeChanges(this.meta,function(t){return t.id},t.columns.reset,t.columns.change,t.columns.add,t.columns.remove),0!==this.depth||_.isEqual(t.breakdownColumns,this.breakdownColumns)||(this.breakdownColumns=t.breakdownColumns,this.removeChild()),e.reset&&0<e.reset.length&&this.removeChild(),r?this.updateError(this,r):this.listener&&this.listener.updateError(this,void 0),this.hasDataFlag=!0,this.updateChildren()&&this.listener.updateDataSource(this)},y.prototype.subscribe=function(){this.api.subscribe(this.source,this.onData.bind(this))},y.prototype.updateDataSource=function(t){this.listener.updateDataSource(this)},y.prototype.updateError=function(t,e){this.listener.updateError(this,e)},y.prototype.unsubscribe=function(){this.childDataSource&&(this.childDataSource.unsubscribe(),delete this.childDataSource),this.api.unsubscribe(this.source)},y.sourceKey=function(t){return t.getPath()},y.prototype.removeChild=function(){this.childDataSource&&(this.childDataSource.unsubscribe(),delete this.childDataSource)},y.prototype.updateChildren=function(){var t;return!(this.breakdownColumns&&this.breakdownColumns.length&&this.depth<this.breakdownColumns.length-1)||(this.focus.length>this.depth?(this.childDataSource&&this.focus[this.depth]!==this.childDataSource.getSource().id&&this.removeChild(),this.childDataSource||(0!==this.depth&&(this.focus[this.depth-1],this.source.id),(t=this.source.dataSet&&this.source.dataSet.collection.get(this.focus[this.depth]))&&(this.childDataSource=new y(t,this,this.api,this.focus,this.depth+1,this.breakdownColumns),this.childDataSource.subscribe()))):(this.removeChild(),this.focus.length!==this.depth||!this.hasDataFlag||0!==this.depth&&this.focus[this.depth-1]!=this.source.id||this.listener.updateDataSource(this)),!1)},y.BREAKDOWN_ID="{breakdownId}";var m=y;function y(t,e,r,i,a,o){this.breakdownColumns=[],this.hasDataFlag=!1,this.focus=[],this.meta={},this.source=t,this.listener=e,this.api=r,this.depth=a||0,this.breakdownColumns=o,this.setFocus(i)}g=e.DeepModel,o(v,g),v.prototype.initialize=function(t){},v.prototype.computeLayoutProp=function(t){var e=void 0===this.get("Padding.Top")?0:this.get("Padding.Top"),r=void 0===this.get("Padding.Left")?0:this.get("Padding.Left"),i=void 0===this.get("Padding.Bottom")?0:this.get("Padding.Bottom"),a=void 0===this.get("Padding.Right")?0:this.get("Padding.Right");return{padding:{top:e+t.top,left:r+t.left,right:a+t.right,bottom:i+t.bottom}}};var g,b=v;function v(){return null!==g&&g.apply(this,arguments)||this}"function"!=typeof Object.assign&&Object.defineProperty(Object,"assign",{value:function(t){if(null===t)throw new TypeError("Cannot convert undefined or null to object");for(var e=Object(t),r=1;r<arguments.length;r++){var i=arguments[r];if(null!==i)for(var a in i)Object.prototype.hasOwnProperty.call(i,a)&&(e[a]=i[a])}return e},writable:!0,configurable:!0});D.expandNestedViewStates=function(t,r){var e,i=Object.keys(t),a=[];return(a=_.every(i,function(t){var e=r.getPropertyMeta(i[0]);return e&&"viewstate"===e.type})?_.uniq(_.filter(_.map(i,function(t){t=/^((?:\w+\.)*)(\d+)/.exec(t);return t?t[1].slice(0,-1):null}),function(t){return null!==t})):a).length?(e={},_.each(a,function(t){return e[t]=r.getProperty(t)}),e):t},D.focus2Array=function(t){var e=[],r=/"([^"]*)"/g,t=t.toString?t.toString():"",i=/^\[([^\]]*)]$/.exec(t);if(null!==i){if(/^(?:"[^"\\]*(?:\\[\S\s][^"\\]*)*")(?:,"[^"\\]*(?:\\[\S\s][^"\\]*)*")*/.test(i[1]))for(var a=void 0;null!==(a=r.exec(i[1]));)e.push(_.map(a[1].split(","),function(t){return t.replace(/&#44;/g,",")}))}else e.push(t.split(","));return _.filter(e,function(t){return 0<(""+t).length})},D.getFormatter=function(i,a,o,n){return"Number"===i||"Formatted Number"===i||"Smart Number"===i||"Datetime"===i||"Currency"===i||"SmartCurrency"===i?function(t){var e,r=t;if(null==t)return"";if("Smart Number"===i)r=_.isNumber(t)?A.smartFormatNumber(t,a):_.escape(t);else{if("Datetime"===i)return l.isMoment(e=t)||l.isDuration(t)?t.format(n):A.isKDBTemporal(t)?A.convertKDBTemporalToMoment(t).format(n):("number"==typeof t&&(e=new Date(t)),A.convertDateStringValueToMoment(e.toString()).format(n));r="Formatted Number"===i&&t.toFixed?A.formatNumber(t,a):t.toFixed?t.toFixed(a):_.escape(r)}if(o&&0<=r.toString().indexOf(".")){for(;"0"===r[r.length-1];)r=r.slice(0,-1);"."===r[r.length-1]&&(r=r.slice(0,-1))}return r}:"General"===i?function(t){return l.isMoment(t)||l.isDuration(t)?t.format():_.escape(t)}:"Boolean"===i?function(t){return _.escape(t)}:void 0},D.pump=function(r){if(null!=r){if(!_.isObject(r))return r;var t=Object.getPrototypeOf(r);if(_.isObject(r)&&t!==Object.prototype&&t!==Array.prototype)return r;if(t===Array.prototype)return r.map(D.pump);var i=/^(\d+)((?:\.\w+)+)$/;if(Object.keys(r).every(function(t){return i.test(t)}))return Object.keys(r).map(function(t){var e=i.exec(t);return{index:Number(e[1]),tail:e[2].substring(1),value:r[t]}}).reduce(function(t,e){var r={};return r[e.index]={},r[e.index][e.tail]=e.value,$.extend(!0,t,D.pump(r))},[]);var a={greedy:/^(\w+)((?:\.\w+)*)$/,nonGreedy:/^(\w+)((?:\.\w+)+)$/};return Object.keys(r).some(function(t){return a.nonGreedy.test(t)})?Object.keys(r).map(function(t){var e=a.greedy.exec(t);return{head:e[1],tail:""!==e[2]?e[2].substring(1):null,value:r[t]}}).reduce(function(t,e){var r={};return null!==e.tail?(r[e.head]={},r[e.head][e.tail]=e.value):r[e.head]=e.value,$.extend(!0,t,D.pump(r))},{}):_.mapValues(r,D.pump)}},D.replaceViewStatesWithValue=function(t,e,r){return D.replaceViewStates(t,e,function(t,e,r,i){return i.value!==r&&console.warn("viewModel value has changed"),i.value},r)},D.safeHandle=function(r){return function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];try{r.apply(this,t)}catch(t){console.error("oupsies..",t)}}},D.alpha=function(t,e){var r=s.Tools.hex2RGB(t);return r?"rgba("+r[0]+","+r[1]+","+r[2]+","+e/100+")":new Color(t).alpha(e/100).rgbaString()},D.colorFactory=function(t,e,r){void 0===e&&(e="#4f6aa6"),void 0===r&&(r=80);var i={};return i[t+"Color"]={title:t.replace("Point","").replace("Hover","Hover ").replace("Border","Border ").replace("Background","Background ")+"Color",type:"gradient",default:e,options:{gradient:!1}},i[t+"Opacity"]={title:t.replace("Point","").replace("Hover","Hover ").replace("Border","Border ").replace("Background","Background ")+"Opacity",default:r,minimum:0,maximum:100,type:"number",step:1,format:"range"},i},D.replaceViewStates=function(r,t,s,l){var c=function(t,e){return function r(t,e,i){i=i?i+".":"";e+="";var a=l.getPropertyMeta(i+e);{var o,n;return a&&"data"===a.type?t:a&&"viewstate"===a.type?(n=(i+e).split("."),o=n.pop(),n=n.join("."),s(n,o,t,a)):!_.isArray(t)&&!_.isObject(t)||t.has&&t.has("_dataSource")&&t.has("_dataType")?t:(i+=e,c=function(t,e){return r(t,e,i)},(u=_.isArray(t)?_.map:_.mapValues)(t,c))}}(t,e,r||"")},u=_.isArray(t)?_.map:_.mapValues;return u(t,c)};var S=D;function D(){}var x={Trigger:{type:"string",enum:["Click","Hover"],default:"Click",title:"Trigger Action",propertyOrder:2,options:{hidden:!0}}},w=(C.getComponentDefinition=function(t){var e,r,i={id:1,componentName:"CompareChart",componentDescription:"",version:"4.5.1",appArgs:{quickStart:[{path:"Basics.Data"}],json:{version:"4.5.1",Basics:{Data:"",Theme:"Dark",Focus:"",Actions:[]},Labels:{Label:""},Data:[{Column:"",Display:"",Color:""}],Padding:{Top:5,Bottom:20,Left:0,Right:40},Style:{chartBarColors:[{type:"#0061FF"},{type:"#F23A66"},{type:"#009BAB"},{type:"#7647CC"},{type:"#FFC300"},{type:"#9FA3A6"},{type:"#003A99"},{type:"#A90B31"},{type:"#005D67"},{type:"#452481"}],advanced:"",advancedTooltip:"<div>Value : {{value}}</div>",labelColor:"#404040"},FileExport:{ShowScreenshot:!1,ShowExportCsvButton:!1,ShowExportExcelButton:!1,FileName:[]},NodePercentages:{Show:!1,Position:0,Width:40},NodeValues:{Show:!0,Position:0,Format:"Number",Precision:0,Width:40},NodeLabels:{Show:!0,Position:0,Format:"General",Precision:0,DateFormat:"YYYY-MM-DD",HideTrailingZeroes:!1,Width:90},possibleColumns:[""],possibleLabels:[""]},schema:{type:"object",title:"Properties",properties:{possibleLabels:{type:"array",propertyOrder:1,format:"table",items:{type:"string"},default:["sym"],options:{collapsed:!0,hidden:!0}},possibleColumns:{propertyOrder:2,type:"array",format:"table",items:{type:"string"},default:["sym"],options:{collapsed:!0,hidden:!0}},possibleRules:{type:"array",propertyOrder:1,format:"table",items:{type:"string"},default:[],options:{collapsed:!0,hidden:!0}},possibleCalcs:{type:"array",propertyOrder:1,format:"table",items:{type:"string"},default:[],options:{collapsed:!0,hidden:!0}},Basics:{type:"object",propertyOrder:3,title:"Basics",options:{collapsed:!1},properties:{Data:{type:"data",format:"string",title:"Data Source",default:""},Theme:{type:"string",title:"Theme",options:{hidden:!0},enum:["Light","Dark"]},DashboardTheme:{options:{hidden:!0}},Focus:{type:"viewstate",title:"Focus",default:""},ChartType:{options:{hidden:!0}},Actions:{type:"actions",options:{collapsed:!0},fields:{map:_.extend({Current:{title:"Source",type:"string",enumSource:"possible_columns",watch:{possible_columns:"root.possibleColumns"},propertyOrder:10},ViewstateProperty:{title:"Viewstate",type:"viewstate"}},x),nav:x,query:x,url:x}}}},Labels:{type:"object",propertyOrder:4,title:"LHS Data",options:{collapsed:!0},properties:{Label:{propertyOrder:1,default:"",title:"Series Key",type:"customDropdown",data:"possible_labels",watch:{possible_labels:"root.possibleLabels"}}}},Data:{type:"array",propertyOrder:5,format:"object",title:"RHS Data",uniqueItems:!1,options:{collapsed:!0},items:{type:"object",title:"Data",properties:{Column:{default:"",title:"Series Data",type:"customDropdown",data:"possible_columns",watch:{possible_columns:"root.possibleColumns"}},Display:{type:"string",default:"",title:"Display"},Color:{type:"gradient",options:{gradient:!1,hidden:!0},title:"Color",default:"#0061FF"}}}},Padding:{type:"object",title:"Padding",propertyOrder:8,options:{collapsed:!0},properties:{Left:{type:"number",default:2},Right:{type:"number",default:2},Top:{type:"number",default:2},Bottom:{type:"number",default:2}}},Style:{type:"object",propertyOrder:8,title:"Style",options:{collapsed:!0},properties:{chartBarColors:{type:"array",format:"table",title:"Colour Palette",propertyOrder:1,options:{collapsed:!1},uniqueItems:!1,items:{type:"object",title:"Bar Colour",properties:{type:{type:"gradient",options:{gradient:!1},title:"color",default:"#0061FF"}}},default:[{type:"#0061FF"},{type:"#F23A66"},{type:"#009BAB"},{type:"#7647CC"},{type:"#FFC300"},{type:"#9FA3A6"},{type:"#003A99"},{type:"#A90B31"},{type:"#005D67"},{type:"#452481"}]},advanced:{type:"css",title:"Advanced CSS",propertyOrder:2,default:""},advancedTooltip:{type:"tooltipTemplate",title:"Custom tooltip",propertyOrder:3,data:["xaxis","yaxis","key","color"],default:"<div>Value : {{value}}</div>"},labelColor:{type:"gradient",options:{gradient:!1},title:"Text Colour",default:"#404040"}}},FileExport:{type:"object",propertyOrder:320,title:"File Export",options:{collapsed:!0},properties:{ShowExportCsvButton:{type:"boolean",title:"Show Export Csv Button",default:!1,format:"checkbox"},ShowExportExcelButton:{type:"boolean",title:"Show Export Excel Button",default:!1,format:"checkbox"},ShowScreenshot:{type:"boolean",title:"Show Screenshot Button",default:!1,format:"checkbox"},FileName:{type:"array",format:"table",title:"FileName",options:{hidden:!1,collapsed:!0},items:{type:"object",title:"Filename Part",options:{collapsed:!0},properties:{FileNamePart:{title:"FileName Part",type:"string"}}}}}},NodeLabels:{type:"object",propertyOrder:5,title:"Labels",options:{collapsed:!0},properties:{Show:{type:"boolean",title:"Show",default:!1,propertyOrder:1,format:"checkbox"},Position:{type:"number",title:"Position",default:0,propertyOrder:2,format:"number"},Format:{type:"string",propertyOrder:3,enum:["General","Number","Smart Number","Formatted Number","Datetime"],default:"General"},Precision:{type:"number",propertyOrder:4,title:"Decimal Places",format:"number",minimum:0,maximum:10,default:2},HideTrailingZeroes:{type:"boolean",propertyOrder:5,title:"Hide Trailing Zeroes",format:"checkbox",default:!1},DateFormat:{type:"string",propertyOrder:6,title:"Date/Time format",enum:["YYYY-MM-DD","YYYY-MMM-DD","YYYY-MMMM-DD","YYYY-MM","YYYY-MMM","YYYY-MMMM","MMM DD","MMM Do","YYYY-MM-DD HH:mm:ss","YYYY-MM-DD hh:mm:ss","YYYY-MM-DD kk:mm:ss","hh:mm:ss","kk:mm:ss","hh:mm:ss.SS","hh:mm","kk:mm","mm:ss","mm:ss.SS"],default:"YYYY-MM-DD"},Width:{type:"number",propertyOrder:7,title:"Width",format:"number",default:90}}},NodeValues:{type:"object",propertyOrder:6,title:"Values",options:{collapsed:!0},properties:{Show:{type:"boolean",title:"Show",default:!1,propertyOrder:1,format:"checkbox"},Position:{type:"number",title:"Position",default:0,propertyOrder:2,format:"number"},Format:{type:"string",propertyOrder:3,enum:["Number","Smart Number"],default:"General"},Precision:{type:"number",propertyOrder:4,title:"Decimal Places",format:"number",minimum:0,maximum:10,default:2},Width:{type:"number",propertyOrder:5,title:"Width",format:"number",default:40}}},NodePercentages:{type:"object",propertyOrder:7,title:"Percentages",options:{collapsed:!0},properties:{Show:{type:"boolean",title:"Show",default:!1,propertyOrder:1,format:"checkbox"},Position:{type:"number",title:"Position",default:0,propertyOrder:2,format:"number"},Width:{type:"number",title:"Width",propertyOrder:3,default:40}}}}}}};if(0<_.keys(t.settingsModel.attributes).length)for(r=C.upgrades.indexOf(_.find(C.upgrades,{version:t.settingsModel.get("version")}))+1;r<C.upgrades.length;r+=1)(e=C.upgrades[r]).fn(t.settingsModel),t.settingsModel.set("version",e.version);return i},C);function C(){}w.upgrades=[{version:0,fn:function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e]}},{version:"4.1.0s1",fn:function(t){}},{version:"4.1.0s2",fn:function(t){}},{version:"4.3.0",fn:function(t){void 0===t.get("NodeLabels")&&t.set("NodeLabels",{Show:!0,Position:0,Format:"General",Precision:0,DateFormat:"YYYY-MM-HH",HideTrailingZeroes:!1}),void 0===t.get("NodeValues")&&t.set("NodeValues",{Show:!0,Position:0,Format:"Number",Precision:0,Width:40}),void 0===t.get("NodePercentages")&&t.set("NodePercentages",{Show:!1,Position:0,Width:40});t.unset("notificationEvent");t=t.get("format");delete t.showBreadCrumbs,delete t.showControls,delete t.reduceXTicks,delete t.groupSpacing,delete t.rotateLabels,delete t.maxChartElements,delete t.yAxisFormat,delete t.labelShow,delete t.labelPosition,delete t.labelFormat,delete t.valueShow,delete t.valuePosition,delete t.valueFormat,delete t.percentPosition,delete t.percentFormat,delete t.percentShow}},{version:"4.3.0.1",fn:function(t){var e=t.get("Style");e.labelColor=void 0===e.labelColor?"#404040":e.labelColor,t.set("Style",e)}},{version:"4.3.0.2",fn:function(t){var e=t.get("Basics");e.Actions=void 0===e.Actions?[]:e.Actions,t.set("Basics",e)}},{version:"4.5.1",fn:function(t){var e=t.get("NodeLabels"),r=t.get("NodePercentages"),i=t.get("NodeValues");e.Width=void 0===e.Width?90:e.Width,r.Width=void 0===r.Width?40:r.Width,i.Width=void 0===i.Width?40:i.Width,t.set("NodeLabels",e),t.set("NodePercentages",r),t.set("NodeValues",i)}}];N.prototype.on=function(t){this.handlers.push(t)},N.prototype.off=function(e){this.handlers=this.handlers.filter(function(t){return t!==e})},N.prototype.trigger=function(e){this.handlers.slice(0).forEach(function(t){return t(e)})},N.prototype.expose=function(){return this};var P=N;function N(){this.handlers=[]}Object.defineProperty(F.prototype,"ShowTooltip",{get:function(){return this.onTooltipShow.expose()},enumerable:!1,configurable:!0}),Object.defineProperty(F.prototype,"HideTooltip",{get:function(){return this.onTooltipHide.expose()},enumerable:!1,configurable:!0}),F.prototype.partData=function(t,e){var r={};return r.keys=[f.set(t.map(function(t){return t[0]})).values(),f.set(t.map(function(t){return t[1]})).values()],r.data=[r.keys[0].map(function(t){return r.keys[1].map(function(t){return 0})}),r.keys[1].map(function(t){return r.keys[0].map(function(t){return 0})})],t.forEach(function(t){r.data[0][r.keys[0].indexOf(t[0])][r.keys[1].indexOf(t[1])]=t[e],r.data[1][r.keys[1].indexOf(t[1])][r.keys[0].indexOf(t[0])]=t[e]}),r},F.prototype.visualize=function(e){var a={};function o(i,a,o,n,s){var l=f.sum(i),e=0,c=0,u=o-a-2*n*i.length,p=[],r=(i.forEach(function(t){var e=0==l?0:t/l,r=e*(o-a-2*n*i.length),t=(r==s?u-=s:c+=r,{middle:0,y:0,h:0,key1:0,key2:0,value:t,percent:e,height:r});p.push(t)}),u/Math.max(c,1)),e=0;return p.forEach(function(t){t.percent=r*t.percent,t.height=t.height==s?s:t.height*r,t.middle=e+n+t.height,t.y=a+t.middle-t.percent*(o-a-2*n*i.length),t.h=t.percent*(o-a-2*n*i.length),t.percent=0==l?0:t.value/l,e+=2*n+t.height}),p}return a.mainBars=[o(e.data[0].map(function(t){return f.sum(t)}),0,this.height,this.buffMargin,this.minHeight),o(e.data[1].map(function(t){return f.sum(t)}),0,this.height,this.buffMargin,this.minHeight)],a.subBars=[[],[]],a.mainBars.forEach(function(t,i){t.forEach(function(t,r){o(e.data[i][r],t.y,t.y+t.h,0,0).forEach(function(t,e){t.key1=0==i?r:e,t.key2=0==i?e:r,a.subBars[i].push(t)})})}),a.subBars.forEach(function(t){t.sort(function(t,e){return t.key1<e.key1?-1:t.key1>e.key1?1:t.key2<e.key2?-1:t.key2>e.key2?1:0})}),a.edges=a.subBars[0].map(function(t,e){return{key1:t.key1,key2:t.key2,y1:t.y,y2:a.subBars[1][e].y,h1:t.h,h2:a.subBars[1][e].h}}),a.keys=e.keys,a},F.prototype.arcTween=function(t){var e=this,r=f.interpolate(this._current,t);return this._current=r(0),function(t){return e.edgePolygon(r(t))}},F.prototype.drawPart=function(r,t,i){var a=this,e=(f.select("#"+t).append("g").attr("class","part"+i).attr("transform","translate("+i*(this.bb+this.minHeight)+",0)"),f.select("#"+t).select(".part"+i).append("g").attr("class","subbars"),f.select("#"+t).select(".part"+i).append("g").attr("class","mainbars"),f.select("#"+t).select(".part"+i).select(".mainbars").selectAll(".mainbar").data(r.mainBars[i]).enter().append("g").attr("class","mainbar"));e.append("rect").attr("class","mainrect").attr("x",100).attr("y",function(t){return t.middle-t.height}).attr("width",this.minHeight).attr("height",function(t){return t.height}).style("shape-rendering","auto").style("fill-opacity",0).style("stroke-width","0.5").style("stroke","black").style("stroke-opacity",0),e.append("text").attr("class","barlabel").attr("x",this.c1[i]).attr("y",function(t){return t.middle+5}).text(function(t,e){return 9<r.mainBars[i][e].height?r.keys[i][e]:""}).attr("text-anchor","start").attr("display",this.displayLabel),e.append("text").attr("class","barvalue").attr("x",this.c2[i]).attr("y",function(t){return t.middle+5}).text(function(t,e){return 9<r.mainBars[i][e].height?[a.smartNumberFormatter?a.smartNumberFormatter(t.value):t.value.toFixed(a.decimalPlaces)]:""}).attr("text-anchor","start").attr("display",this.displayValue),e.append("text").attr("class","barpercent").attr("x",this.c3[i]).attr("y",function(t){return t.middle+5}).text(function(t,e){t=a.smartNumberFormatter?a.smartNumberFormatter(100*t.percent):(100*t.percent).toFixed(a.decimalPlaces);return 9<r.mainBars[i][e].height?["( "+t+"%) "]:""}).attr("text-anchor","start").style("fill","grey").attr("display",this.displayPercent),f.select("#"+t).select(".part"+i).select(".subbars").selectAll(".subbar").data(r.subBars[i]).enter().append("rect").attr("class","subbar").attr("x",this.partWidth).attr("y",function(t){return t.y}).attr("width",this.minHeight).attr("height",function(t){return t.h}).style("fill",function(t){return a.colors[t.key1]})},F.prototype.drawEdges=function(t,e){var r=this;f.select("#"+e).append("g").attr("class","edges").attr("transform","translate("+(this.minHeight+this.partWidth)+",0)"),f.select("#"+e).select(".edges").selectAll(".edge").data(t.edges).enter().append("polygon").attr("class","edge").attr("points",this.edgePolygon).style("fill",function(t){return r.colors[t.key1]}).style("opacity",.5).each(function(t){r._current=t})},F.prototype.drawHeader=function(r,i){var a=this;f.select("#"+i).append("g").attr("class","header").append("text").text(r[2]).style("font-size","20").attr("x",108).attr("y",-20).style("text-anchor","middle").style("font-weight","bold"),[0,1].forEach(function(t){var e=f.select("#"+i).select(".part"+t).append("g").attr("class","header");e.append("text").text(r[t]).attr("x",a.c1[t]-5).attr("y",-5).style("fill","grey").style("display","none"),e.append("text").text("Count").attr("x",a.c2[t]-10).attr("y",-5).style("fill","grey").style("display","none"),e.append("line").attr("x1",a.c1[t]-10).attr("y1",-2).attr("x2",a.c3[t]+10).attr("y2",-2).style("stroke","black").style("stroke-width","1").style("shape-rendering","crispEdges").style("display","none")})},F.prototype.edgePolygon=function(t){return[0,t.y1,this.bb,t.y2,this.bb,t.y2+t.h2,0,t.y1+t.h1].join(" ")},F.prototype.transitionPart=function(r,t,i){var a=this,e=f.select("#"+t).select(".part"+i).select(".mainbars").selectAll(".mainbar").data(r.mainBars[i]);e.select(".mainrect").transition().duration(500).attr("y",function(t){return t.middle-t.height/2}).attr("height",function(t){return t.height}),e.select(".barlabel").transition().duration(500).attr("y",function(t){return t.middle-t.height/2}),e.select(".barvalue").transition().duration(500).attr("y",function(t){return t.middle-t.height/2}).text(function(t,e){return 9<r.mainBars[i][e].height?[a.smartNumberFormatter?a.smartNumberFormatter(t.value):t.value.toFixed(a.decimalPlaces)]:""}),e.select(".barpercent").transition().duration(500).attr("y",function(t){return t.middle-t.height/2}).text(function(t,e){t=a.smartNumberFormatter?a.smartNumberFormatter(100*t.percent):(100*t.percent).toFixed(a.decimalPlaces);return 9<r.mainBars[i][e].height?["( "+t+"%) "]:""}),f.select("#"+t).select(".part"+i).select(".subbars").selectAll(".subbar").data(r.subBars[i]).transition().duration(500).attr("y",function(t){return t.y}).attr("height",function(t){return t.h})},F.prototype.transitionEdges=function(t,e){var r=this;f.select("#"+e).append("g").attr("class","edges").attr("transform","translate("+this.minHeight+",0)"),f.select("#"+e).select(".edges").selectAll(".edge").data(t.edges).transition().duration(500).attrTween("points",function(t){var e=f.interpolate(r._current,t);return r._current=e(0),function(t){return r.edgePolygon(e(t))}}).style("opacity",function(t){return 0==t.h1||0==t.h2?0:.5})},F.prototype.transition=function(t,e){this.transitionPart(t,e,0),this.transitionPart(t,e,1),this.transitionEdges(t,e)},F.prototype.draw=function(n,e){var s=this;n.forEach(function(o,a){e.append("g").attr("id",o.id).attr("transform","translate("+1e3*a+",0)");var t=s.visualize(o.data);s.drawPart(t,o.id,0),s.drawPart(t,o.id,1),s.drawEdges(t,o.id),s.drawHeader(o.header,o.id),[0,1].forEach(function(i){f.select("#"+o.id).select(".part"+i).select(".mainbars").selectAll(".mainbar").on("mouseover",function(t,e){var r=f.select("#"+o.id).select(".part"+i).select(".subbars").selectAll(".subbar")[a][e];return s.onTooltipShow.trigger({data:t,dataIndex:e,seriesIndex:a,svg:r}),s.selectSegment(n,i,e)}).on("mouseout",function(t,e){return s.onTooltipHide.trigger(),s.deSelectSegment(n,i,e)})}),[0,1].forEach(function(a){f.select("#"+o.id).select(".part"+a).select(".subbars").selectAll(".subbar").on("mouseover",function(t,e,r){var i=f.select("#"+o.id).select(".part"+a).select(".subbars").selectAll(".subbar")[r][e];return s.onTooltipShow.trigger({data:t,dataIndex:e,seriesIndex:r,svg:i}),s.selectSegment(n,a,t["key"+(a+1)])}).on("mouseout",function(t){return s.onTooltipHide.trigger(),s.deSelectSegment(n,a,t["key"+(a+1)])})})}),this.selectSegment(n,0,0)},F.prototype.selectSegment=function(t,r,i){var a=this;t.forEach(function(t){var e={keys:[],data:{}},e=(e.keys=t.data.keys.map(function(t){return t}),e.data[r]=_.map(t.data.data[r],function(t){return t}),e.data[1-r]=_.map(t.data.data[1-r],function(t){return t.map(function(t,e){return i==e?t:0})}),a.transition(a.visualize(e),t.id),f.select("#"+t.id).select(".part"+r).select(".mainbars").selectAll(".mainbar").filter(function(t,e){return e==i}));e.select(".mainrect").style("stroke-opacity",1),e.select(".barlabel").style("font-weight","bold"),e.select(".barvalue").style("font-weight","bold"),e.select(".barpercent").style("font-weight","bold")})};var H=F;function F(t,e,r,i,a,o,n,s,l,c,u,p,d){var h=this;this.buffMargin=1,this.onTooltipShow=new P,this.onTooltipHide=new P,this.deSelectSegment=function(t,e,r){t.forEach(function(t){h.transition(h.visualize(t.data),t.id);t=f.select("#"+t.id).select(".part"+e).select(".mainbars").selectAll(".mainbar").filter(function(t,e){return e==r});t.select(".mainrect").style("stroke-opacity",0),t.select(".barlabel").style("font-weight","normal"),t.select(".barvalue").style("font-weight","normal"),t.select(".barpercent").style("font-weight","normal")})},this.minHeight=l,this.height=e,this.colors=t,this.decimalPlaces=i,this.bb=r,this.c1=a,this.c2=o,this.c3=n,this.partWidth=s,this.displayLabel=c,this.displayValue=u,this.displayPercent=p,this.smartNumberFormatter=d}f.tip=function(){var t,o=function(){return"n"},n=function(){return[0,0]},s=function(){return" "},l=((t=f.select(document.createElement("div"))).style({position:"absolute",opacity:0,pointerEvents:"none",boxSizing:"border-box"}),t.node()),e=null,c=null,u=null;function p(t){e="svg"===(t=(t=t).node()).tagName.toLowerCase()?t:t.ownerSVGElement,c=e.createSVGPoint(),e.parentNode.appendChild(l)}p.show=function(){var t=Array.prototype.slice.call(arguments),e=(t[t.length-1]instanceof SVGElement&&(u=t.pop()),s.apply(this,t)),r=(n.apply(this,t),o.apply(this,t)),i=f.select(l),a=0;for(i.html(e).style({opacity:1,"pointer-events":"all"});a--;)i.classed(h[a],!1);return d.get(r).apply(this),e=t[4]<100?t[4]+50:t[4]-50,i.classed(r,!0).style({top:e+"px",left:t[3]+20+"px"}),parseInt($(i[0]).css("left"),10)+$(i[0]).width()>$(i[0]).parent().width()&&$(i[0]).css("left",$(i[0]).parent().width()-$(i[0]).width()-40+"px"),parseInt($(i[0]).css("top"),10)+$(i[0]).height()>$(i[0]).parent().height()&&$(i[0]).css("top",$(i[0]).parent().height()-$(i[0]).height()+"px"),p},p.hide=function(){return f.select(l).style({opacity:0,"pointer-events":"none"}),p},p.attr=function(t,e){if(arguments.length<2&&"string"==typeof t)return f.select(l).attr(t);t=Array.prototype.slice.call(arguments);return f.selection.prototype.attr.apply(f.select(l),t),p},p.style=function(t,e){if(arguments.length<2&&"string"==typeof t)return f.select(l).style(t);t=Array.prototype.slice.call(arguments);return f.selection.prototype.style.apply(f.select(l),t),p},p.direction=function(t){return arguments.length?(o=null===t?t:f.functor(t),p):o},p.offset=function(t){return arguments.length?(n=null===t?t:f.functor(t),p):n},p.html=function(t){return arguments.length?(s=null==t?t:f.functor(t),p):s};var d=f.map({n:function(){var t=r();return{top:t.n.y-l.offsetHeight,left:t.n.x-l.offsetWidth/2}},s:function(){var t=r();return{top:t.s.y,left:t.s.x-l.offsetWidth/2}},e:function(){var t=r();return{top:t.e.y-l.offsetHeight/2,left:t.e.x}},w:function(){var t=r();return{top:t.w.y-l.offsetHeight/2,left:t.w.x-l.offsetWidth}},nw:function(){var t=r();return{top:t.nw.y-l.offsetHeight,left:t.nw.x-l.offsetWidth}},ne:function(){var t=r();return{top:t.ne.y-l.offsetHeight,left:t.ne.x}},sw:function(){var t=r();return{top:t.sw.y,left:t.sw.x-l.offsetWidth}},se:function(){var t=r();return{top:t.se.y,left:t.e.x}}}),h=d.keys();function r(){var t=u||f.event.target,e={},r=t.getScreenCTM(),t=t.getBBox(),i=t.width,a=t.height,o=t.x,t=t.y,n=document.documentElement.scrollTop||document.body.scrollTop,s=document.documentElement.scrollLeft||document.body.scrollLeft;return c.x=o+s,c.y=t+n,e.nw=c.matrixTransform(r),c.x+=i,e.ne=c.matrixTransform(r),c.y+=a,e.se=c.matrixTransform(r),c.x-=i,e.sw=c.matrixTransform(r),c.y-=a/2,e.w=c.matrixTransform(r),c.x+=i,e.e=c.matrixTransform(r),c.x-=i/2,c.y-=a/2,e.n=c.matrixTransform(r),c.y+=a,e.s=c.matrixTransform(r),e}return p};k.app=a.template({compiler:[8,">= 4.3.0"],main:function(t,e,r,i,a){var o,n=null!=e?e:t.nullContext||{},s=t.hooks.helperMissing,l="function",c=t.escapeExpression,t=t.lookupProperty||function(t,e){if(Object.prototype.hasOwnProperty.call(t,e))return t[e]};return'<div class="CompareChart">\n\n    <div class="title">\n    </div>\n\n    <div class="frame">\n        <div id="biPartite_'+c(typeof(o=null!=(o=t(r,"id")||(null!=e?t(e,"id"):e))?o:s)==l?o.call(n,{name:"id",hash:{},data:a,loc:{start:{line:7,column:27},end:{line:7,column:33}}}):o)+'" class="graph biPartite_'+c(typeof(o=null!=(o=t(r,"id")||(null!=e?t(e,"id"):e))?o:s)==l?o.call(n,{name:"id",hash:{},data:a,loc:{start:{line:7,column:58},end:{line:7,column:64}}}):o)+'" >\n         \n            \n        </div>\n    </div>\n\n</div>'},useData:!0}),k.chart=a.template({compiler:[8,">= 4.3.0"],main:function(t,e,r,i,a){return'<div class="crumbs">\n</div>\n<div class="graph">\n    <svg></svg>\n</div>\n'},useData:!0}),k.fileExporter=a.template({compiler:[8,">= 4.3.0"],main:function(t,e,r,i,a){return'<div class="tools-panel">\n</div>'},useData:!0});var T=k;function k(){}E.getConfig=function(t){var i=this,a={},e={".csv":"Csv",".xlsx":"Excel"}[t.fileFormat],o=t.columnsConfig,n=o.dataSource;return a.fileName=s.ExportTools.getExportFileName(t.fileName,"",e),a.metaData=[],a.fileFormat=t.fileFormat,a.workSheetTitle=t.workSheetTitle,n&&(e=o.labelColId,n.breakdownColumns.length&&"{breakdownId}"===e&&(e=n.breakdownColumns[n.getDepth()]),a.dataSet=n.getData().toJSON(),a.metaData=[this.getExportMetaData({colId:e,colName:e,dataType:o.labelProps.Format,dataFormat:o.labelProps.DateFormat,precision:o.labelProps.Precision,hideTrailingZeroes:o.labelProps.HideTrailingZeroes,kdbType:n.getColumnType(e)})],_.each(o.layers,function(t){var e=t.Column,r=t.Display,t=s.ExportTools.regExValidateColumnIDs(e,n.getColumnNames());0<t.length?t.forEach(function(t){a.metaData.push(i.getExportMetaData({colId:t,colName:r,dataType:o.layersProps.Format,dataFormat:"",precision:o.layersProps.Precision,hideTrailingZeroes:!1,kdbType:n.getColumnType(t)}))}):console.log("Column with id: '"+e+"' not found")})),a},E.getExportMetaData=function(t){var e={},r=this.getValidPrecission(Number(t.precision)),r=this.resolveColumnTypeAndFormat(t.dataType,t.dataFormat,r,t.kdbType);return e.colId=t.colId,e.colName=t.colName,e.dataType=r.dataType,e.dataKdbType=r.dataKdbType,e.dataFormat=r.dataFormat,e.hideTrailingZeroes=t.hideTrailingZeroes,e.prefix="",e.suffix="",e},E.resolveColumnTypeAndFormat=function(t,e,r,i){var a=11<i&&i<20,o=3<i&&i<10,n=r?"."+Array(r+1).join("0"):"";switch((3===i||i<1||19<i)&&(i=11,e="TO_STRING",t="String"),t){case"Number":o&&(e="#0"+n);break;case"Formatted Number":t="Number",e="#,##0"+n;break;case"Smart Number":t="Number",e="SmartNumber"+n;break;case"Datetime":t=s.ExportTools.getTemporalTypeFromFormat(e),e=s.ExportTools.CHARTS_DATE_FORMAT_MAP[e],e=a?e||"":(t="String","");break;default:t="String",e=""}return{dataType:t=1===i?"Boolean":t,dataFormat:e,dataKdbType:i}},E.getValidPrecission=function(t){var e=void 0!==t?t:0;return e<0?(e=0,console.info("Invalid precission, should be between in range of 0 and 10, got: ",t)):10<e&&(e=10,console.info("Invalid precission, should be between in range of 0 and 10, got: ",t)),e};var Y=E;function E(){}O=s.ExportTools.FileExporterView,o(B,O),B.prototype.initialize=function(){this.fileExport=function(t){try{var e=s.ExportTools,r=Y.getConfig(_.extend(this.getExportConfig(),{fileFormat:t}));e.openFileExportDialog(r)}catch(t){s.Log.Warn("Invalid file export config check properties")}}},B.prototype.apiExport=function(){};var O,L=B;function B(){return null!==O&&O.apply(this,arguments)||this}L.prototype.SETTINGS=["api","appViewModel","getExportConfig","getSvgNode","isPivot"];var M,A=s.Tools;function V(t){var r=M.call(this,t)||this,i=(r.focus=[],r.layers=new d,r.dataSources={},r.errors={},_.extend(r,_.pick(t,["api","dashboardViewModel"])),r.api.setProperty,r.onSettingsChange);return r.onSettingsChange=function(t){var e=this.onSettingsChange!==(this.onSettingsChange=i);this.onSettingsChange(t),e&&(this.isReadyForThemeChange=!0,this.setThemeAccordingToDashboardSettings())}.bind(r),r.$el.html(T.app({id:r.cid})),r.listenTo(r.layers,"add",_.bind(function(t){t.get("NodeLabels")&&t.get("NodeValues")||(t.set("NodeLabels",this.api.getProperty("NodeLabels")),t.set("NodeValues",this.api.getProperty("NodeValues"))),this.setThemeAccordingToDashboardSettings()},r)),r.listenTo(r.layers,"reset",_.bind(function(t){this.setThemeAccordingToDashboardSettings()},r)),r.listenTo(r.layers,"remove",function(t){t.stopListening()}),r.listenTo(r.layers,"update",_.bind(function(t,e){this.updatePossibleLayers();e.changes.added.length,e.changes.removed.length;S.safeHandle(this.initializeChart).call(this)},r)),r.layoutModel=new b,r.listenTo(r.layoutModel,"change",S.safeHandle(r.initializeChart)),r.fileExportModel=new e.DeepModel,r.fileExporterView=new L({model:r.fileExportModel,el:T.fileExporter({}),api:r.api,appViewModel:r.fileExportModel,getSvgNode:function(){return r.$el.find(".frame svg")[0]},getExportConfig:function(){var t=r.layers.at(0),e={};try{e={columnsConfig:{dataSource:r.dataSources[t.get("Basics.Data").cid],layers:t.get("Data"),labelColId:t.get("Labels.Label"),labelProps:t.get("NodeLabels"),layersProps:t.get("NodeValues")},fileName:r.fileExportModel.get("FileExport.FileName"),altFileName:t.get("format.widgetTitle"),workSheetTitle:"CompareChart"}}catch(t){s.Log.Warn("Can not export file -  Datasource or other properties are not set")}return e}}),r.$el.prepend(r.fileExporterView.$el),r.listenTo(r.fileExporterView,"redraw-chart",S.safeHandle(r.initializeChart)),r}return M=e.View,o(V,M),V.prototype.onSettingsChange=function(t){t=S.expandNestedViewStates(t,this.api),t=S.replaceViewStatesWithValue("",t,this.api),t=S.pump(t);this.onSettingsChangeProcessed.call(this,t)},V.prototype.updateError=function(t,e){function r(t){return"Error"===t?3:"Loading"===t?2:"NoResults"===t?1:0}var i=this,t=t.getKey(),e=(e?this.errors[t]=e:delete this.errors[t],_.reduce(this.errors,function(t,e){e=e.type;return r(e)>r(t)?e:t},""));e&&("NoResults"!==e||Object.keys(this.dataSources).length===Object.keys(this.errors).length)?(t=_.map(this.errors,function(t,e){t=t.error,e=i.dataSources[e];return t?"["+e.getPath()+"]: "+t:null}).filter(function(t){return t}),this.api.showQueryStatus({error:t.join("\n"),type:e})):this.api.hideQueryStatus()},V.prototype.updateDataSource=function(e){var r=this;if(this.dataSources[e.getKey()]){var i=this.layers.filter(function(t){t=t.get("Basics.Data");return t&&t.cid===e.getKey()}),a=s.HeuristicHelpers.getNumericColumns(e),o=s.HeuristicHelpers.getStringColumns(e),n=this.errors[e.getKey()];if(!(0!==o.length&&0!==a.length||n&&"Loading"!==_.get(n,"type")))return void this.api.showQueryStatus({error:t("Data Source provided is not valid for Bipartite Chart"),type:"Warning"});i.forEach(function(t){t.updateData(e),t.set("possibleColumns",e.getColumnNames()),t.set("possibleRules",e.getColumnNames()),t.set("possibleLabels",e.getColumnNames()),r.api.setProperty("possibleColumns",t.get("possibleColumns")),r.api.setProperty("possibleRules",t.get("possibleRules")),r.api.setProperty("possibleLabels",t.get("possibleLabels")),""===r.api.getProperty("Labels.Label")&&r.api.setProperty("Labels.Label",o[0]),""===r.api.getProperty("Data.0.Column")&&r.api.setProperty("Data.0.Column",a[0])})}S.safeHandle(this.initializeChart).call(this)},V.prototype.onSettingsChangeProcessed=function(t){_.isObject(t.Basics)&&this.onSettingsBasicsChanged.call(this,t.Basics),_.isObject(t.Basics)&&t.Basics.Data&&this.onSettingsLayersChanged.call(this,t),_.isObject(t.Labels)&&this.onSettingsOnLabels(t),_.isObject(t.Data)&&this.onSettingsOnData(t),_.isObject(t.NodeLabels)&&this.updateBaseLayer(t),_.isObject(t.NodePercentages)&&this.updateBaseLayer(t),_.isObject(t.NodeValues)&&this.updateBaseLayer(t),_.isObject(t.Style)&&this.onSettingsOnStyle(t,"Style"),_.isObject(t.Padding)&&this.onSettingsPaddingChanged.call(this,t),_.isObject(t.FileExport)&&this.onSettingsFileExportChanged.call(this,t.FileExport)},V.prototype.onSettingsFileExportChanged=function(t){var r=this;this.fileExportModel&&_.each(t,function(t,e){r.fileExportModel.set("FileExport."+e,t)})},V.prototype.onSettingsPaddingChanged=function(t){this.layoutModel.set("Padding",t.Padding)},V.prototype.onSettingsLayersChanged=function(t){this.layers.set(t);var t=t.Basics.Data,e=this.dataSources[t.cid];e?e.hasData()&&this.updateDataSource(e):(e=new m(t,this,this.api,this.focus),(this.dataSources[t.cid]=e).subscribe()),t.cid},V.prototype.onSettingsOnLabels=function(t){var r=this.layers.models[0];_.each(t.Labels,function(t,e){r&&"Label"===e&&r.set("Labels.Label",t)})},V.prototype.onSettingsOnStyle=function(t,e){var r;this.layers&&0<this.layers.models.length&&(void 0===(r=this.layers.models[0]).get(e)?r.set(e,this.api.getProperty(e)):this.updateBaseLayer(t))},V.prototype.updateBaseLayer=function(t){var e;this.layers&&0<this.layers.models.length&&((e=this.layers.models[0]).set(t),_.each(this.dataSources,function(t){e.chartData={},e.updateData(t)}),e.updateVisuals(),this.initializeChart())},V.prototype.onSettingsOnData=function(t){var e;0<this.layers.models.length&&((e=this.layers.models[0]).set("Data",t.Data),_.each(this.dataSources,_.bind(function(t){e.chartData={},void 0===e.get("Style")&&e.set("Style",this.api.getProperty("Style")),e.updateData(t)},this)),this.initializeChart())},V.prototype.onSettingsBasicsChanged=function(t){var e=this;void 0!==t.Focus&&(this.focus=_.first(S.focus2Array(t.Focus))||[],_.each(this.dataSources,function(t){t.setFocus(e.focus)}))},V.prototype.initializeChart=function(){var r,t,e,i,a,o,n,s=this;this.chart&&(this.chart.destroy(),delete this.chart),this.layers.models[0]&&this.layers.models[0].chartData&&(r=this.layers.models[0].chartData,t=this.layers.models[0].format,r&&r.data&&t&&(e=this.$el.width()-this.layers.models[0].getWidth()-2*t.minWidth,n=this.$el.height(),(i=this.$el.find("#biPartite_"+this.cid)).empty(),o=r.data.length/t.colors.length,o=isNaN(o)||o<1?1:Math.ceil(r.data.length/t.colors.length),a=window.d3.select("#biPartite_"+this.cid).append("svg").append("g").attr("transform","translate("+t.margin.l+","+t.margin.t+")"),n=[{data:(o=new H(_.flatten(_.times(o,_.constant(t.colors))),n,e,t.decimal,t.c1,t.c2,t.c3,t.partWidth,t.minWidth,t.labelShow,t.valueShow,t.percentShow,t.yAxisFormat)).partData(r.data,2),id:"view_biPartite_"+this.cid,header:["","",""]}],o.draw(n,a),this.tooltip(a),o.ShowTooltip.on(function(t){var e=_.get(t,"svg")?t.svg.getBoundingClientRect():{x:0,y:0};s.tip.show(t.data,t.dataIndex,t.seriesIndex,e.x,e.y)}),o.HideTooltip.on(function(){s.tip.hide()}),$(i).find(".part0 .mainbar").click(function(e){var t=_.indexOf(r.data,_.find(r.data,function(t){return t[0]===$(e.target).text()}));-1!=t&&s.onClick(t)}),this.setThemeLabelColor(t.labelColor)))},V.prototype.onResizeStop=function(){S.safeHandle(this.initializeChart).call(this)},V.prototype.tooltip=function(t){var e,r,i=this.api.getProperty("Style");this.tip=window.d3.tip().attr("class","d3-tip").html(function(t){e=a.compile(i.advancedTooltip);try{r=e(t)}catch(t){r=""}return r}),t.call(this.tip)},V.prototype.onClick=function(t){var e,r,i=this.layers.models[0],a=i.get("Basics.Data"),a=this.dataSources[a.cid],t=a.getData().at(t);void 0!==t&&(e=a.getDepth(),r=_.clone(this.focus),a=a.getPropertyFromColumn(i.get("Labels.Label")),i=t.get(a),r[e]=i&&i.toString?i.toString():""+i,this.api.setProperty("Basics.Focus",r.join(","),!0),this.doActions(t))},V.prototype.doActions=function(e){var t=this.api.getProperty("Basics.Actions").map(function(t){return n(n({},t),{Value:e.get(t.Current)})});this.api.doActions(t,"Basics.Actions")},V.prototype.onLayerDataEvents=function(t){var e=t.get("Basics.Data"),e=e?this.dataSources[e.cid]:void 0;t.updateData(e),t.set("_Hidden._PossibleColumns",e?e.getColumnNames():[])},V.prototype.onLayerVisualEvents=function(t){t.updateVisuals()},V.prototype.setTheme=function(t){var e;if("Light"===t)e="#000000";else{if("Dark"!==t)return void console.warn("Dashboard Theme should be set / unkown theme: "+t);e="#FFFFFF"}t=t.toLowerCase();this.layers.models[0],this.api;this.$el.removeClass("dark light"),this.$el.addClass(t),this.setThemeLabelColor(e)},V.prototype.setThemeLabelColor=function(t){this.$el.find("text").css("fill",t)},V.prototype.setThemeAccordingToDashboardSettings=function(){this.isReadyForThemeChange&&this.setTheme(this.dashboardViewModel.get("DashboardTheme"))},V.prototype.updatePossibleLayers=function(){this.layers.filter(function(t){return"Line"===t.get("_Hidden._Type")}).forEach(function(i){var t=i.collection.reduceRight(function(t,e,r){return[i===e?"nofill":"Layer "+(r+1)].concat(t)},["origin"]);i.set("_Hidden._PossibleLayers",t)}.bind(this))},V.getComponentDefinition=w.getComponentDefinition,V.DEBUG=!1,V});