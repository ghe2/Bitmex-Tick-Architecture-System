define(["backbone","Handlebars","moment","mapbox","css!./css/app.css"],function(o,y,e,l){"use strict";var i,r=this&&this.__extends||(i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o])})(e,t)},function(e,t){function o(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(o.prototype=t.prototype,new o)}),s=(n.getComponentDefinition=function(e){var t,o,i={appArgs:{json:{version:"4.6.0",MapDetails:{Bearing:12,Key:"",Latitude:19.297668,Longitude:-99.5968,Pitch:14,Selected:"",SelectedCol:"",Zoom:8},Overlays:{GeoJSON:"",GeoJSONFull:"",GeoJSONLines:""},Points:{Color:"",DataSource:"",Icon:"",Latitude:"",Longitude:"",SubTitle:"",Title:"",Tooltip:"",Type:""},possibleColumns:[""],Style:{Theme:"Dark",advanced:""}},schema:{properties:{MapDetails:{options:{collapsed:!1},properties:{Key:{default:"",propertyOrder:1,title:"Map Box Key",type:"string"},Bearing:{default:0,maximum:15,minimum:0,propertyOrder:5,title:"Bearing",type:"number"},Latitude:{default:0,maximum:85,minimum:-85,propertyOrder:2,title:"Latitude",type:"number"},Longitude:{default:0,maximum:180,minimum:-180,propertyOrder:3,title:"Longitude",type:"number"},Pitch:{default:0,maximum:50,minimum:0,propertyOrder:4,title:"Pitch",type:"number"},Selected:{default:"",propertyOrder:6,type:"viewstate"},SelectedCol:{default:"lat",enumSource:"poss_rul_cols",propertyOrder:7,title:"Selected Column",type:"string",watch:{poss_rul_cols:"root.possibleColumns"}},Zoom:{default:8,maximum:17,minimum:0,propertyOrder:1,title:"Zoom",type:"number"}},propertyOrder:2,title:"Map",type:"object"},Overlays:{options:{collapsed:!0},properties:{GeoJSON:{default:"",propertyOrder:1,title:"GeoJSON Overlay Data",type:"json"},GeoJSONFull:{default:"",propertyOrder:3,title:"GeoJSON Full ",type:"json"},GeoJSONLines:{default:"",propertyOrder:2,title:"GeoJSON Lines Data",type:"json"}},propertyOrder:990,title:"Overlays",type:"object"},Points:{properties:{Color:{default:"",enumSource:"poss_rul_cols",propertyOrder:7,title:"Color",type:"string",watch:{poss_rul_cols:"root.possibleColumns"}},DataSource:{default:8,format:"data",maximum:17,minimum:0,propertyOrder:1,title:"DataSource",type:"data"},Icon:{default:"",enumSource:"poss_rul_cols",propertyOrder:8,title:"Icon",type:"string",watch:{poss_rul_cols:"root.possibleColumns"}},Latitude:{default:"lat",enumSource:"poss_rul_cols",propertyOrder:2,title:"Latitude Data",type:"string",watch:{poss_rul_cols:"root.possibleColumns"}},Longitude:{default:"lng",enumSource:"poss_rul_cols",propertyOrder:3,title:"Longitude Data",type:"string",watch:{poss_rul_cols:"root.possibleColumns"}},SubTitle:{default:"",enumSource:"poss_rul_cols",propertyOrder:6,title:"Sub Title",type:"string",watch:{poss_rul_cols:"root.possibleColumns"}},Title:{default:"",enumSource:"poss_rul_cols",propertyOrder:5,title:"Title",type:"string",watch:{poss_rul_cols:"root.possibleColumns"}},Tooltip:{default:"",propertyOrder:9,title:"Tooltip",type:"tooltipTemplate",disableTree:!0},Type:{default:"",enumSource:"poss_rul_cols",propertyOrder:4,title:"Marker Type",type:"string",watch:{poss_rul_cols:"root.possibleColumns"}}},propertyOrder:2,title:"Points",type:"object"},possibleColumns:{default:[],format:"table",items:{type:"string"},options:{collapsed:!0,hidden:!0},type:"array"},Style:{options:{collapsed:!0},properties:{DashboardTheme:{options:{hidden:!0}},Theme:{default:"Dark",enum:["Light","Dark"],options:{hidden:!0},title:"Theme",type:"string"},advanced:{default:"",propertyOrder:160,title:"Advanced CSS",type:"css"}},propertyOrder:991,title:"Style",type:"object"}},title:"Properties",type:"object"},websiteUrl:e.websiteUrl},appKey:"Mapbox",buildViewThumb:null,componentDescription:"Mapbox Widget (BETA)",componentName:"Mapbox",css:"mapbox",ghostViewThumb:null,id:10123};if(0<_.keys(e.settingsModel.attributes).length)for(o=n.upgrades.indexOf(_.find(n.upgrades,{version:e.settingsModel.get("version")}))+1;o<n.upgrades.length;o+=1)(t=n.upgrades[o]).fn(e.settingsModel,e),e.settingsModel.set("version",t.version);return i},n);function n(){}s.upgrades=[{fn:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t]},version:0},{version:"4.5.1",fn:function(e){e.set("possibleColumns",e.get("PossibleColumns"))}},{version:"4.6.0",fn:function(e){var t=e.get("MapDetails");t.Key=void 0===t.Key?"":t.Key,e.set("MapDetails",t)}}];a.alert=y.template({compiler:[8,">= 4.3.0"],main:function(e,t,o,i,r){var s,n=null!=t?t:e.nullContext||{},a=e.hooks.helperMissing,l="function",p=e.escapeExpression,e=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return' <div>\n    <div style="display:inline-block;">\n        <div style="font-weight: 400; font-size: 13px;"> '+p(typeof(s=null!=(s=e(o,"title")||(null!=t?e(t,"title"):t))?s:a)==l?s.call(n,{name:"title",hash:{},data:r,loc:{start:{line:3,column:57},end:{line:3,column:66}}}):s)+' </div>\n        <div style="color: rgba(0,0,0,.54);"> '+p(typeof(s=null!=(s=e(o,"subtitle")||(null!=t?e(t,"subtitle"):t))?s:a)==l?s.call(n,{name:"subtitle",hash:{},data:r,loc:{start:{line:4,column:46},end:{line:4,column:58}}}):s)+'</div>\n        <div style="color: rgba(0,0,0,.54);"> '+p(typeof(s=null!=(s=e(o,"timeAgo")||(null!=t?e(t,"timeAgo"):t))?s:a)==l?s.call(n,{name:"timeAgo",hash:{},data:r,loc:{start:{line:5,column:46},end:{line:5,column:57}}}):s)+' </div>\n    </div>\n    <div style="float:right;">\n        <i aria- hidden="true" class="material-icons" style="color:'+p(typeof(s=null!=(s=e(o,"color")||(null!=t?e(t,"color"):t))?s:a)==l?s.call(n,{name:"color",hash:{},data:r,loc:{start:{line:8,column:67},end:{line:8,column:76}}}):s)+';"> '+p(typeof(s=null!=(s=e(o,"icon")||(null!=t?e(t,"icon"):t))?s:a)==l?s.call(n,{name:"icon",hash:{},data:r,loc:{start:{line:8,column:80},end:{line:8,column:88}}}):s)+" </i>\n        \n    </div>\n</div>"},useData:!0}),a.app=y.template({compiler:[8,">= 4.3.0"],main:function(e,t,o,i,r){var s=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'<div class="mapbox" id="mapbox-'+e.escapeExpression("function"==typeof(o=null!=(o=s(o,"id")||(null!=t?s(t,"id"):t))?o:e.hooks.helperMissing)?o.call(null!=t?t:e.nullContext||{},{name:"id",hash:{},data:r,loc:{start:{line:1,column:31},end:{line:1,column:37}}}):o)+'">\n</div>\n'},useData:!0}),a.markerTooltip=y.template({1:function(e,t,o,i,r){var s=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return"<div>"+e.escapeExpression("function"==typeof(o=null!=(o=s(o,"process")||(null!=t?s(t,"process"):t))?o:e.hooks.helperMissing)?o.call(null!=t?t:e.nullContext||{},{name:"process",hash:{},data:r,loc:{start:{line:4,column:28},end:{line:4,column:39}}}):o)+"</div>"},compiler:[8,">= 4.3.0"],main:function(e,t,o,i,r){var s,n=null!=t?t:e.nullContext||{},a=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'  <div style="color:black">\n    <div style="padding:5px;">\n        <a style="font-size: 20px!important; font-weight: 500; color: #1976d2; cursor:pointer;">'+e.escapeExpression("function"==typeof(s=null!=(s=a(o,"title")||(null!=t?a(t,"title"):t))?s:e.hooks.helperMissing)?s.call(n,{name:"title",hash:{},data:r,loc:{start:{line:3,column:96},end:{line:3,column:105}}}):s)+"</a> \n        "+(null!=(s=a(o,"if").call(n,null!=t?a(t,"process"):t,{name:"if",hash:{},fn:e.program(1,r,0),inverse:e.noop,data:r,loc:{start:{line:4,column:8},end:{line:4,column:52}}}))?s:"")+'\n    </div>\n    <div class="alertHtml" style="height:100%; padding-left:10px;padding-right:10px;"></div>\n</div>'},useData:!0});var p=a;function a(){}var u,c=["MapDetails.Selected","Points.Tooltip"];function d(e){var t=u.call(this,e)||this;return t.pointsSource=void 0,t.pointsData=[],t.ignoreOnSettingsChange=!1,t.errors={},t.listenersActive=!1,t.mapLoaded=!1,t.mapboxID="",t.ID=t.cid,t.lineID="line"+t.cid,t.pointID="point"+t.cid,t.markers=[],t.templateSubscrKey=null,t.templateVs={},t.api=e.api,t.mapboxID="mapbox-"+t.cid,t.$el.html(p.app({id:t.cid})),t.$el.addClass("mapbox-app"),t.$mapbox=t.$el.find(".mapbox"),t.viewModel=new o.DeepModel({}),t}return u=o.View,r(d,u),d.prototype.onResize=function(){this.renderMap()},d.prototype.onSettingsChange=function(e){var o=this;_.each(e,function(e,t){o.viewModel.set(t,e)}),!this.ignoreOnSettingsChange&&Object.keys(e).filter(function(e){return-1===c.indexOf(e)&&"string"==typeof e&&-1===c.indexOf(e.split(".")[0])}).length?this.renderMap():this.ignoreOnSettingsChange=!1,this.listenersActive||this.initializeListeners()},d.prototype.initializeListeners=function(){this.listenTo(this.viewModel,"change:Points.DataSource",this.onPointsChange),this.listenTo(this.viewModel,"change:Points.Tooltip",this.onTemplateChange),this.onPointsChange(this.viewModel,this.viewModel.get("Points.DataSource")),this.listenersActive=!0},d.prototype.destroyMap=function(){this.map&&this.map.remove()},d.prototype.onPointsData=function(e,t,o){if(o)return this.updateError("Points Source",o);o=this.pointsSource.dataSet.columns.map(function(e){return e.get("id")});this.api.setProperty("possibleColumns",[""].concat(o)),this.pointsData=t.items?t.items():this.pointsSource.dataSet.collection.models.map(function(e){return e.attributes}),this.renderMap()},d.prototype.onPointsChange=function(e,o){this.pointsSource&&(this.stopListening(this.pointsSource),this.api.unsubscribe(this.pointsSource),this.pointsSource=void 0),o&&(this.pointsSource=o,this.pointsSource&&this.pointsSource.attributes?(this.updateError("Point Source",void 0),this.api.subscribe(this.pointsSource,$.proxy(this.onPointsData,this))):this.updateError("Points Source",{error:t("Invalid Data Source: ")+o.path+" "+t("selected"),type:"Warning"}))},d.prototype.onTemplateChange=function(e,t){var o=this;this.unsubscribeTemplate(),t?this.templateSubscrKey=this.api.subscribeTemplateViewStates(t,function(e){o.templateVs=e,o.renderMap()}):this.templateVs={}},d.prototype.renderMap=function(){this.destroyMap();var e=this.viewModel.get("MapDetails"),t=e.Zoom,o=e.Bearing,i=e.Latitude,r=e.Longitude,s=e.Pitch,e=e.Key;(l.accessToken=e)?(this.api.hideQueryStatus(),this.map=new l.Map({bearing:o,center:[r,i],container:this.mapboxID,pitch:s,style:"mapbox://styles/mapbox/streets-v9",zoom:t}),this.map.on("load",this.onMapLoad.bind(this))):this.api.showQueryStatus({error:"Please add Mapbox API Key",type:"Error"})},d.prototype.refreshMapGeojson=function(){var e=this.viewModel.get("Overlays.GeoJSON");e&&(e=JSON.parse(e),this.mapLoaded&&(this.map.getLayer(this.ID)&&this.map.removeLayer(this.ID),e&&this.map.addLayer({id:this.ID,paint:{"fill-extrusion-base":["get","base_height"],"fill-extrusion-color":["get","color"],"fill-extrusion-height":["get","height"],"fill-extrusion-opacity":1},source:{data:e,type:"geojson"},type:"fill-extrusion"})))},d.prototype.refreshMapGeojsonLine=function(){var e=this.viewModel.get("Overlays.GeoJSONLines");e&&(e=JSON.parse(e),this.mapLoaded&&(this.map.getLayer(this.lineID)&&this.map.removeLayer(this.lineID),e&&this.map.addLayer({id:"route",layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":["get","color"],"line-width":["get","stroke-width"]},source:{data:e,type:"geojson"},type:"line"})))},d.prototype.refreshMapGeojsonFull=function(){var e=this.viewModel.get("Overlays.GeoJSONFull");e&&(e=JSON.parse(e),this.mapLoaded&&(this.map.getLayer(this.pointID)&&this.map.removeLayer(this.pointID),e&&this.map.addLayer(e)))},d.prototype.remove=function(){return this.destroyMap(),this.unsubscribeTemplate(),o.View.prototype.remove.apply(this)},d.prototype.addMarker=function(e,t,o){var i="",r=document.createElement("i"),s=document.createElement("div"),n=this.api;switch(o.type){case"circle":r.className="mapxBoxIcon",s.className="mapxBoxMarker",s.className="circle";break;case"square":r.className="mapxBoxIcon",s.className="mapxBoxMarker",s.className="square";break;case"Plant_Marker":r.className="fa fa-building mapxBoxIcon",s.className="material-icons mapxBoxMarker";break;default:r.className="material-icons mapxBoxIcon",s.className="material-icons mapxBoxMarker"}s.appendChild(r),i+="background : "+o.color,r.innerHTML=o.icon,s.style.cssText=i,r.style.cssText="";var i=window.document.createElement("div"),a=(i.innerHTML=p.markerTooltip({process:o.process,title:o.title}),o.tooltip),a=($(i).find(".alertHtml").html(a),new l.Marker(s).setLngLat(e).setPopup(new l.Popup({offset:10}).setDOMContent(i)).addTo(this.map));s.addEventListener("click",function(e){n.setProperty("MapDetails.Selected",o.selected)}),this.markers.push(a)},d.prototype.addMarkerData=function(){var o,i=this,e=this.viewModel.get("Points"),r=e.Latitude,s=e.Longitude,n=e.Message,a=e.Type,l=e.Title,p=e.SubTitle,u=e.Color,c=e.Icon,d=(e.DataSource,e.Tooltip),m=this.viewModel.get("MapDetails.SelectedCol"),h="";_.each(this.pointsData,function(e){try{var t=y.compile(d);h='<div style="color:#000000">'+t(_.extend(e,i.templateVs))+"</div>"}catch(e){h=""}t={color:e[u],icon:e[c],process:e[p],selected:e[m],title:e[l],tooltip:h,type:e[a]};o=e[s]&&e[r]?[e[s],e[r]]:[0,0],i.addMarker(o,e[n],t)})},d.prototype.onMapLoad=function(){this.mapLoaded=!0,this.refreshMapGeojson(),this.refreshMapGeojsonLine(),this.refreshMapGeojsonFull(),this.addMarkerData()},d.prototype.unsubscribeTemplate=function(){this.templateSubscrKey&&this.api.unsubscribeTemplateViewStates(this.templateSubscrKey)},d.prototype.updateError=function(e,t){t?this.errors[e]=t:delete this.errors[e],_.keys(this.errors).length?(t=_.map(this.errors,function(e,t){return"["+t+"]: "+e.error}),this.api.showQueryStatus({error:t.join("\n"),type:"Error"})):this.api.hideQueryStatus()},d.getComponentDefinition=s.getComponentDefinition,d});