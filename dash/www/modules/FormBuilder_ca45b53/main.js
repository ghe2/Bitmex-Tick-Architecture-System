define(["backbone","Handlebars","Forms","QuickBase","jqueryui","css!./css/app.css"],function(r,e,s,u,i){"use strict";var o,n=this&&this.__extends||(o=function(e,t){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)},function(e,t){function i(){this.constructor=e}o(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}),l=(p.getComponentDefinition=function(e){var t,i,o={id:1014,componentName:"Form Builder",componentDescription:"Create a form",appKey:"FormBuilder",css:"FormBuilder",ghostViewThumb:null,buildViewThumb:null,appArgs:{websiteUrl:(e=e||{websiteUrl:"",settingsModel:new r.Model}).websiteUrl,json:{version:"4.6.1",Basics:{Title:"Form",FormDefinition:"",FormValues:""},Actions:[],StateOutput:[],Elements:[],Style:{Layout:"Column",HideGroupBorders:!1,HideGroupTitles:!1,HideSubmit:!1,HideCancel:!1,FocusOnLoad:!1,Horizontal:"Center",Vertical:"Middle",LabelWidths:"100px",MaxFormWidth:"100%",SubmitButtonText:"Submit",CancelButtonText:"Cancel"}},schema:{type:"object",title:"Properties",_transform:function(e,t,i,o){var n,l,s,r=e.Basics.FormDefinition instanceof u.DocumentViewModel,a=_.last(i.split(".")),d=i.split(".");r?"root"===a?(_.set(t,"properties.Elements.options.hidden",!0),o(e,t)):o(e):"root"===a?(p.setNestedSchema(t,e.Elements),o(e,t)):"Elements"===a?(r=_.get(e,i),n=p.generateUniqueId(e.Elements),l=i+"."+(r.length-1),(s=_.get(e,l))&&(s.id||(s.id=n,s.title=s.title||n),"group"!==s.type._Type&&delete s.Elements),o(e)):(l=_.initial(d).join("."),s=_.get(e,l),"type"===a?"group"===s.type._Type?(_.extend(s,{Elements:[]}),p.setNestedSchema(t,e.Elements),o(e,t)):(delete s.Elements,o(e)):("id"===a&&(!s.id||1<p.filterById(e.Elements,s.id).length)&&(s.id=p.generateUniqueId(e.Elements)),o(e)))},properties:{Basics:{type:"object",title:"Basics",options:{collapsed:!1},propertyOrder:1,properties:{FormDefinition:{title:"Kdb Schema",type:"viewstate",default:""},FormValues:{title:"Form Values",type:"viewstate",default:""},Title:{title:"Title",type:"string",default:"Form"}}},Actions:{type:"actions",fields:{map:p.actionFields,nav:p.actionFields,query:p.actionFields,url:p.actionFields},title:"Actions"},StateOutput:{type:"actions",fields:{map:_.extend({Current:{title:"Form Values",type:"object",options:{hidden:!0}},Target:{title:"Output",type:"string",default:""}},p.actionFields)},excludedFields:["nav","query","url"],title:"State Output"},Elements:p.ElementsSchema,Style:{type:"object",title:"Style",options:{collapsed:!0},properties:{HideGroupBorders:{type:"boolean",format:"checkbox",title:"Hide Fieldset Borders",default:!1},HideGroupTitles:{type:"boolean",format:"checkbox",title:"Hide Group Titles",default:!1},HideSubmit:{type:"boolean",format:"checkbox",title:"Hide Submit",default:!1},HideCancel:{type:"boolean",format:"checkbox",title:"Hide Cancel",default:!1},FocusOnLoad:{type:"boolean",format:"checkbox",title:"Focus On Load",default:!1},Horizontal:{type:"string",title:"Horizontal",enum:["Left","Center","Right"]},Vertical:{type:"string",title:"Vertical",enum:["Top","Middle","Bottom"]},Layout:{type:"string",title:"Layout",enum:["Column","Row"]},MaxFormWidth:{type:"string",title:"Max Form Width"},LabelWidths:{type:"string",title:"Label Widths"},SubmitButtonText:{type:"string",title:"Submit Button Text",default:"Submit"},CancelButtonText:{type:"string",title:"Cancel Button Text",default:"Cancel"}}}}}}};if(0<_.keys(e.settingsModel.attributes).length)for(i=p.upgrades.indexOf(_.find(p.upgrades,{version:e.settingsModel.get("version")}))+1;i<p.upgrades.length;i+=1)(t=p.upgrades[i]).fn(e.settingsModel,e),e.settingsModel.set("version",t.version);return o},p.getSettingsModel=function(e){var t=p.getComponentDefinition(null).appArgs.json;return $.extend(!0,t,e),new r.DeepModel(t)},p.countElements=function(e,t){var i=0;return(e=t?_.filter(e,function(e){return e.type._Type===t}):e)&&(i=e.length,_.each(_.filter(e,function(e){return"group"===e.type._Type}),function(e){i+=p.countElements(e.Elements,t)})),i},p.countGroups=function(e,t){var i=t=void 0===t?0:t;return _.each(e,function(e){"group"===e.type._Type&&(e=p.countGroups(e.Elements,t+1),i<e&&(i=e))}),i},p.filterById=function(e,i){return _.reduce(e,function(e,t){return t.id===i&&e.push(t),e="group"===t.type._Type?e.concat(p.filterById(t.Elements,i)):e},[])},p.generateUniqueId=function(e,t){for(var i=t||"Element",o=p.countElements(e,t),n=i+o;0<p.filterById(e,n).length;)n=i+ ++o;return n},p.getValidatorSchema=function(e,t){return{id:e,title:e,type:"object",options:{hidden:!0,collapsed:!0,linked_oneof_property:{property:"type",value:e}},properties:_.extend({type:{type:"string",default:e,options:{hidden:!0}},message:{type:"string",title:"Message",default:""},disabled:{type:"boolean",title:"Disabled",default:!1}},t||{})}},p.getTypeSchema=function(e,t){return{id:e,title:e,type:"object",options:{hidden:!0,collapsed:!0,linked_oneof_property:{property:"_Type",value:e}},properties:_.extend({_Type:{type:"string",default:e,options:{hidden:!0}},Data:{type:"string",hidden:!0},DataSourceMapping:{type:"object",hidden:!0},Items:{type:"array",hidden:!0},DropdownPossibleValues:{type:"array",hidden:!0},layout:{type:"string",hidden:!0}},t||{},"symbol"===e?{password:{type:"boolean",default:!1,title:"Password Field"}}:{})}},p.setNestedSchema=function(e,t){for(var i=p.countGroups(t),o="properties.Elements.items.properties.Elements",n=0;n<i;n++)_.set(e,o,_.cloneDeep(p.ElementsSchema)),o+=".items.properties.Elements"},p.kdbTypes=["symbol","boolean","byte","char","date","datetime","real","float","group","guid","int","list","long","minute","month","second","short","string","time","timespan","timestamp"],p.ElementsSchema={title:"Elements",type:"array",format:"object",options:{collapsed:!0},items:{id:"arr_item",title:"Element",type:"object",headerTemplate:"{{#if self.id}}{{self.id}}{{else}}Element{{i1}}{{/if}}",options:{collapsed:!0,keep_oneof_values:!1},properties:{id:{type:"string",title:"id"},title:{type:"string",title:"Title"},default:{type:"string",title:"Default",default:""},hidden:{type:"boolean",title:"Hidden",default:!1},disabled:{type:"boolean",title:"Disabled",default:!1},ignoreOnChange:{type:"boolean",title:"Ignore On Change",default:!1},classes:{type:"string",title:"CSS classes",default:""},type:{type:"object",title:"Type",id:"type",options:{disable_collapse:!0,keep_oneof_values:!1},default:p.getTypeSchema("symbol"),_transform:function(o,e,t,n){var l,s;"Data"===t?(t=o.Data,l=o.DataSourceMapping.Value instanceof r.Model,s=o.DataSourceMapping.Text instanceof r.Model,t?t.getMeta(function(e){var e=_.fromPairs(_.map(e.columns.collection.models,function(e){return[e.get("id"),e.toJSON()]})),t=_.keys(e),e=_.find(e,function(e){return 0===e.kdbType||11===e.kdbType}),i=o.DataSourceMapping.DropdownPossibleValues;i&&!_.isEqual(i.sort(),t.sort())&&(o.DataSourceMapping.DropdownPossibleValues=t,o.DropdownPossibleValues=t,l||(o.DataSourceMapping.Value=t[0]||""),s||(o.DataSourceMapping.Text=e&&e.id||t[0]||"")),n(o)}):(o.DataSourceMapping.DropdownPossibleValues=[],o.DropdownPossibleValues=[],l||(o.DataSourceMapping.Value=""),s||(o.DataSourceMapping.Text=""),n(o))):n()},oneOf:_.map(p.kdbTypes,function(e){switch(e){case"group":return p.getTypeSchema(e,{layout:{type:"string",title:"Layout",enum:["Column","Row"],default:"Column",hidden:!1}});case"list":return{id:e,title:e,type:"object",options:{hidden:!1,collapsed:!1,linked_oneof_property:{property:"_Type",value:e}},properties:{_Type:{type:"string",default:e,options:{hidden:!0}},DropdownPossibleValues:{type:"array",items:{type:"string"},default:[],options:{hidden:!0}},Data:{type:"data",title:"Data Source",default:"",propertyOrder:3},forceSelect:{type:"boolean",title:"Force Selected Value",default:!1,format:"checkbox",propertyOrder:1},multiSelect:{type:"boolean",title:"Multi-select",default:!1,format:"checkbox",propertyOrder:2},DataSourceMapping:{type:"object",title:"Data Source Mapping",properties:{Value:{type:"string",enumSource:"possible_values",default:"",watch:{possible_values:"arr_item.type.DropdownPossibleValues"}},Text:{type:"string",enumSource:"possible_values",default:"",watch:{possible_values:"arr_item.type.DropdownPossibleValues"}},DropdownPossibleValues:{type:"array",items:{type:"string"},default:[],options:{hidden:!0}}}},Items:{type:"array",format:"table",title:"Items",uniqueItems:!0,options:{collapsed:!1},items:{type:"object",properties:{Value:{type:"string"},Text:{type:"string"}}}}}};default:return p.getTypeSchema(e)}})},validators:{title:"Validators",type:"array",format:"object",options:{collapsed:!0},items:{title:"Validator",type:"object",headerTemplate:"Validator {{i1}}",options:{keep_oneof_values:!1,disable_collapse:!0},oneOf:[p.getValidatorSchema("email"),p.getValidatorSchema("range",{min:{type:"string",title:"Min"},max:{type:"string",title:"Max"}}),p.getValidatorSchema("required"),p.getValidatorSchema("regexp",{regexp:{type:"string",title:"regexp"},flags:{type:"string",title:"flags"}}),p.getValidatorSchema("url")]}}}}},p.actionFields={Trigger:{type:"string",enum:["Submit","Cancel","Change"],default:"Click",title:"Trigger Action",propertyOrder:2}},p);function p(){}l.upgrades=[{version:0,fn:_.noop.bind(this)}];a=r.Model,n(c,a),c.prototype.getValueOrDefault=function(e){return((e=D.getValue(e))||0===e)&&" "!==e&&0!==e.length||(e=_.includes(_.keys(this.attributes),"default")?this.get("default"):e||null),!this.get("multiSelect")||_.isNil(e)||_.isArray(e)?e:e.toString().split(",")},c.prototype.setValueOrDefault=function(e){this.set("value",this.getValueOrDefault(e))};var a,d=c;function c(e){var t=a.call(this,e)||this;return t.path=e.path||"",t.view=new T({model:t,api:e.api}),t}m=r.Collection,n(f,m);var m,h=f;function f(){return null!==m&&m.apply(this,arguments)||this}g=r.Model,n(v,g);var g,y=v;function v(e){var t=g.call(this,e)||this;return t.fields=new h,t.path=e.path||"",t.view=new E({model:t,api:e.api}),t}b=r.View,n(P,b),P.prototype.addError=function(e){this.clearErrors(),e&&(this.$editor.addClass("error"),this.$error=s.ErrorTooltip.show(e,this.$editor))},P.prototype.clearErrors=function(){this.$error&&(this.$editor.removeClass("error"),s.ErrorTooltip.clear(this.$error))},P.prototype.focus=function(){var t,i=this;"list"===this.model.get("type")?(t=function(){clearInterval(i.focusInterval),delete i.focusInterval},this.focusInterval=setInterval(function(){var e=i.$editor.find("span.select2-selection");e.length&&(e.focus(),t())},50),this.focusTimeout=setTimeout(t.bind(this),500)):this.editor.focus()},P.prototype.getEditorEl=function(){return this.$editor},P.prototype.getLabelEl=function(){return this.$label},P.prototype.remove=function(){return this.unsubscribe(),clearInterval(this.focusInterval),clearTimeout(this.focusTimeout),r.View.prototype.remove.apply(this)},P.prototype.renderEditor=function(){var i,t=this,e=this.model.get("type"),o=("list"===e?(o=this.model.get("multiSelect")?"MultiSelect":"Select",this.defaultValidators=[]):(l=s.RTTI.getByName(e),o=this.model.get("password")&&"symbol"===e?"Password":l.editor.type,this.defaultValidators=l.editor.validators),r.Form.editors[o]),n={options:l&&l.editor.options,width:"100%"},l=this.model.getValueOrDefault(this.api.getProperty(D.PROP_VALUES)[this.model.id]);"list"===e&&(i=this.model.get("values")||this.model.get("Items")||[],_.isArray(i)?n.options=_.map(i,function(e){return _.isObject(e)?{val:e.Value,label:e.Text}:e}):_.isObject(i)?n.options=_.map(i.Value,function(e,t){return{val:e,label:i.Text[t]||e}}):"string"==typeof i&&(n.options=i.split(",")),n.enforceValue=this.model.get("forceSelect")||!1,n.modelKey="value",l=this.model.get("multiSelect")?_.filter(l,function(e){return t.isElementOfDropdown(e,n.options)}):this.isElementOfDropdown(l,n.options)?l:null,this.editor&&this.editor.$el.hasClass("select2-hidden-accessible")&&this.editor.$el.data("select2")&&this.editor.$el.select2("close")),this.model.set("value",l),this.editor=new o({id:e+"_"+_.uniqueId(),key:"value",schema:n,model:this.model,validators:this.getAllValidators()}),this.editor.render(),this.editor.on("change",function(){t.debouncedUpdateModelValue()}),this.$editor.empty(),this.$editor.append(this.editor.$el),this.$editor.attr("name",this.model.id),this.$editor.find("input,select").prop("disabled",!!this.model.get("disabled"))},P.prototype.renderView=function(){this.renderEditor(),this.renderLabel(),this.$el.toggleClass("hidden",!!this.model.get("hidden"))},P.prototype.renderLabel=function(){this.$label.empty(),this.$label.append('<label name="'+this.model.id+'">'+this.model.get("title")+"</label>"),this.$label.attr("name",this.model.id),this.$label.css("width",this.api.getProperty(D.PROP_LABELWIDTHS))},P.prototype.toggle=function(e){this.$el.css("display",e?"":"none")},P.prototype.updateValidators=function(){this.editor.validators=this.getAllValidators()},P.prototype.validate=function(){return!this.model.get("hidden")&&this.editor.validate()},P.prototype.initializeEvents=function(){var i=this;this.listenTo(this.model,"change:Data",function(e){i.unsubscribe(),i.data=e.get("Data"),i.subscribe()}),this.listenTo(this.model,"change:DataSourceMapping.Value change:DataSourceMapping.Text",function(t){i.data&&i.model.set("values",_.map(i.data.dataSet.collection.models,function(e){return{Value:e.get(t.get("DataSourceMapping.Value")),Text:e.get(t.get("DataSourceMapping.Text"))}}))}),this.listenTo(this.model,"change:validators",function(){i.updateValidators()}),this.listenTo(this.model,"change:default",function(e){e.get("value")||e.setValueOrDefault(e.get("default"))}),this.listenTo(this.model,"change:classes",function(e){var t=e.previousAttributes().classes;t&&i.$el.removeClass(t),i.$el.addClass(e.get("classes"))}),this.listenTo(this.model,"change:disabled",function(e){i.$editor.find("input,select").prop("disabled",!!e.get("disabled"))}),this.listenTo(this.model,"change:value",function(e){i.pendingValueChange=!0,_.includes(_.keys(i.editor),"previousValue")&&(i.editor.previousValue=e.get("value"))})},P.prototype.isElementOfDropdown=function(t,e){return _.some(e,function(e){return t==(e.val||e)})},P.prototype.isTime=function(){return _.includes(["date","datetime","minute","month","second","time","timespan","timestamp"],this.model.get("type"))},P.prototype.getAllValidators=function(){var o=this,e=_.compact(_.map(_.filter(this.model.get("validators"),function(e){return!e.disabled&&("regexp"!==e.type||e.regexp)}),function(t){var i={message:t.message};return"function"===t.type?function(){if(t.condition)return i}:"range"===t.type&&o.isTime()?function(){var e=o.model.get("value");if(e<t.min||t.max<e)return i}:t}));return _.union(this.defaultValidators,e)},P.prototype.subscribe=function(){var i=this;this.data&&this.api.subscribe(this.data,function(e,t){e=e.columns;e.reset?i.metaCollection.reset(e.reset):(i.metaCollection.remove(_.map(e.remove,function(e){return e.id})),i.metaCollection.add(e.add),i.metaCollection.add(e.change,{merge:!0})),t.reset?i.dataCollection.reset(t.reset):_.isArray(e.reset)&&_.isEmpty(e.reset)?i.dataCollection.reset():(i.dataCollection.remove(_.map(t.remove,function(e){return e._rowIndex})),i.dataCollection.add(t.add),i.dataCollection.add(t.change,{merge:!0})),i.model.set("values",_.map(i.dataCollection.models,function(e){return{Value:e.get(i.model.get("DataSourceMapping.Value")),Text:e.get(i.model.get("DataSourceMapping.Text"))}}))})},P.prototype.unsubscribe=function(){this.data&&(this.api.unsubscribe(this.data),delete this.data,this.model.unset("values"))},P.prototype.updateModelValue=function(){this.editor.getValue()!==this.model.get("value")&&this.model.set("value",this.editor.getValue())};var b,T=P;function P(e){var t=b.call(this,e)||this;return t.pendingValueChange=!1,t.defaultValidators=[],t.api=e.api,t.model=e.model,t.data=t.model.get("Data"),t.metaCollection=new r.Collection([],{model:r.Model.extend({idAttribute:"id"})}),t.dataCollection=new r.Collection([],{model:r.Model.extend({idAttribute:"_rowIndex"})}),t.$el.html(w.FormField({})),t.$el=t.$el.find(".form-field"),t.$editor=t.$el.find(".editor"),t.$label=t.$el.find(".label"),t.$el.attr("name",t.model.id),t.debouncedUpdateModelValue=_.debounce(t.updateModelValue.bind(t),300),t.initializeEvents(),t.subscribe(),t}O=r.View,n(S,O),S.prototype.clearErrors=function(){this.model.fields.each(function(e){return e.view.clearErrors()})},S.prototype.focus=function(){var e=this.model.fields.at(0);e&&e.view.focus()},S.prototype.remove=function(){return this.clearErrors(),this.model.fields.remove(this.model.fields.models),r.View.prototype.remove.apply(this)},S.prototype.renderView=function(){this.$fields.prop("disabled",!!this.model.get("disabled")),this.$el.toggleClass("hidden",!!this.model.get("hidden"))},S.prototype.toggle=function(e){this.$el.toggle(e)},S.prototype.validate=function(){this.clearErrors();var i=!1;return this.model.get("hidden")||this.model.fields.each(function(e){var t=e.view.validate();t&&(i=!0,e instanceof d&&e.view.addError(t.message))}),i},S.prototype.initializeEvents=function(){var o=this;this.listenTo(this.model.fields,"add",function(e){var t=o.$fields.children("[name='"+e.id+"']"),i=o.$fields.children(".form-field,.form-group");t[0]?t.replaceWith(e.view.$el):i.length?e.get("index")?i.eq(e.get("index")-1).after(e.view.$el):o.$fields.prepend(e.view.$el):o.$fields.append(e.view.$el),o.updateModelValue(e),e.view.renderView()}),this.listenTo(this.model.fields,"remove",function(e){return e.view.remove()}),this.listenTo(this.model.fields,"change:index",function(e){o.model.fields.remove(e),o.model.fields.add(e,{at:e.get("index")}),e.view.initializeEvents(),e instanceof y&&e.view.updateModel()}),this.listenTo(this.model.fields,"change:title",function(e){e instanceof d?(e.view.renderLabel(),o.$fields.find(".label[name='"+e.id+"']").replaceWith(e.view.getLabelEl())):o.setLegendTitle(e)}),this.listenTo(this.model.fields,"change:hidden",function(e){e.view.$el.toggleClass("hidden",!!e.get("hidden"))}),this.listenTo(this.model.fields,"change:value",this.updateModelValue.bind(this)),this.listenTo(this.model.fields,"change:values change:Items change:forceSelect change:multiSelect change:password",function(e){e.view.renderEditor(),o.$fields.find('.editor[name="'+e.id+'"]').replaceWith(e.view.getEditorEl())}),this.listenTo(this.model.fields,"change:type",function(e){var t=o.model.fields.indexOf(e);o.model.fields.remove(e),e.view.remove(),e="group"===e.get("type")?new y(o.getOptions(!0,e.attributes,e.id)):new d(o.getOptions(!1,e.attributes,e.id)),o.model.fields.add(e,{at:t}),e.view.renderView()}),this.listenTo(this.model.fields,"change:properties",function(e){e.view.updateModel()}),this.listenTo(this.model,"change:title",this.setLegendTitle.bind(this)),this.listenTo(this.model,"change:properties",this.updateModel.bind(this)),this.listenTo(this.model,"change:layout",function(e){o.$fields.toggleClass("Layout-Row","Row"===e.get("layout"))}),this.listenTo(this.model,"change:disabled",function(e){o.$fields.prop("disabled",!!e.get("disabled"))})},S.prototype.createModel=function(e,t,i){t=this.getOptions(e,t,i),i=new(e?y:d)(t);return e&&this.setLegendTitle(i),i},S.prototype.getChildPath=function(e){return this.model.path?this.model.path+"."+e:e},S.prototype.getOptions=function(e,t,i){var o=this.getChildPath(i);return _.extend({},t,{api:this.api,id:i,path:o})},S.prototype.setLegendTitle=function(e){e.view.$fields.find("> legend").html(e.get("title"))},S.prototype.updateModel=function(){var s=this,r=this.model.fields.clone(),a=-1;_.each(this.model.get("properties"),function(e,t){var i,o=s.model.fields.get(t),n=(_.extend(e,{index:++a}),"group"===e.type),l=o&&e.type!==o.get("type");o&&l&&((i=s.model.fields.get(o.id))&&(s.model.fields.remove(i),r.remove(i))),!o||l?(o=s.createModel(n,e,t),s.model.fields.add(o)):(o.set(e),r.remove(r.get(t)))}),r.each(function(e){e=s.model.fields.get(e.id);s.model.fields.remove(e)})},S.prototype.updateModelValue=function(e){var t=_.cloneDeep(this.model.get("value"));e instanceof y?_.extend(t,e.get("value")):(t[e.id]={value:e.get("multiSelect")&&e.get("value")?e.get("value").join(","):e.get("value"),type:"list"===e.get("type")?"symbol":e.get("type")},e.view.pendingValueChange=!1),this.model.set("value",t),this.clearErrors()};var O,E=S;function S(e){var t=O.call(this,e)||this;return t.api=e.api,t.model=e.model,t.model.set("value",{}),t.$el.addClass("form-group"),t.$el.html(w.GroupView({rowLayout:"Row"===t.model.get("layout")})),t.$el.attr("name",t.model.id),t.$fields=t.$el.find("fieldset"),t.initializeEvents(),t.updateModel(),t}V.FieldError=e.template({compiler:[8,">= 4.3.0"],main:function(e,t,i,o,n){var l=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'<div class="error"><span>'+e.escapeExpression(e.lambda(null!=(e=null!=t?l(t,"error"):t)?l(e,"message"):e,t))+"</span></div>"},useData:!0}),V.FormField=e.template({compiler:[8,">= 4.3.0"],main:function(e,t,i,o,n){return'<div class="form-field bbf-field">\n    <div class="label"></div>\n    <div class="editor bbf-editor"></div>\n</div>'},useData:!0}),V.GroupView=e.template({1:function(e,t,i,o,n){return'class="Layout-Row"'},compiler:[8,">= 4.3.0"],main:function(e,t,i,o,n){var l=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return"<fieldset "+(null!=(i=l(i,"if").call(null!=t?t:e.nullContext||{},null!=t?l(t,"rowLayout"):t,{name:"if",hash:{},fn:e.program(1,n,0),inverse:e.noop,data:n,loc:{start:{line:1,column:10},end:{line:1,column:52}}}))?i:"")+">\n    <legend></legend>\n</fieldset>"},useData:!0}),V.app=e.template({compiler:[8,">= 4.3.0"],main:function(e,t,i,o,n){return'<div class="Form-Builder">\n    <div class="form-buttons">\n        <button class="submit-button">Submit</button>\n        <button class="cancel-button">Cancel</button>\n    </div>\n</div>'},useData:!0});var w=V;function V(){}C=r.View,n(R,C),R.getValue=function(e){return e&&_.includes(_.keys(e),"value")?e.value:e},R.reduceList=function(e){return _.reduce(e,function(e,t){return _.isObject(t)?e.push(R.reduceProperties(t)):e.push(t),e},[])},R.reduceNestedTable=function(e){return R.reduceProperties(e,e.columns[0],e.columns[1])},R.reduceProperties=function(e,t,i){var o,n,l;return void 0===t&&(t="key"),"object"==typeof e?(o="table"===e._type||"table"===e.type)||"203"===e.class?(n=e.value||e,l=0,_.mapValues(_.keyBy(_.map(n.rows,function(e){return e[t]})),function(){var e=o?_.pick(n.rows[l++],n.columns.slice(1)):n.rows[l++][i];return e="object"==typeof e?"203"===e.class?R.reduceNestedTable(e):_.transform(e,function(e,t,i){e[i]="203"===t.class?R.reduceNestedTable(t):t}):e})):_.reduce(_.includes(_.keys(e),"value")?e.value:e,function(e,t,i){return _.isArray(t.value||t)?e[i]=R.reduceList(t.value||t):_.isObject(t.value)?e[i]=R.reduceProperties(t):void 0===t.value?e[i]=t:e[i]=t.value,e},{}):e},R.prototype.onSettingsChange=function(i){var e,n=this,t=_.keys(i);_.includes(t,R.PROP_DEFINITION)?(e=i[R.PROP_DEFINITION])&&(this.model.set("properties",R.reduceProperties(e.properties)),this.model.set("title",R.getValue(e.title)||"")):_.includes(t,R.PROP_VALUES)&&0<this.model.fields.length&&_.each(this.model.get("value"),function(e,t){e=i[R.PROP_VALUES][t];t=n.findFieldModel(n.model,t);t&&!t.view.pendingValueChange&&t.setValueOrDefault(R.getValue(e))}),!i[R.PROP_DEFINITION]&&_.includes(t,R.PROP_ELEMENTS)?this.model.set("properties",this.saveElements(i[R.PROP_ELEMENTS])):!i[R.PROP_DEFINITION]&&_.some(t,function(e){return _.includes(e,R.PROP_ELEMENTS)})&&_.each(i,function(e,t){var i,t=_.reduce(t.split(/\.?Elements\.?/),function(e,t){return t&&e.push(t),e},[]),o=n.getModelFromPath(n.model,t);o&&_.last(t)&&(t=1<(t=_.last(t).split(".")).length?t.slice(1):t,i=_.cloneDeep(o.get(_.first(t))),_.isObject(i)?(_.set(i,t.slice(1).join("."),e),o.set(_.first(t),i)):o.set(t.join("."),e))}),_.includes(t,R.PROP_HIDEBORDERS)&&this.$form.toggleClass("hide-borders",i[R.PROP_HIDEBORDERS]),_.includes(t,R.PROP_HIDETITLES)&&this.$form.toggleClass("hide-titles",i[R.PROP_HIDETITLES]),_.includes(t,R.PROP_HIDESUBMIT)&&this.$submit.toggle(!i[R.PROP_HIDESUBMIT]),_.includes(t,R.PROP_HIDECANCEL)&&this.$cancel.toggle(!i[R.PROP_HIDECANCEL]),_.includes(t,R.PROP_HORIZONTAL)&&(this.$form.removeClass("Center Left Right"),this.$form.addClass(this.api.getProperty(R.PROP_HORIZONTAL))),_.includes(t,R.PROP_VERTICAL)&&(this.$form.removeClass("Middle Top Bottom"),this.$form.addClass(this.api.getProperty(R.PROP_VERTICAL))),_.includes(t,R.PROP_LABELWIDTHS)&&this.$form.find(".form-field > .label").css("width",this.api.getProperty(R.PROP_LABELWIDTHS)),_.includes(t,R.PROP_MAXFORMWIDTH)&&this.$form.css("max-width",this.api.getProperty(R.PROP_MAXFORMWIDTH)),_.includes(t,R.PROP_SUBMITBUTTONTEXT)&&this.changeButtonText(this.$submit,this.api.getProperty(R.PROP_SUBMITBUTTONTEXT)),_.includes(t,R.PROP_CANCELBUTTONTEXT)&&this.changeButtonText(this.$cancel,this.api.getProperty(R.PROP_CANCELBUTTONTEXT)),_.includes(t,R.PROP_TITLE)&&this.model.view.$fields.find("> legend").html(i[R.PROP_TITLE]||this.model.get("title")||""),_.includes(t,R.PROP_LAYOUT)&&this.model.view.$fields.toggleClass("Layout-Row","Row"===i[R.PROP_LAYOUT])},R.prototype.remove=function(){return this.model.view.remove(),this},R.prototype.afterInitialRender=function(){this.api.getProperty(R.PROP_FOCUSONLOAD)&&this.model.view.focus()},R.prototype.changeButtonText=function(e,i){e.button("option","label",t(i))},R.prototype.doActions=function(o){var n=this,e=_.transform(this.api.getProperty(R.PROP_ACTIONS),function(e,t,i){t.Trigger===o&&(t._PropertyIndex=i,e.push(t))}),t=_.transform(this.api.getProperty(R.PROP_STATEOUTPUT),function(e,t,i){t.Trigger===o&&(t._PropertyIndex=i,i=n.api.getProperty(R.PROP_VALUES),t.Value=_.extend(i?_.cloneDeep(i):{},n.getModelValues("Change"===o)),e.push(t))});this.api.doActions(e,R.PROP_ACTIONS),this.api.doActions(t,R.PROP_STATEOUTPUT)},R.prototype.findFieldModel=function(e,t){var i,o=this;return e instanceof d?e.id===t?e:void 0:(_.each(e.fields.models,function(e){if(e.id===t?i=e:e instanceof y&&(i=o.findFieldModel(e,t)),i)return!1}),i)},R.prototype.getModelFromPath=function(e,t){var i=_.first(null==(i=_.first(t))?void 0:i.split("."));if(i&&e){if(1===t.length)return e.fields.models[i];e=e.fields.models[i];return e?this.getModelFromPath(e,t.slice(1)):void 0}},R.prototype.getModelValues=function(e){var n;return e?(e=(n=function(i,o){return _.reduce(i.fields.models,function(e,t){return t instanceof y?e=e.concat(n(t,o||i.get("ignoreOnChange"))):(o||t.get("ignoreOnChange"))&&e.push(t.id),e},[])})(this.model),_.omit(this.model.get("value"),e)):this.model.get("value")},R.prototype.onSubmit=function(){this.model.view.validate()||this.doActions("Submit")},R.prototype.onValueChange=function(){this.doActions("Change");var e=this.api.getProperty(R.PROP_VALUES);e&&this.api.setProperty(R.PROP_VALUES,_.extend(_.cloneDeep(e),this.getModelValues()))},R.prototype.saveElements=function(e){var o=this;return _.reduce(e,function(e,t){e[t.id]={};var i=e[t.id];return t=_.mapKeys(t,function(e,t){var i;return"type"===t.substring(0,4)?"_Type"===(i=t.substring(5))?"type":i:t}),_.each(_.omit(t,"id"),function(e,t){"Elements"===t?i.properties=o.saveElements(e):i[t]=e}),e},{})},R.getComponentDefinition=l.getComponentDefinition,R.getSettingsModel=l.getSettingsModel,R.PROP_ACTIONS="Actions",R.PROP_STATEOUTPUT="StateOutput",R.PROP_DEFINITION="Basics.FormDefinition",R.PROP_VALUES="Basics.FormValues",R.PROP_TITLE="Basics.Title",R.PROP_ELEMENTS="Elements",R.PROP_HORIZONTAL="Style.Horizontal",R.PROP_VERTICAL="Style.Vertical",R.PROP_LABELWIDTHS="Style.LabelWidths",R.PROP_MAXFORMWIDTH="Style.MaxFormWidth",R.PROP_HIDEBORDERS="Style.HideGroupBorders",R.PROP_HIDETITLES="Style.HideGroupTitles",R.PROP_HIDESUBMIT="Style.HideSubmit",R.PROP_HIDECANCEL="Style.HideCancel",R.PROP_FOCUSONLOAD="Style.FocusOnLoad",R.PROP_SUBMITBUTTONTEXT="Style.SubmitButtonText",R.PROP_CANCELBUTTONTEXT="Style.CancelButtonText",R.PROP_LAYOUT="Style.Layout";var C,D=R;function R(e){var i=C.call(this,e)||this;return i.api=e.api,i.$el.html(w.app({})),i.$form=i.$el.find(".Form-Builder"),i.model=new y({api:i.api}),i.$form.prepend(i.model.view.$el),i.$cancel=i.$form.find(".cancel-button"),i.$cancel.button({text:t("Cancel"),icons:{primary:"fa fa-times"}}).click(i.doActions.bind(i,"Cancel")),i.$submit=i.$form.find(".submit-button"),i.$submit.button({text:t("Submit"),icons:{primary:"fa fa-check"}}).click(i.onSubmit.bind(i)),i.listenTo(i.model,"change:value",_.debounce(i.onValueChange.bind(i),100)),i.listenToOnce(i.model,"change:properties",i.afterInitialRender.bind(i)),i}return D});