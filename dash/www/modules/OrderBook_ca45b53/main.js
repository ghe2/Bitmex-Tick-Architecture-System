define(["backbone","Datagrid","d3","Handlebars","dashMoment","QuickBase","css!./css/app.css"],function(o,r,T,i,H,S){"use strict";var s,e=this&&this.__extends||(s=function(e,t){return(s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)},function(e,t){function i(){this.constructor=e}s(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}),n=this&&this.__assign||function(){return(n=Object.assign||function(e){for(var t,i=1,o=arguments.length;i<o;i++)for(var s in t=arguments[i])Object.prototype.hasOwnProperty.call(t,s)&&(e[s]=t[s]);return e}).apply(this,arguments)},w=(a.val2YN=function(e){return e?"Y":"N"},a.compareKDBTimes=function(e,t){return e.i>t.i?1:e.i<t.i?-1:e.n>t.n?1:e.n<t.n?-1:0},a.convertKDBDatetimeToISOstring=function(e){var t=e;return e&&e.i&&(t=new Date(e.i).toISOString(),void 0!==e.n&&(t=t.substr(0,t.length-4)+("00000000"+e.n).slice(-9)+"Z")),t},a.decimalPlaces=function(e){var t=0,e=e.toString();return t=0<=e.indexOf(".")?e.split(".")[1].length:t},a.extractProps=function(e){var e=i.parse(e),o={};return function t(e){var i;e&&_.includes(["Program","BlockStatement","MustacheStatement","SubExpression"],e.type)&&(_.each((0<((null==(i=e.params)?void 0:i.length)||0)?e.params:null)||(e.path?[e.path]:null),function(e){"SubExpression"===e.type?t(e):"PathExpression"===e.type&&(o[e.original]=!0)}),_.each(e.body,t),t(e.program),t(e.inverse))}(e),_.keys(o)},a.fixedDecimalStringCompare=function(e,t){var i="-"===e[0],o=i?1-e.length:e.length,s="-"===t[0]?1-t.length:t.length;return o!==s?s<o?1:-1:(i?-1:1)*(t<e?1:e<t?-1:0)},a.formatter=function(e){var t,i=e;return _.isObject(e)&&void 0!==e.class&&(t=e.class,_.includes(["1212","1213","1214","1215","1216","1217","1218","1219"],t)&&(i=a.convertKDBDatetimeToISOstring(e))),i},a.generateDatagridSettingsModel=function(e){e=e instanceof o.Model&&"Dark"===e.get("DashboardTheme");return r.getSettingsModel({Basics:{ShowPagingControl:!1,EnableGrouping:!1},Selection:{FollowSelectedValue:!0,Mode:"Multi Row"},FileExport:{ShowFullExportButton:!1},Style:{SelectedRowBackgroundColor:"#3A9FC7",HeaderTextTransformation:"capitalize",EvenRowBackgroundColorOverride:e?"#282828":"#f0f0f0",OddRowBackgroundColorOverride:e?"#303030":"#e0e0e0"}})},a.getOffsets=function(e){var t,i=e.offsetX,o=e.offsetY;return 0!==i&&void 0!==i||(t=e.target||e.srcElement)&&(t=t.getBoundingClientRect(),i=e.clientX-t.left,o=e.clientY-t.top),{x:i,y:o}},a.log10=function(e){return parseFloat((Math.log(e)/Math.LN10).toPrecision(6))},a.objToUri=function(i){return _.reduce(_.keys(i),function(e,t){return t&&e.push(t+"="+i[t]),e},[]).join("&")},a.roundToPipSize=function(e,t,i){return _.isNil(e)?"":(Math.round(e/t)*t).toFixed(i)},a.roundToPlaces=function(e,t){t=Math.pow(10,t);return e*=t,(e=Math.round(e))/t},a.round=function(e,t,i){if(i===a.Rounding.Normal)return a.roundToPlaces(e,t);t=Math.pow(10,t);return i===a.Rounding.Floor?Math.floor(e*t)/t:Math.ceil(e*t)/t},a.ORDER_MAP={MOC:5,MKT:5,"MKT-":5,"MKT ":5,"MKT+":5},a);function a(){}(g=(g=w=w||{}).Rounding||(g.Rounding={}))[g.Normal=0]="Normal",g[g.Floor=1]="Floor",g[g.Ceiling=2]="Ceiling";d.app=i.template({compiler:[8,">= 4.3.0"],main:function(e,t,i,o,s){return'<div class="statusBar"></div>\n<div class="book">\n    <ul>\n        <li><a href="#OrderBook-1">Book</a></li>\n        <li><a href="#OrderBook-2">Depth</a></li>\n        <li><a href="#OrderBook-3">Chart</a></li>\n    </ul>\n    <div id="OrderBook-1">\n    </div>\n    <div id="OrderBook-2">\n    </div>\n    <div id="OrderBook-3">\n    </div>\n    <div class="fps">60</div>\n    <div class="orderBookErrors"><i class="fa fa-exclamation-triangle" aria-hidden="true"></i></div>\n</div>'},useData:!0}),d.book=i.template({compiler:[8,">= 4.3.0"],main:function(e,t,i,o,s){return'<div class="buy"></div><div class="sell"></div>'},useData:!0}),d.chart=i.template({compiler:[8,">= 4.3.0"],main:function(e,t,i,o,s){return'<svg></svg>\n<canvas></canvas>\n<div class="tooltip"></div>\n<a class="zoomIn" title="Zoom In" />\n<a class="zoomOut" title="Zoom Out" />\n<a class="lockY" title="Lock Y Axis">Y</a>\n<a class="lockX" title="Lock X Axis">X</a>\n<a class="reset" title="Reset" />'},useData:!0}),d.depth=i.template({compiler:[8,">= 4.3.0"],main:function(e,t,i,o,s){return'<div class="buyBook"></div><div class="sellBook"></div>'},useData:!0});var l=d;function d(){}var h={Name:{title:"Name",type:"string",default:""},Enabled:{type:"boolean",format:"checkbox",default:!0,options:{hidden:!0}},ConditionSource:{title:"Condition Source",type:"string",enumSource:"possible_columns",watch:{possible_columns:"root.possibleColumns"},default:""},ConditionOperator:{title:"Condition Operator",type:"string",enum:["","search","contains","starts with","ends with","==","<",">","<=",">=","!="],default:""},ConditionValue:{title:"Condition Value",type:"string",default:""},Color:{type:"gradient",options:{noColor:!0},default:""}},c=(_.each(["Name","Enabled","ConditionSource","ConditionOperator","ConditionValue","Color"],function(e,t){h[e].propertyOrder=1010+t}),{Name:{title:"Name",type:"string",default:""},Enabled:{type:"boolean",format:"checkbox",default:!0,options:{hidden:!0}},Target:{type:"customDropdown",data:"possible_columns",watch:{possible_columns:"root.possibleColumns"},default:"*"},ConditionSource:{title:"Condition Source",type:"string",enumSource:"possible_columns",watch:{possible_columns:"root.possibleColumns"},default:""},ConditionOperator:{title:"Condition Operator",type:"string",enum:["","search","contains","starts with","ends with","==","<",">","<=",">=","!="],default:""},ConditionValue:{title:"Condition Value",type:"string",default:""},Color:{type:"gradient",options:{noColor:!0},default:""},BackgroundColor:{title:"Background Color",type:"gradient",options:{noColor:!0,gradient:!0},default:""},BorderColor:{title:"Border Color",type:"gradient",options:{noColor:!0},default:""},Icon:{type:"icon",title:"Icon",default:""},IconColor:{title:"Icon Color",type:"gradient",options:{noColor:!0},default:""}}),u=(_.each(["Name","Enabled","Target","ConditionSource","ConditionOperator","ConditionValue","Color","BackgroundColor","BorderColor","Icon","IconColor"],function(e,t){c[e].propertyOrder=1010+t}),[{Name:"qty up",Enabled:!0,Target:"leavesQty",ConditionSource:"change_leavesQty",ConditionOperator:"==",ConditionValue:"UP",Color:"",BackgroundColor:"#00a300",BorderColor:"",Icon:"",IconColor:""},{Name:"qty down",Enabled:!0,Target:"leavesQty",ConditionSource:"change_leavesQty",ConditionOperator:"==",ConditionValue:"DOWN",Color:"",BackgroundColor:"#b50000",BorderColor:"",Icon:"",IconColor:""},{Name:"price up",Enabled:!0,Target:"price",ConditionSource:"change_price",ConditionOperator:"==",ConditionValue:"UP",Color:"",BackgroundColor:"#00a300",BorderColor:"",Icon:"",IconColor:""},{Name:"price down",Enabled:!0,Target:"price",ConditionSource:"change_price",ConditionOperator:"==",ConditionValue:"DOWN",Color:"",BackgroundColor:"#b50000",BorderColor:"",Icon:"",IconColor:""}]),p={UserDefined:{type:"boolean",title:"User Defined",format:"checkbox",default:!1},Field:{title:"Data Field Name",type:"customDropdown",default:"",data:"possible_columns",watch:{possible_columns:"root.possibleColumns"}},DisplayName:{title:"Display Name",type:"string",default:""},Sortable:{type:"boolean",format:"checkbox",default:!0,options:{hidden:!0}},Format:{type:"string",enum:["General","Number","Formatted Number","Smart Number","Date","Time","DateTime","Percentage","Boolean"],default:"General"},Precision:{type:"number",title:"Precision",format:"number",minimum:0,maximum:10,default:2},HideTrailingZeroes:{type:"boolean",title:"Hide Trailing Zeroes",format:"checkbox",default:!1},Currency:{title:"Currency Symbol",type:"string",enum:["none","USD","GBP","EUR"],default:"none"},DateFormat:{title:"Date Format",type:"string",enum:S.Tools.Formats.Date,default:"YYYY-MM-DD"},TimeFormat:{title:"Time Format",type:"string",enum:S.Tools.Formats.Time,default:"HH:mm:ss"},HighlightNegativeColor:{options:{noColor:!0},type:"gradient",title:"Negative Color",default:""},HighlightChanges:{type:"boolean",title:"Highlight Changes",format:"checkbox",default:!1},HighlightChangeDuration:{title:"Highlight Change Duration",minimum:50,maximum:1e3,type:"number",step:10,format:"range",default:200},ShowArrowsOnChange:{type:"boolean",title:"Show arrows on Change",format:"checkbox",default:!1},HighlightMinValueColor:{options:{noColor:!0},type:"gradient",title:"Min Value Color",default:""},HighlightMaxValueColor:{options:{noColor:!0},type:"gradient",title:"Max Value Color",default:""},RangeHighlightColor:{options:{noColor:!0},type:"gradient",title:"Range Color",default:""},WidthWeight:{title:"Width (relative)",minimum:0,type:"number",default:1},MinWidthAbsolute:{title:"Min Width (px)",minimum:0,type:"number",default:1},PercentageColorOverride:{type:"gradient",default:"#606060",title:"Percentage Color"},IsReadonly:{type:"boolean",title:"Read Only",format:"checkbox",default:!1},TextAlign:{title:"Text Align",type:"string",enum:["left","center","right"],default:"center"},Template:{type:"handlebar",data:[],default:""},Hidden:{type:"boolean",format:"checkbox",default:!1}},F={},g=(_.each(["UserDefined","Field","DisplayName","WidthWeight","MinWidthAbsolute","TextAlign","Sortable","Format","Precision","HideTrailingZeroes","Currency","DateFormat","TimeFormat","HighlightNegativeColor","HighlightChanges","HighlightChangeDuration","ShowArrowsOnChange","HighlightMinValueColor","HighlightMaxValueColor","RangeHighlightColor","PercentageColorOverride","IsReadonly","Template","Hidden"],function(e,t){p[e].propertyOrder=1010+t,F[e]=p[e].default}),f.getComponentDefinition=function(e){var t={id:3,componentName:"order book",componentDescription:"See results from your data queries.",appKey:"OrderBook",listViewThumb:"",ghostViewThumb:null,buildViewThumb:null,appArgs:{json:{version:"4.7.0",possibleColumns:[],Basics:{OrderBook:"",LastBookTrades:"",OrderEvents:"",DistanceToPreload:40,OrderEventsOut:"",BaseTime:"",Selected:"",SelectedDuplicate:"",ShowTradesBookPublic:!1,ShowTradesBookInternal:!1,ShowLastBookTrades:!0,SelectedTime:"",SelectedOrderID:"",ClickedOrderID:"",OpenInBook:!1,PipSize:5,SortPriority:"",YaxisMax:"data",ShowBuySell:!0,ShowExports:!0,Filtering:"disabled",ActiveTab:2,MaxPriceLevels:999999999,BuysAboveSell:!1},HighlightRules:[{Name:"Buy Green",Enabled:!0,ConditionSource:"S",ConditionOperator:"==",ConditionValue:"B",Color:"#00ff00"},{Name:"Sell Red",Enabled:!0,ConditionSource:"S",ConditionOperator:"==",ConditionValue:"S",Color:"#ff0000"}],GridHighlightRules:_.cloneDeep(u),ColumnsConfiguration:[{UserDefined:!1,Field:"time",DisplayName:"time",Sortable:!1,Format:"Time",Precision:0,HideTrailingZeroes:!1,Currency:"none",DateFormat:"YYYY-MM-DD",TimeFormat:"HH:mm:ss.SSS",HighlightNegativeColor:"",HighlightChanges:!1,HighlightChangeDuration:200,ShowArrowsOnChange:!1,HighlightMinValueColor:"",HighlightMaxValueColor:"",RangeHighlightColor:"",WidthWeight:1,MinWidthAbsolute:110,PercentageColorOverride:"#93DF93",IsReadonly:!1,TextAlign:"center",Template:"",Hidden:!1},{UserDefined:!1,Field:"orderID",DisplayName:"orderID",Sortable:!1,Format:"General",Precision:2,HideTrailingZeroes:!1,Currency:"none",DateFormat:"YYYY-MM-DD",TimeFormat:"HH:mm:ss",HighlightNegativeColor:"",HighlightChanges:!1,HighlightChangeDuration:200,ShowArrowsOnChange:!1,HighlightMinValueColor:"",HighlightMaxValueColor:"",RangeHighlightColor:"",WidthWeight:1,MinWidthAbsolute:110,PercentageColorOverride:"#93DF93",IsReadonly:!1,TextAlign:"center",Template:"",Hidden:!1},{UserDefined:!1,Field:"leavesQty",DisplayName:"Quantity",Sortable:!1,Format:"Number",Precision:2,HideTrailingZeroes:!1,Currency:"none",DateFormat:"YYYY-MM-DD",TimeFormat:"HH:mm:ss",HighlightNegativeColor:"",HighlightChanges:!1,HighlightChangeDuration:200,ShowArrowsOnChange:!1,HighlightMinValueColor:"",HighlightMaxValueColor:"",RangeHighlightColor:"",WidthWeight:1,MinWidthAbsolute:100,PercentageColorOverride:"#93DF93",IsReadonly:!1,TextAlign:"center",Template:"",Hidden:!1},{UserDefined:!1,Field:"price",DisplayName:"price",Sortable:!1,Format:"General",Precision:5,HideTrailingZeroes:!1,Currency:"none",DateFormat:"YYYY-MM-DD",TimeFormat:"HH:mm:ss",HighlightNegativeColor:"",HighlightChanges:!1,HighlightChangeDuration:200,ShowArrowsOnChange:!1,HighlightMinValueColor:"",HighlightMaxValueColor:"",RangeHighlightColor:"",WidthWeight:1,MinWidthAbsolute:70,PercentageColorOverride:"#93DF93",IsReadonly:!1,TextAlign:"center",Template:f.PRICE_COL_TEMPLATE,Hidden:!1}],Style:{Theme:"Dark",statusBar:'<table style="font-size: 1.1em; text-align: center"><tr><td>NBBO Bid:</td><td >{{toFixed latestNbboBid 4}}</td><td>NBBO Ask:</td><td>{{toFixed latestNbboAsk 4}}</td><td>Hi:</td><td>{{toFixed currentDailyTradeHigh 4}}</td><td>Lo:</td><td>{{toFixed currentDailyTradeLow 4}}</td><td>Last:</td><td>{{toFixed latestTrade 4}}</td></tr></table>',chartTooltip:f.TOOLTIP_TEMPLATE,bookTooltip:f.TOOLTIP_BOOK_TEMPLATE,EvenRowBackgroundColorOverride:"#282828",OddRowBackgroundColorOverride:"#303030",SelectedRowBackgroundColor:"",RowHeight:30,HeaderRowHeight:30,HeaderTextTransformation:"none",HeaderFontWeight:"",FontFamily:"",FontSize:"",advanced:"",ShowChartGridLines:!1}},schema:{type:"object",title:"Properties",_transform:function(t,i,e,o){"Basics.OrderBook"===e?t.Basics.OrderBook?t.Basics.OrderBook.getMeta(function(e){e=_.map(e.columns.collection.models,function(e){return e.get("id")}),e=_.concat("",e);_.isEqual(t.possibleColumns,e)||(t.possibleColumns=e),o(t,i)}):(t.possibleColumns=[],o(t,i)):o()},properties:{possibleColumns:{type:"array",format:"table",items:{type:"string"},default:[],options:{collapsed:!0,hidden:!0}},Basics:{type:"object",title:"Basics",options:{collapsed:!1},properties:{OrderBook:{propertyOrder:1,type:"data",title:"Order Book"},LastBookTrades:{propertyOrder:3,type:"data",title:"Last Book Trades"},OrderEvents:{propertyOrder:2,type:"data",title:"Order Events"},OrderEventsOut:{propertyOrder:23,type:"data",title:"Order Events Out"},DistanceToPreload:{propertyOrder:24,type:"number",format:"number",title:"Distance to Preload",default:60},BaseTime:{propertyOrder:4,type:"viewstate",default:"",title:"Base Time"},Selected:{propertyOrder:5,type:"viewstate",default:"",title:"Selected"},SelectedDuplicate:{propertyOrder:6,type:"viewstate",default:"",title:"SelectedDuplicate"},SelectedTime:{propertyOrder:7,type:"viewstate",default:"",title:"Selected Time"},SelectedOrderID:{propertyOrder:8,type:"string",title:"Selected OrderID"},ShowTradesBookPublic:{propertyOrder:11,type:"boolean",title:"Show Public Trades",default:!1,format:"checkbox"},ShowTradesBookInternal:{propertyOrder:12,type:"boolean",title:"Show Internal Trades",default:!1,format:"checkbox"},ShowLastBookTrades:{propertyOrder:13,type:"string",title:"Show Trade Movement",default:"last trade",enum:["none","last trade","current daily high/low"]},ClickedOrderID:{propertyOrder:9,type:"string",title:"Clicked OrderID"},OpenInBook:{propertyOrder:10,type:"boolean",title:"Show Clicked Chart Order in Depth",default:!1,format:"checkbox"},PipSize:{propertyOrder:14,type:"number",format:"number",title:"Pip Size",default:1e-4},SortPriority:{propertyOrder:15,type:"string",title:"Sort Priority",enumSource:"possible_columns",watch:{possible_columns:"root.possibleColumns"},default:""},ShowBuySell:{propertyOrder:16,type:"boolean",title:"Show Buy And Sell Tags",default:!0,format:"checkbox"},ShowExports:{propertyOrder:17,type:"boolean",title:"Show Exports",default:!0,format:"checkbox"},Filtering:{propertyOrder:18,type:"string",title:"Filtering",default:"disabled",enum:["Quick Search","Column Filters","Advanced Column Filters","disabled"]},YaxisMax:{propertyOrder:19,type:"string",title:"Y-Axis Max",default:"data",enum:["view","data"]},ActiveTab:{propertyOrder:20,type:"integer",title:"Selected Tab Index",default:2,minimum:0,maximum:2},MaxPriceLevels:{propertyOrder:21,type:"integer",title:"Maximum Price Levels",default:99999999,maximum:99999999,minimum:2},BuysAboveSell:{propertyOrder:22,type:"boolean",title:"Stack Buys Above Sells",default:!1,format:"checkbox"}}},BucketState:{type:"object",title:"Bucket State",options:{collapsed:!1},properties:{Buckets:{type:"data",title:"Buckets"},Selected:{type:"viewstate",title:"Selected"}}},HighlightRules:{type:"array",format:"object",title:"Chart Highlight Rules",options:{hidden:!1,collapsed:!1},items:{type:"object",title:"Rule",options:{collapsed:!0},properties:h}},ColumnsConfiguration:{type:"array",format:"object",title:"Columns",options:{collapsed:!1,bulkEditor:!0},items:{type:"object",title:"column",options:{collapsed:!0},properties:p}},GridHighlightRules:{type:"array",format:"object",title:"Grid Highlight Rules",options:{hidden:!1,collapsed:!1},items:{type:"object",title:"Rule",options:{collapsed:!0},properties:c}},Style:{type:"object",title:"Style",options:{collapsed:!0},properties:{Theme:{type:"string",title:"Theme",options:{hidden:!0},enum:["Light","Dark"]},DashboardTheme:{options:{hidden:!0}},statusBar:{type:"handlebar",title:"Status Bar",propertyOrder:3,data:["series","values"],default:""},chartTooltip:{type:"handlebar",title:"Chart Tooltip",propertyOrder:4,data:["series","values"],default:""},bookTooltip:{type:"handlebar",title:"Book Tooltip",propertyOrder:5,data:["series","values"],default:""},advanced:{type:"css",title:"Advanced CSS",default:""},EvenRowBackgroundColorOverride:{type:"gradient",options:{noColor:!1,gradient:!1},default:"#282828",title:"Even Row Background"},OddRowBackgroundColorOverride:{type:"gradient",options:{noColor:!1,gradient:!1},default:"#303030",title:"Odd Row Background"},SelectedRowBackgroundColor:{type:"gradient",options:{noColor:!0,gradient:!1},default:"",title:"Selected Row Background"},RowHeight:{type:"number",format:"number",title:"Row Height",default:30},HeaderRowHeight:{type:"number",format:"number",title:"Header Row Height",default:30},HeaderTextTransformation:{title:"Header Text Transformation",type:"string",enum:["uppercase","lowercase","capitalize","none"]},HeaderFontWeight:{title:"Header Font Weight",type:"string",enum:["","normal","bold"],default:""},FontFamily:{title:"Font Family",type:"string",enum:["","monospace","fantasy"],default:""},FontSize:{title:"Font Size",type:"string",default:""},ShowChartGridLines:{default:!1,format:"checkbox",title:"Display Chart Gridlines",type:"boolean"}}}}}}};if(0<_.keys(e.settingsModel.attributes).length)for(var i=_.find(f.upgrades,{version:e.settingsModel.get("version")}),o=void 0===i?1:f.upgrades.indexOf(i)+1;o<f.upgrades.length;o+=1){var s=f.upgrades[o];s.fn(e.settingsModel),e.settingsModel.set("version",s.version)}return t},f.defaults=function(){return f.getComponentDefinition({settingsModel:new o.Model}).appArgs.json},f.PRICE_COL_TEMPLATE="{{#eq (lowercase orderType) 'peg'}}{{#has (lowercase pegInstruction) 'floating.close'}}MOC{{else}}{{#has (lowercase pegInstruction) 'floating.midprice'}}MKT{{else}}{{#eq pegOffsetValue null}}MKT{{else}}{{#if pegOffsetValue}}{{#eq (round pegOffsetValue) 0}}{{#lt pegOffsetValue 0}}MKT{{toPrecision (toFloat pegOffsetValue) 1}}{{else}}MKT{{/lt}}{{else}}MKT+{{toPrecision (toFloat pegOffsetValue) 1}}{{/eq}}{{else}}MKT{{/if}}{{/eq}}{{/has}}{{/has}}{{else}}{{#if price}}{{price}}{{else}}MKT{{/if}}{{/eq}}",f.TOOLTIP_TEMPLATE='<table><tbody>{{#if buy}}    <tr><td colspan="2"><i class="fa fa-square" style="color:{{buy.color}}"></i>&nbsp;&nbsp;Buy</td></tr>    <tr><td>Price</td><td>{{buy.price}}</td></tr>    <tr><td>Qty</td><td>{{buy.leavesQty}}</td></tr>    <tr><td>Order&nbsp;ID</td><td>{{buy.orderID}}</td></tr>    <tr><td>Status</td><td>{{buy.subType}}</td></tr>{{/if}}{{#if sell}}    <tr><td colspan="2"><i class="fa fa-square" style="color:{{sell.color}}"></i>&nbsp;&nbsp;Sell</td></tr>    <tr><td>Price</td><td>{{sell.price}}</td></tr>    <tr><td>Qty</td><td>{{sell.leavesQty}}</td></tr>    <tr><td>Order&nbsp;ID</td><td>{{sell.orderID}}</td></tr>    <tr><td>Status</td><td>{{sell.subType}}</td></tr>{{/if}}</tbody></table>',f.TOOLTIP_BOOK_TEMPLATE='<div style="padding:10px; background: #f0f0f0; color: #101010; font-size:11px; border:1px solid #c0c0c0; border-radius: 2px;">    {{#each this}}        {{#eq @key "thisValue"}}            <b>{{../thisField}}</b> : {{this}}<br>{{/eq}}{{/each}}</div>',f.upgrades=[{version:"4.0.1s2",fn:function(e){var t=e.get("ColumnsConfiguration"),o=/\{\{toFixed (\S+) (\d+)\}\}/;e.set("Basics.ShowBuySell",!0),e.set("Basics.ShowExports",!0),e.set("Basics.Filtering","disabled"),e.unset("Basics.OrdersTarget"),e.unset("Basics.TradesTarget"),e.set("Basics.ShowLastBookTradesPublic",!1),_.each(t,function(e){for(var t,i;i=o.exec(e.Template);)e.Template=e.Template.replace(i[0],"{{"+i[1]+"}}"),void 0===t&&(t=parseInt(i[2],10),e.Format="Number",e.Precision=t)})}},{version:"4.0.2p1",fn:function(e){'<table><tbody>{{#if buy}}    <tr><td colspan="2"><i class="fa fa-square" style="color:green" />&nbsp;&nbsp;Buy</td></tr>    <tr><td>Price</td><td>{{buy.price}}</td></tr>    <tr><td>Qty</td><td>{{buy.leavesQty}}</td></tr>    <tr><td>Order&nbsp;ID</td><td>{{buy.orderID}}</td></tr>    <tr><td>Status</td><td>{{buy.subType}}</td></tr>{{/if}}{{#if sell}}    <tr><td colspan="2"><i class="fa fa-square" style="color:red" />&nbsp;&nbsp;Sell</td></tr>    <tr><td>Price</td><td>{{sell.price}}</td></tr>    <tr><td>Qty</td><td>{{sell.leavesQty}}</td></tr>    <tr><td>Order&nbsp;ID</td><td>{{sell.orderID}}</td></tr>    <tr><td>Status</td><td>{{sell.subType}}</td></tr>{{/if}}</table>'===e.get("Style").chartTooltip&&e.set("Style.chartTooltip",f.TOOLTIP_TEMPLATE);var t=e.get("Basics");t.ShowTradesBookPublic=t.ShowLastBookTradesPublic||!1,t.ShowTradesBookInternal=!1,t.ShowLastBookTrades=!0,e.unset("Basics.ShowLastBookTradesPublic")}},{version:"4.1.0s1a",fn:function(e){e.set("Style.EvenRowBackgroundColorOverride","#282828"),e.set("Style.OddRowBackgroundColorOverride","#303030"),e.set("Style.SelectedRowBackgroundColor",""),e.set("Style.RowHeight",30),e.set("Style.HeaderTextTransformation","none"),e.set("Style.HeaderFontWeight",""),e.set("Style.FontFamily",""),e.set("Style.FontSize","")}},{version:"4.1.1.s1e",fn:function(e){var t=e.get("Basics"),i=e.get("Style");t.ActiveTab=void 0===t.ActiveTab?2:t.ActiveTab,i.HeaderRowHeight=void 0===i.HeaderRowHeight?30:i.HeaderRowHeight,e.set("Style",i),t.MaxPriceLevels||(t.MaxPriceLevels=99999999),t.hasOwnProperty("EndTime")&&(delete t.EndTime,delete t.StartTime)}},{version:"4.2.0.a",fn:function(e){var t=e.get("Basics");t.hasOwnProperty("BuysAboveSell")||(t.BuysAboveSell=!1),void 0===t.OpenInBook&&(t.OpenInBook=!1),e.set("Basics",t)}},{version:"4.3.0.2",fn:function(e){var t=e.get("Basics");void 0===t.YaxisMax&&(t.YaxisMax="data"),void 0===t.ShowZeroPrice&&(t.ShowZeroPrice=!1),e.set("Basics",t),e.unset("Basics.ShowZeroPrice")}},{version:"4.6.0",fn:function(i){var e=i.get("Style"),t=i.get("HighlightRules");void 0===e.bookTooltip&&(e.bookTooltip=f.TOOLTIP_BOOK_TEMPLATE),i.set("Style",e),t.length&&_.each(t,function(e,t){"Fill Left-to-Right"!==e.ConditionOperator&&"Fill Right-to-Left"!==e.ConditionOperator||i.set("HighlightRules."+t+".ConditionOperator","")}),i.set("Basics.SortPriority","")}},{version:"4.6.1",fn:function(e){var t={},i=(_.each(e.get("ColumnsConfiguration"),function(e){e.HighlightChanges&&(t[e.Field]=!0,e.HighlightChanges=!1)}),e.get("GridHighlightRules"));_.each(u,function(e){t[e.Target]&&i.push(_.cloneDeep(e))})}},{version:"4.6.1p1",fn:function(e){_.each(e.get("GridHighlightRules"),function(e){e.Icon||(e.Icon="")})}},{version:"4.6.1p2",fn:function(e){e.set("Basics.OrderEventsOut",""),e.set("Basics.DistanceToPreload",40)}},{fn:function(e){var t=e.get("Style");t.ShowChartGridLines=!_.isNil(t.ShowChartGridLines)&&t.ShowChartGridLines,e.set("Style",t),e.get("Basics.ShowLastBookTrades")?e.set("Basics.ShowLastBookTrades","last trade"):e.set("Basics.ShowLastBookTrades","none")},version:"4.7.0"}],f);function f(){}y.eventTimeComparison=function(e,t){return e.time.i>t.time.i?1:e.time.i<t.time.i?-1:e.time.n>t.time.n?1:e.time.n<t.time.n?-1:0},y.timeComparison=function(e,t){return e.i>t.i?1:e.i<t.i?-1:e.n>t.n?1:e.n<t.n?-1:0},y.prototype.applyEvent=function(e){var t=this.findSelectedIndex(e?e.idx:void 0);return S.Log.Info("found idx:"+(e?e.idx:void 0)+" @"+t),this.applyEventIndex(t)},y.prototype.updateEventsData=function(e){var t=this;_.each(e,function(e){null!==e.time&&(void 0===t.minEventTime||y.timeComparison(e.time,t.minEventTime)<0)&&(t.minEventTime=e.time),null!==e.time&&(void 0===t.maxEventTime||0<y.timeComparison(e.time,t.maxEventTime))&&(t.maxEventTime=e.time)}),S.Log.Info("events x"+e.length+" "+S.Tools.convertKDBTemporalToMoment(this.minEventTime).formatNano()+"->"+S.Tools.convertKDBTemporalToMoment(this.maxEventTime).formatNano()+")"),this.eventsData=e,this.selectedIndex=S.Tools.binarySearch(-1,this.eventsData,function(e){return e.idx},7)},y.prototype.addToDictArray=function(e,t,i){var o=e[t];_.isArray(o)?o.push(i):e[t]=[i]},y.prototype.checkBaseData=function(){for(var e=0;e<this.baseData.length;e++)_.isEqual(this.baseData[e],this.baseCopy[e])},y.prototype.applySingleEvent=function(e,t,i){if(e&&"order"===e.eventType)switch(e.subType){case"partiallyFilled":case"filled":this.updateLastTrade(e);case"new":case"cancelled":case"doneForDay":case"expired":case"stopped":case"suspended":case"replaced":case"restated":this.eventApply(e);break;case"pendingNew":case"pendingReplace":case"pendingCancel":case"rejected":break;default:this.addToDictArray(t,i+e.subType+" unknown order type",e)}},y.prototype.revertSingleEvent=function(e,t,i){if("order"===e.eventType)switch(e.subType){case"partiallyFilled":case"filled":case"new":case"cancelled":case"doneForDay":case"expired":case"stopped":case"suspended":case"replaced":case"restated":this.eventRevert(e);break;case"pendingNew":case"pendingReplace":case"pendingCancel":case"rejected":break;default:this.addToDictArray(t,i+e.subType+" unknown order type",e)}},y.prototype.applyEventIndex=function(e){var t=this.selectedIndex+"->"+e+" ",i={};if(S.Log.Info(t),e>this.selectedIndex){for(var o=this.selectedIndex+1;o<=e;o++)this.applySingleEvent(this.eventsData[o],i,t);this.selectedIndex=e}else{for(o=this.selectedIndex;e<o;o--)this.revertSingleEvent(this.eventsData[o],i,t);this.selectedIndex=e,this.revertLastTrades()}return this.updateError("Validation",i),this.bookDict},y.prototype.eventApply=function(t){var i;this.isBlank(t.orderID)||(i=void 0===(i=this.bookDict[t.orderID])?{orderID:t.orderID}:_.cloneDeep(this.bookDict[t.orderID]),_.each(this.applyAttributes,function(e){i[e]=t[e]}),this.bookDict[t.orderID]=i)},y.prototype.isBlank=function(e){return null==e||""===e},y.prototype.eventRevert=function(i){var o,s=this;this.isBlank(i.orderID)||(void 0===(o=this.bookDict[i.orderID])?(o={orderID:i.orderID},_.each(this.applyAttributes,function(e){o[e]=i[e]})):o=_.cloneDeep(this.bookDict[i.orderID]),_.each(this.revertAttributesSrc,function(e,t){o[s.revertAttributesDst[t]]=i[e]}),this.bookDict[i.orderID]=o)},y.prototype.revertLastTrades=function(){var e,t;for(this.lastTrade=this.lastTradeAsk=this.lastTradeBid=void 0,e=this.selectedIndex;0<=e&&e<this.eventsData.length&&("partiallyFilled"!==(t=this.eventsData[e]).subType&&"filled"!==t.subType||!this.setLastTrades(t));e--);this.lastTrade&&this.lastTradeAsk&&this.lastTradeBid||!this.bookLastAsk||!this.bookLastBid||(this.setLastTrades(0<y.eventTimeComparison(this.bookLastAsk,this.bookLastBid)?this.bookLastAsk:this.bookLastBid),this.setLastTrades(this.bookLastAsk),this.setLastTrades(this.bookLastBid))},y.prototype.setLastTrades=function(e){return this.lastTrade||(this.lastTrade=e),"S"===e.side?this.lastTradeAsk=this.lastTradeAsk||e:this.lastTradeBid=this.lastTradeBid||e,!!this.lastTrade&&!!this.lastTradeAsk&&!!this.lastTradeBid},y.prototype.updateLastTrade=function(e){"S"===(this.lastTrade=e).side?this.lastTradeAsk=e:this.lastTradeBid=e},y.prototype.updateError=function(e,i){_.extend(i,this.baseErrorObjs);var t=_.sortBy(_.keys(i),function(e){return-i[e].length});0<t.length?(console.error("ERROR: Order Book "+e),_.each(t,function(e){var t=i[e];console.error(t.length+":"+e,t)}),this.updateErrorFn("Order Book Calc",{error:e+"<p>"+_.map(t,function(e){return"x "+i[e].length+": "+e}).join("<br/>"),type:"Warning"})):this.updateErrorFn("Order Book Calc",void 0)},y.prototype.findSelectedIndex=function(e){return S.Tools.binarySearch(e,this.eventsData,function(e){return e.idx},7)},y.PREV_RX=/^prev_(.+)$/,y.NO_APPLY={idx:!0,_rowIndex:!0,eventType:!0,orderID:!0};var m=y;function y(e,t,i,o){var s=this,o=(this.baseMin=Number.MAX_VALUE,this.baseMax=Number.MIN_VALUE,this.applyAttributes=[],this.revertAttributesSrc=[],this.revertAttributesDst=[],this.baseErrorObjs={},this.eventsData=[],this.selectedIndex=-1,t&&0<t.length&&_.each(_.keys(t[0]),function(e){var t=y.PREV_RX.exec(e);t&&2===t.length?(s.revertAttributesSrc.push(t[0]),s.revertAttributesDst.push(t[1])):y.NO_APPLY[e]||s.applyAttributes.push(e)}),this.bookLastAsk=_.find(o||[],function(e){return"S"===e.side}),this.bookLastBid=_.find(o||[],function(e){return"B"===e.side}),this.updateErrorFn=i,this.baseData=e,this.bookDict=_.keyBy(_.map(e,function(e){return e.price<s.baseMin&&(s.baseMin=e.price),(void 0===s.minBookTime||y.timeComparison(e.time,s.minBookTime)<0)&&(s.minBookTime=e.time),(void 0===s.maxBookTime||0<y.timeComparison(e.time,s.maxBookTime))&&(s.maxBookTime=e.time),e.price>s.baseMax&&(s.baseMax=e.price),e}),"orderID"),this.updateEventsData(t),S.Log.Info("base x"+this.baseData.length+" "+S.Tools.convertKDBTemporalToMoment(this.minBookTime).formatNano()+"->"+S.Tools.convertKDBTemporalToMoment(this.maxBookTime).formatNano()+")"),_.keys(this.baseErrorObjs).length?S.Log.Error("OBR: base errors: "+_.keys(this.baseErrorObjs).length):S.Log.Info("A_OK"),this.baseCopy=this.baseData.map(function(e){return _.clone(e)}),this.revertLastTrades(),{});!_.isEmpty(this.bookDict)&&_.some(this.bookDict,function(e){return!(!e||!e.leavesQty)})||this.addToDictArray(o,"Empty Order Book: "+_.values(this.bookDict).length+" orders with 0 qty.",[]),this.updateError("Validation",o)}b=S.CustomEvents,e(v,b),v.prototype.checkPreloadStatus=function(e){var t,i=this.getEventsData();this.isActive&&this.isPlaying&&null!==e&&null!=i&&i.length&&(t=Number(e),i=i.length,e=this.getEventDataIdx(e),0!==t&&0<=e&&0<i&&(e<this.distanceToPreload||i-e<this.distanceToPreload)&&(i=this.getTargetBlockOffsetToLoad(t),e=!1,!(0<t||t<0)||this.loadedBlocks[i]||this.isLoading||(e=!0,this.blockOffsetToLoad=i),e&&this.preloadEvents()))},v.prototype.getMergedPreloadedData=function(e){var t=Number(e),i=this.getEventsData(),o=i.length,e=this.getEventDataIdx(e),s=Math.min(60,this.distanceToPreload);if(this.isActive&&0<=e&&0<o&&(e<s||o-e<s)){if(this.isLoading)return null;s=e<o-e,o=this.getBlockOffset(t)+(s?-1:1),e=void 0;if(!this.mergedBlocks[o]&&this.loadedBlocks[o]&&(s?(e=this.loadedBlocks[o].concat(_.take(i,this.blockSize)),this.mergedBlocks[o+2]=!1):(e=_.takeRight(i,this.blockSize).concat(this.loadedBlocks[o]),this.mergedBlocks[o-2]=!1)),e)return this.mergedBlocks[o]=!0,e=_.map(e,function(e){return _.clone(e)}),_.each(e,function(e){return delete e._rowIndex}),e}return null},v.prototype.isUltimatelyFirst=function(e){return!!this.isActive&&(e=Number(e),e=this.getTargetBlockOffsetToLoad(e),!(!this.loadedBlocks[e]||0!==this.loadedBlocks[e].length))},v.prototype.isUltimatelyLast=function(e){return!!this.isActive&&(e=Number(e),e=this.getTargetBlockOffsetToLoad(e),!(!this.loadedBlocks[e]||0!==this.loadedBlocks[e].length))},v.prototype.reset=function(){this.loadedBlocks={},this.mergedBlocks={},this.blockOffset=0,this.isLoading=!1},v.prototype.getBlockOffset=function(e){return Math.round(e/this.blockSize)},v.prototype.getTargetBlockOffsetToLoad=function(e){return Math.round((Math.abs(e)+this.blockSize/2)/this.blockSize)*Math.sign(e)},v.prototype.onDataPreloadedEvents=function(){for(var e=this,t=[],i=0;i<arguments.length;i++)t[i]=arguments[i];console.log("OBR: events loaded",t),this.isLoading&&(this.loadedBlocks[this.blockOffsetToLoad]=t[1].reset,this.isLoading=!1),_.defer(function(){e.api.unsubscribe(e.preloadedEventsModel),e.trigger("eventsLoaded",e.blockOffsetToLoad)})},v.prototype.onPropChangeDistance=function(e,t){this.distanceToPreload=Math.abs(Number(t))},v.prototype.preloadEvents=function(){var e,t=this.getEventsModel();t&&(this.loadedBlocks[0]=this.loadedBlocks[0]||this.getEventsData(),_.has(this.mergedBlocks,"0")||(this.mergedBlocks[0]=!0),this.preloadedEventsModel=t.clone(),t=_.clone(this.preloadedEventsModel.get("_queryParams")),e=_.findIndex(t,{name:"block"}),this.blockSize=Number(_.get(_.find(t,{name:"blocksize"}),"value"))||1500,void 0!==e?(t[e]=_.defaults({isViewState:!1,value:""+this.blockOffsetToLoad},t[e]),this.preloadedEventsModel.set("_queryParams",t,{silent:!0}),this.preloadedEventsModel.path+=_.uniqueId("Preloaded_"),console.log("OBR: loading block: "+this.blockOffsetToLoad),this.isLoading=!0,this.api.subscribe(this.preloadedEventsModel,this.onDataPreloadedEvents.bind(this))):S.Log.Error("block / blocksize parameter missing in Events query"))},v.PROP_DISTANCE_TO_PRELOAD="Basics.DistanceToPreload";var b,N=v;function v(e,t,i,o,s){var r=b.call(this)||this;return r.isActive=!1,r.loadedBlocks={},r.mergedBlocks={},r.isPlaying=!0,r.distanceToPreload=60,r.blockOffset=0,r.blockSize=1500,r.blockOffsetToLoad=null,r.isLoading=!1,r.viewModel=e,r.api=t,r.getEventDataIdx=i,r.getEventsModel=o,r.getEventsData=s,r.listenTo(r.viewModel,"change:"+v.PROP_DISTANCE_TO_PRELOAD,r.onPropChangeDistance.bind(r)),r}C=o.View,e(M,C),M.createHorizontalAccordion=function(e){var t=e.leftView,i=e.rightView,o={weight:1,isExpanded:!0,isResizeable:!0,hideHeader:!0},e=new M({el:e.el,split:"Vertical",sections:[_.extend({$el:t.$el},o),_.extend({$el:i.$el},o)]});return t.$el.css({right:"auto",display:"inline-block"}),i.$el.css({left:"auto",display:"inline-block"}),e.listenTo(e,"sectionResized",function(){t&&t.onResize(),i&&i.onResize()}),e},M.prototype.remove=function(){return this.debouncedRemoveAnimate.cancel(),_.each(this.sections,function(e){var t,i;e.resizeable&&null!=(i=(t=e.$el).resizeable)&&i.call(t,"instance")&&e.$el.resizable("destroy")}),this},M.prototype.resize=function(){this.isVertical()?_.some(this.sections,function(e){return e.isExpanded})&&(this.expandedSpan=this.$el.height()):this.expandedSpan=this.$el.width(),this.updateLayout(!1)},M.prototype.adjustWeights=function(e,i){var o=this.sum(_.map(e,function(e){return e.weight})),s=this.sum(i);_.each(e,function(e,t){e.weight=o*(i[t]/s)})},M.prototype.isVertical=function(){return this.hasHorizontalSplit},M.prototype.onSectionResize=function(e,t,i){for(var o,s,r=0,n=this.isVertical()?e.$el.height():e.$el.width(),a=n-(this.isVertical()?i.originalSize.height:i.originalSize.width),l=[e],d=[n],h=this.sections.indexOf(e)+1;h<this.sections.length&&(!(o=this.sections[h]).isExpanded||(s=Math.max(this.HEADING_SPAN,o.startSpan-(a-r)),r+=Math.min(o.startSpan-this.HEADING_SPAN,a-r),this.isVertical()?o.$el.height(s+"px"):o.$el.width(s+"px"),l.push(o),d.push(s),r!==a));h+=1);this.adjustWeights(l,d),this.trigger("sectionResized",l,d)},M.prototype.sum=function(e){return _.reduce(e,function(e,t){return e+t},0)},M.prototype.updateLayout=function(e){var o=this,e=(this.$el.toggleClass("animate",e),_.filter(this.sections,function(e){return e.isExpanded})),t=_.filter(this.sections,function(e){return!e.hideHeader}),s=(e.length?this.expandedSpan:t.length*this.HEADING_SPAN)-t.length*this.HEADING_SPAN,t=this.sum(_.map(e,function(e){return e.weight||0})),r=s/t,n=this;_.each(this.sections,function(e,t){var i=(e.isExpanded?e.weight*r:0)+(e.hideHeader?0:o.HEADING_SPAN)+"px";e.$el.toggleClass("expanded",e.isExpanded),e.$el.toggleClass("noHeader",e.hideHeader),o.isVertical()?e.$el.css({height:i,width:""}):e.$el.css({height:"",width:i}),e.isResizeable&&e.isExpanded&&t<o.sections.length-1&&_.some(o.sections.slice(t+1),function(e){return e.isExpanded})?e.resizeable=e.$el.resizable({minHeight:4,minWidth:2,handles:n.isVertical()?"s":"e",resize:n.onSectionResize.bind(n,e),start:function(){_.each(n.sections,function(e){e.startSpan=n.isVertical()?e.$el.height():e.$el.width()}),n.isVertical()?(e.$el.resizable("option","maxHeight",s),e.$el.resizable("option","maxWidth",null)):(e.$el.resizable("option","maxHeight",null),e.$el.resizable("option","maxWidth",s))},stop:function(){n.updateLayout(!1)}}).on("resize",function(e){e.stopPropagation()}):e.resizeable&&(e.$el.resizable("destroy"),delete e.resizeable)}),this.debouncedRemoveAnimate()};var C,G=M;function M(e){var t=C.call(this,e)||this;return t.HEADING_SPAN=0,t.hasHorizontalSplit="Vertical"!==e.split,t.expandedSpan=t.isVertical()?t.$el.height():t.$el.width(),t.sections=e.sections||[],t.debouncedRemoveAnimate=_.debounce(function(){t.$el.removeClass("animate"),t.trigger("layoutUpdated")},300),t.updateLayout(!1),t}D=o.View,e(k,D),k.prototype.onSettingsModelChange=function(e,t){t=t&&t[0]&&t[0].Target?t[0].Target:"";""!==t&&this.options.viewModel.set("Basics.ClickedOrderID",t)},k.prototype.updateActionTarget=function(e){this.selectedObjectRouting["Selection.Actions"][0].Target=e},k.prototype.updateStyles=function(e){this.setProperty({Style:e})},k.prototype.setTooltipTemplate=function(e){this.tooltipTemplate=e,this.buyGrid.onSettingsChange({"Tooltip.Template":this.tooltipTemplate}),this.sellGrid.onSettingsChange({"Tooltip.Template":this.tooltipTemplate})},k.prototype.setColumns=function(e){this.buyGrid.onSettingsChange({ColumnsConfiguration:_.cloneDeep(this.addPriceUIColumn(e))}),this.sellGrid.onSettingsChange({ColumnsConfiguration:_.cloneDeep(this.addPriceUIColumn(e)).reverse()})},k.prototype.setHighlightRules=function(e){this.setProperty({HighlightRules:e})},k.prototype.setShowBuySell=function(e){this.$el.find(".title")[e?"show":"hide"]()},k.prototype.setShowExports=function(e){this.setProperty({"FileExport.ShowExportCsvButton":e,"FileExport.ShowExportExcelButton":e})},k.prototype.setFiltering=function(e){this.setProperty({"Basics.Filtering":e})},k.prototype.setTheme=function(){this.buyGrid.setTheme(),this.sellGrid.setTheme()},k.prototype.onResize=function(){this.accordion.resize(),this.buyGrid.onResize(),this.sellGrid.onResize()},k.prototype.remove=function(){return this.buyGrid.remove(),this.sellGrid.remove(),this.accordion.remove(),o.View.prototype.remove.call(this)},k.prototype.orderCompare=function(e,t,i){var o=w.ORDER_MAP[e.substring(0,4)],s=w.ORDER_MAP[t.substring(0,4)];return o?s?0:-1:s?1:w.fixedDecimalStringCompare(e,t)*i},k.prototype.addPriceUIColumn=function(e){e=_.clone(e);return e.push({UserDefined:!1,Field:"priceUI",DisplayName:"priceUI",Sortable:!0,Format:"General",Precision:5,HideTrailingZeroes:!1,Currency:"none",DateFormat:"YYYY-MM-DD",TimeFormat:"HH:mm:ss",HighlightNegativeColor:"",HighlightChanges:!1,HighlightChangeDuration:200,ShowArrowsOnChange:!1,HighlightMinValueColor:"",HighlightMaxValueColor:"",RangeHighlightColor:"",WidthWeight:1,MinWidthAbsolute:70,PercentageColorOverride:"#93DF93",IsReadonly:!1,TextAlign:"center",Template:"",Hidden:!0}),e},k.prototype.addSortOrderGlyph=function(e){this.$el.find((e===this.buyGrid?".buy":".sell")+" .slick-header .slick-header-column.price .slick-sort-indicator").addClass("slick-sort-indicator-"+(e===this.buyGrid?"desc":"asc"))},k.prototype.setProperty=function(e){this.sellSettingsModel.set(e),this.sellGrid.onSettingsChange(e),this.buySettingsModel.set(e),this.buyGrid.onSettingsChange(e)};var D,z=k;function k(e){var o=D.call(this,e)||this,i=_.uniqueId("bookView"),t=(o.options=e,o.$el.html(l.book()),o.api=e.api,o.tooltipTemplate=e.tooltipTemplate,o.addPriceUIColumn(e.columns));return o.buySettingsModel=w.generateDatagridSettingsModel(e.dashboardViewModel),o.buySettingsModel.set({Basics:{Data:e.buyModel,Filtering:e.filtering},Selection:{Mode:"Area",RowSelectionColumn:"orderID",SelectedValue:e.selectedOrderID},ColumnsConfiguration:_.cloneDeep(t),HighlightRules:e.highlightRules||[],Style:e.style,Tooltip:{Position:"cursor",Template:o.tooltipTemplate}}),o.sellSettingsModel=w.generateDatagridSettingsModel(e.dashboardViewModel),o.sellSettingsModel.set({Basics:{Data:e.sellModel,Filtering:e.filtering},Selection:{Mode:"Area",RowSelectionColumn:"orderID",SelectedValue:e.selectedOrderID},ColumnsConfiguration:_.cloneDeep(t).reverse(),HighlightRules:e.highlightRules||[],Style:e.style,Tooltip:{Position:"cursor",Template:o.tooltipTemplate}}),o.buyGrid=new r({orderBookMode:!0,viewModel:new S.DocumentViewModel({},{},void 0),settingsModel:o.buySettingsModel,sortColumns:[{sortCol:"priceUI",sortAsc:!1},{sortCol:o.options.sortPriority,sortAsc:!0}],sortFunctions:[o.orderCompare.bind(o)],el:o.$el.find(".buy")[0],deltaClient:null,dashboardViewModel:e.dashboardViewModel,api:{doActions:function(e,i){_.each(e,function(e,t){"map"===e._Type&&o.buyGrid.api.setProperty((i||"Actions")+"."+t+".Target",e.Current)})},getProperty:function(e){return o.buySettingsModel.get(e)},getPropertyMeta:function(e){return o.buySettingsModel.get(e)},setProperty:function(e,t){var i={};o.buySettingsModel.set(e,t),i[e]=t,o.buyGrid&&o.buyGrid.onSettingsChange(i)},showQueryStatus:function(){return _.noop()},hideQueryStatus:function(){return _.noop()},subscribe:function(e,t){e.subscribe(i+"buy",{key:i+"buy",onData:t,source:e})},unsubscribe:function(e){return e.unsubscribe(i+"buy")},loadSetting:function(){return _.noop()},saveSetting:function(){return _.noop()},setTooltip:function(e){return o.api.setTooltip(e)},removeTooltip:function(){o.api.removeTooltip()}}}),o.sellGrid=new r({orderBookMode:!0,viewModel:new S.DocumentViewModel({},{},void 0),settingsModel:o.sellSettingsModel,sortColumns:[{sortCol:"priceUI",sortAsc:!0},{sortCol:o.options.sortPriority,sortAsc:!0}],sortFunctions:[o.orderCompare.bind(o)],el:o.$el.find(".sell")[0],deltaClient:null,dashboardViewModel:e.dashboardViewModel,api:{doActions:function(e,i){_.each(e,function(e,t){"map"===e._Type&&o.buyGrid.api.setProperty((i||"Actions")+"."+t+".Target",e.Current)})},getProperty:function(e){return o.sellSettingsModel.get(e)},getPropertyMeta:function(e){return o.sellSettingsModel.get(e)},setProperty:function(e,t){var i={};o.sellSettingsModel.set(e,t),i[e]=t,o.sellGrid&&o.sellGrid.onSettingsChange(i)},showQueryStatus:function(){return _.noop()},hideQueryStatus:function(){return _.noop()},subscribe:function(e,t){e.subscribe(i+"sell",{key:i+"sell",onData:t,source:e})},unsubscribe:function(e){return e.unsubscribe(i+"sell")},loadSetting:function(){return _.noop()},saveSetting:function(){return _.noop()},setTooltip:function(e){return o.api.setTooltip(e)},removeTooltip:function(){o.api.removeTooltip()}}}),o.accordion=G.createHorizontalAccordion({el:o.$el[0],leftView:o.buyGrid,rightView:o.sellGrid}),o.listenToOnce(o.buyGrid,"data-processed",function(){return o.addSortOrderGlyph(o.buyGrid)}),o.listenToOnce(o.sellGrid,"data-processed",function(){return o.addSortOrderGlyph(o.sellGrid)}),o.buyGrid.onSettingsChange(o.buySettingsModel.toFlat()),o.sellGrid.onSettingsChange(o.sellSettingsModel.toFlat()),o.buyGrid.$el.find(".title").text("BUY").css({color:"#00FF00",padding:"8px"}),o.sellGrid.$el.find(".title").text("SELL").css({color:"#FF0000",padding:"8px"}),o.setShowBuySell(e.showBuySell),o.setShowExports(e.showExports),o.selectedObjectRouting={"Selection.Actions":[{_Type:"map",TriggerColumn:"*",Trigger:"Double Click",Current:"orderID",Target:e.clickedID}]},o.sellGrid.onSettingsChange(o.selectedObjectRouting),o.buyGrid.onSettingsChange(o.selectedObjectRouting),o.sellSettingsModel.set(o.selectedObjectRouting),o.buySettingsModel.set(o.selectedObjectRouting),o.listenTo(o.sellSettingsModel,"change:Selection.Actions",o.onSettingsModelChange.bind(o)),o.listenTo(o.buySettingsModel,"change:Selection.Actions",o.onSettingsModelChange.bind(o)),o}B.isMatch=function(e,t){var i=!1;return _.isString(e)||(e=null!=e&&e.toString?e.toString():""),!_.isString(t)&&t.toString&&(t=t.toString()),e=e.split(/ +and +| +/),_.includes(e,"or")&&(e=_.without(e,"or"),i=!0),_[i?"some":"every"](e,function(e){return B.isSimpleMatch(e,t)})},B.isSimpleMatch=function(e,t){var i=!1,e=(0===e.indexOf("-")&&(e=e.replace("-",""),i=!0),new RegExp("^"+e.replace(/\*/g,".*")+"$").test(t));return i?!e:e};var U=B;function B(){}O.getConditionResult=function(e,t,i){var o,s,r=!1;if(O.OPERATORS_FOR_CONVERTION[i]&&(o=(""+e).toLowerCase(),s=(""+t).toLowerCase()),""!==s)switch(i){case"contains":r=0<=o.indexOf(s);break;case"starts with":r=0===o.indexOf(s);break;case"ends with":r=-1!==o.indexOf(s,o.length-s.length);break;case"==":r=e==t;break;case"<":r=e<t;break;case">":r=t<e;break;case"<=":r=e<=t;break;case">=":r=t<=e;break;case"!=":r=e!=t;break;case"search":r=U.isMatch(s,o);break;default:S.Log.Error("GRID: highlight rule with unknown operator: ",i)}return r},O.OPERATORS_FOR_CONVERTION=_.reduce(["contains","starts with","ends with","search"],function(e,t){return e[t]=!0,e},{});var Q=O;function O(){}P.prototype.add=function(e){var t=S.Tools.binarySearch2(e,this.orders,P.cmpInv);this.orders.splice(0<=t?t+1:-t-1,0,e)},P.cmp=S.Tools.getComparator(S.ipc.TypeNum.Timestamp,function(e){return e}),P.cmpInv=function(e,t){return P.cmp(t.orderTime||t.time,e.orderTime||e.time)};var Y=P;function P(e,t,i){this.price=e,this.quantity=t,this.orders=i}var K=function(e,t,i,o,s,r,n,a,l,d,h){this.orders=e,this.minPrice=t,this.maxPrice=i,this.pipSize=o,this.showTradesBookPublic=s,this.showTradesBookInternal=r,this.showLastBookTrades=n,this.selected=a,this.lastTrade=l,this.lastTradeAsk=d,this.lastTradeBid=h},X=(Object.defineProperty(j.prototype,"range",{get:function(){return this.maxPrice-this.minPrice},enumerable:!1,configurable:!0}),j);function j(e,t,i,o,s,r,n){this.priceDict=e,this.scaleX=t,this.maxQty=i,this.xBarOffset=o,this.closestX=s,this.minPrice=r,this.maxPrice=n}Object.defineProperty(x.prototype,"x",{get:function(){return this.event.pageX},enumerable:!1,configurable:!0}),Object.defineProperty(x.prototype,"y",{get:function(){return this.event.pageX},enumerable:!1,configurable:!0});var W=x;function x(e,t,i){this.event=e,this.canvasX=t,this.canvasY=i}var I,q=function(e,t,i,o){this.order=e,this._x=t,this._y=i,this._h=o},Z=(I=o.View,e(E,I),E.getScale=function(){return window.devicePixelRatio||1},E.prototype.isTabActive=function(e){return!1===e&&this.removeTooltip(),this.isActive===e},E.prototype.onResize=function(){this.width=Math.max(this.el.offsetWidth-this.margin.left-this.margin.right,0),this.height=Math.max(this.el.offsetHeight-this.margin.top-this.margin.bottom,0),this.graph.selectAll("g.x.axis").attr("transform","translate(0,"+this.height+")"),this.svg.attr("width",this.width+this.margin.left+this.margin.right).attr("height",this.height+this.margin.top+this.margin.bottom),this.canvas.width=Math.round(this.width*window.devicePixelRatio),this.canvas.height=Math.round(this.height*window.devicePixelRatio),this.canvas.style.width=this.width+"px",this.canvas.style.height=this.height+"px",this.yAxis=T.svg.axis().scale(this.y).orient("left").ticks(Math.min(Math.ceil(this.height/26),10),"s"),this.y.range([this.height,0]),this.yInv.range([0,this.height]),this.x.range([0,this.width])},E.prototype.render=function(){return this.renderQueued||(this.renderQueued=!0,window.requestAnimationFrame(this.renderInternal.bind(this))),this},E.prototype.remove=function(){return this.$lockY.off(),this.$lockX.off(),this.$zoomIn.off(),this.$zoomOut.off(),this.$reset.off(),$(this.canvas).off(),this.el.onmousemove=null,o.View.prototype.remove.apply(this)},E.prototype.resetView=function(){this.mid=void 0,this.range=void 0,this.transformX=0,this.lastTransformX=0},E.prototype.setHighlightRules=function(e){this.highlightRules=e},E.prototype.setTooltipTemplate=function(e){this.tooltipTemplate=e},E.prototype.setTheme=function(e){e!==this.lastTheme&&(this.lastTheme=e,this.render())},E.prototype.setRenderState=function(e){this.state=e,this.renderInternal()},E.prototype.initializeEvents=function(){var o=this;this.$lockY.on("click",function(){var e=o.$lockY.find(".fa-lock").length;o.yLock=!e,o.$lockY.button({icons:{primary:"fa fa-"+(o.yLock?"lock":"unlock")}})}),this.$lockX.on("click",function(){var e;o.postRenderState&&(e=o.$lockX.find(".fa-lock").length,o.xLock=!e,o.$lockX.button({icons:{primary:"fa fa-"+(o.xLock?"lock":"unlock")}}))}),this.$zoomIn.on("click",function(){o.range&&(o.range*=E.ZOOM_RATIO,o.render())}),this.$zoomOut.on("click",function(){o.range&&(o.range*=1/E.ZOOM_RATIO,o.render())}),this.$reset.on("click",function(){var e=o.xLock;o.xLock=!1,o.resetView(),o.render(),o.xLock=e}),this.el.onmousemove=this.onMouseMove.bind(this),this.canvas.addEventListener("mousedown",function(e){S.Log.Info("mousedown",e),o.removeTooltip(),o.canvas.style.cursor="grabbing",o.mousedown=e}),this.canvas.addEventListener("mouseup",function(e){S.Log.Info("mouseup",e),o.canvas.style.cursor="",o.lastTransformX+=o.transformX,o.transformX=0,o.mousedown=void 0}),this.$el.on("dblclick",function(e){!o.postRenderState||(e=_.first(o.pickOrderFromXY(e,o.postRenderState)))&&(o.viewModel.get("Basics.OpenInBook")?(o.api.setProperty("Basics.ActiveTab",1),o.viewModel.set("FocusOrder",e)):o.api.setProperty("Basics.ClickedOrderID",e.orderID))}),$(this.canvas).on("mousewheel DOMMouseScroll",function(e){var t,i;o.move&&o.postRenderState&&o.range&&(i=((t=Math.round(o.width*o.postRenderState.scaleX))/2-o.move.canvasX)/t*o.postRenderState.range*(1-E.ZOOM_RATIO),0<o.move.canvasX&&o.move.canvasX<t&&0<o.move.canvasY&&o.move.canvasY<o.height&&o.isActive&&e.target&&(e.originalEvent.wheelDelta<0||e.originalEvent.detail<0||0<e.originalEvent.deltaY?(o.lastTransformX=o.lastTransformX-i,o.range*=1/E.ZOOM_RATIO):(o.lastTransformX=o.lastTransformX+i,o.range*=E.ZOOM_RATIO),o.render(),e.preventDefault()))})},E.prototype.calculateTickValues=function(e,t,i,o,s){for(var e=Math.ceil(e/o)*o,r=[],s=s/60,n=Math.ceil(i/o/s),a=(2<n&&n<5?n=5:5<n&&(i/((n=Math.pow(10,Math.ceil(w.log10(n))))*o)<s/5?n/=5:i/(n*o)<s/2&&(n/=2)),o*n),l=e;l<t;l+=a)r.push(l);return r},E.prototype.pickOrderFromXY=function(e,t){var i=E.getScale(),o=this.height*i,e=w.getOffsets(e),s=e.x*i,r=o-e.y*i,n=[];return _.each(this.orderSets,function(e){n=n.concat(e.filter(function(e){return e&&0<e._h&&e._x<=s&&s<e._x+t.closestX&&e._y<=r&&r<e._y+e._h}))}),n.map(function(e){return e.order})},E.prototype.onTooltip=function(){if(this.move&&this.postRenderState){var e,t,i=this.pickOrderFromXY(this.move.event,this.postRenderState);if(1===i.length)"B"===i[0].side?e=i[0]:t=i[0];else if(!i.length)return void this.removeTooltip();(e||t)&&(e&&((e=_.cloneDeep(e)).price=parseFloat(e.price.toFixed(15)),e.color=this.highlightOrder(e)),t&&((t=_.cloneDeep(t)).price=parseFloat(t.price.toFixed(15)),t.color=this.highlightOrder(t)),this.subscriptionKey&&this.api.unsubscribeTemplateViewStates(this.subscriptionKey));var o=Math.round(this.move.canvasX/this.postRenderState.scaleX),s=Math.round(this.move.canvasY/this.postRenderState.scaleX),r=this.el.getElementsByTagName("canvas")[0],i={text:1<i.length?"Hovering over "+i.length+" orders.":this.api.getProperty("Style.chartTooltip"),data:{buy:e,sell:t},position:{top:s,left:o},anchorEl:r};this.tooltip=this.api.setTooltip(i)}},E.prototype.onMouseMove=function(e){var t,i=$(this.canvas).offset();i&&this.postRenderState&&(t=Math.round((e.pageX-i.left)*this.postRenderState.scaleX),i=Math.round(e.pageY-i.top),this.move&&t===this.move.canvasX&&i===this.move.canvasY||(this.move=new W(e,t,i),e=Math.round(this.width*this.postRenderState.scaleX),t<0||e<t||i<0||i>this.height?this.deboucedOnTooltip.cancel():this.mousedown?(i=this.mousedown.offsetX*this.postRenderState.scaleX,this.transformX=(t-i)/e*this.postRenderState.range,S.Log.Info("xOffset:"+this.transformX),this.removeTooltip(),this.render()):this.deboucedOnTooltip()))},E.prototype.highlightOrder=function(s){var r=null,n=this.viewModel.get("Basics.PipSize")?this.viewModel.get("Basics.PipSize"):ee.DEFAULT_PIPSIZE,a=w.decimalPlaces(n);return _.each(this.highlightRules,function(e){var t=e.ConditionSource,i=e.ConditionOperator,o=e.ConditionValue,t="price"!==t?s[t]:(Math.round(s[t]/n)*n).toFixed(a);Q.getConditionResult(t,o,i)&&(r=e.Color)}),r||E.DEFAULT_COLOR},E.prototype.transformView=function(e){var t,i,o,s,r;return e.lastTradeAsk&&e.lastTradeBid&&e.lastTradeAsk.latestTrade&&e.lastTradeBid.latestTrade?(o=(e.lastTradeAsk.latestTrade+e.lastTradeBid.latestTrade)/2,t=Math.min(e.minPrice,e.lastTradeAsk.latestTrade,e.lastTradeBid.latestTrade),i=Math.max(e.maxPrice,e.lastTradeAsk.latestTrade,e.lastTradeBid.latestTrade),(o<e.minPrice||i<o)&&(o=Math.min(e.minPrice,e.lastTradeAsk.latestTrade,e.lastTradeBid.latestTrade)+(i-t)/2)):i=e.lastTrade&&e.lastTrade.latestTrade?(o=e.lastTrade.latestTrade,t=Math.min(e.minPrice,e.lastTrade.latestTrade),Math.max(e.maxPrice,e.lastTrade.latestTrade)):(o=(e.minPrice+e.maxPrice)/2,t=e.minPrice,e.maxPrice),this.xLock&&void 0!==this.mid?o=this.mid:this.mid=o,void 0===this.range&&((s=i-t)<E.RANGE_MIN?this.range=E.RANGE_MIN:(r=(this.api.getProperty("Basics.MaxPriceLevels")||E.DEFAULT_MAXPRICELVL)*e.pipSize,this.range=r<s?r:s)),(this.lastTransformX||this.transformX)&&(i<(r=o-(this.lastTransformX+this.transformX))?(this.transformX-=i-r,r=i):r<t&&(this.transformX+=r-t,r=t),o=r),[o-this.range/2-e.pipSize/2,o+this.range/2+e.pipSize/2]},E.prototype.renderInternal=function(){var e,s,r,t,i,o,n,a,l,d,h,c,u,p,g,f,m,y,b=this,v=(this.renderQueued=!1,this.state);void 0!==v&&(e=performance?performance.now():0,s=E.getScale(),r=w.decimalPlaces(v.pipSize),d=0,i={dashLines:"#fff",overLay:"rgba(255,255,255,"+(t=.75)+")"},o=this.canvas.width/this.canvas.getBoundingClientRect().width,[v.showLastBookTrades,v.showTradesBookInternal,v.showTradesBookPublic].forEach(function(e){e&&.25<t&&(t-=.25)}),"Light"===this.lastTheme&&(i.dashLines="#808080",i.overLay="rgba(128,128,128,"+(t+.1)+")"),n={},_.each(v.orders,function(e){var t,i,o;e&&e.leavesQty&&(t=_.isNil(e.price)?"":e.price.toFixed(r),i=n[t],o=parseFloat(e.leavesQty),d=i?(i.quantity+=o,i.add(e),Math.max(i.quantity,d)):(n[t]=new Y(t,o,[e]),Math.max(o,d)))}),f=this.transformView(v),a=f[0],l=f[1],this.yLock&&this.postRenderState&&(d=this.postRenderState.maxQty),this.x.domain([a,l]),f=this.calculateTickValues(a,l,l-a,v.pipSize,this.width),"view"!==this.api.getProperty("Basics.YaxisMax")||this.yLock||(y=_.filter(n,function(e,t){t=parseFloat(t);return a<=t&&t<=l}),y=_.map(y,function(e){return _.sumBy(e.orders,"leavesQty")}),d=_.max(y)||d),this.xAxis=T.svg.axis().scale(this.x).orient("bottom").tickValues(f).tickFormat(T.format(",."+r+"f")),y=this.api.getProperty("Style.ShowChartGridLines"),this.xAxis.tickSize(y?-this.height:6,0),this.yAxis.tickSize(y?-this.width:6,0),this.y.domain([0,d]),this.yInv.domain([0,d]),(h=Math.round(this.width*o)/((l-a)/v.pipSize))<=1?(h=1,c=0):(c=Math.floor(h/2),h=2*c-1),(u=this.canvas.getContext("2d"))?(u.clearRect(0,0,this.canvas.width,this.canvas.height),this.orderSets={},this.layoutOrders(c,n,this.orderSets,null==(f=v.selected)?void 0:f.orderID),_.forEach(this.orderSets,function(e,t){u.fillStyle="#10c710"===t?"rgba(0,255,0,0.4)":t;for(var i=e.length-1;0<=i;i--){var o=e[i];o._h<=0||u.fillRect(o._x,b.height*s-(o._y+o._h),h,o._h)}}),"current daily high/low"===v.showLastBookTrades?(y=_.get(v,"selected.currentDailyTradeLow"),f=_.get(v,"selected.currentDailyTradeHigh"),m=_.get(v,"selected.latestTrade"),u.fillStyle=i.dashLines,y&&(g=Math.round(this.x(y)*s)),(p=f?Math.round(this.x(f)*s):p)&&g&&(u.fillStyle="rgba(0,0,0,0.3)",g=Math.round(this.x(y)*s),u.fillRect(p,0,g-p,this.height*s)),m&&(u.font="12px Arial",f=Math.round(this.x(m)*s),y=""+m,u.fillStyle="#000000",m=u.measureText(y).width,u.fillRect(f-m/2,0,m,15),u.fillStyle="#ffffff",u.fillText(y,f-m/2,12),u.fillStyle="#ffff00",this.drawVDash(u,f,0,1,this.height*s,4,4))):(v.showTradesBookPublic&&v.selected&&(u.fillStyle=i.dashLines,v.selected.latestNbboAsk&&(g=Math.round(this.x(v.selected.latestNbboAsk)*s),this.drawVDash(u,g,0,1,this.height*s,4,4)),v.selected.latestNbboBid&&(p=Math.round(this.x(v.selected.latestNbboBid)*s),this.drawVDash(u,p,0,1,this.height*s,4,4)),v.selected.latestNbboAsk&&p&&g&&(u.fillStyle=i.overLay,g=Math.round(this.x(v.selected.latestNbboAsk)*s),u.fillRect(p,0,g-p,this.height*s))),v.showTradesBookInternal&&v.selected&&(u.fillStyle=i.dashLines,v.selected.latestIbboAsk&&(g=Math.round(this.x(v.selected.latestIbboAsk)*s),this.drawVDash(u,g,0,1,this.height*s,6,4)),v.selected.latestIbboBid&&(p=Math.round(this.x(v.selected.latestIbboBid)*s),this.drawVDash(u,p,0,1,this.height*s,6,4)),v.selected.latestIbboAsk&&p&&g&&(u.fillStyle=i.overLay,g=Math.round(this.x(v.selected.latestIbboAsk)*s),u.fillRect(p,0,g-p,this.height*s))),"last trade"===v.showLastBookTrades&&(u.fillStyle=i.dashLines,v.lastTradeAsk&&v.lastTradeAsk!==v.lastTrade&&v.lastTradeAsk.latestTrade&&(p=Math.round(this.x(v.lastTradeAsk.latestTrade)*s),this.drawVDash(u,p,0,1,this.height*s,2,4)),v.lastTradeBid&&v.lastTradeBid!==v.lastTrade&&v.lastTradeBid.latestTrade&&(p=Math.round(this.x(v.lastTradeBid.latestTrade)*s),this.drawVDash(u,p,0,1,this.height*s,2,4)),v.lastTrade&&v.lastTrade.latestTrade&&(g=Math.round(this.x(v.lastTrade.latestTrade)*s),this.drawVDash(u,g,0,1,this.height*s,4,4)),v.lastTrade&&v.lastTrade.latestTrade&&p&&g&&(u.fillStyle=i.overLay,g=Math.round(this.x(v.lastTrade.latestTrade)*s),u.fillRect(p,0,g-p,this.height*s)))),this.graph.select(".x.axis").call(this.xAxis),this.graph.select(".y.axis").call(this.yAxis),performance&&performance.now&&(y=performance.now(),S.Log.Info("Render: "+(y-e)+" ms")),this.postRenderState=new X(n,o,d,c,h,a,l)):S.Log.Error("OrderBook: Context Not Initialized"))},E.prototype.drawVDash=function(e,t,i,o,s,r,n){for(var a=r+n,l=Math.round(s/a),d=0;d<l;d++)e.fillRect(t,i,o,r),i+=a;i<s&&e.fillRect(t,i,o,Math.min(r,s-i))},E.prototype.layoutOrders=function(n,e,a,l){var d=this,h=E.getScale(),c=this.api.getProperty("Basics.SortPriority"),u=!!this.api.getProperty("Basics.BuysAboveSell"),p=this.api.getProperty("Style.SelectedRowBackgroundColor")||"rgb(58,159,199)";_.each(e,function(e){var t=Math.round(d.x(Number(e.price))*h)-n,i=0;e.orders=d.sortPriceDictItem(e.orders,u,c);for(var o=0;o<e.orders.length;o++){var s=e.orders[o],r=new q(s,t,d.yInv(i)*h,2<(r=d.yInv(Number(s.leavesQty))*h)?r-.5:r),s=(i+=Number(s.leavesQty),l===s.orderID?p:d.highlightOrder(s));a[s]?a[s].push(r):a[s]=[r]}})},E.prototype.sortPriceDictItem=function(e,t,i){var o;return t?(o=0<e.length&&e[0][i]&&e[0][i].i?function(e,t){return S.Tools.convertKDBTemporalToMoment(t[i]).valueOf()-S.Tools.convertKDBTemporalToMoment(e[i]).valueOf()}:function(e,t){return t[i]-e[i]},e.sort(function(e,t){return e.side.localeCompare(t.side)||o(e,t)}).reverse()):e.sort(function(e,t){return t[i]-e[i]}).reverse()},E.prototype.removeTooltip=function(){this.tooltip&&(this.deboucedOnTooltip.cancel(),this.api.removeTooltip(),delete this.tooltip)},E.DEFAULT_COLOR="#666",E.ZOOM_RATIO=.95,E.RANGE_MIN=1e-5,E.DEFAULT_MAXPRICELVL=9,E);function E(e){var t=I.call(this,e)||this;return t.margin={top:20,right:20,bottom:30,left:60},t.transformX=0,t.subscriptionKey="",t.isActive=!0,t.renderQueued=!1,t.xLock=!1,t.yLock=!1,t.lastTransformX=0,t.orderSets={},t.$el.addClass("chart-div"),t.$el.html(l.chart({})),t.tooltipTemplate=e.tooltipTemplate,t.highlightRules=e.highlightRules,t.api=e.api,t.viewModel=e.viewModel,t.lastTheme=e.lastTheme,t.width=t.el.offsetWidth-t.margin.left-t.margin.right,t.height=t.el.offsetHeight-t.margin.top-t.margin.bottom,t.svg=T.select(t.$el.find("> svg")[0]).attr("width",t.width+t.margin.left+t.margin.right).attr("height",t.height+t.margin.top+t.margin.bottom),t.canvas=t.el.querySelector("canvas"),t.canvas.style.position="absolute",t.canvas.style.top=t.margin.top+"px",t.canvas.style.left=t.margin.left+"px",t.canvas.width=t.width,t.canvas.height=t.height,t.graph=t.svg.append("g").attr("transform","translate("+t.margin.left+","+t.margin.top+")"),t.y=T.scale.linear().range([t.height,0]),t.yInv=T.scale.linear().range([0,t.height]),t.x=T.scale.linear().range([0,t.width]),t.graph.append("g").attr("class","x axis").attr("transform","translate(0,"+t.height+")"),t.graph.append("g").attr("class","y axis").append("text").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").style("text-anchor","end"),t.yAxis=T.svg.axis().scale(t.y).orient("left").ticks(10,"s"),t.$zoomIn=t.$el.find("> .zoomIn"),t.$zoomOut=t.$el.find("> .zoomOut"),t.$reset=t.$el.find("> .reset"),t.$lockY=t.$el.find("> .lockY"),t.$lockX=t.$el.find("> .lockX"),t.$lockY.button({icons:{primary:"fa fa-unlock"}}),t.$lockX.button({icons:{primary:"fa fa-unlock"}}),t.$zoomIn.button({icons:{primary:"fa fa-search-plus"},text:!1}),t.$zoomOut.button({icons:{primary:"fa fa-search-minus"},text:!1}),t.$reset.button({icons:{primary:"fa fa-history"},text:!1}),t.deboucedOnTooltip=_.debounce(t.onTooltip.bind(t),20),t.initializeEvents(),t}R=o.View,e(A,R),A.prototype.onSettingsModelChange=function(e,t){t=t&&t[0]&&t[0].Target?t[0].Target:"";""!==t&&this.api.setProperty("Basics.ClickedOrderID",t)},A.prototype.onFocusOrder=function(t){for(var e,i=("S"===t.side?this.sellGrid:this.buyGrid).grid,o=0;o<i.getData().getGroups().length;o++)i.getData().getGroups()[o].rows.filter(function(e){return e.orderID===t.orderID}).length&&(e=o);var s=i.getData().getGroups()[e].groupingKey;i.getData().collapseAllGroups(),i.getData().expandGroup(s),i.scrollRowToTop(e),i.getData().refresh()},A.prototype.onResize=function(){this.accordion.resize(),this.buyGrid.onResize(),this.sellGrid.onResize()},A.prototype.remove=function(){return this.buyGrid.remove(),this.sellGrid.remove(),this.accordion.remove(),o.View.prototype.remove.call(this)},A.prototype.updateStyles=function(e){this.setProperty({Style:e})},A.prototype.updateActionTarget=function(e){this.selectedObjectRouting["Selection.Actions"][0].Target=e},A.prototype.setColumns=function(e){this.buyGrid.onSettingsChange({ColumnsConfiguration:_.cloneDeep(this.addPriceUIColumn(e))}),this.sellGrid.onSettingsChange({ColumnsConfiguration:_.cloneDeep(this.addPriceUIColumn(e)).reverse()})},A.prototype.setHighlightRules=function(e){this.setProperty({HighlightRules:e}),this.setQuantityChangeColors()},A.prototype.setShowBuySell=function(e){this.$el.find(".title")[e?"show":"hide"]()},A.prototype.setShowExports=function(e){this.setProperty({"FileExport.ShowExportCsvButton":e,"FileExport.ShowExportExcelButton":e})},A.prototype.setFiltering=function(e){this.setProperty({"Basics.Filtering":e})},A.prototype.setPreviousStateMap=function(e,o){this.priceDictPrevious=_.reduce(e,function(e,t){var i;return t&&0<t.leavesQty&&(e[i=t.side+":"+(o?o(t):t.price)]?e[i]+=t.leavesQty:e[i]=t.leavesQty),e},{}),this.unsubscribeGridUIChangeEvent()},A.prototype.setTheme=function(){this.buyGrid.setTheme(),this.sellGrid.setTheme()},A.prototype.addPriceUIColumn=function(e){e=_.clone(e);return e.push({UserDefined:!1,Field:"priceUI",DisplayName:"priceUI",Sortable:!1,Format:"General",Precision:5,HideTrailingZeroes:!1,Currency:"none",DateFormat:"YYYY-MM-DD",TimeFormat:"HH:mm:ss",HighlightNegativeColor:"",HighlightChanges:!0,HighlightChangeDuration:200,ShowArrowsOnChange:!1,HighlightMinValueColor:"",HighlightMaxValueColor:"",RangeHighlightColor:"",WidthWeight:1,MinWidthAbsolute:70,PercentageColorOverride:"#93DF93",IsReadonly:!1,TextAlign:"center",Template:"",Hidden:!0}),e},A.prototype.getHighlightColor=function(e){return _.get(_.find(this.buySettingsModel.get("HighlightRules"),{ConditionSource:"change_leavesQty",ConditionValue:e}),"BackgroundColor","UP"===e?"green":"red")},A.prototype.highlightGroupChanges=function(e){for(var t,i,o,s=e===this.buyGrid?"B:":"S:",r=e.grid,n=r.getViewport(),a=n.top;a<=n.bottom;a++)r.getDataItem(a)instanceof Slick.NonDataRow&&((t=r.getCellNode(a,0))&&(i=s+(t.textContent||"").split(" ")[0],i=this.priceDictPrevious[i]||0,o=Number(t.querySelector(".lblGroupSummary>b").textContent.replace(/,/g,"")),t.querySelector(".lblGroupSummary").style.backgroundColor=Number.isNaN(o)||o===i?"":i<o?this.upColor:this.downColor))},A.prototype.setProperty=function(e){this.sellSettingsModel.set(e),this.sellGrid.onSettingsChange(e),this.buySettingsModel.set(e),this.buyGrid.onSettingsChange(e)},A.prototype.setQuantityChangeColors=function(){this.upColor=this.getHighlightColor("UP"),this.downColor=this.getHighlightColor("DOWN")},A.prototype.subscribeGridUIChangeEvent=function(e){e===this.buyGrid?(this.buyGrid.grid.onScroll.subscribe(this.onGridUIChangeBuyDebounced),this.buyGrid.grid.getData().onRowCountChanged.subscribe(this.onGridUIChangeBuyDebounced)):(this.sellGrid.grid.onScroll.subscribe(this.onGridUIChangeSellDebounced),this.sellGrid.grid.getData().onRowCountChanged.subscribe(this.onGridUIChangeSellDebounced))},A.prototype.unsubscribeGridUIChangeEvent=function(){var e;this.onGridUIChangeBuyDebounced.cancel(),this.onGridUIChangeSellDebounced.cancel(),null!=(e=this.buyGrid.grid)&&e.onScroll.unsubscribe(this.onGridUIChangeBuyDebounced),null!=(e=this.buyGrid.grid)&&e.getData().onRowCountChanged.unsubscribe(this.onGridUIChangeBuyDebounced),null!=(e=this.sellGrid.grid)&&e.onScroll.unsubscribe(this.onGridUIChangeSellDebounced),null!=(e=this.sellGrid.grid)&&e.getData().onRowCountChanged.unsubscribe(this.onGridUIChangeSellDebounced)};var R,J=A;function A(e){var o=R.call(this,e)||this,i=(o.priceDictPrevious={},o.DEBOUNCE_INTERVAL=50,o.upColor="",o.downColor="",_.uniqueId("depthView")),t=(o.api=e.api,o.$el.html(l.depth()),{GroupingConfiguration:[{ColumnProperty:"priceUI"}],SummaryRow_Groupings:[{Column:"leavesQty",Function:"SUM",Label:" ",Color:""}]}),s=o.addPriceUIColumn(e.columns);return o.buySettingsModel=w.generateDatagridSettingsModel(e.dashboardViewModel),o.buySettingsModel.set(_.extend({Basics:{Data:e.buyModel,Filtering:e.filtering,GroupingAutoCollapse:!0},Selection:{Mode:"Area",RowSelectionColumn:"orderID",SelectedValue:e.selectedOrderID},Style:e.style,ColumnsConfiguration:_.cloneDeep(s),HighlightRules:e.highlightRules||[]},t)),o.sellSettingsModel=w.generateDatagridSettingsModel(e.dashboardViewModel),o.sellSettingsModel.set(_.extend({Basics:{Data:e.sellModel,Filtering:e.filtering,GroupingAutoCollapse:!0},Selection:{Mode:"Area",RowSelectionColumn:"orderID",SelectedValue:e.selectedOrderID},Style:e.style,ColumnsConfiguration:_.cloneDeep(s).reverse(),HighlightRules:e.highlightRules||[]},t)),o.buyGrid=new r({orderBookMode:!0,viewModel:new S.DocumentViewModel({},{},void 0),settingsModel:o.buySettingsModel,sortColumns:[{sortCol:"price",sortAsc:!1},{sortCol:e.sortPriority,sortAsc:!0}],groupingsOrder:[function(e,t){var e=e.groupingKey,t=t.groupingKey,i=w.ORDER_MAP[e.substring(0,4)],o=w.ORDER_MAP[t.substring(0,4)];return i?o?0:-1:o?1:-w.fixedDecimalStringCompare(e,t)}],el:o.$el.find(".buyBook")[0],deltaClient:null,dashboardViewModel:e.dashboardViewModel,api:{doActions:function(e,i){_.each(e,function(e,t){"map"===e._Type&&o.buyGrid.api.setProperty((i||"Actions")+"."+t+".Target",e.Current)})},getProperty:function(e){return o.buySettingsModel.get(e)},getPropertyMeta:function(e){return o.buySettingsModel.get(e)},setProperty:function(e,t){var i={};o.buySettingsModel.set(e,t),i[e]=t,o.buyGrid&&o.buyGrid.onSettingsChange(i)},showQueryStatus:function(){return _.noop()},hideQueryStatus:function(){return _.noop()},subscribe:function(e,t){e.subscribe(i+"buy",{key:i+"buy",onData:t,source:e})},unsubscribe:function(e){return e.unsubscribe(i+"buy")},loadSetting:function(){return _.noop()},saveSetting:function(){return _.noop()}}}),o.sellGrid=new r({orderBookMode:!0,viewModel:new S.DocumentViewModel({},{},void 0),settingsModel:o.sellSettingsModel,sortColumns:[{sortCol:"price",sortAsc:!0},{sortCol:e.sortPriority,sortAsc:!0}],groupingsOrder:[function(e,t){var e=e.groupingKey,t=t.groupingKey,i=w.ORDER_MAP[e.substring(0,4)],o=w.ORDER_MAP[t.substring(0,4)];return i?o?0:-1:o?1:w.fixedDecimalStringCompare(e,t)}],el:o.$el.find(".sellBook")[0],deltaClient:null,dashboardViewModel:e.dashboardViewModel,api:{doActions:function(e,i){_.each(e,function(e,t){"map"===e._Type&&o.buyGrid.api.setProperty((i||"Actions")+"."+t+".Target",e.Current)})},getProperty:function(e){return o.sellSettingsModel.get(e)},getPropertyMeta:function(e){return o.sellSettingsModel.get(e)},setProperty:function(e,t){var i={};o.sellSettingsModel.set(e,t),i[e]=t,o.sellGrid&&o.sellGrid.onSettingsChange(i)},showQueryStatus:function(){return _.noop()},hideQueryStatus:function(){return _.noop()},subscribe:function(e,t){e.subscribe(i+"sell",{key:i+"sell",onData:t,source:e})},unsubscribe:function(e){e.unsubscribe(i+"sell")},loadSetting:function(){return _.noop()},saveSetting:function(){return _.noop()}}}),o.accordion=G.createHorizontalAccordion({el:o.$el[0],leftView:o.buyGrid,rightView:o.sellGrid}),o.buyGrid.onSettingsChange(o.buySettingsModel.toFlat()),o.sellGrid.onSettingsChange(o.sellSettingsModel.toFlat()),o.buyGrid.$el.find(".title").text("BUY").css({color:"#00FF00",padding:"8px"}),o.sellGrid.$el.find(".title").text("SELL").css({color:"#FF0000",padding:"8px"}),o.setShowBuySell(e.showBuySell),o.setShowExports(e.showExports),o.selectedObjectRouting={"Selection.Actions":[{_Type:"map",TriggerColumn:"*",Trigger:"Double Click",Current:"orderID",Target:e.clickedID}]},o.sellGrid.onSettingsChange(o.selectedObjectRouting),o.buyGrid.onSettingsChange(o.selectedObjectRouting),o.sellSettingsModel.set(o.selectedObjectRouting),o.buySettingsModel.set(o.selectedObjectRouting),o.listenTo(o.sellSettingsModel,"change:Selection.Actions",o.onSettingsModelChange.bind(o)),o.listenTo(o.buySettingsModel,"change:Selection.Actions",o.onSettingsModelChange.bind(o)),o.setQuantityChangeColors(),o.onGridUIChangeBuyDebounced=_.debounce(function(){o.highlightGroupChanges(o.buyGrid)},o.DEBOUNCE_INTERVAL),o.onGridUIChangeSellDebounced=_.debounce(function(){o.highlightGroupChanges(o.sellGrid)},o.DEBOUNCE_INTERVAL),o.listenTo(o.buyGrid,"data-processed",function(){o.highlightGroupChanges(o.buyGrid),o.subscribeGridUIChangeEvent(o.buyGrid)}),o.listenTo(o.sellGrid,"data-processed",function(){o.highlightGroupChanges(o.sellGrid),o.subscribeGridUIChangeEvent(o.sellGrid)}),o}L=o.View,e(V,L),V.prototype.onResize=function(){switch(this.getActiveTab()){case 0:this.initTabBook(),this.bookView&&this.bookView.onResize(),this.update();break;case 1:this.initTabDepth(),this.depthView&&this.depthView.onResize(),this.update();break;case 2:this.initTabChart(),this.chartView&&this.chartView.onResize(),this.update()}},V.prototype.onSettingsChange=function(t){var i=this;if(S.Log.Info("OBR onSettings:"+JSON.stringify(t),t),["Basics.OrderBook","Basics.LastBookTrades","Basics.ShowTradesBookPublic","Basics.ShowTradesBookInternal","Basics.ShowLastBookTrades","Basics.OrderEvents","Basics.OrderEventsOut",V.PROP_PIPSIZE,"Basics.SortPriority"].forEach(function(e){void 0!==t[e]&&i.viewModel.set(e,t[e])}),void 0!==this.selectOnInit)return console.info("OBR: update skipped pending selectOnInit: "+JSON.stringify(t,null,2)),void(this.settingsQueue=$.extend(!0,this.settingsQueue||{},t));this.settingsQueue=void 0,["Basics.Selected","Basics.SelectedOrderID","Basics.SelectedTime"].forEach(function(e){void 0!==t[e]&&i.viewModel.set(e,t[e])}),_.each(t,function(e,t){i.viewModel.set(t,e)})},V.prototype.remove=function(){return this.removeViews(),this.model&&this.api.unsubscribe(this.model),o.View.prototype.remove.apply(this)},V.prototype.initializeEvents=function(){var i=this;this.listenTo(this.viewModel,"change:Basics.OrderBook",this.onPropDataChange.bind(this)),this.listenTo(this.viewModel,"change:Basics.OrderEvents",this.onPropEventsChange.bind(this)),this.listenTo(this.viewModel,"change:Basics.OrderEventsOut",this.onPropEventsOutChange.bind(this)),this.listenTo(this.viewModel,"change:"+V.PROP_PIPSIZE,this.update.bind(this)),this.listenTo(this.viewModel,"change:Basics.LastBookTrades",this.onPropLastBookTradesChange.bind(this)),this.listenTo(this.viewModel,"change:Basics.ShowTradesBookPublic",this.update.bind(this)),this.listenTo(this.viewModel,"change:Basics.ShowTradesBookInternal",this.update.bind(this)),this.listenTo(this.viewModel,"change:Basics.ShowLastBookTrades",this.update.bind(this)),this.listenTo(this.viewModel,"change:Basics.Selected",this.onPropSelectedChange.bind(this)),this.listenTo(this.viewModel,"change:Basics.SelectedDuplicate",this.onPropSelectedDuplicateChange.bind(this)),this.listenTo(this.viewModel,"change:Basics.SelectedTime",this.onPropSelectedTimeChange.bind(this)),this.listenTo(this.viewModel,"change:Basics.ShowBuySell",this.onShowBuySell.bind(this)),this.listenTo(this.viewModel,"change:Basics.ShowExports",this.onShowExports.bind(this)),this.listenTo(this.viewModel,"change:Basics.Filtering",this.onFiltering.bind(this)),this.listenTo(this.viewModel,"change:Basics.SortPriority",this.onSortPriority.bind(this)),this.listenTo(this.viewModel,"change:Style.ShowChartGridLines",this.onShowGridlines.bind(this)),this.listenTo(this.viewModel,"change:Basics.ActiveTab",this.onActiveTabChanged.bind(this)),this.listenTo(this.viewModel,"change:Basics.MaxPriceLevels",this.onMaxPriceLvlsChanged.bind(this)),this.listenTo(this.viewModel,"change:Basics.BuysAboveSell",this.onBuysAboveSellChanged.bind(this)),this.listenTo(this.viewModel,"change:"+this.PROP_COLUMNS,function(){i.setupPriceUITemplate(),i.onPropColumnsConfigurationChange(),i.processData()}),this.listenTo(this.viewModel,"change:Basics.ClickedOrderID",this.onPropClickedIDChanged.bind(this)),this.listenTo(this.viewModel,"change:Style.Theme",this.onPropThemeChange.bind(this)),this.listenTo(this.dashboardViewModel,"change:DashboardTheme",this.onPropThemeChange.bind(this)),this.listenTo(this.viewModel,"change:Style",this.onStyleChange.bind(this)),this.listenTo(this.viewModel,"change:Style.statusBar",this.onPropStatusBarChange.bind(this)),this.listenTo(this.viewModel,"change:Style.chartTooltip",this.onPropChartTooltipChange.bind(this)),this.listenTo(this.viewModel,"change:Style.bookTooltip",this.onPropBookTooltipChange.bind(this)),this.listenTo(this.viewModel,"change:HighlightRules",this.onHighlightRulesChange.bind(this)),this.listenTo(this.viewModel,"change:GridHighlightRules",this.onGridHighlightRulesChange.bind(this)),this.listenTo(this.viewModel,"change:",function(){}),this.listenTo(this.selectedEventIndex,"change:value",function(e,t){t=i.getEvent(t);t&&"order"===t.eventType&&i.api.setProperty("Basics.SelectedOrderID",t.orderID)}),this.initErrorObj()},V.prototype.checkEvents=function(){},V.prototype.getActiveTab=function(){return this.$el.tabs("option","active")},V.prototype.getChange=function(e,t){return e===t?"NONE":_.isNil(t)||t<e?"UP":"DOWN"},V.prototype.getChangeDecimalString=function(e,t){e=w.fixedDecimalStringCompare(e,t);return 0===e?"NONE":1===e?"UP":"DOWN"},V.prototype.getEvent=function(e){if(this.eventsDataLoaded&&0<this.eventsData.length)return 0<=(e=this.getEventDataIdx(e))?this.eventsData[e]:void 0},V.prototype.getEventDataIdx=function(e){var t=this.columnInfo.get("idx");return S.Tools.binarySearch(e,this.eventsData,function(e){return e.idx},t.get("kdbType"))},V.prototype.getEventsData=function(){return this.eventsData},V.prototype.getEventsModel=function(){return this.eventsModel},V.prototype.setupPriceUITemplate=function(){this.priceUITemplate=void 0,this.priceUIProps=[];var e=_.find(this.viewModel.get(this.PROP_COLUMNS),{Field:"price"}),e=(null==e?void 0:e.Template)||"";e&&(this.priceUIProps=_.union(["leavesQty","price","side"],w.extractProps(e)),this.priceUITemplate=i.compile(e))},V.prototype.getMissingColumns=function(e,t){return _.filter(e,function(e){return void 0===t.get(e)})},V.prototype.getSelected=function(){return this.getEvent(this.selected||0)},V.prototype.getRebasedIndex=function(e){var t,i;if(0<this.eventsData.length)return t=_.first(this.eventsData),i=_.last(this.eventsData),t&&w.convertKDBDatetimeToISOstring(t.time)===e?t[V.EVENTS_PK]:i&&w.convertKDBDatetimeToISOstring(i.time)===e?i[V.EVENTS_PK]:0},V.prototype.getNearestEventByDate=function(e){var t;if(e&&this.eventsData&&e.hasOwnProperty("i")&&e.hasOwnProperty("n")){(t=S.Tools.binarySearch(e,this.eventsData,function(e){return e.time},12))<0&&(t=-t-2,t=Math.max(0,t));for(var i=t+1;i<this.eventsData.length&&0===m.eventTimeComparison(this.eventsData[i],this.eventsData[i-1]);i++)t=i;return this.eventsData[t]}},V.prototype.initData=function(){var e;S.Log.Info(" Base:"+w.val2YN(this.baseDataLoaded)+" Events:"+w.val2YN(!this.eventsModel||this.eventsDataLoaded)+" Last Trades:"+w.val2YN(!this.lastTradesModel||this.lastTradesDataLoaded)),!(this.baseDataLoaded&&this.baseData&&this.eventsData)||this.eventsModel&&!this.eventsDataLoaded||this.lastTradesModel&&!this.lastTradesDataLoaded||(window.gkBook=this.book=new m(this.baseData,this.eventsData,this.updateError.bind(this),this.lastTradesData),this.ordersModel&&this.ordersModel.apply(),this.tradesModel&&this.tradesModel.apply(),this.bookBuyModel.apply(),this.bookSellModel.apply(),void 0!==this.selectOnInit&&(e=this.selectOnInit,this.selectOnInit=void 0,_.isNumber(e)?(this.settingsQueue&&(this.settingsQueue=_.omit(this.settingsQueue,"Basics.Selected")),this.api.setProperty("Basics.Selected",e),this.onPropSelectedChange(this.viewModel,e)):(this.settingsQueue&&(this.settingsQueue=_.omit(this.settingsQueue,"Basics.SelectedTime")),this.api.setProperty("Basics.SelectedTime",e),this.onPropSelectedTimeChange(this.viewModel,e))),this.settingsQueue&&this.onSettingsChange(this.settingsQueue),this.rebased&&(this.rebased=!1,this.selected=this.getRebasedIndex(e),this.api.setProperty("Basics.Selected",this.selected)),this.update())},V.prototype.initErrorObj=function(){var e=this;this.$el.parent().parent().find("> .queryStatus").css({"pointer-events":"none",opacity:0}),this.$el.find(".orderBookErrorObjs").mouseover(function(){e.$el.parent().parent().find("> .queryStatus").stop().css("pointer-events","none").fadeTo(200,1)}).mouseout(function(){e.$el.parent().parent().find("> .queryStatus").stop().fadeTo(200,0)})},V.prototype.initTabBook=function(){var e;this.book&&!this.bookView&&(e=$("<div>"),this.$el.find("#OrderBook-1").append(e),this.bookView=new z({el:e[0],buyModel:this.bookBuyModel,sellModel:this.bookSellModel,sortPriority:this.viewModel.get("Basics.SortPriority"),showBuySell:this.viewModel.get("Basics.ShowBuySell"),showExports:this.viewModel.get("Basics.ShowExports"),filtering:this.viewModel.get("Basics.Filtering"),style:this.viewModel.get("Style"),selectedOrderID:this.selectedOrderID,clickedID:this.viewModel.get("Basics.ClickedOrderID"),viewModel:this.viewModel,dashboardViewModel:this.dashboardViewModel,highlightRules:$.extend(!0,[],this.gridHighlightRules),columns:$.extend(!0,[],this.viewModel.get(this.PROP_COLUMNS)),api:this.api,tooltipTemplate:this.viewModel.get("Style.bookTooltip")}))},V.prototype.initTabDepth=function(){var e;this.book&&!this.depthView&&(e=$("<div>"),this.$el.find("#OrderBook-2").append(e),this.depthView=new J({el:e[0],buyModel:this.bookBuyModel,sellModel:this.bookSellModel,sortPriority:this.viewModel.get("Basics.SortPriority"),showBuySell:this.viewModel.get("Basics.ShowBuySell"),showExports:this.viewModel.get("Basics.ShowExports"),filtering:this.viewModel.get("Basics.Filtering"),style:this.viewModel.get("Style"),selectedOrderID:this.selectedOrderID,clickedID:this.viewModel.get("Basics.ClickedOrderID"),viewModel:this.viewModel,dashboardViewModel:this.dashboardViewModel,highlightRules:$.extend(!0,[],this.gridHighlightRules),columns:$.extend(!0,[],this.viewModel.get(this.PROP_COLUMNS)),api:this.api}))},V.prototype.initTabChart=function(){var t=this;return this.chartView||(this.chartView=new Z({tooltipTemplate:this.chartTooltipTemplate,highlightRules:this.highlightRules,api:this.api,viewModel:this.viewModel,lastTheme:this.lastTheme||"Dark"}),this.listenTo(this.viewModel,"change:FocusOrder",function(e){t.depthView?t.depthView.onFocusOrder(e.get("FocusOrder")):t.focusOrder=e.get("FocusOrder")}),this.$el.find("#OrderBook-3").append(this.chartView.el),this.chartView.onResize()),this.chartView},V.prototype.update=function(){this.updateQueued||(this.updateQueued=!0,window.requestAnimationFrame(this.processData.bind(this)))},V.prototype.onActiveTabChanged=function(){this.$el.tabs({active:this.viewModel.get("Basics.ActiveTab")})},V.prototype.onMaxPriceLvlsChanged=function(){if(this.chartView){this.chartView.resetView();try{this.chartView.render()}catch(e){}}},V.prototype.onBuysAboveSellChanged=function(){try{this.chartView&&this.chartView.render()}catch(e){}},V.prototype.onBaseData=function(e,i,o){o?this.updateError(this.BOOK_NAME,o):(e.columns.reset?this.baseColumnInfo.reset(e.columns.reset):(this.baseColumnInfo.remove(_.map(e.columns.remove,function(e){return e.id})),this.baseColumnInfo.add(e.columns.add),this.baseColumnInfo.add(e.columns.change,{merge:!0})),o=this.getMissingColumns(this.BOOK_COLUMNS,this.baseColumnInfo),this.updateError(this.BOOK_NAME,0<o.length?{error:t('Missing columns: "')+o.join(","),type:"Warning"}:void 0),e=i.items(),this.baseData=e,this.baseDict=_.fromPairs(_.map(e,function(e){return[e[V.ORDER_PK],e]})),this.baseDataSpec=S.DocumentDataModel.convertMetaToDeltaClientColumnSpec(_.map(this.baseColumnInfo.models,function(e){return e.attributes})),this.baseDataLoaded=!0,S.Log.Info("BaseData"),delete this.book,this.initData())},V.prototype.onEventsData=function(i,e,o){o?this.updateError("Order Events",o):(i.columns.reset?this.columnInfo.reset(i.columns.reset):(this.columnInfo.remove(_.map(i.columns.remove,function(e){return e.id})),this.columnInfo.add(i.columns.add),this.columnInfo.add(i.columns.change,{merge:!0})),o=this.getMissingColumns(this.EVENT_COLUMNS,this.columnInfo),this.updateError("Order Events",0<o.length?{error:t('Missing columns: "')+o.join(","),type:"Warning"}:void 0),_.some(["add","remove","reset","change"],function(e){return void 0!==i.columns[e]})&&(this.columnInfo.sort(),o=_.map(this.columnInfo.models,function(e){return e.id}),this.api.setProperty("possibleColumns",o.concat(["change_leavesQty","change_price"]))),this.eventsData=e.items(),this.eventsDataSpec=S.DocumentDataModel.convertMetaToDeltaClientColumnSpec(_.map(this.columnInfo.models,function(e){return e.attributes})),this.eventsDataLoaded=!0,S.Log.Info("EventsData"),delete this.book,this.updateEventsOutModel(this.eventsData),this.initData())},V.prototype.onFiltering=function(e,t){this.depthView&&this.depthView.setFiltering(t),this.bookView&&this.bookView.setFiltering(t)},V.prototype.onGridHighlightRulesChange=function(e,t){this.gridHighlightRules=$.extend(!0,[],t),this.isFillHighlightingOn=!!_.find(this.gridHighlightRules,{ConditionSource:"change_leavesQty",ConditionValue:V.FILL_HIGHLIGHT_VALUE}),this.bookView&&this.bookView.setHighlightRules(this.gridHighlightRules),this.depthView&&this.depthView.setHighlightRules(this.gridHighlightRules)},V.prototype.onHighlightRulesChange=function(e,t){this.highlightRules=$.extend(!0,[],t),this.chartView&&(this.chartView.setHighlightRules(this.highlightRules),this.update())},V.prototype.onLastBookTradesData=function(e,t,i){i?this.updateError("Last Book Trades",i):(this.updateError("Last Book Trades",void 0),e.primaryKey!==this.lastTradesPrimaryKey&&(this.lastTradesPrimaryKey=e.primaryKey,this.lastTradesDict={},this.lastTradesData=[]),this.lastTradesData=t.items(),this.lastTradesDataLoaded=!0,S.Log.Info("LastTrades"),delete this.book,this.initData())},V.prototype.onPropBookTooltipChange=function(e,t){this.bookView&&this.bookView.setTooltipTemplate(t)},V.prototype.onPropChartTooltipChange=function(e,t){this.chartTooltipTemplate=i.compile(t),this.chartView&&this.chartView.setTooltipTemplate(this.chartTooltipTemplate)},V.prototype.onPropClickedIDChanged=function(e,t){this.depthView&&this.depthView.updateActionTarget(t),this.bookView&&this.bookView.updateActionTarget(t),this.api.setProperty("Basics.ClickedOrderID",t)},V.prototype.onPropColumnsConfigurationChange=function(){this.bookView&&this.bookView.setColumns($.extend(!0,[],this.viewModel.get(this.PROP_COLUMNS))),this.depthView&&this.depthView.setColumns($.extend(!0,[],this.viewModel.get(this.PROP_COLUMNS)))},V.prototype.onPropDataChange=function(e,i){this.baseModel&&(this.stopListening(this.baseModel),this.api.unsubscribe(this.baseModel),this.baseModel=void 0),i?(this.baseModel=i,this.baseModel&&this.baseModel.attributes?(this.updateError(this.BOOK_NAME,void 0),this.api.subscribe(this.baseModel,this.onBaseData.bind(this))):this.updateError(this.BOOK_NAME,{error:t('Invalid Data Source: "')+i.path+'" '+t("selected"),type:"Warning"})):this.updateError(this.BOOK_NAME,{error:t("To populate this component, please define a")+" <b> "+t("Data Source")+"</b> "+t("from")+"<b> "+t("Properties")+"-"+t("Basics")+"</b>",type:"Warning"})},V.prototype.onPropEventsChange=function(e,i){this.eventsModel&&(this.stopListening(this.eventsModel),this.api.unsubscribe(this.eventsModel),this.eventsModel=void 0),i?(this.eventsModel=i,this.eventsModel&&this.eventsModel.attributes?(this.updateError(this.EVENTS_NAME,void 0),this.api.subscribe(this.eventsModel,this.onEventsData.bind(this))):this.updateError(this.EVENTS_NAME,{error:t('Invalid Data Source: "')+i.path+'" '+t("selected"),type:"Warning"})):this.updateError(this.EVENTS_NAME,void 0)},V.prototype.onPropEventsOutChange=function(e,t){this.eventsOutModel&&(this.stopListening(this.eventsOutModel),this.api.unsubscribe(this.eventsOutModel),this.eventsOutModel=void 0),t?(this.eventsOutModel=t,this.preloader.isActive=!0,t.stop(),t.set({_dataType:"copy",_subscriptionKey:""}),t.apply()):this.preloader.isActive=!1},V.prototype.onPropLastBookTradesChange=function(e,i){this.lastBookTradesModel&&(this.stopListening(this.lastBookTradesModel),this.api.unsubscribe(this.lastBookTradesModel),this.lastBookTradesModel=void 0),i?(this.lastBookTradesModel=i,this.lastBookTradesModel&&this.lastBookTradesModel.attributes?(this.updateError("Last Book Trades",void 0),this.api.subscribe(this.lastBookTradesModel,this.onLastBookTradesData.bind(this))):this.updateError("Last Book Trades",{error:t('Invalid Data Source: "')+i.path+'" '+t("selected"),type:"Warning"})):this.updateError("Last Book Trades",void 0)},V.prototype.onPropSelectedChange=function(e,t){this.selected=t;var i,t=this.getSelected();this.preloader.checkPreloadStatus(this.selected),t&&(i=w.convertKDBDatetimeToISOstring(t.time),this.viewModel.set("Basics.SelectedTime",i,{silent:!0}),this.api.setProperty("Basics.SelectedTime",i),this.api.setProperty("Basics.SelectedDuplicate",t.idx),this.eventsData&&0<this.eventsData.length&&(t===_.first(this.eventsData)?this.preloader.isActive&&this.preloader.isUltimatelyFirst(this.selected)||this.rebase(i):t!==_.last(this.eventsData)||this.preloader.isActive&&this.preloader.isUltimatelyLast(this.selected)||this.rebase(i),this.mergePreloadedData(t,this.selected))),this.update()},V.prototype.onPropSelectedDuplicateChange=function(e,t){t=this.getEvent(t);t&&this.api.setProperty("Basics.SelectedOrderID","order"===t.eventType?t.orderID:"")},V.prototype.onPropSelectedTimeChange=function(e,t){var i,o;console.log("OBR: onPropSelectedTimeChange",e,t),this.preloader.reset(),this.eventsDataLoaded&&(i=t?S.Tools.convertISODatetimeToKDBLikeObject(t):i)&&(e=S.Tools.convertISODatetimeToKDBLikeObject(t),!(o=this.eventsData&&this.eventsData.length&&0<=w.compareKDBTimes(e,this.eventsData[0].time)&&0<=w.compareKDBTimes(this.eventsData[this.eventsData.length-1].time,e)?this.getNearestEventByDate(e):o)||o===_.first(this.eventsData)||o===_.last(this.eventsData)?this.rebase(t):this.api.setProperty("Basics.Selected",o.idx))},V.prototype.onPropStatusBarChange=function(e,t){i.registerHelper("toFixed",function(e,t){return"number"==typeof e?e.toFixed(t):e}),this.statusBarTemplate=i.compile(t),this.update()},V.prototype.onPropThemeChange=function(e,t){this.lastTheme&&this.$el.removeClass(this.lastTheme),this.dashboardViewModel&&this.dashboardViewModel.get("DashboardTheme")&&(t=this.dashboardViewModel.get("DashboardTheme")),this.$el.addClass(t),this.lastTheme=t,this.bookView&&this.bookView.setTheme(),this.depthView&&this.depthView.setTheme(),this.chartView&&this.chartView.setTheme(t)},V.prototype.onShowGridlines=function(){this.chartView&&this.update()},V.prototype.onSortPriority=function(){this.bookView&&(this.bookView&&this.bookView.remove()&&delete this.bookView,this.depthView&&this.depthView.remove()&&delete this.depthView,this.onResize(),this.update())},V.prototype.onShowBuySell=function(e,t){this.depthView&&this.depthView.setShowBuySell(t),this.bookView&&this.bookView.setShowBuySell(t)},V.prototype.onShowExports=function(e,t){this.depthView&&this.depthView.setShowExports(t),this.bookView&&this.bookView.setShowExports(t)},V.prototype.onStyleChange=function(e,t){this.bookView&&this.bookView.updateStyles(t),this.depthView&&this.depthView.updateStyles(t)},V.prototype.onTabActivate=function(){switch(this.api.setProperty("Basics.ActiveTab",this.getActiveTab()),this.getActiveTab()){case 0:this.initTabBook(),this.chartView&&this.chartView.isTabActive(!1),this.bookView&&this.bookView.onResize();break;case 1:this.initTabDepth(),this.chartView&&this.chartView.isTabActive(!1),this.depthView&&this.depthView.onResize();break;case 2:this.chartView=this.initTabChart(),this.chartView.isTabActive(!0),this.chartView.onResize()}this.update()},V.prototype.processData=function(){var e,t,i,o,s,r,n,a,l=this;this.updateQueued=!1,this.book?(e=this.getSelected(),t=this.getActiveTab(),i=this.viewModel.get(V.PROP_PIPSIZE)?this.viewModel.get(V.PROP_PIPSIZE):V.DEFAULT_PIPSIZE,o=w.decimalPlaces(i),a=e?(a=this.getEventDataIdx(this.selected),t<=1&&1<=a&&(this.book.applyEvent(e),s=this.eventsData[a-1],n=this.book.applyEvent(s),n=_.mapValues(n,function(e){e=_.pick(e,l.priceUIProps);return e.price=w.roundToPipSize(e.price,i,o),e}),this.isFillHighlightingOn&&a+1<this.eventsData.length&&(a=this.eventsData[a+1],a=this.book.applyEvent(a),r=_.reduce(a,function(e,t,i){return!t||0!==t.leavesQty||"fill"!==(t.execType||"").toLowerCase()&&"filled"!==(t.subType||"").toLowerCase()||(e[i]=!0),e},{}),this.book.applyEvent(s))),this.book.applyEvent(e)):this.book.bookDict,2===t?(this.chartView=this.initTabChart(),this.chartView.setTheme(this.lastTheme),this.chartView.setRenderState(new K(a,this.book.baseMin,this.book.baseMax,i,!!this.viewModel.get("Basics.ShowTradesBookPublic"),!!this.viewModel.get("Basics.ShowTradesBookInternal"),this.viewModel.get("Basics.ShowLastBookTrades"),e,this.book.lastTrade,this.book.lastTradeAsk,this.book.lastTradeBid))):0!==t&&1!==t||(0===t?this.initTabBook():this.initTabDepth(),s=_.values(a).filter(function(e){return e&&0<e.leavesQty}),1===t&&this.depthView?(this.depthView.setPreviousStateMap(n,this.priceUITemplate),this.updateBuySellModels(s,i,o,n,r),this.focusOrder&&this.depthView.onFocusOrder(this.focusOrder),this.focusOrder=null):this.updateBuySellModels(s,i,o,n,r)),this.statusBarTemplate&&(this.statusBar.innerHTML=this.statusBarTemplate(e)),this.selectedEventIndex.set("value",this.selected)):S.Log.Info("no book yet")},V.prototype.mergePreloadedData=function(e,t){var i=this,o=this.preloader.getMergedPreloadedData(t);o&&(console.log("OBR: merging data"),_.defer(function(){return i.updateEventsOutModel(o)}))},V.prototype.rebase=function(e){var t=this,i=(console.log("OBR: rebase"),this.api.getPropertyMeta?this.api.getPropertyMeta("Basics.BaseTime"):this.api.getProperty("Basics.BaseTime"));if(e=e||this.viewModel.get("Basics.SelectedTime"),S.Log.Info("rebase:"+e),i&&i.value===e)return S.Log.Info("rebase reduntant"),void S.Log.Info("Selected ID",this.selected);this.preloader.reset(),this.selectOnInit=e,_.delay(function(){t.selectOnInit&&(t.selectOnInit=void 0,S.Log.Warn("OBR: failsafe inacted"))},1e4),this.selectOnInit=e,this.selected=0,delete this.book,this.baseDataLoaded=!1,this.eventsDataLoaded=!1,this.lastTradesDataLoaded=!1,this.removeViews(),this.viewModel.get("Basics.SelectedTime")?(i?S.Log.Info("rebase "+i.value+"->"+e):S.Log.Info("rebase ->"+e),this.api.setProperty("Basics.BaseTime",e),this.rebased=!0):S.Log.Error("ErrorObj no selected time"),this.update()},V.prototype.removeViews=function(){this.bookView&&this.bookView.remove()&&delete this.bookView,this.depthView&&this.depthView.remove()&&delete this.depthView,this.chartView&&this.chartView.remove()&&delete this.chartView},V.prototype.updateBuySellModels=function(e,i,o,s,t){var r=this,e=e.map(function(e){var t=w.roundToPipSize(e.price,i,o);return n(n({},e),{price:t})}),e=(this.baseDataSpec&&(this.baseDataSpec.columns.indexOf("priceUI")<0&&this.baseDataSpec.columns.push("priceUI"),this.baseDataSpec.meta.hasOwnProperty("priceUI")||Object.assign(this.baseDataSpec.meta,{priceUI:11})),s&&_.each(e,function(e){var t=s[e.orderID];t&&(e.change_leavesQty=r.getChange(e.leavesQty,t.leavesQty),e.change_price=r.getChangeDecimalString(e.price,t.price))}),t&&_.each(e,function(e){t[e.orderID]&&(e.change_leavesQty=(e.change_leavesQty||"")+V.FILL_HIGHLIGHT_VALUE)}),e.map(function(e){return n(n({},e),{priceUI:r.priceUITemplate?r.priceUITemplate(e):e.price})}));this.bookSellModel.onExecuteSuccess(_.extend({rows:e.filter(function(e){return"S"===e.side})},this.baseDataSpec),!0),this.bookBuyModel.onExecuteSuccess(_.extend({rows:e.filter(function(e){return"B"===e.side})},this.baseDataSpec),!0)},V.prototype.updateError=function(e,t){t?this.errors[e]=t:delete this.errors[e],_.keys(this.errors).length?(this.$el.find(".orderBookErrorObjs").show(),t=_.map(this.errors,function(e,t){return"["+t+"]: "+e.error}),this.api.showQueryStatus({error:t.join("\n"),type:"ErrorObj"})):(this.$el.find(".orderBookErrorObjs").hide(),this.api.hideQueryStatus())},V.prototype.updateEventsOutModel=function(e){this.eventsOutModel&&(this.eventsOutModel.apply(),this.eventsOutModel.onExecuteBegin(),this.eventsOutModel.onExecuteSuccess(_.defaults({rows:e},this.eventsDataSpec),!0),this.eventsData=e,null!=(e=this.book)&&e.updateEventsData(this.eventsData),this.update())},V.getComponentDefinition=g.getComponentDefinition,V.DEFAULT_PIPSIZE=.01,V.PROP_PIPSIZE="Basics.PipSize",V.ORDER_PK="orderID",V.EVENTS_PK="idx",V.FILL_HIGHLIGHT_VALUE="FILL";var L,ee=V;function V(e){var t=L.call(this,e)||this,i=(t.errors={},t.eventsData=[],t.updateQueued=!1,t.baseData=[],t.baseDataLoaded=!1,t.baseDict={},t.eventsDataLoaded=!1,t.fpsStart=0,t.frameCounter=0,t.gridHighlightRules=[],t.highlightRules=[],t.isFillHighlightingOn=!1,t.lastTradesDataLoaded=!1,t.lastTradesData=[],t.lastTradesDict={},t.priceUIProps=[],t.rebased=!1,t.PROP_COLUMNS="ColumnsConfiguration",t.BOOK_NAME="Order Book",t.EVENTS_NAME="Order Events",t.BOOK_COLUMNS=["orderID","time","side","sym","price","displayQty","totalQty","leavesQty"],t.EVENT_COLUMNS=["orderID","eventType","latestTrade","leavesQty","price","subType","side","time"],{_subscriptionKey:"orderID",_dataType:"copy"});return t.viewModel=new o.DeepModel,t.collection=new o.Collection,t.columnInfo=new o.Collection,t.columnInfo.comparator="index",t.baseColumnInfo=new o.Collection,t.baseColumnInfo.comparator="index",t.api=e.api,t.dashboardViewModel=e.dashboardViewModel,t.selectedEventIndex=new S.DocumentViewModel({_default:void 0,value:void 0},{}),t.bookSellModel=new S.DocumentDataModel(i,null,"",null),t.bookBuyModel=new S.DocumentDataModel(i,null,"",null),t.preloader=new N(t.viewModel,t.api,t.getEventDataIdx.bind(t),t.getEventsModel.bind(t),t.getEventsData.bind(t)),t.$el.addClass("OrderBook"),t.$el.html(l.app()),t.statusBar=t.el.querySelector(".statusBar"),t.$el.tabs({active:2,activate:function(){t.onTabActivate()}}),t.fpsStart=Date.now(),t.initializeEvents(),t.$el.parent().parent().find("> .errorMessage.ui-state-header").css("top","56px"),t}return ee});