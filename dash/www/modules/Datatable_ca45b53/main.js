define(["backbone","Handlebars","moment","QuickBase","xlsx","css!./css/app.css"],function(d,i,m,h,N){var o,I=this&&this.__spreadArrays||function(){for(var e=0,t=0,i=arguments.length;t<i;t++)e+=arguments[t].length;for(var o=Array(e),n=0,t=0;t<i;t++)for(var a=arguments[t],l=0,r=a.length;l<r;l++,n++)o[n]=a[l];return o},y=this&&this.__assign||function(){return(y=Object.assign||function(e){for(var t,i=1,o=arguments.length;i<o;i++)for(var n in t=arguments[i])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}).apply(this,arguments)},e=this&&this.__extends||(o=function(e,t){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)},function(e,t){function i(){this.constructor=e}o(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}),w=(l.focus2Array=function(e){var t,i=[],o=/"([^"]*)"/g,e=e.toString?e.toString():"",n=/^\[([^\]]*)]$/.exec(e);if(null!=n){if(/^(?:"[^"\\]*(?:\\[\S\s][^"\\]*)*")(?:,"[^"\\]*(?:\\[\S\s][^"\\]*)*")*/.test(n[1]))for(;null!==(t=o.exec(n[1]));)i.push(_.map(t[1].split(","),function(e){return e}))}else i.push(e.split(","));return _.filter(i,function(e){return 0<(""+e).length})},l.focus2Object=function(e){return _.reduce(l.focus2Array(e),function(e,t,i){for(var o=t.length,n=e,a=0;a<o;a++){var l=t[a];n[l]||(n[l]={}),n=n[l]}return e},{})},l.getDepth=function(e){function o(e,i){return void 0===i&&(i=[]),_.isEmpty(e)?[i]:_.flatMap(e,function(e,t){return o(e,I(i,[t]))})}return _.reduce(o(e),function(e,t){return e=t.length>e?t.length:e},0)},l.hasCalc=function(){var e=document.createElement("div");return e.style.cssText="width:"+["","-webkit-","-moz-","-o-","-ms-"].join("calc(10px);width:"),!!e.style.length},l.sumArrayValues=function(e){return e.reduce(function(e,t){return e+t},0)},l.getConditionResult=function(e,t,i){var o,n,a=!1;switch(l.OPERATORS_FOR_CONVERTION[i]&&(o=(""+e).toLowerCase(),n=(""+t).toLowerCase()),i){case"contains":a=0<=o.indexOf(n);break;case"starts with":a=0===o.indexOf(n);break;case"ends with":a=-1!==o.indexOf(n,o.length-n.length);break;case"==":a=e==t;break;case"<":a=e<t;break;case">":a=t<e;break;case"<=":a=e<=t;break;case">=":a=t<=e;break;case"!=":a=e!=t;break;default:console.log("GRID: highlight rule with unknown operator: ",i)}return a},l.OPERATORS_FOR_CONVERTION=_.reduce(["contains","starts with","ends with","search"],function(e,t){return e[t]=!0,e},{}),l);function l(){}n.app=i.template({compiler:[8,">= 4.3.0"],main:function(e,t,i,o,n){return'<div class="Datatable">\n    \n    <div class="title">\n    </div>\n\n    <div class="frame">\n    </div>\n\n</div>\n'},useData:!0}),n.columnConfiguration=i.template({compiler:[8,">= 4.3.0"],main:function(e,t,i,o,n){return'<p>\n    Display selected columns\n</p>\n\n<ul class="lstColumns">\n    \n</ul>'},useData:!0}),n.datatable=i.template({1:function(e,t,i,o,n){var a=null!=t?t:e.nullContext||{},l=e.hooks.helperMissing,r=e.escapeExpression,e=e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]};return'<div class="table-tools">\n\t<a class="toggle-drilldown"><i class="fa fa-fw fa-level-down"></i><span>'+r((e(i,"t")||t&&e(t,"t")||l).call(a,"Drilldown",{name:"t",hash:{},data:n,loc:{start:{line:3,column:73},end:{line:3,column:90}}}))+'</span></a>\n\t<a class="toggle-filters"><i class="fa fa-fw fa-filter"></i><span>'+r((e(i,"t")||t&&e(t,"t")||l).call(a,"Show Filters",{name:"t",hash:{},data:n,loc:{start:{line:4,column:67},end:{line:4,column:87}}}))+'</span></a>\n    <a class="reset-filters" style="display:none"><i class="fa fa-fw fa-times"></i><span>'+r((e(i,"t")||t&&e(t,"t")||l).call(a,"Reset Filters",{name:"t",hash:{},data:n,loc:{start:{line:5,column:89},end:{line:5,column:110}}}))+'</span></a>\n    <span class="lnksExport link-disabled">\n        <i class="fa fa-fw fa-download" title="'+r((e(i,"t")||t&&e(t,"t")||l).call(a,"Download",{name:"t",hash:{},data:n,loc:{start:{line:7,column:47},end:{line:7,column:63}}}))+'"></i>\n        <a class="lnkExcelExport" title="'+r((e(i,"t")||t&&e(t,"t")||l).call(a,"Download the current dataset in Excel format",{name:"t",hash:{},data:n,loc:{start:{line:8,column:41},end:{line:8,column:93}}}))+'">'+r((e(i,"t")||t&&e(t,"t")||l).call(a,"Excel",{name:"t",hash:{},data:n,loc:{start:{line:8,column:95},end:{line:8,column:108}}}))+'</a>\n        <a class="lnkCsvExport" title="'+r((e(i,"t")||t&&e(t,"t")||l).call(a,"Download the current dataset in CSV format",{name:"t",hash:{},data:n,loc:{start:{line:9,column:39},end:{line:9,column:89}}}))+'">'+r((e(i,"t")||t&&e(t,"t")||l).call(a,"CSV",{name:"t",hash:{},data:n,loc:{start:{line:9,column:91},end:{line:9,column:102}}}))+'</a>\n        <a class="lnkFullExport" title="'+r((e(i,"t")||t&&e(t,"t")||l).call(a,"Download the full dataset from the server",{name:"t",hash:{},data:n,loc:{start:{line:10,column:40},end:{line:10,column:89}}}))+'">'+r((e(i,"t")||t&&e(t,"t")||l).call(a,"Full",{name:"t",hash:{},data:n,loc:{start:{line:10,column:91},end:{line:10,column:103}}}))+'</a>\n    </span>\n</div>\n<div class="table-header">\n    <div class="table-row"></div>\n</div>\n'},compiler:[8,">= 4.3.0"],main:function(e,t,i,o,n){return(null!=(i=(e.lookupProperty||function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]})(i,"if").call(null!=t?t:e.nullContext||{},t,{name:"if",hash:{},fn:e.program(1,n,0),inverse:e.noop,data:n,loc:{start:{line:1,column:0},end:{line:16,column:7}}}))?i:"")+'<div class="table-body">\n    <div class="scrollfix">\n        <div class="table-content"></div>\n    </div>\n</div>\n<div class="table-footer">\n\t<div class="table-row"></div>\n</div>'},useData:!0});var L=n;function n(){}r.generateColorSchema=function(e){for(var t=[],i=r.hexToRgb(e),o=i.r,n=i.g,a=i.b,l=0;l<10;l++)t[l]="rgb("+(o-10*l)+","+(n-10*l)+","+(a-10*l)+")";return t.reverse(),r.COLOR_SCHEMAS[e]=t},r.getColor=function(e,t){return e=e.replace("#",""),(r.COLOR_SCHEMAS[e]||r.generateColorSchema(e))[t]},r.hexToRgb=function(e){return{r:parseInt(e.substr(0,2),16),g:parseInt(e.substr(2,2),16),b:parseInt(e.substr(4,2),16)}},r.COLOR_SCHEMAS={};var j=r;function r(){}a.prototype.applyHighlightRules=function(e){var n,a,l,r,s,d,h,c,u,p=this;if(this.hlRules=e,this.highlightBgColor="",!this.highlightRulesActive&&e.length){for(this.highlightRulesActive=!0,this.innerEl=document.createElement("div");this.el.firstChild;)this.innerEl.appendChild(this.el.removeChild(this.el.firstChild));this.el.className+=" highlightRulesActive",this.innerEl.className="highlightDiv",this.el.appendChild(this.innerEl)}var t=this.breakdown,g=_.isEmpty(t.focus)?0:_.first(w.focus2Array(t.focus)).length,f=t?t.breakdownColumns:[];this.iconsDiv&&this.iconsDiv.parentElement&&this.innerEl.removeChild(this.iconsDiv),this.iconsDiv=void 0,_.includes(_.keys(this.model.attributes),this.dataDef.field)&&(_.forEachRight(e,function(e){var t,i=!1,o=_.includes(["Fill Left-to-Right","Fill Right-to-Left"],e.ConditionOperator);"*"!==e.Target&&e.Target!==p.dataDef.field||("{breakdownId}"===(t=e.ConditionSource)&&(t=f[g]),t=p.model.get(t),7===p.dataDef.kdbType&&_.isString(t)&&!isNaN(parseInt(t,10))?t=parseInt(t,10):_.isString(t)&&!isNaN(Number(t))&&(t=Number(t)),n=e.BackgroundColor,a=p.negativeColor||e.Color,l=e.BorderColor,r=e.Icon,s=e.IconColor||"transparent",o?_.isNumber(t)&&(d=e.ConditionOperator,h=e.BackgroundColor,c=e.BorderColor,u=Math.max(0,Math.min(100,t))):"previous value"===e.ConditionValue?(console.log(y({},p.model)),p.model.hasChanged()&&!_.isUndefined(p.model.changed[e.ConditionSource])&&w.getConditionResult(t,p.model.previous(e.ConditionSource),e.ConditionOperator)&&(i=!0)):w.getConditionResult(t,e.ConditionValue,e.ConditionOperator)&&(i=!0)),i&&(!n||p.selected&&p.rowSelectionMode||(p.setBgColor(n),p.highlightBgColor=e.BackgroundColor),a&&(p.el.style.color=p.innerEl.style.color=a),l&&(p.el.style.border="1px solid "+l),r&&(o=0===r.indexOf("mi-")?"mi":"fa",p.iconsDiv||(p.iconsDiv=document.createElement("div"),"left"==p.el.style.textAlign?p.iconsDiv.className="cellIconsRight":p.iconsDiv.className="cellIconsLeft",p.innerEl.prepend(p.iconsDiv)),(t=document.createElement("span")).style.color=s,t.className=o+" "+r+" cellIcons",p.iconsDiv.prepend(t)))}),d&&(h||c)&&(this.ladderDiv||(this.ladderDiv=document.createElement("div")),this.ladderDiv.className=d.replace(" ","_"),this.ladderDiv.style.width=u+"%",h&&(this.ladderDiv.style.backgroundColor=h),c&&(this.ladderDiv.style.border="1px solid "+c),this.innerEl.prepend(this.ladderDiv)))},a.prototype.applyRangeBackground=function(e,t,i,o,n){this.rangeArgs=[e,t,i,o,n],e!==this.dataDef.columnConfig.Field||this.selected&&this.rowSelectionMode||this.highlightBgColor||(e=this.model.get(this.dataDef.columnConfig.Field),n=Math.round(9*(o===i?1:n?(e-o)/(i-o):(e-i)/(o-i))),e=j.getColor(t,n),t&&(this.rangeBgColor=e,this.setBgColor(e)))},a.prototype.generateFormatterFunction=function(u){var p,o,n,a,g=this,f=u.Field,l=!1,e=this.dataDef.kdbType;return e&&7===e&&(l=!0),e=_.trim(u.Template)?(p=i.compile(u.Template),function(i,o,n){var t,a=this;try{var l,e,r,s,d,h=_.omit(o.attributes,["subscribe","unsubscribe"]),c=_.isUndefined(i)?o.get(f):o.get(i);d=_.includes(["General","Percentage","Boolean"],n.Format)?h:(l=g.generateFormatterFunction(_.extend({},n,{Template:"",HighlightNegative:!1})),e=_.extend({thisValue:c},h),r=u.Template.match(/\{\{(.*?)\}\}/g).join(" "),(s=_.union(Object.keys(e).filter(function(e){return r.match(new RegExp(e))}),["thisValue"])).unshift(e),d=_.pick.apply(_,s),_.mapValues(d,function(e,t){return l("thisValue"===t?i:t,o,n)})),d=_.extend({},h,{thisField:i,thisValue:d[i],thisRawValue:c},d),t=p(_.extend(d,O.componentApi.getTemplateViewStates(u.Template))),this.innerEl&&(this.unsubscribeTemplateViewStates(),this.subscriptionKey=O.componentApi.subscribeTemplateViewStates(u.Template,function(e){t=p(_.extend(d,e)),a.innerEl.innerHTML=t}))}catch(e){t=""}if(!this.innerEl)return t;this.innerEl.innerHTML=t}):"Number"===u.Format||"Formatted Number"===u.Format||"Smart Number"===u.Format?function(e,t,i){t=_.isUndefined(e)?t.get(f):t.get(e),e=t;return null==t?"":(e="Smart Number"===i.Format?E.smartFormatNumber(t,i.Precision,!0):"Formatted Number"===i.Format?E.formatNumber(t,i.Precision):E.toFixedNumber(t,i.Precision),e=g.hideTralingZeroes(e,i.HideTrailingZeroes),this.innerEl?void(this.innerEl.textContent=e):e)}:"Date"===u.Format||"Time"===u.Format||"DateTime"===u.Format?function(e,t,i){var o="DateTime"===i.Format,n="Time"===i.Format,t=_.isUndefined(e)?t.get(f):t.get(e),e=E.convertKDBTemporalToMoment(t),t=_.isNull(t)||_.isFunction(e.isValid)&&!e.isValid()?_.escape(t):n?e.formatNano(i.TimeFormat,{trim:!1,trimNano:!1}):o?e.formatNano(i.DateFormat+" "+i.TimeFormat,{trim:!1,trimNano:!1}):e.formatNano(i.DateFormat);if(!this.innerEl)return t;this.innerEl.textContent=t}:"Percentage"===u.Format?function(e,t,i){var o,n,t=_.isUndefined(e)?t.get(f):t.get(e);if(l&&_.isString(t)&&(t=parseInt(t,10)),n=_.isNumber(t)?(t*=100,e="",o=Math.max(0,t),o=Math.min(100,o),(n=i.PercentageColorOverride)&&(e="background-color:"+n+";color:"+n+";"),t=t.toFixed(u.Precision),t=g.hideTralingZeroes(t,i.HideTrailingZeroes),this.innerEl?'<div class="percentageFormatter"><p style="'+e+"width:"+o+'%">.</p><span>'+t+"%</span></div>":t):_.escape(t),!this.innerEl)return n;this.innerEl.innerHTML=n}:function(e,t,i){t=_.isUndefined(e)?t.get(f):t.get(e);return t&&"1216"===t.class?t.toString():this.innerEl?void(this.innerEl.textContent=t):_.escape(t)},"none"!==u.Currency&&0<=u.Format.toLowerCase().indexOf("number")&&(o=g.CURRENCY_SYMBOL_MAP[u.Currency],n=e,e=function(e,t,i){e=n.apply(this,[e,t,i]);if(this.innerEl)this.innerEl.innerHTML=o+this.innerEl.textContent;else{if(!this.el)return o+e;this.el.innerHTML=o+e}}),u.HighlightNegative&&(a=e,e=function(e,t,i){e=a.apply(this,[e,t,i]),t=t.get(f);if(!this.innerEl)return e;_.isNumber(t)&&t<0?this.el.style.color=this.negativeColor=i.HighlightNegativeColor:this.el.style.color=this.negativeColor=""}),e},a.prototype.hideTralingZeroes=function(e,t){var i=e.toString();if(t&&0<=i.indexOf(".")){for(e="",(t=i[i.length-1]).match(/[kmbtpe]/i)&&(e=t,i=i.slice(0,-1));"0"===i[i.length-1];)i=i.slice(0,-1);"."===i[i.length-1]&&(i=i.slice(0,-1)),i+=e}return i},a.prototype.highlightMaxOrMin=function(){function e(e,t){!(i.highlightBgColor||i.selected&&i.rowSelectionMode)&&i.model.get(e)&&-1<i.model.get(e).split(",").indexOf(i.dataDef.columnConfig.Field)&&(i.minMaxBgColor=t||i.bgColor,i.setBgColor(i.minMaxBgColor))}var i=this;e("isMin",this.dataDef.columnConfig.HighlightMinValueColor),e("isMax",this.dataDef.columnConfig.HighlightMaxValueColor)},a.prototype.onModelChange=function(e){var t,i,o,n,a=this,l=this.model.get(this.dataDef.field),r="transparent",s="none";l!==this.contentCache&&(this.dataDef.columnConfig&&(a.dataDef.formatterFn=a.generateFormatterFunction(a.dataDef.columnConfig),this.highlightChangeDuration=this.dataDef.columnConfig.HighlightChangeDuration||1500,i=parseFloat(l),o=parseFloat(this.contentCache),_.isNumber(i)&&_.isNumber(o)&&(this.dataDef.columnConfig.HighlightChanges&&(r=$(this.el).css("background-color"),n=o<i?"#7FFF8E":"#FF7F7F",$(this.el).stop(!0,!0).css("background-color",n).animate({backgroundColor:r},a.highlightChangeDuration)),s=o<i?"up":i<o?"down":"none")),this.contentCache=l,a.dataDef.formatterFn?a.dataDef.formatterFn.apply(this,[this.dataDef.field,this.model,this.dataDef.columnConfig]):this.innerEl.textContent=l),this.applyHighlightRules(this.hlRules),a.dataDef.columnConfig.ShowArrowsOnChange&&("up"===s?t=$('<i class="fa fa-caret-up"></i>'):"down"===s&&(t=$('<i class="fa fa-caret-down"></i>')),t&&$(a.innerEl).append(t),_.delay(function(){$(a.innerEl).find(">i").remove()},400))},a.prototype.onModelPropertyChange=function(e,t){t!==this.contentCache&&(this.contentCache=t,this.innerEl.textContent=t)},a.prototype.layout=function(e,t,i){e!==this.cachedHidden&&(this.cachedHidden=e,this.el.style.visibility=e?"hidden":"visible"),e||(t!==this.cachedLeft&&(this.cachedLeft=t,this.el.style.left=t+"px"),i!==this.cachedWidth&&(this.cachedWidth=i,this.el.style.width=i+"px"),this.dataDef.columnConfig.TextAlign!==this.cachedTextAlign&&(this.cachedTextAlign=this.dataDef.columnConfig.TextAlign,this.el.style.textAlign=this.cachedTextAlign,"left"==this.cachedTextAlign&&this.iconsDiv?this.iconsDiv.className="cellIconsRight":"left"!=this.cachedTextAlign&&this.iconsDiv&&(this.iconsDiv.className="cellIconsLeft")))},a.prototype.refreshHighlights=function(e){e===this.dataDef.columnConfig.Field&&(this.resetTextAndBorder(),this.resetBgColor())},a.prototype.remove=function(){this.unsubscribeTemplateViewStates(),this.el.remove()},a.prototype.resetBgColor=function(e){e?this.bgColor=e:e=this.bgColor,this.setBgColor(e),this.hlRules.length&&(this.applyHighlightRules(this.hlRules),this.highlightBgColor||(this.minMaxBgColor?this.highlightMaxOrMin():this.rangeBgColor&&this.applyRangeBackground.apply(this,this.rangeArgs)))},a.prototype.resetTextAndBorder=function(){this.el.style.color=this.negativeColor||"",this.el.style.border="",this.innerEl&&(this.innerEl.style.color=this.negativeColor||"")},a.prototype.setBgColor=function(e){this.el.style.backgroundColor=e},a.prototype.unsubscribeTemplateViewStates=function(){this.subscriptionKey&&(O.componentApi.unsubscribeTemplateViewStates(this.subscriptionKey),this.subscriptionKey="")},a.DEFAULT_COLOR="transparent";var z=a;function a(e,t,i,o,n,a){this.bgColor="",this.rangeBgColor="",this.minMaxBgColor="",this.highlightBgColor="",this.negativeColor="",this.highlightRulesActive=!1,this.breakdown={},this.hlRules=[],this.rangeArgs=[],this.subscriptionKey="",this.CURRENCY_SYMBOL_MAP={GBP:"&pound;",EUR:"&euro;",USD:"$"},this.model=e,this.dataDef=t,this.cachedTextAlign="center",this.el=document.createElement("div"),this.innerEl=this.el,this.breakdown=o,this.selected=n,this.rowSelectionMode=a,this.applyHighlightRules(i)}s=d.View,e(c,s),c.prototype.initializeEvents=function(){this.el.addEventListener("mousedown",this.rowClickHandler),this.el.addEventListener("dblclick",this.onDoubleClick),this.el.addEventListener("mouseenter",this.onMouseEnter),this.listenTo(this.model,"isMin",this.highlightMaxOrMin),this.listenTo(this.model,"isMax",this.highlightMaxOrMin),this.listenTo(this.model,"HighlightRange",this.applyRangeBackground),this.listenTo(this.model,"RefreshHighlights",this.refreshHighlights),this.listenTo(this.viewModel,"change:HighlightRules",this.onHighlightRulesChange),this.listenTo(this.viewModel,"change:Selection.RowSelectionMode",this.onRowSelectionModeChange),this.onModelChange(this.model),this.listenTo(this.model,"change",this.onModelChange)},c.prototype.applyRangeBackground=function(t,i,o,n,a){_.each(this.cellViews,function(e){e.applyRangeBackground(t,i,o,n,a)})},c.prototype.calcFiltered=function(e){e=e||this.viewModel.get("filter");return _.isEmpty(e)?this.isFiltered=!1:this.isFiltered=c.isModelFiltered(this.model,e,this.dataDef),this.isFiltered},c.prototype.clearSelected=function(){this.cellViews.forEach(function(e){return e.selected=!1})},c.prototype.expandAll=function(e,t){},c.prototype.isAllExpanded=function(e){return!1},c.prototype.getColumnInfo=function(e){return this.parent.getColumnInfo(e)},c.prototype.getRowKey=function(){return this.model.get(this.viewModel.get("Selection.RowSelectionColumn"))},c.prototype.getApp=function(){for(var e=this.parent;e.parent;)e=e.parent;return e},c.prototype.height=function(){return this.isFiltered?0:this.viewModel.get("Style.RowHeight")},c.prototype.highlightMaxOrMin=function(){_.each(this.cellViews,function(e){e.highlightMaxOrMin()})},c.isModelFiltered=function(n,e,a){return void 0!==_.find(e,function(e,t){var i,o=_.find(a,function(e){return e.field===t});return!!o&&(_.isFunction(o.formatterFn)?0===(i=""+o.formatterFn(t,n,o)||"").indexOf('<div class="percentageFormatter">')&&(i=$(i).find("span").text()):i=_.isFunction(o.data)&&""+o.data(n)||"",-1===i.toLowerCase().indexOf(e.toLowerCase()))})},c.prototype.layout=function(e){var i=this,e=e||this.dataDef;E.sum(_.map(e,function(e){return e.hidden?0:e.width||1}));_.each(e,function(e,t){i.cellViews[t].layout(e.hidden,e.leftComputed,e.widthComputed)})},c.prototype.onDoubleClick=function(e){e.stopPropagation(),this.getApp().trigger("rowDoubleClicked",this)},c.prototype.onHighlightRulesChange=function(){var t=this;_.each(this.cellViews,function(e){e.hlRules=t.viewModel.get("HighlightRules"),e.refreshHighlights(e.dataDef.field)})},c.prototype.onModelChange=function(t){_.each(this.cellViews,function(e){e.onModelChange(t)})},c.prototype.onMouseEnter=function(e){e.stopPropagation(),this.cellViews&&this.cellViews[0]&&this.cellViews[0].el&&this.cellViews[0].el.className.indexOf("expanded")<0&&this.getApp().trigger("rowMouseEntered",this)},c.prototype.onRowSelectionModeChange=function(){var t=this;this.parent.trigger("rowUnselected"),_.each(this.cellViews,function(e){e.rowSelectionMode=t.viewModel.get("Selection.RowSelectionMode")})},c.prototype.refreshHighlights=function(t){_.each(this.cellViews,function(e){e.refreshHighlights(t)})},c.prototype.remove=function(){return this.el.removeEventListener("mousedown",this.rowClickHandler),this.el.removeEventListener("dblclick",this.onDoubleClick),d.View.prototype.remove.call(this)},c.prototype.renderInternal=function(){var i=this,o=[],n=this.parent.viewModel.get("Selection.RowSelectionMode"),a=!1;return n&&!this.parent.disableHighlighting&&b.key(this.model)===this.parent.selected&&(a=!0),_.each(i.dataDef,function(e){var t=new z(i.model,e,i.viewModel.get("HighlightRules"),{breakdownColumns:i.viewModel.get("breakdownColumns"),focus:i.viewModel.get("Basics.Focus")},a,n);t.onModelChange(i.model),e.class&&$(t.el).addClass(e.class),t.layout(e.hidden,e.leftComputed,e.widthComputed),i.cellViews.push(t),o.push(t.el)}),i.$el.append(o),this},c.prototype.resetBgColor=function(t){this.cachedBackgroundColor!==t&&(this.cachedBackgroundColor=t,_.each(this.cellViews,function(e){e.resetBgColor(t)}))},c.prototype.selectCells=function(){this.cellViews.forEach(function(e){return e.selected=!0})},c.prototype.setTop=function(e){e!==this.cachedTop&&(this.cachedTop=e,this.$el.css("top",e+"px"))};var s,K=c;function c(e){var t=s.call(this,_.extend({className:"table-row"},e))||this,i=(t.isFiltered=!1,t.isVisible=!0,t);return t.api=e.api,t.dataDef=e.dataDef,t.viewModel=e.viewModel,t.parent=e.parent,t.cellViews=[],t.onDoubleClick=t.onDoubleClick.bind(t),t.onMouseEnter=t.onMouseEnter.bind(t),i.rowClickHandler=function(t){var e=_.find(i.cellViews,function(e){return e&&e.el===t.target});e&&"pointer"!==e.el.style.cursor&&((e=i.parent)&&b.key(i.model)===e.selected&&t.ctrlKey?i.trigger("rowUnselected",i):i.trigger("rowSelected",i)),t.stopPropagation()},t.renderInternal(),t.initializeEvents(),t}u=d.View,e(p,u),p.prototype.applyExpand=function(){var e,t=this.viewModel.get("Basics.Animate");this.isApplied=!0,this.$expandIcon.toggleClass("expanding",!1),this.isExpanded?this.expandedDatatable||(this.stopListening(this.viewModel,"change:filter"),this.expandedDatatable=new S({model:this.collection,api:this.api,dataDef:this.childDataDef,offsetIndex:this.offsetIndex,depth:this.depth+1,noHeader:!0,rowData:this.rowData,parent:this,viewModel:this.viewModel,sortDef:this.sortDef}),this.listenTo(this.collection,"add remove reset",this.onExpandedOrdersChanged),this.listenTo(this.expandedDatatable,"rowSelected",function(e){this.trigger("rowSelected",e)}.bind(this)),this.listenTo(this.expandedDatatable,"rowUnselected",function(e){this.trigger("rowUnselected",e)}.bind(this)),this.$el.append(this.expandedDatatable.el),this.$expandIcon.toggleClass("expanded",!0),this.updateHeight(),t?_.delay(this.onExpandComplete.bind(this),301):this.onExpandComplete()):this.expandedDatatable&&(this.$expandIcon.toggleClass("expanded",!1),this.onExpandComplete(),e=function(){this.stopListening(this.collection),this.expandedDatatable.remove(),this.expandedDatatable=null,this.updateHeight(),this.parent.processMinMaxHighlighting()}.bind(this),t?_.delay(e,201):e())},p.prototype.clearSelected=function(){this.datatableRow&&this.datatableRow.cellViews.forEach(function(e){return e.selected=!1}),this.expandedDatatable&&this.expandedDatatable.clearSelected()},p.prototype.getColumnInfo=function(e){return this.parent.getColumnInfo(e)},p.prototype.updateColumnInfo=function(e){return this.parent.updateColumnInfo(e)},p.prototype.onData=function(e,t){var i=!1;e.primaryKey!==this.primaryKey&&(this.primaryKey=e.primaryKey,this.collection.reset(),this.collection=new(E.createPivotCollectionFunc(this.primaryKey))),t.reset&&0<t.reset.length?(this.collection.reset(t.reset),i=!0):(t.add&&0<t.add.length&&(this.collection.add(t.add),i=!0),t.change&&0<t.change.length&&(this.collection.add(t.change,{merge:!0}),i=!0),t.remove&&0<t.remove.length&&(this.collection.remove(_.map(t.remove,function(e){return e.id})),i=!0)),i&&(clearTimeout(this.timeout),this.updateColumnInfo(e.columns),this.applyExpand()),this.viewModel.get("Basics.Drilldown")&&this.renderTopFooter()},p.prototype.onExpandClick=function(){var e=this.isExpanded&&this.isApplied;this.isExpanded&&!this.isApplied&&this.expand(!1),this.parent.onExpanded(this.getPath(),!e)},p.prototype.onExpanded=function(e,t){this.parent.onExpanded(e,t)},p.prototype.expand=function(e){var t=this;e&&!this.isExpanded?(this.isExpanded=!0,this.isApplied=!1,this.$expandIcon.toggleClass("expanding",!0),this.timeout=setTimeout(function(){t.expand(!1)},15e3),this.api.subscribe(this.model,this.onData.bind(this))):!e&&this.isExpanded&&(this.isExpanded=!1,this.api.unsubscribe(this.model),this.applyExpand(),clearTimeout(this.timeout))},p.prototype.expandAll=function(e,t){this.expandedDatatable&&this.expandedDatatable.expandAll(e,t)},p.prototype.isAllExpanded=function(e){return this.expandedDatatable&&(e<0||this.expandedDatatable.isAllExpanded(e))},p.prototype.getPath=function(){return this.parent.getPath().concat(this.key())},p.prototype.height=function(){var e;return this.isExpanded&&this.expandedDatatable?(e=this.expandedDatatable.height(),Math.max(e,this.datatableRow.height())):this.datatableRow.height()},p.prototype.key=function(){return p.key(this.model)},p.key=function(e){e=e.id;return _.isString(e)?S.encodeKey(e):e&&e.i?e.toString():""+e},p.prototype.layout=function(e){e=e||this.dataDef;this.datatableRow.layout(e),this.expandedDatatable&&this.expandedDatatable.layoutRows(e.slice(1))},p.prototype.onExpandComplete=function(){this.onRowExpanded(0,this.isExpanded)},p.prototype.onExpandedOrdersChanged=function(){this.updateHeight()},p.prototype.onRowExpanded=function(e,t){this.parent&&this.parent.onRowExpanded(e+1,t)},p.prototype.remove=function(){return this.datatableRow.remove(),this.clickHandler&&_.each(E.clickEvent().split(" "),_.bind(function(e){this.$expandIcon[0].removeEventListener(e,this.clickHandler)},this)),this.expandedDatatable&&this.expandedDatatable.remove(),this.api.unsubscribe(this.model),d.View.prototype.remove.call(this)},p.prototype.renderTopFooter=function(){this.parent.renderFooter()},p.prototype.rowCount=function(){return this.parent.rowCount()},p.prototype.scrollTop=function(){return-(this.cachedTop||0)+this.parent.scrollTop()},p.prototype.setTop=function(e){e!==this.cachedTop&&(this.cachedTop=e,this.$el.css("top",e+"px"))},p.prototype.renderInternal=function(e){return this.expandedDatatable&&this.expandedDatatable.renderInternal(e),this},p.prototype.selectCells=function(){this.datatableRow&&this.datatableRow.cellViews.forEach(function(e){return e.selected=!0}),this.expandedDatatable&&this.expandedDatatable.selectCells()},p.prototype.updateHeight=function(){this.parent.updateHeight()};var u,b=p;function p(e){var t=u.call(this,_.extend({className:"table-row"},e))||this;return t.subscriptionKey=_.uniqueId("datatable_"),t.columnState={},t.isApplied=!1,t.isExpanded=!1,t.isVisible=!0,t.api=e.api,t.offsetIndex=e.offsetIndex,t.parent=e.parent,t.dataDef=e.dataDef,t.depth=e.depth,t.sortDef=e.sortDef,t.viewModel=e.viewModel,t.expandedDatatable=null,t.collection=new d.Collection,t.datatableRow=new K({el:t.el,model:t.model,api:e.api,dataDef:t.dataDef,viewModel:t.viewModel,rowData:e.rowData,parent:t.parent}),e.rowData&&(t.rowData=_.clone(e.rowData.rowData),t.$expandIcon=t.$el.children().first(),t.$expandIcon[0].style.cursor="pointer",t.$expandIcon.addClass("expndbl"),t.childDataDef=t.dataDef.slice(1),t.clickHandler=_.debounce(t.onExpandClick.bind(t),200,{leading:!0}),_.each(E.clickEvent().split(" "),_.bind(function(e){this.$expandIcon[0].addEventListener(e,this.clickHandler)},t))),t.listenTo(t.datatableRow,"rowSelected",function(e){this.trigger("rowSelected",e)}.bind(t)),t.listenTo(t.datatableRow,"rowUnselected",function(e){this.trigger("rowUnselected",e)}.bind(t)),e.expand&&_.defer(function(){this.onExpandClick()}.bind(t)),t}g.prototype.on=function(e,t,i){},g.prototype.off=function(e,t,i){},g.prototype.trigger=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i]},g.prototype.bind=function(e,t,i){},g.prototype.unbind=function(e,t,i){},g.prototype.once=function(e,t,i){},g.prototype.listenTo=function(e,t,i){},g.prototype.listenToOnce=function(e,t,i){},g.prototype.stopListening=function(e,t,i){};var W=g;function g(){_.extend(this,d.Events)}U=d.View,e(f,U),f.prototype.initialize=function(e){var n,a=this;a.options=e.options,a.MODEL=a.options.MODEL,this.$el.html(a.options.body),a.options.buttons=a.options.buttons||{Ok:null},n=a.options.buttons,_.each(n,function(e,i){var o=i.toLowerCase();n[i]={text:t(i),click:function(){_.isFunction(e)&&e(),a.onClose()},icons:_.has(a.ICONS_MAP,o)?{primary:a.ICONS_MAP[o]}:{}}}),this.$dialog=this.$el.dialog(_.extend({dialogClass:"data-table dlgBasicPopup",title:"Basic Popup",resizable:!1,modal:!0,autoOpen:!0,width:300,height:150,close:function(){a.$dialog.dialog("destroy"),a.remove()}},this.options))},f.prototype.onClose=function(){this.$el.dialog("close")},f.prototype.onOkButtonClick=function(){this.onClose()},f.prototype.onResize=function(){};var U,X=f;function f(e){return U.call(this,e)||this}v.downloadCsv=function(e,t){var i,o="",n=[],a=[],l=_.filter(_.sortBy(t.dataDef,function(e){return e.columnIndex}),function(e){return!e.hidden});t.sortedModels.forEach(function(e){return v.parseRow(e,t,l,n,a)}),i=[_.map(l,"header")].concat(a),_.each(i,function(e,t){e=e.join(",");o+=t<i.length?e+"\n":e}),E.fileSave(e,o)},v.parseCell=function(e,t){var i=t.get(e.field)||"",o=e.columnConfig,n=!1,a=!_.isNil(t.get(e.field));return _.isFunction(e.formatterFn)&&a&&(i=e.formatterFn(e.field,t,e.columnConfig),o&&(n=/<[a-z]+>[\s\S]*<\/[a-z]+>/gi.test(i),"General"!==(o.Format||"General")||n||(i=_.unescape(i)))),o&&"Percentage"===o.Format&&(i=""!==i?i+"%":""),(/(&|&#|\\u)[A-Za-z0-9]{2,5};/g.test(i)||n)&&(v.converterDiv.innerHTML=i,i=v.converterDiv.innerText),_.isString(i)&&(i=i.replace(/"/g,'""')),'"'+(i=/^[-\+=@]/.test(i)&&o.Format&&-1===o.Format.indexOf("Number")?"'"+i:i)+'"'||""},v.parseRow=function(t,e,i,o,n){var a,e=e.modelViewDict[t.id];(a=e?e.expandedDatatable:a)?_.each(a.sortedModels,function(e){return v.parseRow(e,a,i,o,n)}):n.push(o.concat(_.map(i,function(e){return v.parseCell(e,t)})))},v.convertTo2digit=function(e){return e=1===(e=""+e).length?"0"+e:e},v.getDefaultFileName=function(){var e=new Date,t=e.getMonth()+1,i=e.getDate();return"CSV "+e.getFullYear()+v.convertTo2digit(t)+v.convertTo2digit(i)},v.sanitizeForFileName=function(e){return e=e.replace(/:/g,"-").replace(/[^\w \.\-]/g,"")},v.showDialog=function(e,i){var o,e=_.map(e.get("FileExport.FileName"),function(e){return(e=null!==(e=e.FileNamePart)&&!_.isObject(e)?e:"").toString()}).join("")||e.get("format.widgetTitle")||v.getDefaultFileName();e=v.sanitizeForFileName(e),e+=v.FILE_EXT,o=new X({options:{width:240,title:t("Export csv file"),body:"<div class='dlgCsvExport'>"+t("Please enter the filename")+"<br/><input type='text' class='ui-corner-all' value='"+e+"'/></div>",buttons:{Ok:function(){var e=""+(e=o.$el.find("input").val())||v.getDefaultFileName();e=v.sanitizeForFileName(e),new RegExp("\\"+v.FILE_EXT+"$").test(e)||(e+=v.FILE_EXT),v.downloadCsv(e,i)},Cancel:0}}})},v.FILE_EXT=".csv",v.converterDiv=document.createElement("div");var q=v;function v(){}function G(){this.SheetNames=[],this.Sheets={}}C.createExcelOfCurrentData=function(e,t){var i,o,n,a={},l={".xlsx":"xlsx",".xls":"xlml"}[C.FILE_EXT],r=[],s=[],d=_.filter(_.sortBy(t.dataDef,function(e){return e.columnIndex}),function(e){return!e.hidden});s.push(_.map(_.map(d,"header"),function(e,t){return{type:"General",value:e,index:t}})),t.sortedModels.forEach(function(e){return C.parseRow(e,t,d,r,s,a)}),n=s,o="Datatable",i=new G,n=C.convertDataToExcel(n,a),i.SheetNames.push(o),i.Sheets[o]=n,o=XLSX.write(i,{bookType:l,bookSST:!0,type:"binary"}),n=C.s2ab(o),E.fileSave(e,n)},C.parseCell=function(e,t,i,o){var n,a,l,r,s,d,h=i.get(e.field),c={},u=!1,p=!1,g=e.columnConfig,f=null!=h;if(_.isFunction(e.formatterFn)&&f&&(h=e.formatterFn(e.field,i,e.columnConfig)),""!==(h=f?h.toString():"")&&g){switch(n=g.Format||"General",a=g.Precision,l=g.DateFormat,r=g.TimeFormat,/<[a-z]+>[\s\S]*<\/[a-z]+>/gi.test(h)?(C.converterDiv.innerHTML=h,h=C.converterDiv.innerText):"General"===n&&(h=_.unescape(h)),h.replace&&16<h.replace(/[,.]/g,"").length&&(p=!0),n){case"Percentage":c.oldValue=h+"%",p?u=!0:(s=Number(h),isNaN(s)||-1!==h.indexOf(".")?!isNaN(s)&&0<h.indexOf(".")&&h.length-h.indexOf(".")<4?(c.type="Percentage_10",c.value=Number((s/100).toFixed(4))):(c.type="General",c.value=h+"%"):(c.type="Percentage_9",c.value=Number((s/100).toFixed(2))));break;case"Smart Number":u=!0;break;case"Number":case"Formatted Number":p?u=!0:/(&|&#|\\u)[A-Za-z0-9]{2,5};/g.test(h)?(C.converterDiv.innerHTML=h,c.value=C.converterDiv.innerText,c.type="General"):(h.replace&&-1!==h.indexOf(",")?(-1!==h.indexOf(".")?(c.type="Number_custom",c.format="#,##0."+Array(a+1).join("0")):c.type="Formatted_Number_3",h=h.replace(/,/g,"")):-1!==h.indexOf(".")&&(c.type="Number_custom",c.format="#0."+Array(a+1).join("0")),isNaN(Number(h))?u=!0:(c.oldValue=h,c.value=Number(h)));break;case"Date":case"DateTime":"Date"===n?d=l:"DateTime"===n&&(d=l+" "+r),!(u=-1!==h.indexOf(".")&&2<h.substr(h.indexOf(".")+1).length?!0:u)&&m.utc(h,d).isValid()&&"Invalid date"!==m.utc(h,d).format()?(c.oldValue=h,c.format=d,c.value=m.utc(h,d).format()):u=!0;break;default:_.includes(["true","false"],h)?(c.oldValue=h,c.value="true"===h,c.type="Boolean"):u=!0}c.type=c.type||n}else c.type=null,c.value="";return u&&(o[t]=!0,_.includes(["Percentage_9","Percentage_10"],n)?c.value=h+"%":c.value=""+h,c.type="General"),c.index=t,c},C.parseRow=function(i,e,t,o,n,a){var l,e=e.modelViewDict[i.id];(l=e?e.expandedDatatable:l)?_.each(l.sortedModels,function(e){return C.parseRow(e,l,t,o,n,a)}):n.push(o.concat(_.map(t,function(e,t){return C.parseCell(e,t+o.length,i,a)})))},C.convertTo2digit=function(e){return e=1===(e=""+e).length?"0"+e:e},C.getDefaultFileName=function(){var e=new Date,t=e.getMonth()+1,i=e.getDate();return"Excel "+e.getFullYear()+C.convertTo2digit(t)+C.convertTo2digit(i)},C.sanitizeForFileName=function(e){return e=e.replace(/:/g,"-").replace(/[^\w \.\-]/g,"")},C.showDialog=function(e,i){var o,n,e=_.map(e.get("FileExport.FileName"),function(e){return(e=null!==(e=e.FileNamePart)&&!_.isObject(e)?e:"").toString()}).join("")||e.get("format.widgetTitle")||C.getDefaultFileName();e=C.sanitizeForFileName(e),e+=C.FILE_EXT,n=new X({options:{width:240,title:t("Export Excel file"),body:"<div class='dlgExcelExport'>"+t("Please enter the filename")+"<br/><input type='text' class='ui-corner-all' value='"+e+"'/></div>",buttons:{Ok:function(){o=""+(o=n.$el.find("input").val())||C.getDefaultFileName(),o=C.sanitizeForFileName(o),new RegExp("\\"+C.FILE_EXT+"$").test(o)||(o+=C.FILE_EXT),C.createExcelOfCurrentData(o,i)},Cancel:0}}})},C.datenum=function(e,t){return t&&(e+=1462),Date.parse(e)-Date.UTC(1899,11,30)/864e5},C.convertDataToExcel=function(e,t){for(var i={},o={s:{c:1e7,r:1e7},e:{c:0,r:0}},n=0;n!=e.length;++n)for(var a=0;a!=e[n].length;++a){o.s.r>n&&(o.s.r=n),o.s.c>a&&(o.s.c=a),o.e.r<n&&(o.e.r=n),o.e.c<a&&(o.e.c=a);var l=e[n][a],r={};if(null!==l.type){t[l.index]&&(l.type="General",l.value=l.oldValue||l.value);var s=XLSX.utils.encode_cell({c:a,r:n});switch("number"==typeof r.v?r.t="n":"boolean"==typeof r.v?r.t="b":r.v instanceof Date?(r.t="n",r.z=XLSX.SSF._table[14],r.v=C.datenum(r.v)):r.t="s",l.type){case"Number":case"Formatted Number":r.t="n",r.z=XLSX.SSF._table[1];break;case"Formatted_Number_2":r.t="n",r.z=XLSX.SSF._table[2];break;case"Formatted_Number_3":r.t="n",r.z=XLSX.SSF._table[3];break;case"Formatted_Number_4":r.t="n",r.z=XLSX.SSF._table[4];break;case"Number_custom":l.format?(r.t="n",r.z=l.format):r.t="s";break;case"Smart number":r.t="s";break;case"Boolean":r.t="b";break;case"Date":r.t="d",r.z=l.format||"YYYY-MM-DD";break;case"DateTime":r.t="d",r.z=l.format||"YYYY-MM-DD HH:mm:ss";break;case"Percentage_9":r.t="n",r.z=XLSX.SSF._table[9];break;case"Percentage_10":r.t="n",r.z=XLSX.SSF._table[10];break;default:r.t="s"}r.v=l.value,i[s]=r}}return o.s.c<1e7&&(i["!ref"]=XLSX.utils.encode_range(o)),i},C.s2ab=function(e){for(var t=new ArrayBuffer(e.length),i=new Uint8Array(t),o=0;o!=e.length;++o)i[o]=255&e.charCodeAt(o);return t},C.FILE_EXT=".xlsx",C.converterDiv=document.createElement("div");var Y=C;function C(){}Q.generateFullExportConfig=function(e){var a={},l=_.filter(_.sortBy(e.dataDef,function(e){return e.columnIndex}),function(e){return!e.hidden}),r=["Date","Time","DateTime"];return l.length&&(a.columnLabel="",a.dateFormat="",_.each(l,function(e,t){var t=t<l.length-1?" && ":"",i=e.kdbType,o=e.columnConfig.Format,n=e.field+"#"+e.header+t;a.columnLabel+=n,12<=i&&i<=19&&_.includes(r,o)&&(n={Date:e.columnConfig.DateFormat,Time:e.columnConfig.TimeFormat,DateTime:e.columnConfig.DateFormat+"_"+e.columnConfig.TimeFormat},i=e.field+"#"+n[o]+t,a.dateFormat+=i)}),new RegExp("&& $").test(a.dateFormat)&&(a.dateFormat=a.dateFormat.slice(0,-4))),a};var Z=Q;function Q(){}e(x,J=W),x.prototype.initalizeEvents=function(){var i=this,e=this;this.$lnkCsvExport.click(function(){return q.showDialog(e.viewModel,e.table)}),this.$lnkExcelExport.click(function(){return Y.showDialog(e.viewModel,e.table)}),this.$lnkFullExport.click(_.bind(this.apiExport,this)),this.listenTo(this.viewModel,"change:FileExport.ShowExportCsvButton change:FileExport.ShowExportExcelButton change:FileExport.ShowFullExportButton",_.bind(this.displayChoiceLinkButtons,this)),this.listenTo(this.viewModel,"change:Basics.Data",function(e,t){h.ExportTools.onQueryChange(t,i.$lnkFullExport)})},x.prototype.apiExport=function(){var e,i,o,n=this;this.$lnkFullExport.hasClass("events-disabled")||(e=$("<span />").addClass("export-spinner fa fa-spinner fa-pulse").attr("title",t("Download in progress")).appendTo(this.$lnkFullExport),i=this.getExportParamOptions(),o=this.viewModel.get("Basics.Data"),this.$lnkFullExport.addClass("export-in-progress"),this.viewModel.get("FileExport.FullExportOverride")?o=this.viewModel.get("FileExport.FullExportOverride"):o.get("_queryString")&&o.get("_aggregateCols")&&o.get("_breakdownCols")&&"server"===o.get("_pivotType")?(o=this.getFullExportQuery(i.exportParams),this.api.subscribe(o,this),this.api.unsubscribe(o)):i.focus=this.viewModel.get("Basics.Focus"),this.api.exportData(o,function(){e.remove(),n.$lnkFullExport.removeClass("export-in-progress")},i))},x.prototype.getExportParamOptions=function(){var e=Z.generateFullExportConfig(this.table);return{exportName:h.ExportTools.getExportFileName(this.getFileName(),this.getAltFileName(),"DatatableExport"),exportParams:e}},x.prototype.getFullExportQuery=function(e){var t=this.viewModel.get("Basics.Data"),i=t.get("_breakdownCols"),o=t.get("_queryString"),n=t.get("_aggregateCols"),a=t.get("_aggregateFns"),l=t.get("_aggregateLabels"),a=this.getSelectPhrase(n,a,l),o="?["+o+";();"+this.getGroupbyPhrase(i)+";"+a+"]";return e.columnLabel=this.getPivotExportColumnParams(i,n,l),new h.DocumentDataModel({_forceReset:!0,_subscriptionKey:"",_dataType:"query",_queryString:o,_dataSource:t.get("_dataSource"),_connection:t.get("_connection")},null,null,void 0,void 0)},x.prototype.getPivotExportColumnParams=function(e,t,i){e=e instanceof d.Model?e.get("value"):e,e=_.map(e,function(e){return e+"#"+e}),t=_.map(t,function(e,t){return(i[t]&&!_.isEmpty(i[t])?i[t]:e)+"#"+e});return _.join(_.concat(e,t)," && ")},x.prototype.stringifyDict=function(e,t,i){return(e?"(enlist":"")+t+(e?")":"")+"!"+(e?"enlist":"(")+i+(e?"":")")},x.prototype.getGroupbyPhrase=function(e){var t=1===e.length,e=e instanceof d.Model?e.get("value"):e,e=_.join(_.map(e,function(e){return"`"+e}),"");return this.stringifyDict(t,e,e)},x.prototype.getSelectPhrase=function(i,e,o){var t=1===i.length,n=_.join(_.map(i,function(e,t){return o[t]&&!_.isEmpty(o[t])?'`$"'+o[t]+'"':'`$"'+e+'"'}),";"),e=_.join(_.map(e,function(e,t){return"("+e+";`"+i[t]+")"}),";");return this.stringifyDict(t,"("+n+")","("+e+")")},x.prototype.displayChoiceLinkButtons=function(){var e=this.viewModel.get("FileExport");e&&(e.ShowExportCsvButton||e.ShowExportExcelButton||e.ShowFullExportButton?(this.$lnksExport.removeClass("link-disabled"),this.$lnkCsvExport.toggleClass("link-disabled",!e.ShowExportCsvButton),this.$lnkExcelExport.toggleClass("link-disabled",!e.ShowExportExcelButton),this.$lnkFullExport.toggleClass("link-disabled",!e.ShowFullExportButton)):this.$lnksExport.addClass("link-disabled"))},x.prototype.positionPanelWithDatagrid=function(){this.positionPanelWithDatagrid()},x.prototype.getFileName=function(){return this.viewModel.get("FileExport.FileName")},x.prototype.getAltFileName=function(){return this.viewModel.get("format.widgetTitle")||""},x.prototype.remove=function(){this.$lnkCsvExport.off(),this.$lnkExcelExport.off(),this.$lnkFullExport.off(),this.stopListening()};var J,ee=x;function x(e){var t=J.call(this)||this;return t.table=e.table,t.api=e.api,t.viewModel=e.viewModel,t.$lnkCsvExport=t.table.$("a.lnkCsvExport"),t.$lnkExcelExport=t.table.$("a.lnkExcelExport"),t.$lnkFullExport=t.table.$("a.lnkFullExport"),t.$lnksExport=t.table.$(".lnksExport"),t.displayChoiceLinkButtons(),t.initalizeEvents(),h.ExportTools.onQueryChange(t.viewModel.get("Basics.Data"),t.$lnkFullExport),t}D.isMatch=function(e,t){var i,o=!1,n=e.split(/ +and +| +/);for(_.includes(n,"or")&&(n=_.without(n,"or"),o=!0),i=0;i<n.length;i++)0!==n[i].indexOf("-")&&n[i].indexOf("*")<0&&(n[i]="*"+n[i]+"*");return _[o?"some":"every"](n,function(e){return D.isSimpleMatch(e,t)})},D.isSimpleMatch=function(e,t){var i=!1;return 0===e.indexOf("-")&&(e=e.replace("-",""),i=!0),e=new RegExp("^"+e.replace(/\*/g,".*")+"$").test(t),i?!e:e};var te=D;function D(){}ie=d.View,e(F,ie),F.prototype.initalizeEvents=function(){var t=this;this.listenTo(this.model,"reset",this.onModelReset),this.listenTo(this.model,"add",this.onModelAdd),this.listenTo(this.model,"remove",this.onModelRemove),this.listenTo(this.viewModel,"change:Basics",this.onSortOrderChange),this.listenTo(this.viewModel,"change:Basics.Focus",this.onFocusChange),this.noHeader?this.listenTo(this.viewModel,"change:filter",function(){t.needsSort=!0}):(this.listenTo(this.viewModel,"change:filter",this.debouncedSort),this.showFilters&&(this.$resetFilters.on(E.clickEvent(),function(){return t.clearFilters()}),this.$toggleFilters.on(E.clickEvent(),function(){t.toggleFilters(!t.showingFilters)})),this.$toggleDrilldown.on(E.clickEvent(),function(){var e=t.viewModel.get("Basics.Drilldown");t.api.setProperty("Basics.Drilldown",!e)}),this.listenTo(this.viewModel,"change:Basics.Drilldown",this.onPropDrilldown),this.listenTo(this.viewModel,"change:Basics.MultipleDrilldown",this.onPropMultipleDrilldown),this.listenTo(this.viewModel,"change:Basics.ExpandAll",this.onPropExpandAll),this.listenTo(this.viewModel,"change:Basics.ShowTools",this.onPropShowTools))},F.prototype.applyFilters=function(){var i={};this.noHeader||(_.each(this.headerEls,function(e){var e=$(e).find("input"),t=e.val();""!==t&&("hidden"===e.css("visibility")?(e.val(""),e.parent().removeClass("filter-active")):i[e.attr("name")]=t)}),this.viewModel.unset("filter",{silent:!0}),this.viewModel.set("filter",i),this.useFilterSettings&&this.saveFilterSettings(i),this.$resetFilters.toggle(!_.isEmpty(i)),this.debouncedUpdateExpandIcons())},F.prototype.saveFilterSettings=function(e){this.api.saveSetting("existingFilters",e),this.existingFilters=e},F.prototype.clearFilter=function(e){var t;!this.hasOwnProperty("noHeader")||this.noHeader?this.parent.parent.clearFilter(e):(t=_.omit(this.existingFilters,e),this.$theadtr.find('input.filter[name="'+e+'"]').val("").closest(".thi").removeClass("filter-active"),this.saveFilterSettings(t),this.applyFilters())},F.prototype.clearFilters=function(){this.noHeader||(this.$theadtr.find(".thi").removeClass("filter-active"),this.$theadtr.find("input.filter").val(""),this.saveFilterSettings(null),this.applyFilters())},F.prototype.clearSelected=function(){var e;this.selected&&(e=this.modelViewDict[this.selected])&&e.clearSelected(),this.selected=null},F.decodeKey=function(e){return _.isString(e)?e.replace(/\&#44;/g,",").replace(/\&#91;/g,"[").replace(/\&#93;/g,"]"):e},F.prototype.domSort=function(){var t=this;_.each(this.sortedModels,function(e){e=b.key(e),e=t.modelViewDict[e];e&&e.$el.appendTo(t.$tcontent)})},F.encodeKey=function(e){return _.isString(e)?e.replace(/,/g,"&#44;").replace(/\[/g,"&#91;").replace(/\]/g,"&#93;"):e},F.prototype.generateView=function(i,e){var o=this,e={model:i,parent:this,api:this.api,depth:this.depth,dataDef:this.dataDef,rowData:this.rowData,sortDef:this.sortDef,viewModel:this.viewModel,offsetIndex:e||0},e=new(e.rowData?b:K)(e);return this.listenTo(e,"rowSelected",function(e){o.disableHighlighting=null;var t=b.key(i);t!==o.selected&&(o.clearSelected(),o.selected=t,o.selectCells()),o.trigger("rowSelected",e)}),this.listenTo(e,"rowUnselected",function(e){o.disableHighlighting=o.selected,o.clearSelected(),o.trigger("rowUnselected",e)}),this.modelViewDict[b.key(i)]=e,this.setRowHeight(e),e},F.prototype.getColumnInfo=function(e){return this.parent.getColumnInfo(e)},F.prototype.updateColumnInfo=function(e){return this.parent.updateColumnInfo(e)},F.prototype.getFocusKeys=function(){var e=w.focus2Array(this.viewModel.get("Basics.Focus")),i=this.parent.getPath(),o=[];return e.forEach(function(e){for(var t=0;t<i.length&&t<e.length&&i[t]===e[t];t++);t===i.length&&t<e.length&&o.push(e[t])}),o},F.prototype.getFooterModels=function(o,n,a,l){var r=this;return o.model.each(function(e){var t=b.key(e),i=o.modelViewDict[t];r.viewModel.get("Basics.Drilldown")?(l=l||w.getDepth(n),o.depth===l?a.push(e):i&&i.expandedDatatable&&r.getFooterModels(i.expandedDatatable,n[t],a,l)):i&&i.expandedDatatable?r.getFooterModels(i.expandedDatatable,n[t],a):a.push(e)}),a},F.prototype.getPath=function(){return this.parent.getPath()},F.prototype.getSortedModels=function(){var t,i,o,n,r={},s=_.fromPairs(_.map(this.getFocusKeys(),function(e){return[e,!0]})),e=this.viewModel.get("filter"),a=this.sortDef.index-this.depth,d=this,l=1!=this.viewModel.get("Basics.Drilldown")||_.isEmpty(s)?d.model.models:_.filter(this.model.models,function(e){return s[b.key(e)]});return _.isEmpty(e)||(_.each(e,function(n,e){var a=_.find(d.dataDef,{field:e}),l=0==d.dataDef.indexOf(a);r[e]=void 0===a?function(){return!0}:function(e){var t,i=b.key(e),o=s[i],e=a.formatterFn(a.field,e,a.columnConfig);return(t=o&&!l&&void 0!==e?d.modelViewDict[i]:t)&&t.expandedDatatable?0<t.expandedDatatable.getSortedModels().length:void 0===e||te.isMatch((""+n).toLowerCase(),(""+e).toLowerCase())}}),l=_.filter(l,function(t){return _.every(r,function(e){return e(t)})})),0<=a&&(t=d.dataDef[a].field,a=(e=this.parent.getColumnInfo(t))&&e.get("kdbType"),i=function(e){return e.get(t)},o=E.getComparator(a,i),n=l.reduce(function(e,t,i){return e[t.id]=i,e},{}),"asc"===d.sortDef.direction?l.sort(function(e,t){return o(i(e),t)||n[e.id]-n[t.id]}):"desc"===d.sortDef.direction&&l.sort(function(e,t){return-1*o(i(e),t)||n[e.id]-n[t.id]})),l},F.prototype.getTableBodyHeight=function(){var e=this.viewModel.get("Style.HeaderRowHeight");return(this.showFilters&&this.viewModel.get("Basics.ShowTools")?36:0)+(this.showingFilters?2:1)*e+"px"},F.prototype.getTheadRowHeight=function(){var e=this.viewModel.get("Style.HeaderRowHeight");return(this.showingFilters?2:1)*e+"px"},F.prototype.height=function(){return this.renderHeight||this.model.length*this.viewModel.get("Style.RowHeight")},F.prototype.layoutSection=function(i){for(var o,n=0,a=E.sum(_.map(this.dataDef,function(e){return e.hidden?0:e.width})),l=this.$scrollfix[0].clientWidth,r={},e=0;e<this.dataDef.length;e++){var t=this.dataDef[e];t.hidden||(o=a?l*t.width/a:0,t.columnConfig.MinWidth>o&&!r[e]&&(o=t.columnConfig.MinWidth,l=Math.max(0,l-o),a=Math.max(0,a-t.width),r[e]=!0,e=-1))}_.each(this.dataDef,function(e,t){o=r[t]?e.columnConfig.MinWidth:e.hidden?0:l*e.width/a,i[t]&&i[t].css({visibility:e.hidden?"hidden":"visible",left:n+"px",width:o+"px","text-align":e.columnConfig.TextAlign||"center"}),e.widthComputed=o,e.leftComputed=n,n+=o})},F.prototype.layoutRows=function(e){var t=e||this.dataDef;this.viewModel.get("Basics.Drilldown"),_.each(_.values(this.modelViewDict),function(e){e.layout(t)})},F.prototype.onBreakdownConfigChanged=function(e){this.viewModel.set("breakdownColumns",e)},F.prototype.onFocusChange=function(e,t,i){var o=this,n=this.getFocusKeys(),a=_.difference(this.expandedIds,n);(!_.isEqual(n,this.expandedIds)||i&&i.forceChange)&&(this.expandedIds=n,a.forEach(function(e){return o.setExpandRowByKey(e,!1)}),n.forEach(function(e){return o.setExpandRowByKey(e,!0)}),this.renderTable())},F.prototype.onHasScrollChange=function(){this.layoutSection(this.headerEls),this.layoutRows(this.dataDef),this.layoutSection(this.footerEls)},F.prototype.onHeaderClick=function(e){var t=$(e.target).closest(".th").index();this.dataDef[t].columnConfig.Sortable&&(this.sortDef.index!==t&&(this.$el.find(".table-header .table-row > div").eq(this.sortDef.index).find(".sort").html(F.SORT_NONE),this.sortDef.index=t,this.sortDef.direction=null),"asc"===this.sortDef.direction?(this.sortDef.direction="desc",this.$el.find(".table-header .table-row > div").eq(t).find(".sort").html(F.SORT_DESC)):"desc"===this.sortDef.direction?(this.sortDef.direction=null,this.$el.find(".table-header .table-row > div").eq(t).find(".sort").html(F.SORT_NONE)):(this.sortDef.direction="asc",this.$el.find(".table-header .table-row > div").eq(t).find(".sort").html(F.SORT_ASC)),e.preventDefault(),this.trigger("sortingChanged",{direction:this.sortDef.direction,columnIndex:t,columnHeader:this.dataDef[t].header}),this.renderTable(!1),this.saveSorting(t,this.sortDef.direction))},F.prototype.setSorting=function(t,e){var i;this.depth||-1!==(i=_.findIndex(this.dataDef,function(e){return e.field===t}))&&this.dataDef[i].columnConfig.Sortable&&(this.sortDef.index!==i&&(this.$el.find(".table-header .table-row > div").eq(this.sortDef.index).find(".sort").html(F.SORT_NONE),this.sortDef.index=i,this.sortDef.direction=null),"descending"===e?(this.sortDef.direction="desc",this.$el.find(".table-header .table-row > div").eq(i).find(".sort").html(F.SORT_DESC)):""===e?(this.sortDef.direction=null,this.$el.find(".table-header .table-row > div").eq(i).find(".sort").html(F.SORT_NONE)):(this.sortDef.direction="asc",this.$el.find(".table-header .table-row > div").eq(i).find(".sort").html(F.SORT_ASC)),this.trigger("sortingChanged",{direction:this.sortDef.direction,columnIndex:i,columnHeader:this.dataDef[i].header}),this.renderTable(!1))},F.prototype.saveSorting=function(e,t){this.api.setProperty("Basics.SortColumn",this.dataDef[e].field),this.api.setProperty("Basics.SortOrder",this.sortDef.direction?"asc"===this.sortDef.direction?"ascending":"descending":"")},F.prototype.onModelAdd=function(e){var t,i=this;this.modelViewDict[b.key(e)]||(t=this.generateView(e),this.$tcontent.append(t.el),this.debouncedSort(),this.debouncedHighlight(),this.listenTo(e,"change",function(){i.debouncedHighlight()}))},F.prototype.onModelRemove=function(e){this.removeView(e)&&(this.debouncedSort(),this.debouncedHighlight())},F.prototype.onModelReset=function(e,t){e.models;t&&_.each(t.previousModels,_.bind(function(e){this.removeView(e)},this)),this.sortedModels=this.getSortedModels(),_.each(this.sortedModels,_.bind(function(e){this.listenTo(e,"change",this.debouncedHighlight)},this)),this.renderInternal(!0),this.debouncedHighlight(),this.onFocusChange(this.viewModel,this.viewModel.get("Basics.Focus"),{forceChange:!0})},F.prototype.onSortOrderChange=function(e,t){(e.changed.Basics.hasOwnProperty("SortOrder")||e.changed.Basics.hasOwnProperty("SortColumn"))&&this.setSorting(t.SortColumn,t.SortOrder)},F.prototype.onPropDrilldown=function(e,i){this.$toggleDrilldown&&this.$toggleDrilldown.find("span").text(i?t("Disable Drilldown"):t("Drilldown")),this.viewModel.get("Basics.Drilldown")&&(this.api.setProperty("Basics.MultipleDrilldown",!1),this.api.setProperty("Basics.ExpandAll",!1)),this.debouncedRenderFooter()},F.prototype.onPropExpandAll=function(e,t){this.api.setProperty("Basics.MultipleDrilldown",t),this.renderHeader()},F.prototype.onPropMultipleDrilldown=function(e,t){var i=this.viewModel.get("Basics.MultipleDrilldown");i?(this.viewModel.set("Basics.Drilldown",!1),this.api.setProperty("Basics.Drilldown",!1)):this.api.setProperty("Basics.ExpandAll",!1),this.$toggleDrilldown.toggle(!i)},F.prototype.onPropShowTools=function(e,t){this.toggleFilters(!1)},F.prototype.onRowExpanded=function(e,t){this.parent.onRowExpanded(e,t),this.model.trigger("RefreshHighlights",!0),this.noHeader||this.debouncedUpdateExpandIcons(),!t&&this.sortedModels.length<=0&&this.applyFilters(),this.debouncedRenderFooter()},F.prototype.updateExpandIcons=function(){for(var e=this.$thead.find("div.thi a.expndbl"),t=0;t<this.dataDef.length&&this.dataDef[t].expandable;t++){var i=this.isAllExpanded(t);t<e.length&&e.eq(t).toggleClass("expanded",i),t+1<e.length&&e.eq(t+1).toggle(i)}},F.prototype.processHighlightingOnChildren=function(){this.processMinMaxHighlighting();for(var e=0;e<this.expandedIds.length;e++){var t=this.modelViewDict[this.expandedIds[e]];t instanceof b&&t.expandedDatatable instanceof F&&t.expandedDatatable.processHighlightingOnChildren()}},F.prototype.processMinMaxHighlighting=function(){function l(e){return e&&e instanceof d.Model}var e,r,s=this,t=this.model.models;s.lastSearchValue,e=_.filter(s.dataDef,function(e){return e.columnConfig.HighlightMinValue||e.columnConfig.HighlightMaxValue||e.columnConfig.RangeHighlight}),r=t||s.model.models,_.each(r,function(t){t.setX("isMin",""),t.trigger("isMin"),t.setX("isMax",""),t.trigger("isMax"),_.each(s.dataDef,function(e){e=e.columnConfig.Field;t.trigger("RefreshHighlights",e)})}),e.length&&0<r.length&&_.each(e,function(t){var e,i,o,n=t.columnConfig.Field,a=null;(t.columnConfig.HighlightMinValue||t.columnConfig.RangeHighlight)&&(a=_.minBy(r,function(e){e=e.get(n);return null==e?Number.MAX_VALUE:7===s.getColumnInfo(n).get("kdbType")&&_.isString(e)?parseInt(e,10):void 0!==e.i?e.i:e})),(t.columnConfig.HighlightMaxValue||t.columnConfig.RangeHighlight)&&(e=_.maxBy(r,function(e){e=e.get(n);return null==e?Number.MIN_VALUE:7===s.getColumnInfo(n).get("kdbType")&&_.isString(e)?parseInt(e,10):void 0!==e.i?e.i:e})),t.columnConfig.RangeHighlight&&(i=a&&a instanceof d.Model?a.get(t.columnConfig.Field):void 0,o=e&&e instanceof d.Model?e.get(t.columnConfig.Field):void 0,_.each(r,function(e){e.trigger("HighlightRange",n,t.columnConfig.RangeHighlightColor,i,o,t.columnConfig.InvertRangeColor)})),t.columnConfig.HighlightMinValue&&l(a)&&(a.get("isMin")?-1===a.get("isMin").split(",").indexOf(n)&&a.setX("isMin",a.get("isMin")+","+n):a.setX("isMin",n),a.trigger("isMin")),t.columnConfig.HighlightMaxValue&&l(e)&&(e.get("isMax")?-1===e.get("isMax").split(",").indexOf(n)&&e.setX("isMax",e.get("isMax")+","+n):e.setX("isMax",n),e.trigger("isMax"))})},F.prototype.remove=function(){return _.each(this.model.models,_.bind(function(e){this.removeView(e)},this)),this.renderTable(!0),this.debouncedSort(),this.debouncedHighlight(),this.layoutModule&&this.layoutModule.remove(),d.View.prototype.remove.call(this)},F.prototype.removeView=function(e){var t=b.key(e),i=this.modelViewDict[t];return!!i&&(i.remove(),delete this.modelViewDict[t],this.stopListening(e),!0)},F.prototype.renderFooter=function(){var s=!1;this.debouncedRenderFooter.cancel(),0===this.depth?(this.footerEls=[],this.$tfooter.empty(),_.each(this.dataDef,function(t,e){var i,o,n,a,l=$(document.createElement("div")).addClass("ui-state-default"),r=w.focus2Object(this.viewModel.get("Basics.Focus"));if(t.footer&&"None"!==t.footer){switch(s=!0,o=(n=this.getFooterModels(this,r,[])).map(function(e){return Number(e.get(t.field))}),a=n.map(function(e){return Number(e.get(t.columnConfig.FooterWeights))}),t.footer){case"Average":i=_.mean(o);break;case"Count":i=n.length;break;case"Sum":i=_.sum(o);break;case"WeightedAverage":i=w.sumArrayValues(o.map(function(e,t){return e*a[t]}))/w.sumArrayValues(a)}t.formatterFn&&"Count"!==t.footer&&((r=new d.Model).set(t.field,i),i=t.formatterFn.bind({el:l[0],innerEl:l[0],unsubscribeTemplateViewStates:z.prototype.unsubscribeTemplateViewStates})(t.field,r,t.columnConfig)),l.text(i).attr("title",t.footer)}this.footerEls.push(l),this.$tfooter.append(l)}.bind(this)),s?(this.layoutSection(this.footerEls),this.$el.addClass("has-footer")):this.$el.removeClass("has-footer")):this.parent.renderTopFooter()},F.prototype.renderInternal=function(e,t){var i,o,n,a,l=this,r=0,s=_.clone(this.modelViewDict),d=0,h=[],c=this.viewModel.get("Style.RowHeight"),u=_.fromPairs(_.map(this.expandedIds,function(e){return[e,!0]})),p=this.rowCount(),g=Math.ceil(p*F.OVERDRAW),f=t||this.scrollTop(),m=this.parent.offsetIndex||0;for((e=e&&!this.needsSort)||(this.sortedModels=this.getSortedModels()),v=0;v<this.sortedModels.length;v++){if(a=this.sortedModels[v],0<this.expandedIds.length&&u[n=b.key(a)]&&(i=this.modelViewDict[n])?(i.offsetIndex=m+v,i.renderInternal(e),(r+=i.height())<f-g*p&&(i.el.style.display="none")):r=d+c,f-g*p<=r){o=v;break}d=r}for(var y=Math.min(this.sortedModels.length,o+p+1+2*g),w=!0,v=o;v<y;v++)a=this.sortedModels[v],n=b.key(a),(i=this.modelViewDict[n])?(delete s[n],i.setTop(d),this.setRowColor(i,m+v),0<this.expandedIds.length&&u[n]?(i.offsetIndex=m+v,i.renderInternal(e),this.setRowColor(i,m+v)):this.setRowHeight(i)):(this.modelViewDict[n]=i=this.generateView(a,m+v),0<this.expandedIds.length&&w&&u[n]&&(w=!1),this.setRowColor(i,m+v),i.setTop(d),this.sortedModels[v].setX({cachedHeight:d}),h.push(i.el)),i.$el.css("display",""),d+=i.height(),i.needsSort=!1;var t=_.uniq(this.expandedIds);for(w&&0<this.expandedIds.length&&_.each(t,function(t){var e=_.find(l.sortedModels,function(e){return b.key(e)===t});e&&!l.modelViewDict[t]&&(l.modelViewDict[t]=i=l.generateView(e,m+v),l.setExpandRowByKey(b.key(e),!0),l.setRowColor(i,m+v),i.setTop(e.get("cachedHeight")),h.push(i.el))}),t.forEach(function(e){s[e]?(s[e].el.style.display="none",delete s[e]):l.modelViewDict[e]&&(l.modelViewDict[e].el.style.display="block")},this),_.each(s,_.bind(function(e,t){e.remove(),delete this.modelViewDict[t],this.stopListening(e.model)},this));v<this.sortedModels.length;v++)d+=(i=this.modelViewDict[b.key(this.sortedModels[v])])?i.height():c,i&&i.setTop(d);h.length&&this.$tcontent.append(h),this.renderHeight=d,0!=this.depth?d!==this.cachedHeight&&(this.cachedHeight=d,this.el.style.height=d+"px"):((t=d>this.bodyHeight)!==this.cachedHasScrollbar&&(this.cachedHasScrollbar=t,this.$thead&&this.$thead.toggleClass("has-scrollbar",t),this.$tfooterRoot&&this.$tfooterRoot.toggleClass("has-scrollbar",t),this.debouncedHasScrollChange()),d!==this.cachedHeight&&(this.cachedHeight=d,this.$tcontent[0].style.height=d+"px")),this.setBodyFontStyles(),this.debouncedHighlight(),e||this.debouncedDomSort(),this.trigger("rendered")},F.prototype.renderHeader=function(){var c=this,u=c.viewModel.get("Style.HeaderTextTransformation"),p=c.viewModel.get("Style.HeaderFontWeight"),g=c.viewModel.get("Style.HeaderRowHeight")||0,e=c.viewModel.get("ordering").split(","),f=e[0],m=e[1];c.$theadtr.height(c.getTheadRowHeight()),c.$tbody.css("top",c.getTableBodyHeight()),c.headerEls=[],c.$theadtr.empty(),_.each(c.dataDef,function(e,t){var i,o=$(document.createElement("div")),n=$(document.createElement("div")),a=$(document.createElement("div")),l=$(document.createElement("a")),r=$(document.createElement("i")),s=$(document.createElement("input")),d=e.header,h=e.columnConfig.Tooltip;!e.unsortable&&e.columnConfig.Sortable&&(i=F.SORT_NONE,d===f&&(c.sortDef.index=t,c.sortDef.direction=m),c.sortDef.index===t&&("asc"===c.sortDef.direction?i=F.SORT_ASC:"desc"===c.sortDef.direction&&(i=F.SORT_DESC)),d+='<span class="sort">'+i+"</span>"),l.on(E.clickEvent(),function(e){c.onHeaderClick(e)}),l.addClass("ui-state-default"),l.hover(function(){l.addClass("ui-state-hover")},function(){l.removeClass("ui-state-hover")}),l.css({"text-transform":u,"font-weight":p,height:g+"px","line-height":g+"px"}),l.html(d),l.attr("title",h||e.header),o.addClass("th"),e.class&&o.addClass(e.class),s.attr("name",e.field),s.addClass("filter"),s.height(g-2+"px"),c.useFilterSettings&&c.existingFilters&&c.existingFilters[e.field]&&("string"==typeof(i=c.existingFilters[e.field])&&0<i.length&&(s.val(i),n.addClass("filter-active"))),s.on("keyup",function(e){27===e.keyCode&&$(this).val(""),0<(""+$(this).val()).length?n.addClass("filter-active"):n.removeClass("filter-active"),c.applyFilters()}),r.on(E.clickEvent(),function(){s.val(""),n.removeClass("filter-active"),c.applyFilters()}),r.addClass("clear-filter fa fa-times"),n.addClass("thi"),n.append(a),a.addClass("linkContainer"),a.append(l),c.viewModel.get("Basics.ExpandAll")&&e.expandable&&(l.css("padding-left","18px"),d=$('<a class="expndbl" />'),a.append(d),d.on(E.clickEvent(),function(){c.expandAll(t,!$(this).hasClass("expanded"))}),d.toggle(t<1)),n.append(s),n.append(r),n.append(""),o.append(n),c.headerEls.push(o),c.$theadtr.append(o)}),this.layoutSection(this.headerEls),this.debouncedUpdateExpandIcons()},F.prototype.renderTable=function(e,t){this.renderArgs?(this.renderArgs.noResort=this.renderArgs.noResort&&e,this.renderArgs.scroll=null!=t?t:this.renderArgs.scroll):this.renderArgs={noResort:e,scroll:t}},F.prototype.renderValidate=function(){this.renderArgs&&(this.renderInternal(this.renderArgs.noResort,this.renderArgs.scroll),this.renderArgs=null),window.requestAnimationFrame(this.renderValidate.bind(this))},F.prototype.resize=function(){var e=this,t=this.$scrollfix.scrollTop();this.bodyHeight=this.$tbody.height(),this.layoutSection(this.headerEls),this.layoutRows(this.dataDef),this.layoutSection(this.footerEls),_.defer(function(){e.$scrollfix.scrollTop(t)}),this.isNotVisibleOnData&&(this.renderTable(),this.isNotVisibleOnData=!this.$el.is(":visible"))},F.prototype.rowCount=function(){return 0==this.depth?Math.ceil(this.$tbody.height()/this.viewModel.get("Style.RowHeight")):this.parent.rowCount()},F.prototype.scrollTop=function(){return 0==this.depth?this.scroll:this.parent.scrollTop()},F.prototype.selectCells=function(){var e;this.selected&&(e=this.modelViewDict[this.selected])&&e.selectCells()},F.prototype.setScroll=function(e){var t;0===this.depth?this.$tcontent.parent().scrollTop(e).trigger("scroll"):(t=this.parent.parent).setScroll(t.scroll+e)},F.prototype.expandAll=function(t,i){var o=this;this.isExpandingAll=!0,this.sortedModels.forEach(function(e){var e=b.key(e);0===t?o.onExpanded(o.getPath().concat([e]),i):1<=t&&(null!=(e=o.modelViewDict[e])&&e.expandAll(t-1,i))},this),this.isExpandingAll=!1},F.prototype.isAllExpanded=function(t){var i=this,e=this.sortedModels.map(function(e){return i.modelViewDict[b.key(e)]});return 0<t&&(e=_.filter(e,function(e){return e&&!!e.expandedDatatable})),_.every(e,function(e){return e&&e.isAllExpanded&&e.isAllExpanded(t-1)})},F.prototype.onExpanded=function(e,t){this.parent.onExpanded(e,t)},F.prototype.setExpandRowByKey=function(e,t){var i,o=this.model.get(F.decodeKey(e));o&&(e=this.modelViewDict[b.key(o)],!t&&e instanceof b&&this.clearFilter(e.primaryKey),i=_.findIndex(this.sortedModels,function(e){return e.id===o.id}),!e&&-1<i&&(this.isExpandingAll?this.renderInternal(!1):(i=i*this.viewModel.get("Style.RowHeight"),this.renderInternal(!0,i),this.setScroll(i)),e=this.modelViewDict[b.key(o)]),e instanceof b&&e.expand(t))},F.prototype.setRowHeight=function(e,t){t=t||Number(this.viewModel.get("Style.RowHeight")||0);e.el.style.height=t+"px",e.el.style.lineHeight=t+"px"},F.prototype.setBodyFontStyles=function(){var e=this.viewModel.get("Style.FontFamily"),t=this.viewModel.get("Style.FontSize"),t=/^(\d*\.)?(\d+)$/.test(t)?t+"px":t;this.$tbody.css({"font-size":t,"font-family":e})},F.prototype.setRowColor=function(e,t){t=b.key(e.model)===this.selected&&this.viewModel.get("Selection.RowSelectionMode")&&!e.parent.disableHighlighting?this.viewModel.get("Style.SelectedRowBackgroundColor"):t%2==0?this.viewModel.get("Style.EvenRowBackgroundColorOverride"):this.viewModel.get("Style.OddRowBackgroundColorOverride");(e.datatableRow||e).resetBgColor(t)},F.prototype.toggleFilters=function(e){var i=this.viewModel.get("Style.HeaderRowHeight");e?(this.$el.addClass("show-filters"),this.showingFilters=!0,this.$toggleFilters.find("span").text(t("Hide Filters")),this.$el.find(".filter").height(i-2+"px"),this.$el.find(".filter").prop("disabled",!1)):(this.$el.removeClass("show-filters"),this.showingFilters=!1,this.$toggleFilters.find("span").text(t("Show Filters")),this.clearFilters()),this.$theadtr.height(this.getTheadRowHeight()),this.$tbody.css("top",this.getTableBodyHeight())},F.prototype.updateHeight=function(){this.parent.updateHeight()},F.SORT_ASC='<i class="fa fa-sort-asc"></i>',F.SORT_DESC='<i class="fa fa-sort-desc"></i>',F.SORT_NONE='<i class="fa fa-sort"></i>',F.HEADER_HEIGHT=25,F.OVERDRAW=0,F.downloadSupported="download"in document.createElement("a");var ie,S=F;function F(e){var t=ie.call(this,e)||this,i=(t.showingFilters=!1,t.expandedIds=[],t.scroll=0,t.filters={},t.hasScrollbar=!1,t.footerEls=[],t.headerEls=[],t.modelViewDict={},t);return t.parent=e.parent,t.noHeader=e.noHeader,t.depth=e.depth,t.viewModel=e.viewModel,t.rowData=e.rowData,t.showFilters=e.showFilters,t.api=e.api,t.dataDef=e.dataDef,t.sortDef=e.sortDef||{index:-1,direction:null},t._debouncedSort=_.debounce(t.renderTable,100),t.debouncedSort=function(){i._debouncedSort()},t._debouncedHighlight=_.debounce(t.processMinMaxHighlighting,300),t.debouncedHighlight=function(){i._debouncedHighlight()},t.debouncedDomSort=_.debounce(t.domSort,300),t.debouncedUpdateExpandIcons=_.debounce(t.updateExpandIcons,320),t.debouncedHasScrollChange=_.debounce(t.onHasScrollChange,500),t.debouncedRenderFooter=_.debounce(t.renderFooter,320),t.$el.addClass("data-table"),t.$el.html(L.datatable(!t.noHeader)),0===t.depth&&(t.layoutModule=new ee({api:t.api,table:t,viewModel:t.viewModel})),t.$tbody=t.$el.find(".table-body"),t.$tcontent=t.$el.find(".table-content"),t.$tfooterRoot=t.$el.find(".table-footer"),t.$tfooter=t.$el.find(".table-footer .table-row"),t.$scrollfix=t.$(".scrollfix"),t.$scrollfix.scroll(function(e){i.$thead[0].scrollLeft=e.currentTarget.scrollLeft,i.$tfooterRoot[0].scrollLeft=e.currentTarget.scrollLeft}),t.noHeader||(t.$thead=t.$el.find(".table-header"),t.$theadtr=t.$el.find(".table-header .table-row"),t.$resetFilters=t.$el.find(".reset-filters"),t.$toggleFilters=t.$el.find(".toggle-filters"),t.$toggleDrilldown=t.$el.find(".toggle-drilldown"),!t.showFilters||t.viewModel&&t.viewModel.has("showTools")&&!t.viewModel.get("showTools")||t.$el.addClass("has-tools"),t.$toggleFilters.css("display",t.showFilters?"inline-block":"none"),t.viewModel.get("drilldown")&&t.$toggleDrilldown.find("span").text("Disable Drilldown"),t.onPropMultipleDrilldown(),t.existingFilters=t.api.loadSetting("existingFilters"),t.renderHeader()),t.onModelReset(t.model),t.onPropDrilldown(t.viewModel,t.viewModel.get("Basics.Drilldown")),t.initalizeEvents(),t.renderFooter(),t.setSorting(t.viewModel.get("Basics.SortColumn"),t.viewModel.get("Basics.SortOrder")),window.requestAnimationFrame(t.renderValidate.bind(t)),t}var oe={Name:{title:"Name",type:"string",default:""},Enabled:{type:"boolean",format:"checkbox",default:!0,options:{hidden:!0}},Target:{type:"string",enumSource:"possible_columns",watch:{possible_columns:"root.highlightTargetPossibleValues"},default:"*"},ConditionSource:{title:"Condition Source",type:"string",enumSource:"possible_columns",watch:{possible_columns:"root.highlightColumnsPossibleValues"},default:""},ConditionOperator:{title:"Condition Operator",type:"string",enum:["","contains","starts with","ends with","==","<",">","<=",">=","!=","Fill Left-to-Right","Fill Right-to-Left"],default:""},ConditionValue:{title:"Condition Value",type:"string",default:""},Color:{type:"gradient",options:{noColor:!0},default:""},BackgroundColor:{title:"Background Color",type:"gradient",options:{noColor:!0,gradient:!0},default:""},BorderColor:{title:"Border Color",type:"gradient",options:{noColor:!0},default:""},Icon:{type:"icon",title:"Icon",default:""},IconColor:{title:"Icon Color",type:"gradient",options:{noColor:!0},default:""}},E=(_.each(["Name","Enabled","Target","ConditionSource","ConditionOperator","ConditionValue","Color","BackgroundColor","BorderColor","Icon","IconColor"],function(e,t){oe[e].propertyOrder=1010+t}),h.Tools),M={Trigger:{type:"string",enum:["Click","Double Click","Hover"],default:"Click",title:"Trigger Action",propertyOrder:2}},T={Field:{title:"Data Field Name",type:"customDropdown",default:"",data:"possible_columns",watch:{possible_columns:"root.datatablePossibleColumns"}},DisplayName:{title:"Display Name",type:"string",default:"",watch:{Field:"Field"}},Tooltip:{title:"Header Tooltip",type:"string",default:""},WidthWeight:{title:"Width (relative)",minimum:0,type:"number",default:1},MinWidth:{title:"Min Width (px)",type:"number",default:1},TextAlign:{title:"Text Align",type:"string",enum:["left","center","right"],default:"center"},Sortable:{type:"boolean",format:"checkbox",default:!0},Format:{type:"string",enum:["General","Number","Formatted Number","Smart Number","Date","Time","DateTime","Percentage"],default:"General"},Precision:{type:"number",title:"Precision",format:"number",minimum:0,maximum:10,default:2},HideTrailingZeroes:{type:"boolean",title:"Hide Trailing Zeroes",format:"checkbox",default:!1},Currency:{title:"Currency Symbol",type:"string",enum:["none","USD","GBP","EUR"],default:"none"},DateFormat:{title:"Date Format",type:"string",enum:E.Formats.Date,default:"YYYY-MM-DD"},TimeFormat:{title:"Time Format",type:"string",enum:E.Formats.Time,default:"HH:mm:ss"},HighlightNegative:{type:"boolean",title:"Highlight Negative",format:"checkbox",default:!0},HighlightNegativeColor:{type:"gradient",options:{formatClassName:"attachedToPreviousProperty",noColor:!0,gradient:!1},title:"Negative Color",default:""},HighlightChanges:{type:"boolean",title:"Highlight Changes",format:"checkbox",default:!1},HighlightChangeDuration:{title:"Highlight Change Duration",minimum:50,maximum:1e3,type:"number",step:10,format:"range",default:200},ShowArrowsOnChange:{type:"boolean",title:"Show arrows on Change",format:"checkbox",default:!1},HighlightMinValue:{type:"boolean",title:"Highlight Min Value",format:"checkbox",default:!1},HighlightMinValueColor:{type:"gradient",options:{noColor:!0,gradient:!1,formatClassName:"attachedToPreviousProperty"},title:"Min Value Color",default:""},HighlightMaxValue:{type:"boolean",title:"Highlight Max Value",format:"checkbox",default:!1},HighlightMaxValueColor:{type:"gradient",options:{noColor:!0,gradient:!1,formatClassName:"attachedToPreviousProperty"},title:"Max Value Color",default:""},PercentageColorOverride:{type:"gradient",options:{noColor:!0,gradient:!1},default:"",title:"Percentage Color"},RangeHighlight:{type:"boolean",title:"Range Highlight",format:"checkbox",default:!1},InvertRangeColor:{type:"boolean",title:"Invert Range Color",format:"checkbox",default:!1},RangeHighlightColor:{type:"gradient",options:{noColor:!0,gradient:!1,formatClassName:"attachedToPreviousProperty"},title:"Range Color",default:""},isBreakdown:{type:"boolean",title:"Is Breakdown",format:"checkbox",default:!1,options:{hidden:!0}},Hidden:{type:"boolean",format:"checkbox",default:!1},Footer:{type:"string",enum:["None","Average","Count","Sum","WeightedAverage"],default:"None",options:{enum_titles:["None","Average","Count","Sum","Weighted Average"]}},FooterWeights:{title:"Footer Weights",type:"string",enumSource:"possible_columns",watch:{possible_columns:"root.datatablePossibleColumns"},default:""},Template:{type:"handlebar",data:[],default:"",columnsFieldName:["datatablePossibleColumns","datatablePossibleBreakdownColumns"],templateItems:{values:{type:"object",items:_.keyBy(["thisField","thisValue","thisRawValue"])}}}},k={Field:{title:"Mapped Field Name",type:"string",enumSource:"possible_columns",watch:{possible_columns:"root.datatablePossibleBreakdownColumns"},default:"",options:{hidden:!0}},DisplayName:{title:"Display Name",type:"string",default:""},Tooltip:{title:"Header Tooltip",type:"string",default:""},TextAlign:{title:"Text Align",type:"string",enum:["left","center","right"],default:"center"},Sortable:{type:"boolean",format:"checkbox",default:!0},Format:{type:"string",enum:["General","Number","Formatted Number","Smart Number","Date","Time","DateTime","Percentage"],default:"General"},Precision:{type:"number",title:"Precision",default:2},HideTrailingZeroes:{type:"boolean",title:"Hide Trailing Zeroes",format:"checkbox",default:!1},Currency:{title:"Currency Symbol",type:"string",enum:["none","USD","GBP","EUR"],default:"none"},DateFormat:{title:"Date Format",type:"string",enum:E.Formats.Date,default:"YYYY-MM-DD"},TimeFormat:{title:"Time Format",type:"string",enum:E.Formats.Time,default:"HH:mm:ss"},WidthWeight:{title:"Width (relative)",minimum:0,type:"number",default:1},MinWidth:{title:"Min Width (px)",type:"number",default:1},PercentageColorOverride:{type:"gradient",options:{noColor:!0,gradient:!1},default:"",title:"Percentage Color"},isBreakdown:{type:"boolean",title:"Is Breakdown",format:"checkbox",default:!1,options:{hidden:!0}},NoDisplay:{type:"boolean",title:"Hidden",format:"checkbox",default:!1,options:{hidden:!0}},Template:{type:"handlebar",data:[],default:"",columnsFieldName:["datatablePossibleColumns","datatablePossibleBreakdownColumns"],templateItems:{values:{type:"object",items:_.keyBy(["thisField","thisValue","thisRawValue"])}}}},R=(_.each(["Field","DisplayName","Tooltip","MinWidth","WidthWeight","TextAlign","Sortable","Format","Precision","HideTrailingZeroes","Currency","DateFormat","TimeFormat","HighlightNegative","HighlightNegativeColor","HighlightChanges","HighlightChangeDuration","ShowArrowsOnChange","HighlightMinValue","HighlightMinValueColor","HighlightMaxValue","HighlightMaxValueColor","RangeHighlight","InvertRangeColor","RangeHighlightColor","PercentageColorOverride","Hidden","Footer","FooterWeights","Template"],function(e,t){T[e].propertyOrder=1010+t}),_.each(["Field","DisplayName","Tooltip","MinWidth","WidthWeight","TextAlign","Sortable","Format","Precision","HideTrailingZeroes","Currency","DateFormat","TimeFormat","PercentageColorOverride","NoDisplay","Template"],function(e,t){k[e].propertyOrder=1010+t}),V.getComponentDefinition=function(e){var t,i,o={id:3,componentName:"pivot table",componentDescription:"See results from your data queries.",appKey:"Datatable",listViewThumb:e.websiteUrl+"Images/pivot-table.png",ghostViewThumb:null,buildViewThumb:null,appArgs:{quickStart:[{path:"Basics.Data",message:"populate Data Source"}],json:{version:"4.7.1",Basics:{Focus:"",Drilldown:!0,Data:"",ShowTools:!0,Animate:!0,MultipleDrilldown:!1,ExpandAll:!1,SortColumn:"",SortOrder:"",ScrollValue:""},Selection:{RowSelectionMode:!1,RowSelectionColumn:"",SelectedValue:""},Actions:[],HighlightRules:[],FileExport:{ShowExportCsvButton:!0,ShowExportExcelButton:!0,ShowFullExportButton:!1,FullExportOverride:"",FileName:[]},BreakdownColumnsConfiguration:[],datatablePossibleBreakdownColumns:[],ColumnsConfiguration:[],datatablePossibleColumns:[],Style:{Theme:"Dark",EvenRowBackgroundColorOverride:"#282828",OddRowBackgroundColorOverride:"#303030",SelectedRowBackgroundColor:"",RowHeight:30,HeaderRowHeight:30,HeaderTextTransformation:"none",HeaderFontWeight:"",FontFamily:"",FontSize:"",advanced:""}},schema:{type:"object",title:"Properties",properties:{notificationEvent:{type:"readOnlyArray",items:{type:"string"},default:null,options:{collapsed:!0,hidden:!0}},datatablePossibleColumns:{type:"readOnlyArray",items:{type:"string"},default:[],options:{collapsed:!0,hidden:!0}},highlightTargetPossibleValues:{type:"readOnlyArray",items:{type:"string"},default:[],options:{collapsed:!0,hidden:!0}},highlightColumnsPossibleValues:{type:"readOnlyArray",items:{type:"string"},default:[],options:{collapsed:!0,hidden:!0}},selectedColumnPossibleValues:{type:"readOnlyArray",items:{type:"string"},default:[],options:{collapsed:!0,hidden:!0}},datatablePossibleBreakdownColumns:{type:"readOnlyArray",items:{type:"string"},default:[],options:{collapsed:!0,hidden:!0}},Basics:{type:"object",title:"Basics",options:{collapsed:!1},propertyOrder:10,properties:{Data:{type:"data",title:"Data Source",default:""},Focus:{type:"viewstate",title:"Focus",default:""},Drilldown:{type:"boolean",title:"Drilldown",default:!1,format:"checkbox"},ShowTools:{type:"boolean",title:"Show Tools",default:!0,format:"checkbox"},Animate:{type:"boolean",title:"Animate",default:!0,format:"checkbox"},MultipleDrilldown:{type:"boolean",title:"Multiple Drilldown",default:!1,format:"checkbox"},ExpandAll:{type:"boolean",title:"Expand All",default:!1,format:"checkbox"},SortColumn:{type:"string",title:"Sort Column",enumSource:"possible_selected_columns",watch:{possible_selected_columns:"root.selectedColumnPossibleValues"},default:""},SortOrder:{type:"string",title:"Sort Order",enum:["","descending","ascending"],default:""},ScrollValue:{type:"number",title:"Scroll Value",default:0}}},BreakdownColumnsConfiguration:{type:"array",format:"object",title:"Breakdown Columns",options:{collapsed:!0,reset:!1,resetTooltip:"",disable_array_delete:!0,disable_array_reorder:!0,disable_array_add:!0,bulkEditor:!0},propertyOrder:20,items:{type:"object",title:"breakdown",headerTemplate:"Column {{ i1 }} {{#if self.DisplayName}}{{ self.DisplayName }}{{else}}{{ self.Field }}{{/if}}",options:{collapsed:!0},properties:k}},ColumnsConfiguration:{type:"array",format:"object",title:"Aggregate Columns",options:{collapsed:!0,reset:!0,resetTooltip:"reset column configuration",disable_array_delete:!1,disable_array_reorder:!1,disable_array_add:!1,bulkEditor:!0},propertyOrder:30,items:{type:"object",title:"column",headerTemplate:"Column {{ i1 }} {{#if self.DisplayName}}{{ self.DisplayName }}{{else}}{{ self.Field }}{{/if}}",options:{collapsed:!0},properties:T}},Selection:{type:"object",title:"Selection & Routing",options:{collapsed:!0},propertyOrder:40,properties:{RowSelectionMode:{type:"boolean",title:"Enable Row Selection",default:!1,format:"checkbox"},RowSelectionColumn:{title:"Selected Column",type:"string",enumSource:"possible_selected_columns",watch:{possible_selected_columns:"root.selectedColumnPossibleValues"},default:""},SelectedValue:{type:"viewstate",title:"Selected Value",default:""}}},Actions:{type:"actions",options:{collapsed:!0},fields:{map:_.extend({Current:{propertyOrder:10,title:"Source Column",type:"string",enumSource:"possible_selected_columns",watch:{possible_selected_columns:"root.highlightColumnsPossibleValues"}}},M),nav:M,query:M,url:M}},HighlightRules:{type:"array",format:"object",title:"Highlight Rules",options:{hidden:!1,collapsed:!0},items:{type:"object",title:"Rule",headerTemplate:"Rule {{ i1 }} {{self.Name}}",options:{collapsed:!0},properties:oe}},FileExport:{type:"object",title:"File Export",options:{collapsed:!0},properties:{ShowExportCsvButton:{type:"boolean",title:"Show Export Csv Button",default:!0,format:"checkbox"},ShowExportExcelButton:{type:"boolean",title:"Show Export Excel Button",default:!1,format:"checkbox"},ShowFullExportButton:{type:"boolean",title:"Show Full Export Button",default:!1,format:"checkbox"},FullExportOverride:{type:"data",title:"Full Export Override",default:""},FileName:{type:"array",format:"table",title:"FileName",options:{hidden:!1,collapsed:!0},items:{type:"object",title:"Filename Part",options:{collapsed:!0},properties:{FileNamePart:{title:"FileName Part",type:"string"}}}}}},Style:{type:"object",title:"Style",options:{collapsed:!0},propertyOrder:50,properties:{Theme:{type:"string",title:"Theme",default:"Dark",options:{hidden:!0},enum:["Light","Dark"]},DashboardTheme:{options:{hidden:!0}},EvenRowBackgroundColorOverride:{type:"gradient",options:{noColor:!1,gradient:!1},default:"#282828",title:"Even Row Background"},OddRowBackgroundColorOverride:{type:"gradient",options:{noColor:!1,gradient:!1},default:"#303030",title:"Odd Row Background"},SelectedRowBackgroundColor:{type:"gradient",options:{noColor:!0,gradient:!1},default:"#505050",title:"Selected Row Background"},RowHeight:{type:"number",format:"number",title:"Row Height",default:30},HeaderRowHeight:{type:"number",format:"number",title:"Header Row Height",default:30},HeaderTextTransformation:{title:"Header Text Transformation",type:"string",enum:["uppercase","lowercase","capitalize","none"]},HeaderFontWeight:{title:"Header Font Weight",type:"string",enum:["","normal","bold"],default:""},FontFamily:{title:"Font Family",type:"string",enum:["","Arial, Helvetica, sans-serif",'"Courier New", Courier, monospace',"Tahoma, Geneva, sans-serif",'"Times New Roman", Times, serif',"Verdana, Geneva, sans-serif"],default:""},FontSize:{title:"Font Size",type:"string",default:""},advanced:{type:"css",title:"Advanced CSS",default:""}}}}}}};if(e.settingsModel&&0<_.keys(e.settingsModel.attributes).length)for(i=V.upgrades.indexOf(_.find(V.upgrades,{version:e.settingsModel.get("version")}))+1;i<V.upgrades.length;i+=1)(t=V.upgrades[i]).fn(e.settingsModel),e.settingsModel.set("version",t.version);return o},V.defaults=function(){return V.getComponentDefinition({settingsModel:new d.Model}).appArgs.json},V);function V(){}R.upgrades=[{version:"4.0.0_d10",fn:function(e){e.set("Selection.RowSelectionMode",e.get("Basics.RowSelectionMode")),e.set("Selection.RowSelectionColumn",e.get("Basics.RowSelectionColumn")),e.set("Selection.SelectedValue",e.get("Basics.Selected")),e.unset("Basics.RowSelectionMode"),e.unset("Basics.RowSelectionColumn"),e.unset("Basics.Selected"),e.set("Style",_.extend({},R.defaults().Style,e.get("Style"))),e.set("Basics",_.extend({},R.defaults().Basics,e.get("Basics"))),e.set("Selection.SelectedObjectRouting",[]),e.set("FileExport",$.extend(!0,{},R.defaults().FileExport)),e.set("FileExport.ShowExportCsvButton",e.get("Basics.ShowTools"))}},{version:"4.0.0_p1",fn:function(e){e.set("FileExport.ShowFullExportButton",!1)}},{version:"4.0.0_p2",fn:function(e){var t=[];_.each(e.get("ColumnsConfiguration"),function(e){e.Hidden=!1,t.push(e)}),e.set({ColumnsConfiguration:t})}},{version:"4.0.0_p2a",fn:function(e){_.each(e.get("ColumnsConfiguration"),function(e){"#606060"===e.PercentageColorOverride&&(e.PercentageColorOverride="")})}},{version:"4.0.2",fn:function(e){e.set("Basics.MultipleDrilldown",!1)}},{version:"4.0.2s1",fn:function(e){e.set("Basics.ExpandAll",!1)}},{version:"4.0.2d1",fn:function(e){_.each(e.get("ColumnsConfiguration"),function(e){"#ff0000"===e.HighlightNegativeColor&&(e.HighlightNegativeColor=""),"#ff0000"===e.HighlightMinValueColor&&(e.HighlightMinValueColor=""),"#ff0000"===e.HighlightMaxValueColor&&(e.HighlightMaxValueColor=""),"#6898aa"===e.RangeHighlightColor&&(e.RangeHighlightColor="")})}},{version:"4.0.2t9",fn:function(e){_.each(e.get("ColumnsConfiguration"),function(e){e.MinWidth=""})}},{version:"4.0.2t10",fn:function(e){_.each(e.get("BreakdownColumnsConfiguration"),function(e){e.MinWidth=""})}},{version:"4.2.0",fn:function(e){_.each(e.get("ColumnsConfiguration"),function(e){e.Footer="None"})}},{version:"4.2.0d3",fn:function(e){e.set("Basics.SortOrder",""),e.set("Basics.SortColumn","")}},{version:"4.2.0d4",fn:function(e){e.set("Style.FontFamily",""),e.set("Style.FontSize","")}},{version:"4.3.0",fn:function(e){_.each(e.get("ColumnsConfiguration"),function(e){e.FooterWeights=""})}},{version:"4.3.0s2",fn:function(e){e.set("Basics.ScrollValue",0)}},{version:"4.3.0s5",fn:function(e){var t;e.get("Actions")||(t=e.get("Selection.SelectedObjectRouting"))&&(t=_.map(t,function(e){return{_Type:"map",Trigger:"Click",Current:e.ColumnProperty,Target:e.ViewstateProperty}}),e.set("Actions",t),e.unset("Selection.SelectedObjectRouting"))}},{version:"4.3.1s1",fn:function(e){e.get("HighlightRules")||e.set("HighlightRules",[])}},{version:"4.4.1",fn:function(e){e.get("FileExport.ShowFullExportButton")||e.set("FileExport.ShowFullExportButton",!1)}},{version:"4.5.0",fn:function(e){_.each(e.get("BreakdownColumnsConfiguration"),function(e){_.has(e,"Template")||(e.Template="")}),_.each(e.get("ColumnsConfiguration"),function(e){_.has(e,"Template")||(e.Template="")})}},{version:"4.5.0a",fn:function(o){var n=h.Tools.getDefaultThemeColors("Light"),a=["Style.EvenRowBackgroundColorOverride","Style.OddRowBackgroundColorOverride","Style.SelectedRowBackgroundColor"];_.forEach(["#f0f0f0","#e0e0e0","#c8c8c8"],function(e,t){var i=a[t];o.get(i)===e&&o.set(i,n[t])})}},{version:"4.7.0",fn:function(e){_.each(e.get("ColumnsConfiguration"),function(e){e.InvertRangeColor||(e.InvertRangeColor=!1)})}},{version:"4.7.1",fn:function(e){e=e.get("FileExport");_.isNil(e.FullExportOverride)&&(e.FullExportOverride="")}}];ne.getRegex=function(e){var t,i=/\/[gimsuy]*$/,e=e.Field,o=!1;if(0===e.indexOf("/")){var o=!0,n=e.substring(1).replace(i,""),i=e.match(i),i=i?i[0].substring(1):"";try{t=new RegExp(n,i)}catch(e){h.Log.Error("PivotTable: invalid regex.",e),t=new RegExp("^$")}}else t=new RegExp("^"+e.replace(/\*/g,"(.*)")+"$","i");return{isExact:o,regex:t}},ne.isDynamic=function(e){e=e.Field||"";return 0===e.indexOf("/")||0<=e.indexOf("*")};var H=ne;function ne(){}e(B,ae=W),B.prototype.initialize=function(){},B.prototype.convertValueIfNecessary=function(e){return E.isKDBTemporal(e)?E.convertKDBTemporalToMoment(e).toDashString():e},B.prototype.isSelected=function(e){var t;return!!e&&(t=this.app.viewModel.get("Selection.RowSelectionColumn"),e=this.convertValueIfNecessary(e[t]),!_.isUndefined(e)&&e==this.app.viewModel.get("Selection.SelectedValue"))},B.prototype.onRowSelected=function(e){var t,i=this,o=i.app.viewModel.get("Selection.RowSelectionColumn");e&&i.app.viewModel.get("Selection.RowSelectionMode")?(i.selectedRowObject=e,i.trigger_selectedRowChanged(),i.doActions(e),i.ignoreSelectingRows||(i.ignoreSelectingRows=!0,t=i.app.api.getPropertyMeta?i.app.api.getPropertyMeta("Selection.SelectedValue"):i.app.api.getProperty("Selection.SelectedValue"),e=i.convertValueIfNecessary(e[o]),t&&"list"===t.viewstateType?i.app.api.setProperty("Selection.SelectedValue",[e]):i.app.api.setProperty("Selection.SelectedValue",e),i.ignoreSelectingRows=!1)):(i.selectedRowObject=null,i.trigger_selectedRowChanged())},B.prototype.doActions=function(a,l){var r=this,s=(void 0===l&&(l="Click"),[]);this.app.viewModel.get("Actions").forEach(function(e,t){var i,o,n=e.Current;"{breakdownId}"===n&&(n=r.app.primaryKey,i=(o=r.app.viewModel.get("Basics")).Data,o=o.Focus,o=_.isEmpty(o)?0:_.first(w.focus2Array(o)).length,i.dataSet&&i.dataSet.breakdownColumns&&(n=i.dataSet.breakdownColumns[o])),e.Trigger===l&&s.push(y(y({},e),{_PropertyIndex:t,Value:a?a[n]:null}))}),s.length&&this.app.api.doActions(s,"Actions")},B.prototype.remove=function(){this.stopListening()},B.prototype.trigger_selectedRowChanged=function(){this.app.trigger("selectedRowChanged",this.selectedRowObject)};var ae,le=B;function B(e){var t=ae.call(this)||this;return t.app=e,t.initialize(),t}e(P,re=W),P.prototype.initializeEvents=function(){this.listenTo(this.app.viewModel,"change:Style.Theme",this.onThemeChanged),this.listenTo(this.app.viewModel," change:Style.RowHeight change:Style.SelectedRowBackgroundColor change:Style.EvenRowBackgroundColorOverride change:Style.OddRowBackgroundColorOverride change:Style.FontFamily change:Style.FontSize",this.onPropStyleRenderChange),this.listenTo(this.app.viewModel," change:Style.HeaderRowHeight change:Style.HeaderTextTransformation change:Style.HeaderFontWeight",this.onPropHeaderStyleRenderChange)},P.prototype.onPropHeaderStyleRenderChange=function(){this.app.datatableView&&this.app.datatableView.renderHeader()},P.prototype.onPropStyleRenderChange=function(){this.app.datatableView&&!this.suspendPropStyleRenderChange&&this.app.datatableView.renderTable(!0)},P.prototype.onThemeChanged=function(){var e,t,o=this,n=!1,a=this.app.viewModel.get("theme"),i=(this.currentTheme&&this.app.$el.removeClass(this.currentTheme),this.currentTheme=a,this.app.$el.addClass(this.currentTheme),[i=this.app.api&&this.app.api.getProperty("Style.EvenRowBackgroundColorOverride")?this.app.api.getProperty("Style.EvenRowBackgroundColorOverride"):i,e=this.app.api&&this.app.api.getProperty("Style.OddRowBackgroundColorOverride")?this.app.api.getProperty("Style.OddRowBackgroundColorOverride"):e,t=this.app.api&&this.app.api.getProperty("Style.SelectedRowBackgroundColor")?this.app.api.getProperty("Style.SelectedRowBackgroundColor"):t]),l=["Style.EvenRowBackgroundColorOverride","Style.OddRowBackgroundColorOverride","Style.SelectedRowBackgroundColor"],r=h.Tools.getDefaultThemeColors("Light"),s=h.Tools.getDefaultThemeColors("Dark");_.forEach(i,function(e,t){var i;"Light"!==a||e&&e!==s[t]?"Dark"!==a||e&&e!==r[t]||(i=s[t]):i=r[t],i&&(n=!0,o.suspendPropStyleRenderChange=!0,o.app.api.setProperty(l[t],i),o.suspendPropStyleRenderChange=!1)}),n&&this.onPropStyleRenderChange()},P.prototype.remove=function(){this.stopListening()},P.prototype.setTheme=function(){var e=this.app.viewModel.get("Style.Theme")||"Dark";this.app.options.dashboardViewModel.get("DashboardTheme")&&(e=this.app.options.dashboardViewModel.get("DashboardTheme")),this.app.viewModel.set("theme",e),this.onThemeChanged()},P.DEFAULT_DARK_EVEN_COLOR="#282828",P.DEFAULT_DARK_ODD_COLOR="#303030",P.DEFAULT_DARK_SELECTED_COLOR="#505050",P.DEFAULT_LIGHT_EVEN_COLOR="#ffffff",P.DEFAULT_LIGHT_ODD_COLOR="#f4f4f4",P.DEFAULT_LIGHT_SELECTED_COLOR="#cecece";var re,se=P;function P(e){var t=re.call(this)||this;return t.app=e,t.setTheme(),t}de=d.View,e(A,de),A.prototype.initializeEvents=function(){this.themeModule.initializeEvents(),this.listenTo(this.viewModel,"change:Basics.Data",this.onPropDataSourceChanged),this.listenTo(this.viewModel,"change:Basics.Drilldown",this.onPropDrillDownChanged),this.listenTo(this.viewModel,"change:Basics.ShowTools",this.onPropShowToolsChanged),this.listenTo(this.viewModel,"change:Basics.Animate",this.onPropAnimateChange),this.listenTo(this.viewModel,"change:notificationEvent",function(){this.resetLayout(),this.model&&this.columnInfo&&this.initColumnConfig()}.bind(this)),this.listenTo(this.viewModel,"change:BreakdownColumnsConfiguration change:ColumnsConfiguration",this.renderDataViews),this.listenTo(this.viewModel,"change:Basics.ScrollValue",this.onScrollValueChanged),this.listenTo(this,"rowDoubleClicked",function(e){this.selectionModule.doActions(e.model.toJSON(),"Double Click")}),this.listenTo(this,"rowMouseEntered",function(e){this.selectionModule.doActions(e.model.toJSON(),"Hover")})},A.prototype.addDatatableView=function(){var i=this,e=(this.calculateRowDataDepth(),document.createElement("div"));this.$el.append(e),this.datatableView=new S({el:e,model:this.collection,viewModel:this.viewModel,dataDef:this.dataDef,offsetIndex:0,parent:this,api:this.api,selectAPI:this,depth:0,rowData:this.rowData,sortDef:{index:-1,direction:null},showFilters:!0}),this.datatableView.$tcontent.parent()[0].addEventListener("scroll",function(e){i.scrollPending||(i.scrollPending=!0,window.requestAnimationFrame(function(){i.onScrollChange()}))}),this.onPropAnimateChange(),_.defer(function(){i.onResize()}),this.listenTo(this.datatableView,"sortingChanged",function(e){i.trigger("sortingChanged",e)}),this.listenTo(this.datatableView,"rowSelected",function(e){i.onRowSelected(e.model.toJSON()),i.datatableView.renderTable(!1)}),this.listenTo(this.datatableView,"rowUnselected",function(e){i.selectionModule.doActions(null),i.datatableView.renderTable(!1)}),this.onRowExpanded(),this.debouncedScrollInit=_.debounce(function(){var e,t;i.datatableView.noHeader||(i.datatableView.useFilterSettings=!0,i.datatableView.renderHeader(),_.isEmpty(i.datatableView.existingFilters)||(e=i.datatableView.dataDef.filter(function(e){return!e.hidden}).map(function(e){return e.field}),t=_.keys(i.datatableView.existingFilters),0<_.intersection(e,t).length?(i.datatableView.toggleFilters(!0),i.datatableView.applyFilters()):i.datatableView.saveFilterSettings(null))),i.onScrollValueChanged(),i.stopListening(i.datatableView,"rendered",i.debouncedScrollInit)},500),this.listenTo(this.datatableView,"rendered",this.debouncedScrollInit)},A.prototype.calculateRowDataDepth=function(){for(var e=this.rowData,t=0;e;)e=e.rowData,t+=1;return t},A.prototype.initColumnConfig=function(){var t,i,o,n,e=this,a=_.map(this.columnInfo.models,"id"),l=this.api.getProperty("datatablePossibleColumns"),r=this.viewModel.get("ColumnsConfiguration"),s=this.viewModel.get("BreakdownColumnsConfiguration"),d=_.map(s,"Field"),h=this.getBreakdownColumns()||[],a=_.difference(a,h),c=h.length&&!_.isEqual(d,h);c&&this.initialBreakdownApplied&&(this.initialBreakdownApplied=!0,this.normaliseFocusAgainstBreakdown(h,d)),d=a.length&&(a.length!==l.length||!_.isEqual(a.sort(),l.sort())),(c||d)&&(this.api.setProperty("datatablePossibleColumns",a),this.api.setProperty("selectedColumnPossibleValues",_.union(h,a)),this.api.setProperty("highlightTargetPossibleValues",_.union(h,a,["*"])),this.api.setProperty("datatablePossibleBreakdownColumns",h),this.api.setProperty("highlightColumnsPossibleValues",_.union(["{breakdownId}"],h,a))),this.api.getProperty("highlightTargetPossibleValues")&&0!=this.api.getProperty("highlightTargetPossibleValues").length||this.api.setProperty("highlightTargetPossibleValues",_.union(h,a,["*"])),this.api.getProperty("highlightColumnsPossibleValues")&&0!=this.api.getProperty("highlightColumnsPossibleValues").length||this.api.setProperty("highlightColumnsPossibleValues",_.union(["{breakdownId}"],h,a)),d&&(d=_.difference(a,l),t=_.difference(l,a),n=[],d.length&&(i={},o=[],_.each(r,function(e){H.isDynamic(e)?o.push(H.getRegex(e).regex):i[e.Field]=!0}),_.each(d,function(t){!i[t]&&!_.some(o,function(e){return e.test(t)})&&n.push(e.generateColumnConfig(t,!1))})),n=_.uniqBy(n,function(e){return e.Field}),this.viewModel.set("ColumnsConfiguration",(l=function(e){return _.filter(e,function(e){return!t.includes(e.Field)}).concat(n)})(this.viewModel.get("ColumnsConfiguration")),{silent:!0}),this.api.setProperty("ColumnsConfiguration",l(this.api.getProperty("ColumnsConfiguration")))),c&&(n=_.map(h,_.bind(function(e){return _.find(s,{Field:e})||this.generateColumnConfig(e,!0)},this)),this.viewModel.set("BreakdownColumnsConfiguration",n,{silent:!0}),this.api.setProperty("BreakdownColumnsConfiguration",n)),this.renderDataViews()},A.prototype.applyDataProperty=function(){var e,i=this.viewModel.get("Basics.Data");this.model&&(this.stopListening(this.model),this.api.unsubscribe(this.model),this.model=null,this.resetLayout()),this.model=i,this.model&&this.model.attributes?((e=function(e,t){t?this.api.showQueryStatus(t):this.api.hideQueryStatus()}.bind(this))(this.model,this.model.get("queryStatus")),this.listenTo(this.model,"change:queryStatus",e),this.api.subscribe(this.model,$.proxy(this.onData,this))):this.api.showQueryStatus({message:t('Invalid Data Source: "')+i.path+'" '+t("selected"),type:"Warning"},this.model)},A.prototype.configToSpec=function(e,t,i){return(e=e||(i?this.generateObjectFromSchema(k):this.generateObjectFromSchema(T))).isBreakdown=i,{header:e.DisplayName||e.Field||t,field:e.Field||t,columnConfig:e,width:e.WidthWeight||0,hidden:!1,footer:e.Footer}},A.prototype.generateColumnConfig=function(e,t){var i=t?this.generateObjectFromSchema(k):this.generateObjectFromSchema(T),t=this.columnInfo.get(e),o="General",n="center",t=t?t.get("kdbType"):null;switch(t){case 4:case 5:case 6:o="Number",i.Precision=0;break;case 7:o="Formatted Number",i.Precision=0;break;case 8:case 9:o="Formatted Number",i.Precision=4;break;case 12:o="DateTime",i.TimeFormat="HH:mm:ss.SSS";break;case 13:o="Date",i.DateFormat="YYYY-MM";break;case 14:o="Date";break;case 15:o="DateTime";break;case 16:o="Time",i.TimeFormat="HH:mm:ss.SSS";break;case 17:o="Time",i.TimeFormat="HH:mm";break;case 18:o="Time";break;case 19:o="Time",i.TimeFormat="HH:mm:ss.SSS";break;case 11:case 1001:n="left"}return(4<=t&&t<=9||12<=t&&t<=19)&&(n="right"),i.Field=e,i.DisplayName=e,i.Format=o,i.TextAlign=n,i},A.prototype.generateObjectFromSchema=function(t){return $.extend(!0,{},_.chain(_.keys(t)).map(function(e){return[e,t[e].default]}).fromPairs().value())},A.prototype.getAggregateColumns=function(){var e=_.map(this.columnInfo.models,function(e){return e.id});return this.isPivot()?_.difference(e,this.getBreakdownColumns()):e.slice(1)},A.prototype.getBreakdownColumns=function(){var e;return this.isPivot()?this.viewModel.get("breakdownColumns"):(e=_.first(this.columnInfo.models))?[e.id]:null},A.prototype.getAggregateConfig=function(){var n=this,a=this.getAggregateColumns(),e=_.filter(this.viewModel.get("ColumnsConfiguration"),{Hidden:!1}),l=[];return e.forEach(function(e){for(var t=H.isDynamic(e),i=H.getRegex(e).regex,o=0;o<a.length;o++)a[o]!==_.get(e,"Field")&&!a[o].match(i)||(l.push(n.configToSpec(t?_.extend({},e,{DisplayName:a[o],Field:a[o]}):e,a[o],!1)),a.splice(o,1),o--)}),l},A.prototype.getBreakdownConfig=function(){var i=this,o=this.viewModel.get("BreakdownColumnsConfiguration");return _.map(this.getBreakdownColumns(),function(e){var t=_.find(o,{Field:e});return i.configToSpec(t,e,!0)})},A.prototype.getColumnInfo=function(e){return this.columnInfo.get(e)},A.prototype.getPath=function(){return[]},A.prototype.isPivot=function(){return this.model&&("pivot"===this.model.get("_dataType")||this.model.get("_pivotType"))&&this.viewModel.get("breakdownColumns")&&1<this.viewModel.get("breakdownColumns").length},A.prototype.normaliseFocusAgainstBreakdown=function(e,i){var o,t=this.viewModel.get("Basics.Focus"),n=0;e&&e.length&&_.find(e,function(e,t){if(!(t<i.length&&e===i[t]))return!0;n++}),(e=t&&_.isString(t)&&"["==t[0]&&"]"==t[t.length-1]?(o=t.match(/"(.*?)"/g),_.each(o,function(e,t){e=(e=e.replace(/"/g,""))&&_.isString(e)?e.split(","):[];n=Math.min(e.length,n),o[t]='"'+e.slice(0,n).join(",")+'"'}),"["+o.join(",")+"]"):(e=t&&_.isString(t)?t.split(","):[],n=Math.min(e.length,n),e.slice(0,n).join(",")))!==t&&(this.viewModel.set("Basics.Focus",e,{silent:!0}),this.api.setProperty("Basics.Focus",e),console.log(e))},A.prototype.onData=function(e,t,i){var o=this,n=!1,a=e.columns;i?this.api.showQueryStatus(i):(this.api.hideQueryStatus(),e.primaryKey!==this.primaryKey&&(this.primaryKey=e.primaryKey,this.collection.reset(),this.collection=new(E.createPivotCollectionFunc(this.primaryKey)),n=!0),a.reset?this.columnInfo.reset(a.reset):(this.columnInfo.remove(_.map(a.remove,function(e){return e.id})),this.columnInfo.add(a.add),this.columnInfo.add(a.change,{merge:!0})),n=n||_.some(["add","remove","reset","change"],function(e){return void 0!==a[e]}),this.columnInfo.sort(),!n&&""+this.viewModel.get("breakdownColumns")==""+e.breakdownColumns||(this.viewModel.set("breakdownColumns",e.breakdownColumns),this.initColumnConfig()),t.reset?this.collection.reset(t.reset):(this.collection.remove(_.map(t.remove,function(e){return e[o.primaryKey]})),this.collection.add(t.add),this.collection.add(t.change,{merge:!0})),this.datatableView&&(this.datatableView.applyFilters(),this.datatableView.renderFooter(),this.datatableView.isNotVisibleOnData=!this.$el.is(":visible")))},A.prototype.onPropAnimateChange=function(){this.datatableView&&this.datatableView.$el.toggleClass("animate",0!=this.viewModel.get("Basics.Animate"))},A.prototype.onPropDataSourceChanged=function(){var e=this;e.viewModel.get("Basics.Data");e.viewModel.set({columns:"",columnsConfig:""},{silent:!0}),e.api.setProperty("ColumnsConfiguration",[]),e.api.setProperty("datatablePossibleColumns",[]),e.applyDataProperty()},A.prototype.onPropDrillDownChanged=function(){this.datatableView&&(this.datatableView.renderTable(!1),this.onRowExpanded(),this.datatableView.debouncedHighlight())},A.prototype.onPropShowToolsChanged=function(){var e=this.viewModel.get("Basics.ShowTools");this.datatableView&&(e?this.datatableView.$el.addClass("has-tools"):(this.datatableView.$el.removeClass("has-tools"),this.datatableView.clearFilters(),this.datatableView.toggleFilters(!1),this.datatableView.renderTable()))},A.prototype.onRowExpanded=function(){var o,n=this,a=0;if(w.focus2Array(this.viewModel.get("Basics.Focus")).forEach(function(e){var t,i=n.datatableView;for(o=0;o<e.length;o++)i&&(a=Math.max(a,o),(t=i.modelViewDict[""+e[o]])&&(i=t.expandedDatatable));i&&(a=Math.max(a,o))},this),this.viewModel.get("Basics.Drilldown"))for(o=0;o<this.getBreakdownColumns().length;o++)this.dataDef[o].hidden=o<a||a<o;else for(o=0;o<this.getBreakdownColumns().length;o++)this.dataDef[o].hidden=a<o;this.datatableView&&(this.datatableView.layoutSection(this.datatableView.headerEls),this.datatableView.layoutRows(this.dataDef),this.datatableView.layoutSection(this.datatableView.footerEls),this.datatableView.renderTable(!1))},A.prototype.onRowSelected=function(e){this.selectionModule.onRowSelected(e)},A.prototype.onResize=function(){var e;this.datatableView&&(e=this.viewModel.get("Basics.Animate"),this.viewModel.set("Basics.Animate",!1),this.datatableView.resize(),this.viewModel.set("Basics.Animate",e))},A.prototype.onScrollChange=function(){var e;this.datatableView?(this.scrollPending=!1,e=this.datatableView.$tcontent.parent()[0].scrollTop,this.datatableView.scroll!==e&&(this.datatableView.scroll=e,this.datatableView.renderTable(!0),this.viewModel.set("Basics.ScrollValue",e))):window.requestAnimationFrame(this.onScrollChange.bind(this))},A.prototype.onScrollValueChanged=function(){var e,t;this.viewModel&&this.datatableView&&(e=this.viewModel.get("Basics.ScrollValue"),t=this.datatableView.$tcontent.parent()[0].scrollTop,this.datatableView.$tcontent.parent()[0].scrollHeight>this.datatableView.$tcontent.parent()[0].clientHeight&&(this.datatableView.renderTable(!0,e),t!==e&&(this.datatableView.$tcontent.parent()[0].scrollTop=e),this.api.setProperty("Basics.ScrollValue",e)))},A.prototype.onSettingsChange=function(e){_.each(e,_.bind(function(e,t){this.viewModel.set(t,e)},this)),this.hasInit||(this.hasInit=!0,this.applyDataProperty(),this.initializeEvents());var t,i=RegExp(/HighlightRules\.[0-9]*\./);for(t in e)if(e.hasOwnProperty(t)&&i.test(t)){this.datatableView.processHighlightingOnChildren();break}},A.prototype.remove=function(){return this.debouncedScrollInit&&this.debouncedScrollInit.cancel(),this.removeDataView(),this.selectionModule.remove(),this.themeModule.remove(),this.model&&(this.api.unsubscribe(this.model),this.model=null),d.View.prototype.remove.apply(this)},A.prototype.removeDataView=function(){this.datatableView&&(this.datatableView.remove(),delete this.datatableView)},A.prototype.renderDataViews=function(){var e,t,o=this,i=this.getBreakdownConfig();if(this.removeDataView(),this.model){var n=_.without(i.concat(this.getAggregateConfig()),void 0);if(_.each(n,function(e,t){var i=o.columnInfo.get(e.field);o.dataDef[t]=void 0!==o.dataDef[t]?_.extend(o.dataDef[t],e):e,o.dataDef[t].kdbType=i&&_.isFunction(i.get)?i.get("kdbType"):null}),this.dataDef=this.dataDef.slice(0,n.length),!_.isEmpty(this.dataDef)){for(t=0;t<i.length-1;t+=1)this.dataDef[t]&&(this.dataDef[t].expandable=!0);if(this.isPivot())for(e=this.rowData={depth:0,viewModel:this.viewModel},t=1;t<i.length-1;t+=1)e.rowData={depth:t,viewModel:this.viewModel},e=e.rowData;else this.rowData=void 0;this.addDatatableView(),this.onPropShowToolsChanged(),this.onPropAnimateChange()}}},A.prototype.renderTopFooter=function(){},A.prototype.resetLayout=function(){this.removeDataView(),this.api.setProperty("ColumnsConfiguration",[]),this.api.setProperty("BreakdownColumnsConfiguration",[]),this.api.setProperty("datatablePossibleColumns",[]),this.api.setProperty("selectedColumnPossibleValues",[]),this.api.setProperty("datatablePossibleBreakdownColumns",[]),this.viewModel.set({ColumnsConfiguration:[],BreakdownColumnsConfiguration:[],datatablePossibleColumns:[],selectedColumnPossibleValues:[],datatablePossibleBreakdownColumns:[]},{silent:!0})},A.prototype.rowCount=function(){return 0},A.prototype.onExpanded=function(i,o){var n,e=w.focus2Array(this.viewModel.get("Basics.Focus")),e=this.viewModel.get("Basics.MultipleDrilldown")?(e=_.filter(e,function(e){for(var t=0;t<i.length&&t<e.length&&e[t]===i[t];)t++;return t===i.length&&t<=e.length?(n=!0,o):!(t==e.length&&t<i.length)}),o&&!n&&e.push(i),o||e.push(i.slice(0,-1)),1<(e=_.filter(e,function(e){return 0<e.length})).length?"["+_.map(e,function(e){return'"'+_.map(e,function(e){return S.encodeKey(e)}).join(",")+'"'}).join(",")+"]":1===e.length?_.map(e[0],function(e){return S.encodeKey(e)}).join(","):""):(i=o?i:i.slice(0,-1),_.map(i,function(e){return S.encodeKey(e)}).join(","));this.api.setProperty("Basics.Focus",e)},A.prototype.scrollTop=function(){return 0},A.prototype.setTheme=function(){this.themeModule.setTheme()},A.prototype.updateColumnInfo=function(e){e.reset&&(this.columnInfo.reset(e.reset),this.updateDataDef())},A.prototype.updateDataDef=function(){var i=this;_.each(this.dataDef,function(e){var t=i.columnInfo.get(e.field);e.kdbType=t&&_.isFunction(t.get)?t.get("kdbType"):null})},A.prototype.updateHeight=function(){console.log("data:updateHeight"),this.datatableView&&this.datatableView.debouncedSort()},A.getComponentDefinition=R.getComponentDefinition;var de,O=A;function A(e){var t=de.call(this,e)||this;return t.collection=new d.Collection,t.columnInfo=new d.Collection,t.dataDef=[],t.subscriptionKey=_.uniqueId("datatable_"),t.viewModel=new d.DeepModel({ordering:"null,null"}),A.componentApi=e.api,t.columnInfo.comparator="index",t.options=e,t.api=e.api,t.appViewModel=e.viewModel,t.appDataModel=e.dataModel,t.selectionModule=new le(t),t.themeModule=new se(t),t.hasInit=!1,t.initialBreakdownApplied=!1,w.hasCalc()||require(["calc_polyfill"],function(){}),t}return O});