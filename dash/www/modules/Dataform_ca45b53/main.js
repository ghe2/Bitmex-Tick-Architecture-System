define(["backbone","Handlebars","Forms","QuickBase","css!./css/app.css"],function(c,e,h,u){var s={SAMPLE_DATA:"",dataItemTransform:function(a,e,t,s){var o,n;"Data"===t?(t=a.Data,o=a.DataSourceMapping.Value instanceof c.Model,n=a.DataSourceMapping.Text instanceof c.Model,t?t.getMeta(function(e){var e=_.fromPairs(_.map(e.columns.collection.models,function(e){return[e.get("id"),e.toJSON()]})),t=_.keys(e),e=_.find(e,function(e){return 0===e.kdbType||11===e.kdbType}),i=a.DataSourceMapping.DropdownPossibleValues;i&&!_.isEqual(i.sort(),t.sort())&&(a.DataSourceMapping.DropdownPossibleValues=t,a.DropdownPossibleValues=t,o||(a.DataSourceMapping.Value=t[0]||""),n||(a.DataSourceMapping.Text=e&&e.id||t[0]||"")),s(a)}):(a.DataSourceMapping.DropdownPossibleValues=[],a.DropdownPossibleValues=[],o||(a.DataSourceMapping.Value=""),n||(a.DataSourceMapping.Text=""),s(a))):s()},getComponentDefinition:function(e){var t,i,a={id:27,componentName:"Dataform",componentDescription:"See results from your data queries.",appKey:"Dataform",css:"Dataform",listViewThumb:e.websiteUrl+"Images/dataform.png",ghostViewThumb:null,buildViewThumb:null,appArgs:{quickStart:[{path:"Basics.Data",message:"populate Data Source"}],json:{version:"4.6.1P2",isDataform:!0,Basics:{Data:"",SubmitButtonText:"Submit",ValidationAnalytic:"",ExpandDictParameters:!0,ForceExecute:!1,ShowReset:!1,ShowSubmit:!0,FloatSubmit:!0,FloatReset:!1,ViewStates:[],Actions:[]},Style:{minWidth:"",advanced:"",display:"Row",inline:"Top",labelWidth:"",labelPadding:"",labelAlign:"Left",padding:"",verticalSpacing:"",submitOffset:"",resetOffset:"",formMargin:""}},schema:{type:"object",title:"Properties",properties:{isDataform:{type:"boolean",default:!0,options:{hidden:!0}},Basics:{type:"object",title:"Basics",options:{collapsed:!1},properties:{Data:{type:"data",title:"Data Source",default:"",propertyOrder:1},ValidationAnalytic:{type:"data",title:"Validation Analytic",default:"",propertyOrder:2},SubmitButtonText:{type:"string",title:"Submit Button Text",default:"Submit",propertyOrder:3},ExpandDictParameters:{type:"boolean",title:"Expand Dict Parameters",format:"checkbox",default:!0,propertyOrder:4},ForceExecute:{type:"boolean",title:"Force Execute on Submit",format:"checkbox",default:!1,propertyOrder:5},ShowReset:{type:"boolean",title:"Show Reset",format:"checkbox",default:!1,propertyOrder:6},FloatReset:{type:"boolean",title:"Float Reset",format:"checkbox",default:!1,propertyOrder:7},ShowSubmit:{type:"boolean",title:"Show Submit",format:"checkbox",default:!0,propertyOrder:8},FloatSubmit:{type:"boolean",title:"Float Submit",format:"checkbox",default:!0,propertyOrder:9},ViewStates:{title:"ViewState Parameters",type:"array",format:"object",options:{disable_array_add:!0,disable_array_delete:!0,no_additional_properties:!0,disable_collapse:!0},items:{id:"arr_item",title:"ViewState",headerTemplate:"{{#if self.DisplayName.path}}{{ self.DisplayName.path }}{{else if self.DisplayName}}{{ self.DisplayName }}{{else}}ViewState {{i1}}{{/if}}",type:"object",options:{hidden:!1,collapsed:!0,keep_oneof_values:!1},properties:{PathEnc:{type:"string",options:{hidden:!0}},DisplayName:{type:"string",title:"Display Name",propertyOrder:1},HideParameter:{type:"boolean",title:"Hide Parameter",default:!1,format:"checkbox",propertyOrder:2},Tooltip:{type:"string",default:"",propertyOrder:3},FieldType:{id:"FieldType",title:"Parameter Type",type:"object",options:{disable_collapse:!0,keep_oneof_values:!1},propertyOrder:4,_transform:s.dataItemTransform,oneOf:[{id:"Text",title:"Default",type:"object",options:{hidden:!0,collapsed:!0,linked_oneof_property:{property:"_Type",value:"Default"}},properties:{_Type:{type:"string",default:"Default",options:{hidden:!0}},Data:{type:"string",hidden:!0},DataSourceMapping:{type:"object",hidden:!0},Items:{type:"array",hidden:!0},DropdownPossibleValues:{type:"array",hidden:!0}}},{id:"Dropdown",title:"Dropdown",type:"object",options:{hidden:!1,collapsed:!1,linked_oneof_property:{property:"_Type",value:"Dropdown"}},properties:{_Type:{type:"string",default:"Dropdown",options:{hidden:!0}},DropdownPossibleValues:{type:"array",items:{type:"string"},default:[],options:{hidden:!0}},Data:{type:"data",title:"Data Source",default:"",propertyOrder:1},AcceptEmptyValues:{type:"boolean",title:"Accept Empty Values",default:!1,format:"checkbox",propertyOrder:3},ForceSelect:{type:"boolean",title:"Force Selected Value",default:!1,format:"checkbox",propertyOrder:4},MultiSelect:{type:"boolean",title:"Multi-select",default:!1,format:"checkbox",propertyOrder:5},ShowSearch:{type:"boolean",title:"Show Search",default:!1,format:"checkbox",propertyOrder:6},AdvancedSearch:{type:"boolean",title:"Advanced Search",default:!1,format:"checkbox",propertyOrder:7},FieldSummaryThreshold:{title:"Field Summary Threshold",type:"number",default:5,propertyOrder:8},TooltipSummaryThreshold:{title:"Tooltip Summary Threshold",type:"number",default:5,propertyOrder:9},SelectAllValue:{title:"'Select All' Value",type:"string",propertyOrder:10},DataSourceMapping:{type:"object",title:"Data Source Mapping",properties:{Value:{type:"string",enumSource:"possible_values",default:"",watch:{possible_values:"arr_item.FieldType.DropdownPossibleValues"}},Text:{type:"string",enumSource:"possible_values",default:"",watch:{possible_values:"arr_item.FieldType.DropdownPossibleValues"}},DropdownPossibleValues:{type:"array",items:{type:"string"},default:[],options:{hidden:!0}}}},Items:{type:"array",format:"table",title:"Items",uniqueItems:!0,options:{collapsed:!1},items:{type:"object",properties:{Value:{type:"string"},Text:{type:"string"}}}}}},{id:"Password",title:"Password",type:"object",options:{hidden:!0,collapsed:!0,linked_oneof_property:{property:"_Type",value:"Password"}},properties:{_Type:{type:"string",default:"Password",options:{hidden:!0}}}}]}}}},Actions:{type:"actions"}}},Style:{type:"object",title:"Style",options:{collapsed:!0},properties:{advanced:{type:"css",title:"Advanced CSS",default:"",propertyOrder:1},display:{type:"string",title:"Display",enum:["Row","Column"],default:"Row",propertyOrder:2},minWidth:{type:"string",title:"Field Width",default:"",propertyOrder:3},padding:{type:"string",title:"Field Padding",default:"",propertyOrder:4},formMargin:{type:"string",title:"Form Margin",default:"",propertyOrder:5},labelAlign:{type:"string",title:"Label Alignment",enum:["Left","Right"],default:"Left",propertyOrder:6},labelPadding:{type:"string",title:"Label Padding",default:"",propertyOrder:7},inline:{type:"string",title:"Label Positions",enum:["Top","Left"],default:"Top",propertyOrder:8},labelWidth:{type:"string",title:"Label Widths",default:"",propertyOrder:9},resetOffset:{type:"string",title:"Reset Margin",default:"",propertyOrder:11},submitOffset:{type:"string",title:"Submit Margin",default:"",propertyOrder:13},verticalSpacing:{type:"string",title:"Vertical Spacing",default:"",propertyOrder:14}}}}}}};if(e.settingsModel&&0<_.keys(e.settingsModel.attributes).length)for(i=s.upgrades.indexOf(_.find(s.upgrades,{version:e.settingsModel.get("version")}))+1;i<s.upgrades.length;i+=1)(t=s.upgrades[i]).fn(e.settingsModel),e.settingsModel.set("version",t.version);return e.dataModel.getByPath(s.SAMPLE_DATA)&&(a.appArgs.json.Basics.Data=s.SAMPLE_DATA),a},upgrades:[{version:"4.0.0",fn:function(e){_.isUndefined(e.get("Basics.SubmitButtonText"))&&e.set("Basics.SubmitButtonText","Submit")}},{version:"4.4.0",fn:function(e){_.isUndefined(e.get("Basics.SubmitButtonText"))&&e.set("Basics.SubmitButtonText","Submit")}},{version:"4.0.0s1",fn:function(e){_.each(e.get("Basics.ViewStates"),function(e){e.Tooltip=""})}},{version:"4.0.2d1",fn:function(i){var e=i.get("Basics.ViewStates");_.each(e,function(e,t){e.FieldType&&e.FieldType.isDropdown&&!e.FieldType.isDefaultInput&&void 0!==e.FieldType.MultiSelect&&i.set("Basics.ViewStates."+t+".FieldType.ShowRowCount",e.FieldType.MultiSelect)})}},{version:"4.0.3",fn:function(i){var e=i.get("Basics.ViewStates");_.each(e,function(e,t){e.FieldType&&e.FieldType.isDropdown&&!e.FieldType.isDefaultInput&&void 0!==e.FieldType.MultiSelect&&i.unset("Basics.ViewStates."+t+".FieldType.ShowRowCount")})}},{version:"4.1.0",fn:function(e){e.set("Basics.FloatSubmit",!0)}},{version:"4.1.1",fn:function(i){var e=i.get("Basics.ViewStates"),t=i.get("Style");(t=void 0===i.get("Style")?{}:t).minWidth=void 0===t.minWidth?"":t.minWidth,t.labelWidth=void 0===t.labelWidth?"":t.labelWidth,t.labelAlign=void 0===t.labelAlign?"Left":t.labelAlign,t.padding=void 0===t.padding?"":t.padding,t.formMargin=void 0===t.formMargin?"":t.formMargin,t.layout=void 0===t.layout?"default":t.layout,t.verticalSpacing=void 0===t.verticalSpacing?"":t.verticalSpacing,t.submitOffset=void 0===t.submitOffset?"16px 0px 0px 10px":t.submitOffset,t.resetOffset=void 0===t.resetOffset?"16px 0px 0px 10px":t.resetOffset,"inline"===t.layout?t.inlineBlock=!1:t.inlineBlock=!0,i.unset("Style.layout"),t.margin&&i.unset("Style.margin"),i.set("Basics.ValidationAnalytic",""),_.each(e,function(e,t){e.DisplayName||i.set("Basics.ViewStates."+t+".DisplayName","")}),i.set("Basics.FloatReset",!0)}},{version:"4.1.1D2",fn:function(i){var e=i.get("Basics.ViewStates");i.unset("Style.resetAlign"),i.unset("Style.submitAlign"),_.each(e,function(e,t){e.FieldType.DisplayName||i.unset("Basics.ViewStates."+t+".FieldType.DisplayName"),e.FieldType.FieldThresholdSummary||i.set("Basics.ViewStates."+t+".FieldType.FieldThresholdSummary"),e.FieldType.SelectAllValue||i.set("Basics.ViewStates."+t+".FieldType.SelectAllValue"),e.FieldType.ForceSelect||i.set("Basics.ViewStates."+t+".FieldType.ForceSelect",!1)}),i.unset("Style.margin")}},{version:"4.2.0p2",fn:function(i){var e=i.get("Basics.ViewStates");_.each(e,function(e,t){e.FieldType.DisplayName||i.unset("Basics.ViewStates."+t+".FieldType.DisplayName",""),e.FieldType.FieldThresholdSummary||i.set("Basics.ViewStates."+t+".FieldType.FieldThresholdSummary",5),e.FieldType.SelectAllValue||i.set("Basics.ViewStates."+t+".FieldType.SelectAllValue","")}),i.unset("Style.margin")}},{version:"4.2.1",fn:function(i){i.unset("Style.inlineBlock"),_.isUndefined(i.get("Style.display"))&&i.set("Style.display","Row");var e=i.get("Basics.ViewStates");_.each(e,function(e,t){e.FieldType.AcceptEmptyValues||i.set("Basics.ViewStates."+t+".FieldType.AcceptEmptyValues",!1),e.FieldType.ShowSearch||i.set("Basics.ViewStates."+t+".FieldType.ShowSearch",!1),e.FieldType.TooltipSummaryThreshold||i.set("Basics.ViewStates."+t+".FieldType.TooltipSummaryThreshold",5),e.FieldType.FieldSummaryThreshold||(e.FieldType.FieldThresholdSummary?i.set("Basics.ViewStates."+t+".FieldType.FieldSummaryThreshold",e.FieldType.FieldThresholdSummary):i.set("Basics.ViewStates."+t+".FieldType.FieldSummaryThreshold",5)),e.FieldType.FieldSummaryThreshold&&i.unset("Basics.ViewStates."+t+".FieldType.FieldThresholdSummary")})}},{version:"4.3.0",fn:function(i){var e=i.get("Basics.ViewStates");_.each(e,function(e,t){e.FieldType.isDropdown?i.set("Basics.ViewStates."+t+".FieldType._Type","Dropdown"):i.set("Basics.ViewStates."+t+".FieldType._Type","Default"),i.unset("Basics.ViewStates."+t+".FieldType.isDefaultInput"),i.unset("Basics.ViewStates."+t+".FieldType.isDropdown")})}},{version:"4.3.1",fn:function(e){var t=e.get("Basics.SetViewStateOnSubmit.Value"),i=e.get("Basics.SetViewStateOnSubmit.ViewState");t&&i?e.set("Basics.Actions",[{_Type:"map",Current:t,Target:i}]):e.get("Basics.Actions")||e.set("Basics.Actions",[]),e.unset("Basics.SetViewStateOnSubmit")}},{version:"4.5.1",fn:function(i){var e=i.get("Basics.ViewStates");_.each(e,function(e,t){i.unset("Basics.ViewStates."+t+".FieldType.UseDataSource")})}},{version:"4.6.1P2",fn:function(i){var e=i.get("Basics.ViewStates");_.each(e,function(e,t){i.set("Basics.ViewStates."+t+".FieldType.AdvancedSearch",!1)})}}]},l=(n.escapeRegexCharacters=function(e){return e.replace(/[\-\[\]\/\{\}\(\)\+\?\.\\\^\$\|]/g,"\\$&")},n.matchCustom=function(e,t){if(""===$.trim(e.term))return t;if(void 0===t.text)return null;var e=e.term||"",i=t.text||"";return n.isMatch(e.toLowerCase(),i.toLowerCase())?t:null},n.isMatch=function(e,t){var i,a=!1,s=e.split(/ +and +| +/);for(_.includes(s,"or")&&(s=_.without(s,"or"),a=!0),i=0;i<s.length;i++)0!==s[i].indexOf("-")&&s[i].indexOf("*")<0&&(s[i]="*"+s[i]+"*");var o=a||_.every(s,function(e){return 0===e.indexOf("-")});return _[a?"some":"every"](s,function(e){return n.isSimpleMatch(e,t,o)})},n.isSimpleMatch=function(e,t,i){var a=!1;if(i||0!==e.indexOf("-")||(e=e.replace("-",""),a=!0),""===t){if("null"===e||"*null*"===e)return!a}else if("-null"===e)return!0;i=new RegExp("^"+n.escapeRegexCharacters(e).replace(/\*/g,".*")+"$").test(t);return a?!i:i},n);function n(){}function o(e){Object.assign(this,(dataModel=e.dataModel,debouncedApplyViewStateClone=e.debouncedApplyViewStateClone,form=e.form,onSubmit=e.onSubmit,settingsModel=e.settingsModel,viewModel=e.viewModel,viewModelClone=e.viewModelClone,e)),this.style=this.settingsModel.get("Style"),this.initializeEvents(),this.$form=this.form.$el,this.$reset=this.form.$el.find("button.reset"),this.$submit=this.form.$el.find("button[type=submit]"),this.$ulList=this.form.$el.find("fieldset > ul")}function r(e){Object.assign(this,(form=e.form,reapplyButtons=e.reapplyButtons,settingsModel=e.settingsModel,viewModel=e.viewModel,widgetId=e.widgetId,e)),this.customCss,this.$customCss,this.initializeEvents()}var p=function(e){return(e=(e=(e=(e=(e=-1<e.indexOf("/")?e.split("/").pop():e).replace("_"," ")).trim()).replace(/([A-Z])/g," $1")).replace(/^./,function(e){return e.toUpperCase()})).trim()},m=function(e){return decodeURIComponent(e)},g=function(e){return atob(e.replace(/_/g,"+").replace(/-/g,"/"))},f=function(e){return encodeURIComponent(e)},y=function(e){return btoa(e).replace(/\+/g,"_").replace(/\//g,"-").replace(/=/g,"")},d=function(e){return _.isObject(e)&&_.isFunction(e.get)&&e.get("_viewType")},S=function(){return"-ms-scroll-limit"in document.documentElement.style&&"-ms-ime-align"in document.documentElement.style},i=c.Model.extend({initialize:function(){this.schema={},this.listenersByPath={}}});_.extend(o.prototype,c.Events,{applyFloat:function(e){var t,i;e?(t="submit"===e?this.$submit:this.$reset,i=document.createElement("li"),$(i).css("width","inherit"),$(i).addClass("bbf-field"),$(i).addClass(e+"-field"),$(i).append(t),this.$ulList.append(i)):(this.applyFloat("submit"),this.applyFloat("reset"))},buttonOrdering:function(){var e=this.form.$el.find("button:last-child"),t=this.form.$el.find("ul > li:last-child"),i=this.form.$el.find("ul > li.reset-field"),a=this.form.$el.find("ul > li.submit-field");1===i.length&&1===a.length?i.is(t)||(a.detach(),i.detach(),this.$ulList.append(a),this.$ulList.append(i)):1!==this.$reset.length||1!==this.$submit.length||this.$reset.is(e)||(this.$submit.detach(),this.$reset.detach(),this.$form.append(this.$submit),this.$form.append(this.$reset))},initializeEvents:function(){this.listenTo(this.viewModel,"change:Basics.FloatReset",this.onFloatReset),this.listenTo(this.viewModel,"change:Basics.FloatSubmit",this.onFloatSubmit),this.listenTo(this.viewModel,"change:Basics.ShowReset",this.onShowResetChanged),this.listenTo(this.viewModel,"change:Basics.ShowSubmit",this.onShowSubmitChanged),this.listenTo(this.viewModel,"change:Basics.SubmitButtonText",this.onSubmitButtonTextChange)},onFloatReset:function(){var e="Row"===this.style.display?this.viewModel.get("Basics.FloatReset"):!this.viewModel.get("Basics.FloatReset"),t=this.viewModel.get("Basics.ShowReset");e&&t?this.applyFloat("reset"):t&&!e&&this.removeFloat("reset"),this.buttonOrdering()},onFloatSubmit:function(){var e="Row"===this.style.display?this.viewModel.get("Basics.FloatSubmit"):!this.viewModel.get("Basics.FloatSubmit"),t=this.viewModel.get("Basics.ShowSubmit");e&&t?this.applyFloat("submit"):t&&!e&&this.removeFloat("submit"),this.buttonOrdering()},onShowResetChanged:function(){this.viewModel.get("Basics.ShowReset")?(this.$form.addClass("has-reset"),this.onFloatReset()):(this.$form.removeClass("has-reset"),this.removeFloat("reset"))},onShowSubmitChanged:function(){this.viewModel.get("Basics.ShowSubmit")?(this.$form.addClass("has-submit"),this.onFloatSubmit()):(this.$form.removeClass("has-submit"),this.removeFloat("submit")),this.form.off(),this.viewModel.get("Basics.ShowSubmit")?this.form.on("change",function(e){this.form.commit()},this):this.form.on("changeList change",function(e){this.form.commit(),this.debouncedNoSubmit()},this)},onSubmitButtonTextChange:function(){this.$submit.find("span.ui-button-text").html(this.viewModel.get("Basics.SubmitButtonText"))},remove:function(){return this.stopListening(),null},removeFloat:function(e){var e="submit"===e?this.$submit:this.$reset,t=e.parent();t.is(this.$form)||(this.$form.append(e),t.remove())},renderReset:function(){this.$reset.data("uiButton")||this.$reset.button({text:"Reset",icons:{primary:"fa fa-undo"}}).click(function(e){var t;this.dataModel&&(t=this.dataModel.getParameters(),t=_.flatten(_.map(t,function(e){return _.isObject(e.dictParameters)?e.dictParameters:e})),_.each(t,function(e,t){var i,a=y(e.path),e=this.viewModelClone.getByPath(e.path);a&&e&&(i=e.get("_default"),e.get("_rolling")&&(i=u.Helpers.convertRollingToDate(i,e.get("_type"))),e.set("value",i),this.form.fields[a]&&this.form.fields[a].editor.getValue()!==i&&("list"===e.get("_type")?this.form.fields[a].editor.setValue(i,!0):this.form.fields[a].editor.setValue(i)),this.viewModel.get("showSubmit")||this.debouncedApplyViewStateClone())}))}.bind(this)),this.onShowResetChanged()},renderSubmit:function(){this.$submit.data("uiButton")||this.$submit.button({text:this.viewModel.get("Basics.SubmitButtonText"),icons:{primary:"fa fa-check"}}).click(this.onSubmit),this.onShowSubmitChanged()}});return _.extend(r.prototype,c.Events,{applyCustomCss:function(e,t){e?e===this.customCss&&!t||(this.$customCss&&this.$customCss.length?this.$customCss.html(e):this.$customCss=$("<style />",{"data-widgetid":this.widgetId,html:e,type:"text/css"}).appendTo(document.head),this.customCss=e):this.$customCss&&(this.$customCss.remove(),this.$customCss=null,this.customCss=null)},constructRule:function(e,t){if(e){var i,a,s=e.tagName.toLowerCase(),o='[data-widgetid="'+this.widgetId+'"] div.Dataform.app-div > form.bbf-form ',n=("button"!=s&&(o+="> div > fieldset > ul "),e&&0<e.classList.length?(i=s+"."+e.classList.toString().replace(/\ /g,"."),o+=this.trimId(i,s)):e&&(o+=e.tagName.toLowerCase()),o+="{","");for(a in t)t.hasOwnProperty(a)&&!this.isBlank(t[a])&&(n+=a+":"+t[a]+";");return n?o+n+"}":""}return""},initializeEvents:function(){this.listenTo(this.settingsModel,"change:Style",this.setStyle)},isBlank:function(e){return!e||/^\s*$/.test(e)},remove:function(){return this.stopListening(),null},setDictStyle:function(){var e=$(this.el).find('i.fa.dict-button[data-action="add"]');_.each(e,function(e){$(e).closest(".bbf-field").css("margin-bottom","0px")})},setStyle:function(){var e=this.settingsModel.changed,t="",i=this.form.$el.find("div.bbf-editor"),a=(this.form.$el.find("div.bbf-editor > div"),this.form.$el.find("ul[data-fields]")),s=this.form.$el.find(".bbf-field"),o=this.form.$el,n=this.form.$el.find("li.bbf-field > label"),l=this.form.$el.find("button.reset"),r=this.settingsModel.get("Style"),d=this.form.$el.find("button[type=submit]"),c=this.viewModel.get("Basics.FloatSubmit")&&this.viewModel.get("Basics.FloatReset")&&this.viewModel.get("Basics.ShowSubmit")&&this.viewModel.get("Basics.ShowReset");o.toggleClass("bothFloat",c),"Left"===r.inline?(i.toggleClass("fillspace",!1),o.toggleClass("inline-labels",!0),t+=this.constructRule(i[0],{"margin-left":r.labelWidth})):(i.toggleClass("fillspace",!0),o.toggleClass("inline-labels",!1)),_.each(i,function(e){var t=e.childNodes[0].type;"checkbox"===t&&$(e).toggleClass(t,!0)}),"Row"===r.display?(a.toggleClass("flex-row",!0),a.toggleClass("flex-column",!1)):(a.toggleClass("flex-row",!1),a.toggleClass("flex-column",!0)),t=(t=(t=(t+=this.constructRule(s[0],{margin:r.formMargin,width:r.minWidth,padding:r.padding,"margin-bottom":r.verticalSpacing}))+this.constructRule(n[0],{width:"Left"===r.inline?r.labelWidth:"100%","text-align":r.labelAlign&&r.labelAlign.toLowerCase(),padding:r.labelPadding}))+this.constructRule(d[0],{margin:r.submitOffset}))+this.constructRule(l[0],{margin:r.resetOffset}),r.labelWidth||r.minWidth||"Left"!==r.inline||(t=(t+=this.constructRule(i[0],{"margin-left":"50px"}))+this.constructRule(n[0],{width:"50px"})),this.applyCustomCss(t,!0),this.setDictStyle(),"Style"in e&&null!=e.Style.display&&this.reapplyButtons()},trimId:function(e,t){var i=e.replace(/\.field[^\s]+/g,"");return"button"===t&&-1===e.indexOf(".reset")&&(i+='[type="submit"]'),i}}),c.View.extend({hasInit:!1,timeout:2e3,errorTooltip:{},initialize:function(e){this.options=e,this.$el.addClass("Dataform"),this.widgetId=e.widgetId,this.appViewModel=e.viewModel,this.appDataModel=e.dataModel,this.model=new i,this.settingsModel=e.settingsModel,this.viewModel=new c.DeepModel,this.DeltaClientLib=e.DeltaClientLib,this.api=e.api,this.hideErrorMessage=this.api.hideErrorMessage,this.showErrorMessage=this.api.showErrorMessage,this.dataCallbacks={},this.propertyListeners={},this.dataformItems=new c.Collection,this.updatedFlag=!1,this.changeQueue={},this.viewModelClone=this.cloneViewState(this.appViewModel),this.dataModelClone=this.cloneDataSources(this.appDataModel),this.applyRelatedDataSourcesMappers(),this.validationCollection=new c.Collection([],{model:c.Model.extend({idAttribute:this.primaryKey})}),this.debouncedApplyViewStateClone=_.debounce(this.applyViewStateClone,100).bind(this),this.debouncedOnDataCollectionChanged=_.debounce(this.onDataCollectionChanged,100),this.debouncedNoSubmit=_.debounce(this.noSubmitBtnSubmission,500).bind(this),this.debouncedRenderForm=_.debounce(this.renderForm,100),this.onThemeChanged(),this.updatedFlag=!0},initializeEvents:function(){this.listenTo(this.options.dashboardViewModel,"change:DashboardTheme",this.onThemeChanged),this.listenTo(this.viewModel,"change:Basics.Data",this.applyDataProperty),this.listenTo(this.viewModel,"change:Basics.ExpandDictParameters",this.onExpandDictParametersChanged),this.listenTo(this.viewModel,"change:Basics.ValidationAnalytic",this.removeTooltips),this.listenTo(this.validationCollection,"change add remove reset",this.debouncedOnDataCollectionChanged)},initializeVSParamListeners:function(e,t){this.stopListening(e),this.listenTo(e,"changeSettings",function(){this.updatedFlag=!0,this.loadParams()}),this.listenTo(e,"change:FieldType.Data",function(e){this.updatedFlag=!0,this.applyViewStateDataProperty(t)}),this.listenTo(e,"change:FieldType._Type",function(){this.onViewStateModelTypeChange()}),this.listenTo(e,"change:FieldType change:Tooltip",function(){"Dropdown"===e.get("FieldType._Type")&&this.generateSchema(t),this.debouncedRenderForm()}),this.listenTo(e,"change:DisplayName",function(){this.applyDisplayName()}),this.listenTo(e,"change:HideParameter",function(e){this.onHideParameter(e,t)})},applyDataProperty:function(){var t=this,e=this.viewModel.get("Basics.Data");if(t.dataModel&&t.stopListening(t.dataModel),!e)return t.dataModel=null,t.model.clear(),void t.debouncedRenderForm();t.dataModel=t.getClonedModel(e),t.dataModelOriginal=e,t.dataModel&&t.dataModel.attributes?(t.dataModel&&(t.loadParams(),t.listenTo(t.dataModel,"change",function(e){0<_.filter(_.keys(e.changed),function(e){return 0===e.indexOf("_")}).length&&_.defer(function(){t.loadParams()})})),t.loadParams(),t.initializeErrorHandler(t.dataModel)):t.showErrorMessage({error:'Invalid Data Source: "'+e.path+'" selected',errorType:"Warning"},t.dataModel)},applyDisplayName:function(){var e=this.getParams();_.each(e,_.bind(function(e){_.isString(e)?t=e:_.isObject(e)&&(t=e.raw?"raw_"+e.key:e.path);var t,e=this.getViewStateItem(t);e&&(e=e.DisplayName,e=_.isObject(e)?e.get("value"):e,t=this.$el.find("[title='"+t+"']"),$(t).html(e))},this))},applyRelatedDataSourcesMappers:function(){var t=this,e=_.map(_.filter(t.settingsModel.get("Basics").ViewStates,function(e){return e&&e.FieldType&&e.FieldType.Data}),function(e){return e.FieldType.Data.path}),i=[],a=_.map(_.map(t.settingsModel.get("Basics").ViewStates,"PathEnc"),function(e){return m(e)});_.each(_.map(t.settingsModel.get("Basics").ViewStates,"HideParameter"),function(e){e&&i.push(e.path)}),_.each(t.api.getDataSourceMap(a,e,i),function(e){e=t.getClonedModel(e);e&&e.apply()})},applyViewStateClone:function(){var i=this;_.each(this.viewModelClone.getViewStateList(),function(e){var t=i.appViewModel.getByPath(e.path);t&&("dict"===e.model.get("_type")?t.set("value",i.cloneDict(e.model.get("value"),i.appViewModel)):t.set("value",e.model.get("value")))}),this.forceExecutePending&&this.dataModelOriginal&&this.dataModelOriginal.forceExecute(),this.executeActions(),this.forceExecutePending=!1},applyViewStateDataProperty:function(t){var n=this,l=this.dataformItems.get(y(t)),e=l.get("viewModel"),i=_.find(this.settingsModel.get("Basics").ViewStates,function(e){return e.PathEnc===f(t)});l&&i&&!l.ignoreModelChanges&&((e=this.getClonedModel(e.get("FieldType.Data")))&&(this.stopListening(e),this.dataUnsubscribe(e,l.get("onData")),l.set("subscribed",!1)),i.FieldType.Data&&(this.listenTo(e,"refresh",function(){n.applyViewStateDataProperty(t)}),l.set("onData",function(e,t){var i=e.columns,a=!1,s=l.get("columnsCollection"),o=l.get("collection"),e=(e.primaryKey!==l.get("primaryKey")&&(l.set("primaryKey",e.primaryKey),o.reset(),l.set("collection",new c.Collection([],{model:c.Model.extend({idAttribute:l.primaryKey})})),a=!0),i.reset?s.reset(i.reset):(s.remove(_.map(i.remove,function(e){return e.id})),s.add(i.add),s.add(i.change,{merge:!0})),a=a||_.some(["add","remove","reset","change"],function(e){return n.metaChange="reset",S()?e in i:void 0!==i[e]}),t.reset?o.reset(t.reset):_.isArray(i.reset)&&_.isEmpty(i.reset)?o.reset():(o.remove(_.map(t.remove,function(e){return e[l.get("primaryKey")]})),o.add(t.add),o.add(t.change,{merge:!0})),m(l.get("pathEnc")));a&&n.onViewStateColumnsCollectionChanged(e),_.some(["add","change","remove","reset"],_.partial(_.has,t))&&n.onViewStateDataCollectionChanged(e)}),e&&(this.dataSubscribe(e,l.get("onData")),l.set("subscribed",!0))))},cloneDataSources:function(e){e=JSON.stringify(e);return new u.DocumentDataModel(JSON.parse(e),null,"",this.viewModelClone,!0)},cloneDict:function(e,i){return value={},_.each(e,function(e,t){e instanceof c.Model?value[t]=i.getByPath(e.path):value[t]=e}),value},cloneViewState:function(o){var n=this,e=JSON.stringify(o),l=new u.DocumentViewModel(JSON.parse(e));return _.each(l.getViewStateList(),function(e){var t=l.getByPath(e.path),e=o.getByPath(e.path);t&&e&&("dict"===e.get("_type")?t.set("value",n.cloneDict(e.get("value"),l)):t.set("value",e.get("value")))}),n.stopListening(o),n.listenTo(o,"change",function(e){var t;e&&(e.path?(t=l.getByPath(e.path))&&("dict"===e.get("_type")?t.set({_default:n.cloneDict(e.get("_default"),l),_type:e.get("_type"),value:n.cloneDict(e.get("value"),l)}):t.set(e.attributes)):e.changed&&_.each(e.changed,_.bind(function(e,t){var i,a=l.get(t),s=o.get(t);s&&!s.path&&(s.path=t),s&&!a?(i=this.getClonedModel(s,"viewstate"))&&(i.path=t,l.set(t,i)):!s&&a?(n.stopListening(a),l.unset(t)):s&&a&&("dict"===s.get("_type")?a.set({_default:n.cloneDict(s.get("_default"),l),_type:s.get("_type"),value:n.cloneDict(s.get("value"),l)}):a.set(s.attributes))},this)))}),l},dataSubscribe:function(e,t){var i=this;e&&t&&(_.has(i.dataCallbacks,e.path)?i.dataCallbacks[e.path].add(t):(i.dataCallbacks[e.path]=$.Callbacks("memory unique"),i.dataCallbacks[e.path].add(t),i.api.subscribe(e,$.proxy(i.dataCallbacks[e.path].fire,i))))},dataUnsubscribe:function(e,t){var i=this;e&&t&&_.has(i.dataCallbacks,e.path)&&_.has(i.dataCallbacks,e.path)&&(i.dataCallbacks[e.path].remove(t),i.dataCallbacks[e.path].has()||(i.api.unsubscribe(e),i.dataCallbacks[e.path]=null,delete i.dataCallbacks[e.path]))},doApply:function(e){var t=this.viewModel.get("Basics.ForceExecute"),i=this.settingsModel.get("Basics.SetViewStateOnSubmit.ViewState"),i=this.getClonedModel(i);this.setError(e),_.isEmpty(e)&&(this.form.commit(),!0===this.viewModel.get("Basics.ShowSubmit")&&(e=this.viewModel.get("Basics.SetViewStateOnSubmit.Value"),i&&e&&i.set("value",e),t&&(this.forceExecutePending=!0)),this.debouncedApplyViewStateClone())},executeActions:function(){var e=this.viewModel.get("Basics.Actions");this.api.doActions(e,"Basics.Actions")},generateSchema:function(e){var t,i,a=y(e),s=this.dataformItems.get(a),o=this.getViewStateItem(e),n=o.FieldType.AcceptEmptyValues;o.FieldType.Data?(i=o.FieldType.DataSourceMapping,o.FieldType.Data&&!s.get("subscribed")&&this.applyViewStateDataProperty(e),i&&i.Value&&i.Text&&(t=s.get("collection").map(function(e){return{val:d(i.Value)?u.Tools.castToDashString(e.get(i.Value.get("value")),s.viewStateType):u.Tools.castToDashString(e.get(i.Value),s.viewStateType),label:d(i.Text)?e.get(i.Text.get("value")):e.get(i.Text)}}),t=n?t:_.filter(t,function(e){return null!==e.val&&void 0!==e.val&&""!==e.val}))):(t=_.map(o.FieldType.Items,function(e){return{label:d(e.Text)?e.Text.get("value"):e.Text,val:d(e.Value)?e.Value.get("value"):e.Value}}),t=n?t:_.filter(t,function(e){return null!==e.val&&void 0!==e.val&&""!==e.val})),this.model.schema[a]={acceptEmptyValues:o.FieldType.AcceptEmptyValues,enforceValue:o.FieldType.ForceSelect,inputItemLimit:o.FieldType.FieldSummaryThreshold,matcher:o.FieldType.AdvancedSearch?l.matchCustom:null,modelKey:a,multiSelect:o.FieldType.MultiSelect,options:t||[],selectAllValue:o.FieldType.SelectAllValue,showSearch:o.FieldType.ShowSearch,tooltip:function(e){return o.Tooltip||e||""},tooltipItemLimit:o.FieldType.TooltipSummaryThreshold,type:s.get("viewModel").get("FieldType.MultiSelect")?"MultiSelect":"Select",validators:[],viewstateType:s.viewStateType,width:"100%"}},getClonedModel:function(e,t){var i,a,s,o,n,l,r=this,d=null,c=null,h="";if(!e||!e.path)return null;switch(t=t||(e.get("_viewType")?"viewstate":e.get("_dataType")?"datasource":null)){case"datasource":d=r.dataModelClone,c=r.appDataModel,h="#clone";break;case"viewstate":d=r.viewModelClone,c=r.appViewModel}if(!d)return null;if(!(i=d.getByPath(e.path))){switch(l=JSON.stringify(e),t){case"datasource":s=new u.DocumentDataModel(JSON.parse(l),null,"",r.viewModelClone);break;case"viewstate":s=new u.DocumentViewModel(JSON.parse(l))}(n=(n=/\/([\w -]+)$/.exec(e.path))&&n[1]?(a=n[1],n=e.path.substr(0,e.path.length-n[0].length),(o=c.getByPath(n)).path=n,r.getClonedModel(o,t)):(a=e.path,d))&&(n.set(a,s),i=s)}return i.isClone=!0,i.path=e.path+h,"datasource"===t?(e.root&&e===e.root?i.root=i:i.root=e.root,i.dataSet||i.apply(),r.stopListening(e),r.listenTo(e,"change",function(){i.set(e.attributes),i.updateParameters()})):"viewstate"===t&&(r.stopListening(e),r.listenTo(e,"change",function(){"dict"===e.get("_type")?i.set({_default:r.cloneDict(e.get("_default"),r.viewModelClone),_type:e.get("_type"),value:r.cloneDict(e.get("value"),r.viewModelClone)}):e.has("_type")&&i.set(e.attributes)})),i},getParams:function(){var e,i;return!(!this.dataModel||!this.dataModel.getParameters||_.isUndefined(this.viewModel.get("Basics.ExpandDictParameters")))&&(e=this.dataModel.getParameters(),i=[],this.viewModel.get("Basics.ExpandDictParameters")?_.each(e,function(t){t.dictParameters?_.each(t.dictParameters,function(e){e.raw?i.push({type:e.type,value:e.value,dict:t.path,key:e.key,raw:!0}):e.key?i.push({path:e.path,key:e.key}):i.push(e.path)}):i.push(t.path)}):_.each(e,function(e){i.push(e.path)}),_.uniq(i))},getViewStateItem:function(t){return _.find(this.api.getProperty("Basics.ViewStates"),function(e){if(e&&e.PathEnc===f(t))return!0})},initializeErrorHandler:function(e){var t=this;t.updateErrorMessage(),t.listenTo(e,"change:error",function(){t.updateErrorMessage()})},loadParams:function(){var r={},e=this.getParams(),d=[];_.each(e,_.bind(function(o,e){var i,a,s,n,t,l;_.isString(o)?title=a=o:_.isObject(o)&&(title=(a=o.raw?"raw_"+o.key:o.path,o.key)),a&&((l=this.appDataModel.getViewState().getByPath(a))&&(l.path=a,n=this.getClonedModel(l)),pathEnc=f(a),s=y(a),d.push(a),i=this.dataformItems.get(s),l=n?n.get("_type"):o.type,i||(i=this.dataformItems.add({collection:new c.Collection([],{model:c.Model.extend({idAttribute:"_rowIndex"})}),columnsCollection:new c.Collection([],{model:c.Model.extend({idAttribute:"id"})}),id:s,order:"",pathEnc:pathEnc,dictPathKey:o.key||"",primaryKey:"_rowIndex",viewModel:new c.DeepModel(_.find(this.settingsModel.get("Basics").ViewStates,function(e){return y(m(e.PathEnc))===s}))}),this.initializeVSParamListeners(i.get("viewModel"),a),this.updatedFlag=!0),i.viewStateType=l,this.model.has(s)||(n?(value=n.get("value"),"dict"===l&&(value=_.mapValues(value,function(e){e=_.isString(e)&&e.match(/^<%.+%>$/)?e.substr(2,a.length-4):_.isObject(e)?e.path:e;return e})),value=u.Tools.castToDashString(value,n.get("_type")),this.model.set(s,value),this.listenTo(n,"change:_type",this.onViewStateModelTypeChange),this.model.listenersByPath[s]=_.bind(function(e,t){this.forceRender=!0,e&&e.get("_type")&&(t=u.Tools.castToDashString(t,e.get("_type"))),this.set(s,t)},this.model),this.model.listenTo(n,"change:value",this.model.listenersByPath[s]),this.listenTo(this.model,"change:"+s,_.bind(function(e,t,i){this.changeQueue[a]=t,i.unset||(this.model.stopListening(n,"change:value",this.model.listenersByPath[s]),n.set("value",t),this.model.listenTo(n,"change:value",this.model.listenersByPath[s]))},this))):(this.model.set(s,o.value),this.listenTo(this.model,"change:"+s,function(e,t,i){var a,s=this.getClonedModel(this.dataModel.getViewState().getByPath(o.dict));s&&(a=_.clone(s.get("value")),i.unset?delete a[o.key]:(o.value=t,a[o.key]={type:o.type,value:o.value}),s.set("value",a))}))),(t=_.find(this.settingsModel.get("Basics").ViewStates,function(e,t){if(e)return i.set("order",t),e.PathEnc===pathEnc}))?t.FieldType||(t.FieldType={}):(t={FieldType:{},HideParameter:!1,PathEnc:pathEnc,DisplayName:p(title),Tooltip:""},r["Basics.ViewStates."+e+".DisplayName"]=t.DisplayName,r["Basics.ViewStates."+e+".FieldType"]=t.FieldType,r["Basics.ViewStates."+e+".HideParameter"]=t.HideParameter,r["Basics.ViewStates."+e+".PathEnc"]=t.PathEnc,r["Basics.ViewStates."+e+".Tooltip"]=t.Tooltip),"Dropdown"===t.FieldType._Type?this.generateSchema(a):"Password"===t.FieldType._Type?this.model.schema[s]=$.extend(!0,{},{type:t.FieldType._Type}):((e=h.RTTI.getByName(l))&&e.editor&&this.model.schema[s]&&e.editor.type!==this.model.schema[s].type&&(this.updatedFlag=!0),this.model.schema[s]=$.extend(!0,{},e.editor)),t.Tooltip&&(l="object"==typeof t.Tooltip?t.Tooltip.get("value"):t.Tooltip,this.model.schema[s].fieldAttrs={title:l.replace(/(?:\\r\\n|\\r|\\n)/g,"\r\n")}))},this)),_.defer(_.bind(function(){_.each(r,_.bind(function(e,t){this.api.setProperty(t,e)},this))},this)),_.each(_.keys(this.model.attributes),_.bind(function(e){var t=g(e),i=this.dataformItems.get(e),a=f(t);-1===d.indexOf(t)&&((t=this.dataModel.getViewState().getByPath(t))&&(this.stopListening(t,"change:_type"),this.model.stopListening(t,"change:value",this.model.listenersByPath[e]),t.stopListening(this.model)),this.model.unset(e),this.settingsModel.set("Basics.ViewStates",_.reject(this.settingsModel.get("Basics.ViewStates"),function(e){return e&&e.PathEnc===a})),i&&(this.stopListening(i.get("collection")),this.stopListening(i.get("viewModel")),this.dataformItems.remove(i)),delete this.model.listenersByPath[e],delete this.model.schema[e],this.updatedFlag=!0)},this)),this.updatedFlag&&(this.renderForm(),this.StylesModule.setStyle(),this.updatedFlag=!1)},viewStateDataModelChanged:function(e,t,i){e=this.dataformItems.get(y(m(e))).get("collection");i.reset?e.reset(i.reset):(e.remove(_.map(i.remove,function(e){return e[self.primaryKey]})),e.add(i.add),e.set(i.change,{remove:!1})),this.updatedFlag=!0,this.loadParams()},noSubmitBtnSubmission:function(){var e=this,t=e.settingsModel.get("Basics.ValidationAnalytic");return t?(e.updateValidationModel(t),e.api.subscribe(e.validationModel,_.bind(e.onValidationData,e))):e.doApply(),!1},onDataCollectionChanged:function(){var t={};this.validationCollection.each(function(e){e.get("Value")&&(t[e.get("Property")]=e.get("Value"))}),this.doApply(t)},onExpandDictParametersChanged:function(){this.updatedFlag=!0,this.loadParams()},onFieldBlur:function(e,t){t=this.errorTooltip[t.schema.tooltipTitle];t&&t.hide()},onFieldFocus:function(e,i){_.each(this.errorTooltip,function(e,t){t===i.schema.tooltipTitle?e.show():e.hide()})},onHideParameter:function(e,t){this.updatedFlag=!0,this.loadParams()},onSettingsChange:function(e){var a=this;_.each(e,function(e,t){"Basics.ViewStates"===t?_.each(e,function(e,t){var i="Basics.ViewStates."+t;a.viewModel.get("Basics.ViewStates")?_.each(e,function(e,t){a.viewModel.set(i+"."+t,e)}):(t=a.settingsModel.get(i+".FieldType.Data"),"Dropdown"===a.settingsModel.get(i+".FieldType._Type")&&t&&(a.api.unsubscribe(t),a.api.subscribe(t,_.bind(a.viewStateDataModelChanged,a,e.PathEnc))))}):a.viewModel.set(t,e)}),e["Basics.ViewStates"]&&_.each(this.viewModel.get("Basics.ViewStates"),function(e){var t;e&&(t=y(m(e.PathEnc)),(t=a.dataformItems.get(t))&&t.get("viewModel").set(e))}),this.hasInit||(this.hasInit=!0,this.applyDataProperty(),this.initializeEvents()),this.updateBindings()},onThemeChanged:function(){var e="Dark";this.options.dashboardViewModel.get("DashboardTheme")&&(e=this.options.dashboardViewModel.get("DashboardTheme")),this.$el.removeClass("Dark").removeClass("Light").addClass(e)},onSubmit:function(e){var t=this.settingsModel.get("Basics.ValidationAnalytic");return e&&e.preventDefault(),t?(this.updateValidationModel(t),this.api.subscribe(this.validationModel,_.bind(this.onValidationData,this))):this.doApply(),!1},onValidationData:function(e,t){var i=this,a=e.columns;e.primaryKey!==this.primaryKey&&(this.primaryKey=e.primaryKey,this.validationCollection.reset()),t.reset?(e.columns.reset&&(this.columns=e.columns.reset),this.validationCollection.reset(t.reset)):_.isArray(a.reset)&&_.isEmpty(a.reset)?this.validationCollection.reset():(this.validationCollection.remove(_.map(t.remove,function(e){return e[i.primaryKey]})),this.validationCollection.add(t.add),this.validationCollection.set(t.change,{remove:!1})),this.api.unsubscribe(this.validationModel)},onViewStateColumnsCollectionChanged:function(i){var a,e=this.dataformItems.get(y(i)),t=[""].concat(e.get("columnsCollection").map(function(e){return e.get("id")})),s=_.find(this.settingsModel.get("Basics").ViewStates,function(e,t){return a=t,e.PathEnc===f(i)});s.FieldType.DataSourceMapping.Text,s.FieldType.DataSourceMapping.Value;e.set("ignoreModelChanges",!0),this.getParams().length>=a&&_.defer(_.bind(function(){this.settingsModel.set("Basics.ViewStates."+a+".FieldType.DropdownPossibleValues",t),_.defer(function(){e.set("ignoreModelChanges",!1)})},this))},onViewStateDataCollectionChanged:function(t){var i,e,a,s=this.dataformItems.get(y(t)),o=s.get("collection"),n=(s.get("pathEnc"),s.get("viewModel")),l=this.dataModel.getViewState().getByPath(t),r=_.find(this.settingsModel.get("Basics").ViewStates,function(e){return e.PathEnc===f(t)});s&&o&&r&&(i=r.FieldType.DataSourceMapping)&&i.Value&&i.Text&&(r=_.map(o.filter(function(e){return null!==e.get(i.Value)&&void 0!==e.get(i.Value)}),function(e){var t=e.get(i.Value);return{val:u.Tools.castToDashString(t,s.viewStateType),label:e.get(i.Text)}}),this.form&&this.form.fields[s.id]&&(this.form.fields[s.id].title=t,this.form.fields[s.id].editor.setOptions(r),a="",r&&r[0]&&(a=r[0].val),l&&(r=u.Tools.castToDashString(l.get("value"),l.get("_type")),n.get("FieldType.ForceSelect")?(o=o.map(function(e){e=u.Tools.castToDashString(e.get(i.Value,l.get("_type")));if(e)return e.toString?e.toString():""+e}),null!=r&&(n.get("FieldType.MultiSelect")?a=r===(e=n.get("FieldType.SelectAllValue"))||_.isEqual(r,[e])?r:_.intersection(o,r):_.includes(o,r.toString?r.toString():""+r)&&(a=r))):a=r),this.form.fields[s.id].editor.setValue(a),n.get("FieldType.ForceSelect")&&(this.form.fields[s.id].commit(),this.viewModel.get("Basics.ShowSubmit")||this.debouncedApplyViewStateClone())))},onViewStateModelTypeChange:function(e,t){var i=this;_.defer(function(){i.loadParams()})},reapplyButtons:function(){this.ButtonsModule.onShowResetChanged(),this.ButtonsModule.onShowSubmitChanged()},remove:function(){var a=this;return this.api&&_.each(this.api.getProperty("Basics.ViewStates"),function(e){_.each(e,function(e,t){var t="Basics.ViewStates."+t,i=a.settingsModel.get(t+".FieldType.Data");"Dropdown"===a.settingsModel.get(t+".FieldType._Type")&&i&&a.api.unsubscribe(i)})}),this.removeTooltips(),this.form&&this.form.remove(),c.View.prototype.remove.call(this)},removeTooltips:function(){label=this.$el.find("label"),_.each(label,_.bind(function(e){(input=$(e).parent().find("div.bbf-editor")).removeClass("error"),_.each(this.errorTooltip,function(e){h.ErrorTooltip.clear(e)}),this.errorTooltip={}},this))},renderForm:function(){var e,i=this,a=[],a=(i.form&&(this.ButtonsModule=this.ButtonsModule.remove(),this.StylesModule=this.StylesModule.remove(),i.form.remove(),i.form=null),i.dataModelClone&&_.isFunction(i.dataModelClone.getViewState)&&(a=i.dataModelClone.getViewState().getViewStateList()),e=_.sortBy(this.dataformItems.models,function(e){return e.get("order")}),e=_.reject(e,function(e){return e.get("viewModel").get("HideParameter")}),e=_.map(e,function(e){return e.get("id")}),this.form=new h({base64:!0,model:this.model,fields:e,resetButton:t("Reset"),submitButton:this.viewModel.get("Basics.ShowSubmit")?t(this.viewModel.get("Basics.SubmitButtonText")):t("Submit"),viewStates:a}).render(),_.assign({},this,{onSubmit:this.onSubmit.bind(this)})),a=(this.ButtonsModule=new o(a),this.ButtonsModule.renderReset(),this.ButtonsModule.renderSubmit(),_.assign({},this,{reapplyButtons:this.reapplyButtons.bind(this)}));this.StylesModule=new r(a),this.StylesModule.setStyle(),i.form.$el.find('[data-action="add"]').click(function(e){e.preventDefault(),_.defer(function(){i.StylesModule.setDictStyle()})}),i.form.$el.find("input").keypress(function(e){13!=e.which||i.viewModel.get("Basics.ShowSubmit")||(i.form.commit(),i.onSubmit())}),i.$el.append(i.form.el),i.debouncedUpdate=_.debounce(function(){i.form.validate({appendToBody:!0})},300),i.listenTo(i.form,"change",i.debouncedUpdate),_.each(e,function(e){i.listenTo(i.form,e+":blur",i.onFieldBlur),i.listenTo(i.form,e+":focus",i.onFieldFocus)}),i.applyDisplayName()},setError:function(e){var a=this,s=(_.isEmpty(e)?this.removeTooltips():this.updateTooltips(event,e),{appendToBody:!0});_.each(e,_.bind(function(e,t){var i=a.dataformItems.findWhere({dictPathKey:t})&&m(a.dataformItems.findWhere({dictPathKey:t}).get("pathEnc")),i=this.$el.find("[title='"+(i||t)+"']").parent().find("div.bbf-editor");$(i).hasClass("error")&&this.errorTooltip[t].closest("body").length||(this.errorTooltip[t]=h.ErrorTooltip.show(e,this.$el.find(i),s),i.addClass("error"))},this))},setTheme:function(){this.onThemeChanged()},updateBindings:function(){var s=this,e=this.getParams();s.dataModel&&(_.each(e,_.bind(function(e){var i,t,a;_.isString(e)?a=e:_.isObject(e)&&(a=e.raw?"raw_"+e.key:e.path),e=s.dataformItems.get(y(a)),i=e?e.get("viewModel"):null,(t=(e=this.getViewStateItem(a))?e.FieldType:t)&&i&&(a=e.HideParameter,_.isObject(a)&&_.isFunction(a.get)&&a.get("_viewType")&&(i.get("HideParameter")&&this.stopListening(i.get("HideParameter")),(a=this.getClonedModel(a))&&(i.set("HideParameter",a.get("value")),this.listenTo(a,"change:value",_.bind(function(e,t){i.set("HideParameter",t)},this)))),i.set("FieldType.Data",t.Data),i.set("Actions",e.Actions))},this)),s.settingsModel.changed&&s.settingsModel.changed.Basics&&!_.isEmpty(_.filter(s.settingsModel.changed.Basics.ViewStates,function(e){return e&&!_.isEmpty(e.FieldType)}))&&(s.updatedFlag=!0,s.loadParams()))},updateErrorMessage:function(){this.dataModel.get("error")?(this.showErrorMessage(this.dataModel.get("error")),_.delay($.proxy(this.hideErrorMessage,this),3e3)):this.hideErrorMessage()},updateTooltips:function(e,t){e?_.each(this.errorTooltip,function(e){h.ErrorTooltip.clear(e)}):(e=this.$el.find("label"),_.each(e,_.bind(function(e){title=$(e).attr("title"),input=$(e).parent().find("div.bbf-editor"),_.has(t,title)?this.errorTooltip[title]&&this.errorTooltip[title].show():(input.removeClass("error"),h.ErrorTooltip.clear(this.errorTooltip[title]),delete this.errorTooltip[title])},this)))},updateValidationModel:function(e){var a,s,o=this,t=o.dataformItems.models[0]&&!!o.dataformItems.models[0].get("dictPathKey");if(this.validationModel=this.getClonedModel(e),a="virtual"===this.validationModel.get("_dataType"),s={name:"data",type:a?"text":"dict",value:{}},t)switch(_.each(o.dataformItems.models,function(e){var t=m(e.get("pathEnc")),i=o.viewModelClone.getByPath(t),e=e.get("dictPathKey");i&&(a?s.value[t]=i.get("value"):s.value[e]={type:i.get("_type"),IsKdbParam:!0,isViewState:!0,name:i.path,value:i.get("value")})}),this.validationModel.get("_dataType")){case"analytic":this.validationModel.attributes._analyticParams=[s];break;case"query":this.validationModel.attributes._queryParams=[s];break;case"virtual":this.validationModel.attributes._virtualParams=[s]}}},{getComponentDefinition:s.getComponentDefinition})});