define(["Handlebars","QuickBase","echarts","moment","xlsx","backbone","css!./css/app.css"],function(e,a,i,n,r,o){"use strict";var s,l=this&&this.__extends||(s=function(t,e){return(s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)},function(t,e){function i(){this.constructor=t}s(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}),O=(p.compareKDBTimes=function(t,e){return t.i>e.i?1:t.i<e.i?-1:t.n>e.n?1:t.n<e.n?-1:0},p.expandNestedViewStates=function(t,e){var i=!1,r=Object.keys(t);if(i=1===r.length?(o=e.getPropertyMeta(r[0]))&&"viewstate"===o.type:i){var o=/^((?:\w+\.)*)(\d+)/.exec(r[0]);if(o)return i=o[1].slice(0,-1),r=e.getProperty(i),(o={})[i]=r,o}return t},p.focus2Array=function(t){var e=[[""]],i=/"([^"]*)"/g,t=t.toString?t.toString():"",r=/^\[([^\]]*)]$/.exec(t);if(null!=r){if(/^(?:"[^"\\]*(?:\\[\S\s][^"\\]*)*")(?:,"[^"\\]*(?:\\[\S\s][^"\\]*)*")*/.test(r[1]))for(var o=void 0;null!==(o=i.exec(r[1]));)e.push(_.map(o[1].split(","),function(t){return t.replace(/&#44;/g,",")}))}else e.push(t.split(","));return _.filter(e,function(t){return 0<(""+t).length})},p.getConditionResult=function(t,e,i,r){var a={isMatch:function(t,e){var i,r=!1,o=t.split(/ +and +| +/);for(_.includes(o,"or")&&(o=_.without(o,"or"),r=!0),i=0;i<o.length;i++)0!==o[i].indexOf("-")&&o[i].indexOf("*")<0&&(o[i]="*"+o[i]+"*");return _[r?"some":"every"](o,function(t){return a.isSimpleMatch(t,e)})},isSimpleMatch:function(t,e){var i=!1;return 0===t.indexOf("-")&&(t=t.replace("-",""),i=!0),t=new RegExp("^"+t.replace(/\*/g,".*")+"$").test(e),i?!t:t}},o=!1,s=isNaN(parseFloat(t))?(""+t).toLowerCase():parseFloat(t),n=isNaN(parseFloat(e))?(""+e).toLowerCase():parseFloat(e);switch(i){case"contains":o=0<=s.toString().indexOf(n.toString());break;case"starts with":o=0===s.toString().indexOf(n.toString());break;case"ends with":o=-1!==s.toString().indexOf(n.toString(),s.toString().length-n.toString().length);break;case"==":o=s===n;break;case"<":o=s<n;break;case">":o=n<s;break;case"<=":o=s<=n;break;case">=":o=n<=s;break;case"!=":o=s!==n;break;case"search":o=a.isMatch(n,s);break;case"regexp":o=new RegExp(e.toString()).test(t.toString())}return o=r?!o:o},p.getFormatter=function(r,o,a,s){return"Number"===r||"Formatted Number"===r||"Smart Number"===r||"Datetime"===r?function(t){var e,i=t;if(null==(t="Smart Number"!==r&&"Formatted Number"!==r||_.isNumber(t)?t:_.isNumber(parseFloat(t))?parseFloat(t):t)||void 0===t)return"";if("Smart Number"===r)i=_.isNumber(t)?P.smartFormatNumber(t,o):_.escape(t);else{if("Datetime"===r)return e=t,n.isMoment(t)||n.isDuration(t)?t.format(s):P.isKDBTemporal(t)||_.get(t,"i")?P.convertKDBTemporalToMoment(t).format(s):("number"==typeof t&&(e=new Date(t)),P.convertDateStringValueToMoment(e.toString()).format(s));if("Formatted Number"===r&&t.toFixed)i=P.formatNumber(t,o);else if(t.toFixed)i=t.toFixed(o);else{if(P.isKDBTemporal(t)||_.get(t,"i"))return P.convertKDBTemporalToMoment(t).format(s);i=_.escape(i)}}if(a&&0<=i.toString().indexOf(".")){for(;"0"===i[i.length-1];)i=i.slice(0,-1);"."===i[i.length-1]&&(i=i.slice(0,-1))}return i}:"General"===r?function(t){return n.isMoment(t)||n.isDuration(t)?t.format():t}:"Boolean"===r?function(t){return _.escape(t)}:void 0},p);function p(){}h.getComponentDefinition=function(t){var e,i,r={appArgs:{quickStart:[{path:"Basics.Data",message:"populate Data Source"}],json:{Basics:{Data:"",Focus:"",NodeClick:"default",Selected:"",SelectedAttr:"name",Theme:"Dark"},Data:{Breakdown:"",Color:"",Value:""},Design:{Label:{Align:"center",Color:"#f0f0f0",Display:"name",Font:{Family:"sans-serif",Size:12},FormatLabel:{DateFormat:"YYYY-MM-DD",Decimal:0,FitText:"Shorten Text",Format:"General",Prefix:"",Suffix:"",Threshold:.1,TrailingZeros:!1},Position:"inside",Rotate:"radial",Show:!0},RadiusInner:0,RadiusOuter:90,VisualMap:{LabelColor:"#f0f0f0",Max:10,Min:0,Pieces:5,Type:"continuous"}},HighlightRule:[],Style:{Palette:[{type:"#F8696B"},{type:"#F98570"},{type:"#FBA276"},{type:"#FCBF7B"},{type:"#FEDC81"},{type:"#EEE683"},{type:"#CCDD82"},{type:"#A9D27F"},{type:"#86C97E"},{type:"#63BE7B"}]},Tooltip:{ShowTooltip:!0,TooltipTemplate:'<table><thead><tr style="padding-right: 10px;"><th>{{_name}}</th><th></th></tr></thead><tr><td><svg style="padding: 0 5px; vertical-align: middle;" width="12" height="12"><rect width="12" height="12"style="fill: {{_color}} ;stroke-width:3;stroke: {{_color}}"></rect></svg>{{_label}}:</td><td style="padding-right: 10px; text-align: left;"><span style="padding-left:10px">{{_value}}</span></td></tr></table>'},possibleColors:[""],possibleColumns:[""],possibleLabels:[""],version:"4.5.0.2"},schema:{properties:{Basics:{options:{collapsed:!1},properties:{DashboardTheme:{options:{hidden:!0}},Data:{default:"",format:"string",propertyOrder:1,title:"Data Source",type:"data"},FixedColumn:{title:"Column Def",type:"string"},Focus:{default:"",propertyOrder:2,title:"Focus",type:"viewstate"},NodeClick:{default:"default",enum:["default","rootToNode"],propertyOrder:3,title:"Node Click",type:"string"},Selected:{default:"",propertyOrder:4,title:"Selected Value",type:"viewstate"},SelectedAttr:{default:"name",enum:["name","value","dataIndex"],propertyOrder:5,title:"Selected Value Attribute",type:"string"},Theme:{enum:["Light","Dark"],options:{hidden:!0},title:"Theme",type:"string"}},propertyOrder:2,title:"Basics",type:"object"},Data:{options:{collapsed:!1},properties:{Breakdown:{default:"",enumSource:"possible_columns",propertyOrder:1,title:"Breakdown",type:"string",watch:{possible_columns:"root.possibleColumns"}},Color:{default:"",enumSource:"possible_colors",propertyOrder:3,title:"Colour",type:"gradient",watch:{possible_colors:"root.possibleColors"}},Value:{default:"",enumSource:"possible_columns",propertyOrder:2,title:"Weight",type:"string",watch:{possible_columns:"root.possibleColumns"}}},propertyOrder:3,title:"Data",type:"object"},Design:{options:{collapsed:!0},properties:{Label:{options:{collapsed:!0},properties:{Align:{default:"center",enum:["center","left","right"],propertyOrder:6,title:"Align",type:"string"},Color:{default:"#f0f0f0",propertyOrder:3,title:"Color",type:"gradient"},Display:{data:[],default:"name",enum:["name","value"],propertyOrder:2,type:"string"},Font:{options:{collapsed:!0},properties:{Family:{default:"sans-serif",enum:["sans-serif","monospace"],title:"Radius Outer",type:"string"},Size:{default:"12",format:"range",maximum:"60",minimum:"1",title:"Radius Inner",type:"number"}},title:"Font",type:"object"},FormatLabel:{options:{collapsed:!0},properties:{DateFormat:{default:"YYYY-MM-DD",enum:["YYYY-MM-DD","YYYY-MMM-DD","YYYY-MMMM-DD","YYYY-MM","YYYY-MMM","YYYY-MMMM","MMM DD","MMM Do","YYYY-MM-DD HH:mm:ss","YYYY-MM-DD hh:mm:ss","YYYY-MM-DD kk:mm:ss","hh:mm:ss","kk:mm:ss","hh:mm:ss.SS","hh:mm","kk:mm","mm:ss","mm:ss.SS"],propertyOrder:4,title:"Date/Time Format",type:"string"},Decimal:{default:0,propertyOrder:2,type:"number"},FitText:{default:"Shorten Text",enum:["Shorten Text","Overflow"],propertyOrder:8,title:"Fit Text",type:"string"},Format:{default:"General",enum:["General","Number","Smart Number","Formatted Number","Datetime"],propertyOrder:1,type:"string"},Prefix:{default:"",propertyOrder:5,type:"string"},Suffix:{default:"",propertyOrder:6,type:"string"},Threshold:{default:.1,propertyOrder:7,type:"number"},TrailingZeros:{default:!1,propertyOrder:3,title:"Hide Trailing Zeroes",type:"boolean"}},title:"Format",type:"object"},Position:{default:"inside",enum:["top","left","right","bottom","inside","insideLeft","insideRight","insideTop","insideBottom","insideTopLeft","insideBottomLeft","insideTopRight","insideBottomRight"],propertyOrder:5,title:"Position",type:"string"},Rotate:{default:"radial",enum:["radial","tangential"],propertyOrder:4,title:"Rotate",type:"string"},Show:{default:!0,format:"checkbox",propertyOrder:1,title:"Show",type:"boolean"}},title:"Label",type:"object"},RadiusInner:{default:"0",format:"range",maximum:"49",minimum:"0",propertyOrder:1,title:"Radius Inner",type:"number"},RadiusOuter:{default:"90",format:"range",maximum:"100",minimum:"50",propertyOrder:2,title:"Radius Outer",type:"number"},VisualMap:{options:{collapsed:!0},properties:{LabelColor:{default:"#f0f0f0",propertyOrder:2,title:"Label Color",type:"gradient"},Max:{default:10,propertyOrder:4,title:"Max",type:"number"},Min:{default:0,propertyOrder:3,title:"Min",type:"number"},Pieces:{default:5,propertyOrder:5,type:"number"},Type:{default:"continuous",enum:["continuous","piecewise"],propertyOrder:1,type:"string"}},title:"Visual Map",type:"object"}},propertyOrder:4,title:"Config",type:"object"},HighlightRule:{items:{headerTemplate:"Rule {{ i1 }} {{self.Name}}",options:{collapsed:!0},properties:{BackgroundColor:{default:"",options:{gradient:!0,noColor:!0},propertyOrder:4,title:"Background Color",type:"gradient"},ConditionOperator:{default:"==",enum:["","search","contains","starts with","ends with","==","<",">","<=",">=","!=","Fill Left-to-Right","Fill Right-to-Left"],propertyOrder:2,title:"Condition Operator",type:"string"},ConditionSource:{default:"text",enum:["text","val"],propertyOrder:1,title:"Condition Source",type:"string"},ConditionValue:{default:"",propertyOrder:3,title:"Condition Value",type:"string"}},title:"Rule",type:"object"},options:{collapsed:!0},propertyOrder:10,title:"Highlight Rules",type:"array"},Style:{options:{collapsed:!0},properties:{Palette:{default:[{type:"#F8696B"},{type:"#F98570"},{type:"#FBA276"},{type:"#FCBF7B"},{type:"#FEDC81"},{type:"#EEE683"},{type:"#CCDD82"},{type:"#A9D27F"},{type:"#86C97E"},{type:"#63BE7B"}],format:"table",items:{properties:{type:{default:"#f8696b",options:{gradient:!1},title:"color",type:"gradient"}},title:"Palette Colour",type:"object"},propertyOrder:11,title:"Colour Palette",type:"array",uniqueItems:!1},advanced:{default:"",propertyOrder:10,title:"Advanced CSS",type:"css"}},propertyOrder:11,title:"Style",type:"object"},Tooltip:{options:{collapsed:!0},properties:{ShowTooltip:{format:"checkbox",propertyOrder:1,title:"Show Tooltip",type:"boolean"},TooltipTemplate:{options:{hidden:!0},propertyOrder:2,templateItems:{values:{items:_.keyBy(["_colour","_name","_value"]),type:"object"}},title:"Custom Template",type:"tooltipTemplate"}},propertyOrder:7,title:"Tooltip",type:"object"},possibleColors:{default:["default"],format:"table",items:{type:"string"},options:{collapsed:!0,hidden:!0},propertyOrder:2,type:"array"},possibleColumns:{default:["sym"],format:"table",items:{type:"string"},options:{collapsed:!0,hidden:!0},propertyOrder:2,type:"array"}},title:"Properties",type:"object"}},componentDescription:"",componentName:"sunburst",id:1,version:"4.5.0"};if(0<_.keys(t.settingsModel.attributes).length)for(i=h.upgrades.indexOf(_.find(h.upgrades,{version:t.settingsModel.get("version")}))+1;i<h.upgrades.length;i+=1)(e=h.upgrades[i]).fn(t.settingsModel),t.settingsModel.set("version",e.version);return r};var u=h;function h(){}u.upgrades=[{fn:function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e]},version:0},{fn:function(t){var e=t.get("HighlightRule"),i=t.get("Design"),e=void 0===e?[]:e;_.get(i,"Design.Label.FormatLabel.Threshold")||(i.Label.FormatLabel.FitText="Shorten Text"),t.set("HighlightRule",e),t.set("Design",i)},version:"4.5.0.2"}];d.app=e.template({compiler:[8,">= 4.3.0"],main:function(t,e,i,r,o){var a=t.lookupProperty||function(t,e){if(Object.prototype.hasOwnProperty.call(t,e))return t[e]};return'<div class="sunburst-container">\n    <div class="sunburst" id='+t.escapeExpression("function"==typeof(i=null!=(i=a(i,"id")||(null!=e?a(e,"id"):e))?i:t.hooks.helperMissing)?i.call(null!=e?e:t.nullContext||{},{name:"id",hash:{},data:o,loc:{start:{line:2,column:29},end:{line:2,column:35}}}):i)+' >\n    </div>\n    <div class="legend"></div>\n</div>'},useData:!0});var c=d;function d(){}y.sourceKey=function(t){return t.getPath()},y.mergeChanges=function(e,i,t,r,o,a){return t&&(e=_.fromPairs(_.map(t,function(t){return[i(t),t]}))),r&&_.each(r,function(t){return _.extend(e[i(t)],t)}),o&&_.each(o,function(t){e[i(t)]=t}),a&&_.each(a,function(t){delete e[i(t)]}),e},y.prototype.setFocus=function(t){this.focus=t,this.updateChildren(),this.childDataSource&&this.childDataSource.setFocus(t)},y.prototype.isFocused=function(){return this.focus.length===this.depth&&(0===this.depth||this.source.id===this.focus[this.depth])},y.prototype.getColumnNames=function(){if(this.breakdownColumns&&this.breakdownColumns.length)return[y.BREAKDOWN_ID,this.breakdownColumns[0]].concat(_.difference(_.keys(this.meta),this.breakdownColumns));try{return _.map(this.meta,function(t){return[t.id,t.index]}).sort(function(t,e){return t[1]-e[1]}).map(function(t){return t[0]})}catch(t){return _.keys(this.meta)}},y.prototype.getColumnType=function(t){return this.childDataSource?this.childDataSource.getColumnType(t):t===y.BREAKDOWN_ID?this.meta[this.primaryKey].kdbType:this.meta[t]?this.meta[t].kdbType:11},y.prototype.getData=function(){return this.childDataSource?this.childDataSource.getData():this.source.dataSet&&this.source.dataSet.collection},y.prototype.getDepth=function(){return this.childDataSource?this.childDataSource.getDepth():this.depth},y.prototype.getKey=function(){return this.source.cid},y.prototype.getPrimaryKey=function(){return this.childDataSource?this.childDataSource.getPrimaryKey():this.primaryKey},y.prototype.getPropertyFromColumn=function(t){return t===y.BREAKDOWN_ID?this.getPrimaryKey():t},y.prototype.getPath=function(){return this.source.path},y.prototype.getSource=function(){return this.source},y.prototype.hasData=function(){return this.childDataSource?this.childDataSource.hasData():this.hasDataFlag},y.prototype.subscribe=function(){var r=this;this.api.subscribe(this.source,function(t,e,i){r.onData(t,e,i)})},y.prototype.onData=function(t,e,i){if(this.columnNames=t.columns.collection.pluck("id"),this.columnTypes=t.columns.collection.pluck("kdbType"),this.valueColName=-1<this.columnNames.indexOf("value")?"value":this.columnNames[1],this.colorNames=_.concat(["default","fixed","level","visual map"],t.columns.collection.pluck("id")),this.data=e,this.api.setProperty("possibleColumns",this.columnNames),this.api.setProperty("possibleColors",this.colorNames),t.primaryKey!==this.primaryKey&&(this.primaryKey=t.primaryKey),this.meta=y.mergeChanges(this.meta,function(t){return t.id},t.columns.reset,t.columns.change,t.columns.add,t.columns.remove),0!==this.depth||_.isEqual(t.breakdownColumns,this.breakdownColumns)||(this.breakdownColumns=t.breakdownColumns,this.removeChild()),e.reset&&0<e.reset.length&&this.removeChild(),i?this.updateError(this,i):this.listener&&this.listener.updateError(this,void 0),this.hasDataFlag=!0,this.updateChildren()){for(var r=this.listener;r&&r.listener;)r=r.listener;this.initializeChart()}},y.prototype.getChartData=function(){var t,e,i=this,r={};return _.get(this,"data.collection")&&(t=this.treeToSunburstTree(),e=this.getBreakdown(),!_.isEqual(e,[""])&&0!==e.length&&t&&0!==t.length&&(r=_.map(this.nest(t,e,""),function(t,e){return _.isNil(t.name)?i.getChild(e,i.isChild(t,e),null):t}))),r},y.prototype.levels=function(){var t=this.getBreakdown(),e=this.api.getProperty(y.PROP_DATA_COLOR),i=_.map(this.api.getProperty(y.PROP_PALETTE),"type"),r=[{}];return"level"===e?(_.each(t,function(t,e){r.push({itemStyle:{color:i[e%i.length]}})}),r):null},y.prototype.updateDataSource=function(t){this.listener.updateDataSource(this)},y.prototype.initializeChart=function(){this.listener.initializeChart()},y.prototype.updateError=function(t,e){this.listener.updateError(this,e)},y.prototype.unsubscribe=function(){this.childDataSource&&(this.childDataSource.unsubscribe(),delete this.childDataSource),this.api.unsubscribe(this.source)},y.prototype.treeToSunburstTree=function(){var r=this.source,o=r.dataSet.collection.toJSON(),a=o.length,s=this.breakdownColumns;return _.each(this.focus,function(e,i){var t;o=_.filter(o,function(t){return t[s[i]]!==e}),(r=r.dataSet.collection.get(e)).dataSet&&(t=r.dataSet.collection.toJSON(),_.each(t,function(t){o[a]=t,a++})),o=_.reject(o,_.isEmpty)}),o},y.prototype.getChild=function(t,e,i){var r,o=this.api.getProperty(y.PROP_DATA_COLOR),a=this.api.getProperty(y.PROP_DATA_WEIGHT);return _.isNull(i)?(r={text:t,val:_.sumBy(e,"value")},{children:e,itemStyle:{color:this.getColor(i,o,r)},name:t}):(r={text:i[t],val:parseFloat(i[a])},{data:i,itemStyle:{color:this.getColor(i,o,r)},name:i[t],value:parseFloat(i[a])})},y.prototype.removeChild=function(){this.childDataSource&&(this.childDataSource.unsubscribe(),delete this.childDataSource)},y.prototype.isChild=function(t,e){var i=this;return _.map(t,function(t,e){return _.isNil(t.name)?i.getChild(e,i.isChild(t,e),null):t})},y.prototype.nest=function(t,e,i){var r=this;if(!e.length)return this.getChild(i,null,t[0]);var o=e[0],a=e.slice(1);return _.mapValues(_.groupBy(t,o),function(t){return 1<t.length||0<t.length&&1===a.length&&t[0][a]?r.nest(t,a,o):r.nest(t,[],o)})},y.prototype.getColor=function(t,e,a){var s=this,i=_.map(this.api.getProperty(y.PROP_PALETTE),"type"),r=this.api.getProperty(y.PROP_HIGHLIGHT),n="fixed"===e?i[0]:"visual map"!==e&&"level"!==e&&"default"!==e&&""!==e&&t?t[e]:void 0;return _.each(r,function(t,e){var i=s.api.getProperty("HighlightRule."+e+".ConditionSource"),r=s.api.getProperty("HighlightRule."+e+".ConditionOperator"),o=s.api.getProperty("HighlightRule."+e+".BackgroundColor"),e=s.api.getProperty("HighlightRule."+e+".ConditionValue");O.getConditionResult(a[i],e,r,!1)&&(n=o)}),n},y.prototype.getBreakdown=function(){var t,e,i,r;if(this.source)return t=this.api.getProperty(y.PROP_DATA_BREAKDOWN),e=this.api.getProperty(y.PROP_DATA_WEIGHT),i=a.HeuristicHelpers.getStringColumns(this),r=a.HeuristicHelpers.getScalarColumns(this),t||(t=(0===i.length?r:i)[0],this.api.setProperty(y.PROP_DATA_BREAKDOWN,t)),!e&&0<r.length&&(e=r[0],this.api.setProperty(y.PROP_DATA_WEIGHT,e)),_.isArray(t)?t:[t]},y.prototype.updateChildren=function(){var t;return!(this.breakdownColumns&&this.breakdownColumns.length&&this.depth<this.breakdownColumns.length-1)||(this.focus.length>this.depth?(this.childDataSource&&this.focus[this.depth]!==this.childDataSource.getSource().id&&this.removeChild(),this.childDataSource||(t=this.source.dataSet&&this.source.dataSet.collection.get(this.focus[this.depth]))&&(this.childDataSource=new y(t,this,this.api,this.focus,this.depth+1,this.breakdownColumns),this.childDataSource.subscribe())):(this.removeChild(),this.focus.length!==this.depth||!this.hasDataFlag||0!==this.depth&&this.focus[this.depth-1]!==this.source.id||this.listener.updateDataSource(this)),!1)},y.BREAKDOWN_ID="{breakdownId}",y.PROP_DATA_COLOR="Data.Color",y.PROP_PALETTE="Style.Palette",y.PROP_DATA_BREAKDOWN="Data.Breakdown",y.PROP_DATA_WEIGHT="Data.Value",y.PROP_HIGHLIGHT="HighlightRule",y.PROP_NODE_CLICK="Basics.NodeClick";var g=y;function y(t,e,i,r,o,a){this.breakdownColumns=[],this.hasDataFlag=!1,this.focus=[],this.meta={},this.source=t,this.listener=e,this.api=i,this.depth=o||0,this.breakdownColumns=a,this.setFocus(r)}var m,P=a.Tools;function D(t){var e=m.call(this,t)||this;return e.errors={},e.sunburstID="",e.focus=[],e.api=t.api,e.sunburstID="sunburst-"+e.cid,e.$el.html(c.app({id:e.sunburstID})),e.$el.addClass("sunburst-app"),e.$echart=e.$el.find(".sunburst"),e}return m=o.View,l(D,m),D.prototype.onSettingsChange=function(i){var r=this,t=[D.PROP_DATA_BREAKDOWN,D.PROP_DATA_COLOR,D.PROP_DATA_WEIGHT,D.PROP_PALETTE,D.PROP_NODE_CLICK],e=[D.PROP_DSN_RADIUSINNER,D.PROP_DSN_RADIUSOUTER,D.PROP_DSN_LBLSHOW,D.PROP_DSN_LBLCOLOR,D.PROP_LBL_DIS,D.PROP_DSN_LBLROTATE,D.PROP_DSN_LBLPOSITION,D.PROP_DSN_LBLALIGN,D.PROP_DSN_LBLFONTFAM,D.PROP_DSN_LBLFONTSIZE,D.PROP_VM_PIECES,D.PROP_TIP_SHOW,D.PROP_TIP_TEMPLATE,D.PROP_VM_MIN,D.PROP_VM_MAX,D.PROP_VM_TYPE,D.PROP_VM_COLOR],o=[D.PROP_SELECTED,D.PROP_SELECTED_ATTR],a=["BackgroundColor","ConditionOperator","ConditionSource","ConditionValue"],s=this.api.getProperty(D.PROP_HIGHLIGHTRULE);this.callIfDef(i,D.PROP_DATA,this.onDataSourceChange),_.each(t,function(t){r.callIfDef(i,t,r.initializeChart)}),_.each(["Format","Decimal","TrailingZeros","DateFormat","Prefix","Suffix","Threshold"],function(t){r.callIfDef(i,"Design.Label.FormatLabel."+t,r.updateOptions)}),_.each(e,function(t){r.callIfDef(i,t,r.updateOptions)}),_.each(o,function(t){r.callIfDef(i,t,r.initActions)}),this.callIfDef(i,"HighlightRule",this.initializeChart),_.each(s,function(t,e){_.each(a,function(t){r.callIfDef(i,D.PROP_HIGHLIGHTRULE+"."+e+"."+t,r.initializeChart)})}),this.callIfDef(i,D.PROP_FOCUS,this.onFocusChange)},D.prototype.onResize=function(){var t,e;this.chart&&(t=this.$el.innerWidth(),e=this.$el.innerHeight(),this.chart.resize({height:e,width:t}))},D.prototype.initializeChart=function(){this.sunburstData=this.dataSource.getChartData(),this.updateOptions()},D.prototype.updateDataSource=function(e){var i,r,o;this.dataSource&&(o=a.HeuristicHelpers.getNumericColumns(e),i=a.HeuristicHelpers.getStringColumns(e),r=a.HeuristicHelpers.getListColumns(e),o=0===o.length?r:o,e=this.errors[e.getKey()],0===i.length&&r.length,0!==o.length||e&&"Loading"!==_.get(e,"type")?this.initializeChart():this.api.showErrorMessage({error:t("Data Source provided is not valid for Pie Chart"),type:"Warning"}))},D.prototype.updateError=function(i,t){function r(t){return"Error"===t?3:"Loading"===t?2:"NoResults"===t?1:0}var e=i.getKey(),t=(t?this.errors[e]=t:delete this.errors[e],_.reduce(this.errors,function(t,e){e=e.type;return r(e)>r(t)?e:t},""));t&&("NoResults"!==t||Object.keys(i).length===Object.keys(this.errors).length)?(e=_.map(this.errors,function(t,e){t=t.error;return t?"["+i.getPath()+"]: "+t:null}).filter(function(t){return t}),this.api.showQueryStatus({error:e.join("\n"),type:t})):this.api.hideQueryStatus()},D.prototype.callIfDef=function(t,e,i){void 0!==t[e]&&i.call(this,t[e],e)},D.prototype.destroyChart=function(){var t=this.$echart.get(0);this.chart&&(this.chart.off("click",null),this.chart.clear(),this.chart.dispose(t),delete this.chart)},D.prototype.hideTooltip=function(){this.tooltip&&(this.api.removeTooltip(),delete this.tooltip)},D.prototype.initActions=function(){var a=this;this.chart&&(this.chart.off("click",null),this.chart.on("click",function(t){var e=a.api.getProperty(D.PROP_FOCUS),e=""===e?[]:e.split(","),i=_.last(t.treePathInfo),r=a.api.getProperty(D.PROP_SELECTED_ATTR),o=[];_.isNil(i[r])||a.api.setProperty(D.PROP_SELECTED,i[r],{bypass:!0}),1<e.length&&1===t.treePathInfo.length?(e.splice(-1,1),a.focus=e.toString(),a.api.setProperty(D.PROP_FOCUS,e.toString(),{bypass:!0})):(_.each(t.treePathInfo,function(t){_.isNil(t[r])||""===t[r]||o.push(t[r])}),a.focus=o,a.api.setProperty(D.PROP_FOCUS,o.toString(),{bypass:!0}))}),this.chart.on("mousemove",this.showTooltip.bind(this)),this.chart.on("mouseout",this.hideTooltip.bind(this)))},D.prototype.initEcharts=function(t){var e=this.$echart.get(0);this.destroyChart(),this.chart=i.init(e),this.onResize(),this.chart.setOption(t),this.focus=this.api.getProperty(D.PROP_FOCUS),"default"!==this.api.getProperty(D.PROP_NODE_CLICK)&&this.setNewFocus(),this.initActions()},D.prototype.onDataSourceChange=function(t){this.unsubscribe(),this.dmDataSource=t;t=new g(t,this,this.api,this.focus);t.hasData()&&this.updateDataSource(t),this.dataSource=t,this.dmDataSource&&t.subscribe()},D.prototype.onFocusChange=function(){var t;this.initActions(),"default"===this.api.getProperty(D.PROP_NODE_CLICK)?(t=this.api.getProperty(D.PROP_FOCUS),_.isNil(t)||(this.focus=_.first(O.focus2Array(t))||[],this.dataSource.setFocus(this.focus))):this.setNewFocus()},D.prototype.setNewFocus=function(){var t,e,i,r,o=this;this.chart&&this.sunburstData&&(t=this.chart.getModel())&&(t=t.getSeriesByIndex(0))&&(r=""===(r=this.api.getProperty(D.PROP_FOCUS))?[]:r.split(","),e=t.getData().tree,i=e.data.tree._nodes,0===r.length?i=this.sunburstChild(i,"",0):_.each(r,function(t,e){0!==i.length&&(0!==e&&(i=i[0].children),i=o.sunburstChild(i,t,e+1))}),1===i.length&&(r=i[0].dataIndex,this.chart._api.dispatchAction({from:e.root.getId(),seriesId:t.id,targetNode:e.getNodeByDataIndex(r),type:"sunburstRootToNode"})))},D.prototype.setTheme=function(t){var e;if("Light"===t)e="Dark";else{if("Dark"!==t)return;e="Light"}P.hasDefaultThemeColors(t,this.api.getProperty(D.PROP_DSN_LBLCOLOR))&&this.api.setProperty(D.PROP_DSN_LBLCOLOR,P.getDefaultThemeColors(e)[0],{bypass:!0}),P.hasDefaultThemeColors(t,this.api.getProperty(D.PROP_VM_COLOR))&&this.api.setProperty(D.PROP_VM_COLOR,P.getDefaultThemeColors(e)[0],{bypass:!0}),e=t.toLowerCase(),this.$el.removeClass("dark light"),this.$el.addClass(e),this.initializeChart()},D.prototype.sunburstChild=function(t,e,i){return _.filter(t,function(t){return t.depth===i&&t.name===e})},D.prototype.showTooltip=function(i){var r,t,e,o,a,s,n;this.api.getProperty(D.PROP_TIP_SHOW)&&(r=i.treePathInfo.length-1,t=this.api.getProperty("Design.Label.FormatLabel.Format"),e=this.api.getProperty("Design.Label.FormatLabel.Decimal"),o=this.api.getProperty("Design.Label.FormatLabel.TrailingZeros"),a=this.api.getProperty("Design.Label.FormatLabel.DateFormat"),s=O.getFormatter(t,e,o,a),n="",_.each(i.treePathInfo,function(t,e){n=0===e?"":r===e?n+'<span style="margin-left:'+5*e+'px">'+i.marker+s(t.name)+" : "+t.value+"</span><br>":n+'<i style="margin-left:'+5*e+'px" class="fa fa-caret-right"></i> '+s(t.name)+" : "+t.value+"<br>"}),this.tooltip=this.api.setTooltip({text:n,anchorEl:this.el,position:{left:i.event.offsetX+20,top:i.event.offsetY+20}}))},D.prototype.getTextWidth=function(t,e){this.canvas=this.canvas||(this.canvas=document.createElement("canvas"));var i=this.canvas.getContext("2d");return i.font=e,i.measureText(t).width},D.prototype.textFill=function(t,e){var i,r,o=t;return"Shorten Text"===this.api.getProperty(D.PROP_LABEL_FIT)&&(r=this.api.getProperty(D.PROP_DSN_LBLFONTSIZE),i=this.api.getProperty(D.PROP_DSN_LBLFONTFAM),o=(r=this.getTextWidth(t,r+"px "+i))<6?"":e<r?t.length<5?"":t.slice(0,3)+"...":t),o},D.prototype.updateOptions=function(){var t,e,i,r,o,a,s,n,l,p,u,h,c,d,g,y,m,P,f,_=this;this.sunburstData&&(t=this.api.getProperty(D.PROP_DSN_RADIUSINNER),e=this.api.getProperty(D.PROP_DSN_RADIUSOUTER),i=this.api.getProperty(D.PROP_DSN_LBLSHOW),r=this.api.getProperty(D.PROP_DSN_LBLCOLOR),o=this.api.getProperty(D.PROP_DSN_LBLROTATE),a=this.api.getProperty(D.PROP_DSN_LBLPOSITION),s=this.api.getProperty(D.PROP_DSN_LBLALIGN),n=this.api.getProperty(D.PROP_DSN_LBLFONTFAM),l=this.api.getProperty(D.PROP_DSN_LBLFONTSIZE),p=this.api.getProperty(D.PROP_NODE_CLICK),u=this.api.getProperty(D.PROP_LBL_DIS),P=this.api.getProperty("Design.Label.FormatLabel.Format"),f=this.api.getProperty("Design.Label.FormatLabel.Decimal"),h=this.api.getProperty("Design.Label.FormatLabel.TrailingZeros"),c=this.api.getProperty("Design.Label.FormatLabel.DateFormat"),d=this.api.getProperty("Design.Label.FormatLabel.Prefix"),g=this.api.getProperty("Design.Label.FormatLabel.Suffix"),y=this.api.getProperty("Design.Label.FormatLabel.Threshold"),m=O.getFormatter(P,f,h,c),f={series:{animation:!(P={align:s,color:r,fontFamily:n,fontSize:l,formatter:function(t){var e=_.chart.getModel().getSeriesByIndex(0).getData().tree.getNodeByDataIndex(t.dataIndex).getLayout();if(e.angle<parseFloat(y))return"";t=(t=t[u]).class?_.timeToNumber(t):t,t=m(t),e=e.r-e.r0,t=_.textFill(t.toString(),e);return d+t+g},position:a,rotate:o,show:i}),data:this.sunburstData,downplay:{label:P},emphasis:{itemStyle:D.PROP_HIGHLIGHT},highlight:{itemStyle:D.PROP_HIGHLIGHT},highlightPolicy:"ancestor",label:P,levels:this.dataSource.levels(),nodeClick:"default"===p||p,radius:[t+"%",e+"%"],sort:null,type:"sunburst"},visualMap:this.visualMap()},this.initEcharts(f))},D.prototype.timeToNumber=function(t){var e=0,e=t.i||e;return e=t.n?e+t.n%1e6:e},D.prototype.unsubscribe=function(){this.api.unsubscribe(this.dataSource)},D.prototype.visualMap=function(){var t,e,i,r,o,a,s=this;return"visual map"===this.api.getProperty(D.PROP_DATA_COLOR)?(t=this.api.getProperty(D.PROP_VM_MIN),e=this.api.getProperty(D.PROP_VM_MAX),i=this.api.getProperty(D.PROP_VM_TYPE),r=this.api.getProperty(D.PROP_VM_COLOR),o=this.api.getProperty(D.PROP_VM_PIECES),a=[],_.each(this.api.getProperty(D.PROP_PALETTE),function(t,e){a.push(s.api.getProperty(D.PROP_PALETTE+"."+e+".type"))}),{inRange:{color:a},max:e,min:t,splitNumber:o,textStyle:{color:r},type:i}):null},D.getComponentDefinition=u.getComponentDefinition,D.PROP_DATA="Basics.Data",D.PROP_DATA_BREAKDOWN="Data.Breakdown",D.PROP_DATA_WEIGHT="Data.Value",D.PROP_DATA_COLOR="Data.Color",D.PROP_SELECTED="Basics.Selected",D.PROP_FOCUS="Basics.Focus",D.PROP_SELECTED_ATTR="Basics.SelectedAttr",D.PROP_NODE_CLICK="Basics.NodeClick",D.PROP_DSN_RADIUSINNER="Design.RadiusInner",D.PROP_DSN_RADIUSOUTER="Design.RadiusOuter",D.PROP_DSN_LBLSHOW="Design.Label.Show",D.PROP_DSN_LBLCOLOR="Design.Label.Color",D.PROP_DSN_LBLROTATE="Design.Label.Rotate",D.PROP_DSN_LBLPOSITION="Design.Label.Position",D.PROP_DSN_LBLALIGN="Design.Label.Align",D.PROP_DSN_LBLFONTFAM="Design.Label.Font.Family",D.PROP_DSN_LBLFONTSIZE="Design.Label.Font.Size",D.PROP_VM_MIN="Design.VisualMap.Min",D.PROP_VM_MAX="Design.VisualMap.Max",D.PROP_VM_COLOR="Design.VisualMap.LabelColor",D.PROP_VM_TYPE="Design.VisualMap.Type",D.PROP_VM_PIECES="Design.VisualMap.Pieces",D.PROP_LBL_DIS="Design.Label.Display",D.PROP_LABEL_FIT="Design.Label.FormatLabel.FitText",D.PROP_PALETTE="Style.Palette",D.PROP_TIP_SHOW="Tooltip.ShowTooltip",D.PROP_TIP_TEMPLATE="Tooltip.TooltipTemplate",D.PROP_HIGHLIGHTRULE="HighlightRule",D.PROP_HIGHLIGHT={shadowColor:"rgba(0, 0, 0, 0.5)",shadowBlur:10,opacity:.6},D});